<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTQiIGZpbGw9IiM2MzY2ZjEiLz48dGV4dCB4PSI1MCUiIHk9IjU0JSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIEJsYWNrLHNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSI5MDAiIGZvbnQtc2l6ZT0iMjYiIGZpbGw9IndoaXRlIj5KRlQ8L3RleHQ+PC9zdmc+" type="image/svg+xml">
    <!-- PWA -->
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Jelian FT">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jelian FT - Clinical Sport v136</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.js"></script>
    <script>
      const SUPABASE_URL = 'https://autdqxqlhxpibleqjvbu.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_iIunAaNnuIWfNhBgd7kjJQ_ykOJxuCn';

      // ============================================================
      // SANDBOX FIX: Previene DataCloneError en entornos srcdoc/iframe
      // Supabase JS internamente hace postMessage con objetos Headers
      // que no son structured-cloneable. Aplicamos 4 capas de defensa.
      // ============================================================
      (function() {

        // 1) BroadcastChannel — Supabase lo usa para sincronizar tabs
        window.BroadcastChannel = class {
          constructor() {} postMessage() {} close() {}
          addEventListener() {} removeEventListener() {} dispatchEvent() { return false; }
        };

        // 2) Worker — Supabase Realtime puede crear workers internos
        window.Worker = class {
          constructor() {} postMessage() {} terminate() {}
          addEventListener() {} removeEventListener() {}
        };

        // 3) Parchar window.postMessage para suprimir DataCloneError
        const _pm = window.postMessage.bind(window);
        window.postMessage = function(data, origin, transfer) {
          try { _pm(data, origin || '*', transfer); }
          catch(e) { if (e && e.name !== 'DataCloneError') throw e; }
        };

        // 4) Parchar fetch para que la Response nunca exponga Headers incompatibles
        //    Supabase llama fetch() y luego intenta postMessage({ headers: response.headers })
        //    Reemplazamos headers con un proxy serializable en cada respuesta.
        const _fetch = window.fetch.bind(window);
        window.fetch = async function(...args) {
          const res = await _fetch(...args);
          const plainHeaders = {};
          try { res.headers.forEach((v, k) => { plainHeaders[k] = v; }); } catch(_e) {}
          return new Proxy(res, {
            get(target, prop) {
              if (prop === 'headers') return new Headers(plainHeaders);
              const val = target[prop];
              return typeof val === 'function' ? val.bind(target) : val;
            }
          });
        };

      })();

      // Detectar si estamos en la vista previa sandbox de Claude (srcdoc/about:srcdoc)
      // En ese caso NO se hacen llamadas de red para evitar DataCloneError de Supabase.
      const IS_SANDBOX = (function() {
        try {
          // Solo activar mock en preview de Claude (srcdoc/about:blank),
          // NO en file:// local ni en servidores reales
          return location.href === 'about:srcdoc' ||
                 location.href === 'about:blank' ||
                 (window.self !== window.top && !location.hostname && !location.href.startsWith('file://'));
        } catch(e) { return true; }
      })();

      const _nullStorage = { getItem: () => null, setItem: () => {}, removeItem: () => {} };

      // Cliente Supabase real o mock según entorno
      let sb;
      window.sb = null; // asegurar acceso global
      if (IS_SANDBOX) {
        // Mock con cadena infinita: soporta cualquier combinacion de metodos Supabase
        // sb.from().select().order().order().limit().eq() etc.
        const _mkChain = () => {
          const EMPTY = { data: [], error: null };
          const EMPTY_ONE = { data: null, error: null };
          const handler = {
            get(_, prop) {
              if (prop === 'then') {
                return (resolve) => Promise.resolve(EMPTY).then(resolve);
              }
              if (prop === 'single') return () => Promise.resolve(EMPTY_ONE);
              return (..._a) => new Proxy({}, handler);
            }
          };
          return new Proxy({}, handler);
        };
        sb = { from: () => _mkChain() };
      } else {
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
          auth: {
            autoRefreshToken: false,
            persistSession: false,
            detectSessionInUrl: false,
            storage: _nullStorage
          },
          realtime: { params: { eventsPerSecond: -1 } }
        });
      }
      window.sb = sb; // exponer globalmente para chat panel
    </script>
       <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --brand-primary: #6366f1;
            --brand-dark: #0f172a;
            --bg-main: #f8fafc;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--brand-dark);
            letter-spacing: -0.01em;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.03);
        }

        .sidebar-gradient {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }

        .nav-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 14px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .sidebar-item-active {
            background: var(--brand-primary) !important;
            color: white !important;
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }

        .metric-card {
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }
        .metric-card { will-change: transform; }
        #sidebar { will-change: transform; }
        #toast { will-change: transform, opacity; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        .red-flag { 
            border-left: 6px solid #ef4444 !important; 
            background: linear-gradient(90deg, #fef2f2 0%, white 100%) !important; 
        }

        input, textarea, select {
            transition: all 0.2s ease;
        }

        @media (max-width: 1024px) {
            .sidebar-adaptive {
                position: fixed;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .sidebar-open {
                transform: translateX(0);
            }
            .main-content {
                width: 100% !important;
                padding: 1rem !important;
            }
        }

        @media print { .no-print { display: none; } }

        /* ===== ANATOMÍA ===== */
        .anat-tab-btn { transition: all 0.2s; }
        .anat-estructura-svg { cursor: pointer; transition: all 0.2s; }
        .anat-estructura-svg:hover { filter: brightness(1.15) drop-shadow(0 0 4px rgba(16,185,129,0.5)); }
        .anat-activo { filter: drop-shadow(0 0 8px #10b981) brightness(1.2) !important; }
        .anat-list-item { transition: all 0.2s; }

        /* ===== FOTOS CLÍNICAS MEJORADAS ===== */
        .foto-filtro-btn { transition: all 0.2s; }
        #fotos-clinicas-grid img { transition: transform 0.3s ease; }

        /* Dark mode anatomía */
        body.dark-mode #anat-info-panel { background: rgba(30,41,59,0.95); }
        body.dark-mode .anat-list-item:hover { background: rgba(99,102,241,0.1) !important; }
        body.dark-mode #anat-tests-grid > div { background: #1e293b !important; border-color: rgba(255,255,255,0.07) !important; }

        /* ===== DARK MODE ===== */
        body.dark-mode {
            --bg-main: #0f172a;
            --brand-dark: #f1f5f9;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        /* === Surfaces === */
        body.dark-mode .glass-card { background: rgba(30,41,59,0.95); border-color: rgba(255,255,255,0.07); }
        body.dark-mode .bg-white { background-color: #1e293b !important; }
        body.dark-mode .bg-slate-50 { background-color: #1e293b !important; }
        body.dark-mode .bg-slate-50\/50 { background-color: rgba(30,41,59,0.5) !important; }
        body.dark-mode .bg-slate-100 { background-color: #273549 !important; }
        body.dark-mode .bg-slate-200 { background-color: #2d3f55 !important; }
        body.dark-mode .bg-slate-800 { background-color: #0f172a !important; }
        body.dark-mode .bg-slate-900 { background-color: #020817 !important; }

        /* === Colored tint surfaces === */
        body.dark-mode .bg-indigo-50  { background-color: rgba(99,102,241,0.15) !important; }
        body.dark-mode .bg-indigo-100 { background-color: rgba(99,102,241,0.2)  !important; }
        body.dark-mode .bg-rose-50    { background-color: rgba(239,68,68,0.12)  !important; }
        body.dark-mode .bg-rose-100   { background-color: rgba(239,68,68,0.18)  !important; }
        body.dark-mode .bg-emerald-50 { background-color: rgba(16,185,129,0.12) !important; }
        body.dark-mode .bg-amber-50   { background-color: rgba(245,158,11,0.12) !important; }
        body.dark-mode .bg-amber-100  { background-color: rgba(245,158,11,0.18) !important; }

        /* === Text === */
        body.dark-mode .text-slate-900 { color: #f1f5f9 !important; }
        body.dark-mode .text-slate-800 { color: #e2e8f0 !important; }
        body.dark-mode .text-slate-700 { color: #cbd5e1 !important; }
        body.dark-mode .text-slate-600 { color: #94a3b8 !important; }
        body.dark-mode .text-slate-500 { color: #64748b !important; }
        body.dark-mode .text-slate-400 { color: #475569 !important; }
        body.dark-mode .text-slate-300 { color: #334155 !important; }

        /* === Colored text — boost contrast === */
        body.dark-mode .text-rose-600  { color: #fca5a5 !important; }
        body.dark-mode .text-rose-500  { color: #fca5a5 !important; }
        body.dark-mode .text-emerald-500 { color: #6ee7b7 !important; }
        body.dark-mode .text-emerald-600 { color: #6ee7b7 !important; }
        body.dark-mode .text-amber-600 { color: #fcd34d !important; }
        body.dark-mode .text-amber-500 { color: #fcd34d !important; }
        body.dark-mode .text-indigo-600 { color: #a5b4fc !important; }
        body.dark-mode .text-indigo-500 { color: #a5b4fc !important; }

        /* === Borders === */
        body.dark-mode .border-slate-50  { border-color: rgba(255,255,255,0.04) !important; }
        body.dark-mode .border-slate-100 { border-color: rgba(255,255,255,0.07) !important; }
        body.dark-mode .border-slate-200 { border-color: rgba(255,255,255,0.1)  !important; }
        body.dark-mode .border-amber-200 { border-color: rgba(245,158,11,0.25)  !important; }
        body.dark-mode .border-indigo-100 { border-color: rgba(99,102,241,0.25) !important; }
        body.dark-mode .divide-slate-50 > * + * { border-color: rgba(255,255,255,0.05) !important; }

        /* === Inputs / Textareas / Selects === */
        body.dark-mode input,
        body.dark-mode textarea,
        body.dark-mode select {
            background-color: #0f172a !important;
            color: #f1f5f9 !important;
            border-color: rgba(255,255,255,0.1) !important;
        }
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder { color: #475569 !important; }

        /* === Sticky notes === */
        body.dark-mode #sticky-notes {
            background-color: rgba(245,158,11,0.08) !important;
            border-color: rgba(245,158,11,0.2) !important;
            color: #fcd34d !important;
        }
        body.dark-mode #sticky-notes::placeholder { color: rgba(252,211,77,0.4) !important; }

        /* === Tables === */
        body.dark-mode table thead { background-color: rgba(15,23,42,0.8) !important; }
        body.dark-mode tr:hover { background-color: rgba(99,102,241,0.08) !important; }
        body.dark-mode .red-flag {
            border-left-color: #ef4444 !important;
            background: linear-gradient(90deg, rgba(239,68,68,0.1) 0%, rgba(30,41,59,0.95) 100%) !important;
        }

        /* === Filter chips === */
        body.dark-mode .filter-chip {
            border-color: rgba(255,255,255,0.12) !important;
            color: #94a3b8 !important;
            background: transparent !important;
        }
        body.dark-mode .filter-chip:hover {
            border-color: #818cf8 !important;
            color: #818cf8 !important;
        }
        body.dark-mode .filter-chip.active {
            background: #6366f1 !important;
            color: white !important;
            border-color: #6366f1 !important;
        }

        /* === Template cards === */
        body.dark-mode .template-card {
            border-color: rgba(255,255,255,0.1) !important;
            background: rgba(30,41,59,0.6) !important;
        }
        body.dark-mode .template-card:hover {
            border-color: #6366f1 !important;
            background: rgba(99,102,241,0.08) !important;
        }

        /* === Objective progress bar track === */
        body.dark-mode .obj-progress { background: rgba(255,255,255,0.08) !important; }

        /* === Weekly calendar === */
        body.dark-mode .week-slot { border-bottom-color: rgba(255,255,255,0.05) !important; }
        body.dark-mode .week-slot:hover { background: rgba(99,102,241,0.08) !important; }
        body.dark-mode .week-pill { background: rgba(99,102,241,0.25) !important; color: #a5b4fc !important; }
        body.dark-mode .week-col-header { color: #64748b !important; }
        body.dark-mode .cal-event-pill { background: rgba(99,102,241,0.25) !important; color: #a5b4fc !important; }
        body.dark-mode .cal-day.today { background: rgba(99,102,241,0.15) !important; border-color: #6366f1 !important; }
        body.dark-mode .cal-day:hover { background: rgba(99,102,241,0.08) !important; }

        /* === Modal boxes === */
        body.dark-mode #modal-box { background: #1e293b !important; }
        body.dark-mode #modal-box h3 { color: #f1f5f9 !important; }
        body.dark-mode #modal-box p { color: #94a3b8 !important; }
        body.dark-mode #edit-modal-box { background: #1e293b !important; }

        /* === Global search === */
        body.dark-mode #global-search-overlay > div > div { background: #1e293b !important; }
        body.dark-mode #global-search-input { background: transparent !important; color: #f1f5f9 !important; }
        body.dark-mode .search-result-item:hover { background: rgba(99,102,241,0.12) !important; }
        body.dark-mode .border-slate-100.border-b { border-color: rgba(255,255,255,0.07) !important; }

        /* === Dashboard metric icon backgrounds === */
        body.dark-mode .bg-rose-50.text-rose-600 { color: #fca5a5 !important; }
        body.dark-mode .bg-emerald-50.text-emerald-600 { color: #6ee7b7 !important; }
        body.dark-mode .bg-amber-50.text-amber-600 { color: #fcd34d !important; }

        /* === Buttons with light backgrounds === */
        body.dark-mode .bg-slate-100.text-slate-700,
        body.dark-mode .bg-slate-200.text-slate-600 {
            background-color: #273549 !important;
            color: #cbd5e1 !important;
        }
        body.dark-mode button.bg-slate-100 { background-color: #273549 !important; color: #cbd5e1 !important; }
        body.dark-mode button.bg-slate-100:hover { background-color: #2d3f55 !important; }
        body.dark-mode button.bg-rose-50 { background-color: rgba(239,68,68,0.15) !important; color: #fca5a5 !important; }
        body.dark-mode button.bg-rose-50:hover { background-color: #ef4444 !important; color: white !important; }
        body.dark-mode button.bg-indigo-50 { background-color: rgba(99,102,241,0.15) !important; color: #a5b4fc !important; }
        body.dark-mode button.bg-indigo-50:hover { background-color: rgba(99,102,241,0.25) !important; }
        body.dark-mode button.bg-white.border { background-color: #1e293b !important; border-color: rgba(255,255,255,0.1) !important; color: #cbd5e1 !important; }
        body.dark-mode button.bg-white.border:hover { background-color: #273549 !important; }
        body.dark-mode button.bg-emerald-50 { background-color: rgba(16,185,129,0.12) !important; }
        body.dark-mode button.bg-amber-50 { background-color: rgba(245,158,11,0.12) !important; }

        /* === Dashboard citas hoy section === */
        body.dark-mode .bg-indigo-50.rounded-xl { background-color: rgba(99,102,241,0.15) !important; }

        /* === Session cards & objective cards === */
        body.dark-mode .border-emerald-200 { border-color: rgba(16,185,129,0.25) !important; }
        body.dark-mode .bg-emerald-50.border-emerald-200 { background-color: rgba(16,185,129,0.08) !important; }
        body.dark-mode .bg-emerald-100 { background-color: rgba(16,185,129,0.2) !important; }
        body.dark-mode .text-emerald-600 { color: #6ee7b7 !important; }

        /* === RPE labels === */
        body.dark-mode .bg-amber-50.text-amber-600 { background-color: rgba(245,158,11,0.12) !important; color: #fcd34d !important; }
        body.dark-mode .bg-emerald-50.text-emerald-600 { background-color: rgba(16,185,129,0.12) !important; color: #6ee7b7 !important; }

        /* === Print / no-print safe === */
        @media print { body.dark-mode * { background: white !important; color: black !important; } }

        /* ===== TÉCNICA CHIPS ===== */
        .tecnica-chip span { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 10px; font-weight: 800; border: 1.5px solid #e2e8f0; color: #64748b; cursor: pointer; transition: all 0.15s; user-select: none; }
        .tecnica-chip input:checked + span { background: #6366f1; color: white; border-color: #6366f1; }
        .tecnica-chip span:hover { border-color: #6366f1; color: #6366f1; }
        body.dark-mode .tecnica-chip span { border-color: rgba(255,255,255,0.12); color: #94a3b8; }
        body.dark-mode .tecnica-chip input:checked + span { background: #6366f1; color: white; }

        /* ===== PHOTO CLINICAL GALLERY ===== */
        .foto-clinica-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 12px; cursor: pointer; border: 2px solid #e2e8f0; transition: all 0.2s; }
        .foto-clinica-thumb:hover { border-color: #6366f1; transform: scale(1.05); }

        /* ===== RTS SEMAFORO ===== */
        .rts-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 12px; border: 1px solid #f1f5f9; }
        .rts-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
        .rts-dot.verde { background: #10b981; }
        .rts-dot.amarillo { background: #f59e0b; }
        .rts-dot.rojo { background: #ef4444; }
        body.dark-mode .rts-item { border-color: rgba(255,255,255,0.07); }

        /* ===== LAST CONTACT BADGE ===== */
        .dias-badge { font-size: 9px; font-weight: 900; padding: 2px 8px; border-radius: 999px; }
        .dias-ok { background: #dcfce7; color: #16a34a; }
        .dias-warn { background: #fef3c7; color: #d97706; }
        .dias-alert { background: #fee2e2; color: #dc2626; }
        body.dark-mode .dias-ok { background: rgba(22,163,74,0.2); color: #4ade80; }
        body.dark-mode .dias-warn { background: rgba(217,119,6,0.2); color: #fbbf24; }
        body.dark-mode .dias-alert { background: rgba(220,38,38,0.2); color: #f87171; }

        /* === RTS items dark mode === */
        body.dark-mode .rts-item { background: rgba(30,41,59,0.8) !important; border-color: rgba(255,255,255,0.07) !important; }
        body.dark-mode .rts-item.bg-emerald-50 { background: rgba(16,185,129,0.08) !important; }
        /* === Ejercicios hoja dark mode === */
        body.dark-mode #ejercicios-personalizados-container .space-y-2 { color: #f1f5f9; }

        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 999px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.08em; }
        .status-activo    { background: #dcfce7; color: #16a34a; }
        .status-reposo    { background: #fef3c7; color: #d97706; }
        .status-aguda     { background: #fee2e2; color: #dc2626; }
        .status-alta      { background: #e0e7ff; color: #4f46e5; }
        body.dark-mode .status-activo  { background: rgba(22,163,74,0.2); color: #4ade80; }
        body.dark-mode .status-reposo  { background: rgba(217,119,6,0.2); color: #fbbf24; }
        body.dark-mode .status-aguda   { background: rgba(220,38,38,0.2); color: #f87171; }
        body.dark-mode .status-alta    { background: rgba(79,70,229,0.2); color: #818cf8; }

        /* ===== PHOTO UPLOAD ===== */
        .avatar-upload { position: relative; cursor: pointer; }
        .avatar-upload:hover .avatar-overlay { opacity: 1; }
        .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.45); border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }

        /* ===== PIN MODAL ===== */
        #pin-screen { position: fixed; inset: 0; background: #0f172a; z-index: 99999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1.5rem; }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #6366f1; transition: background 0.2s; }
        .pin-dot.filled { background: #6366f1; }
        .pin-key { width: 72px; height: 72px; border-radius: 50%; background: rgba(255,255,255,0.06); color: white; font-size: 1.4rem; font-weight: 800; border: none; cursor: pointer; transition: all 0.15s; }
        .pin-key:hover { background: rgba(99,102,241,0.3); transform: scale(1.08); }
        .pin-key:active { transform: scale(0.95); }

        /* ===== NOTES WIDGET ===== */
        #notes-widget { transition: all 0.3s; }

        /* ===== RPE SLIDER ===== */
        input[type=range].rpe-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #4ade80, #facc15, #f87171); outline: none; }
        input[type=range].rpe-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: white; border: 3px solid #6366f1; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* ===== PREDICTION BADGE ===== */
        .prediction-chip { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 6px 14px; border-radius: 999px; font-size: 10px; font-weight: 800; display: inline-flex; align-items: center; gap: 6px; }

        /* ===== OBJECTIVES ===== */
        .obj-progress { height: 6px; border-radius: 3px; background: #e2e8f0; overflow: hidden; }
        .obj-progress-bar { height: 100%; border-radius: 3px; background: linear-gradient(90deg, #6366f1, #8b5cf6); transition: width 0.6s ease; }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeInUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
        .animate-in { animation: fadeInUp 0.35s ease forwards; }
        @keyframes pulse-dot { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.3);opacity:0.7} }
        .alert-pulse { animation: pulse-dot 1.5s infinite; }

        /* ===== SECTION TRANSITIONS ===== */
        @keyframes sectionIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        main > section:not(.hidden) { animation: sectionIn 0.28s cubic-bezier(0.22, 1, 0.36, 1) forwards; }

        /* ===== MODAL SCALE-IN ===== */
        @keyframes modalIn { from { opacity:0; transform:scale(0.95) translateY(8px); } to { opacity:1; transform:scale(1) translateY(0); } }
        #modal-box, #edit-modal-box { animation: modalIn 0.2s cubic-bezier(0.22, 1, 0.36, 1) forwards; }

        /* ===== SIDEBAR NAV ACTIVE ===== */
        .nav-btn.active { background: rgba(99,102,241,0.15) !important; color: white !important; }

        /* ===== BUTTON MICRO-INTERACTION ===== */
        button:active:not(:disabled) { transform: scale(0.97); transition: transform 0.08s ease; }
        .nav-btn:active { transform: translateX(6px) scale(0.97) !important; }

        /* ===== SMOOTH TABLE ROWS ===== */
        tbody tr { transition: background 0.12s ease; }

        /* ===== INPUT FOCUS ELEVATION ===== */
        input:focus, textarea:focus, select:focus {
            background-color: white !important;
            box-shadow: 0 4px 14px rgba(99,102,241,0.08), 0 0 0 2px rgba(99,102,241,0.18) !important;
            transition: box-shadow 0.2s ease, background 0.2s ease;
        }
        body.dark-mode input:focus, body.dark-mode textarea:focus, body.dark-mode select:focus {
            background-color: #0f172a !important;
            box-shadow: 0 4px 14px rgba(99,102,241,0.15), 0 0 0 2px rgba(99,102,241,0.3) !important;
        }

        /* ===== SIDEBAR SMOOTH OPEN ===== */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* ===== LOADING SKELETON ===== */
        @keyframes shimmer { 0%{background-position:-600px 0} 100%{background-position:600px 0} }
        .skeleton { background: linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 50%,#f1f5f9 75%); background-size:1200px 100%; animation: shimmer 1.4s ease-in-out infinite; border-radius:8px; }
        body.dark-mode .skeleton { background: linear-gradient(90deg,#1e293b 25%,#273549 50%,#1e293b 75%); background-size:1200px 100%; }

        /* ===== CALENDAR ===== */
        .cal-day { min-height: 80px; border-radius: 12px; padding: 6px; transition: all 0.2s; cursor: pointer; }
        .cal-day:hover { background: rgba(99,102,241,0.06); }
        .cal-day.today { background: rgba(99,102,241,0.1); border: 2px solid #6366f1; }
        .cal-day.has-events { position: relative; }
        .cal-event-dot { width: 6px; height: 6px; border-radius: 50%; background: #6366f1; display: inline-block; margin: 1px; }
        .cal-event-pill { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 999px; background: #e0e7ff; color: #4f46e5; display: block; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        body.dark-mode .cal-event-pill { background: rgba(99,102,241,0.25); color: #a5b4fc; }

        /* ===== KIOSK MODE ===== */
        #kiosk-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 99998; display: none; flex-direction: column; align-items: center; justify-content: center; gap: 2rem; }
        #kiosk-overlay.active { display: flex; }
        .kiosk-eva-ring { width: 200px; height: 200px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; border: 8px solid; position: relative; }

        /* ===== KEYBOARD SHORTCUT HINT ===== */

        /* ===== CHRONO ===== */
        #chrono-display { font-variant-numeric: tabular-nums; }

        /* ===== EXERCISE TEMPLATE ===== */
        .template-card { border: 2px dashed #e2e8f0; border-radius: 1.5rem; padding: 1.25rem; cursor: pointer; transition: all 0.2s; }
        .template-card:hover { border-color: #6366f1; background: rgba(99,102,241,0.03); }
        body.dark-mode .template-card { border-color: rgba(255,255,255,0.1); }


        /* ===== SEARCH GLOBAL ===== */
        #global-search-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.85); backdrop-filter: blur(8px); z-index: 9996; display: flex; align-items: flex-start; justify-content: center; padding-top: 120px; opacity:0; pointer-events:none; transition: opacity 0.2s ease; }
        #global-search-overlay.active { opacity:1; pointer-events:all; }
        #global-search-overlay > div { transform: translateY(-8px); transition: transform 0.25s cubic-bezier(0.22,1,0.36,1); }
        #global-search-overlay.active > div { transform: translateY(0); }
        .search-result-item { padding: 12px 16px; border-radius: 12px; cursor: pointer; transition: background 0.15s; }
        .search-result-item:hover { background: rgba(99,102,241,0.1); }

        /* Toast */
        #toast {
            position: fixed; bottom: 2rem; right: 2rem;
            background: #1e293b; color: white;
            padding: 1rem 1.5rem; border-radius: 1rem;
            font-size: 0.75rem; font-weight: 700;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            z-index: 9999; opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        #toast.show { opacity: 1; transform: translateY(0); }
        #toast.error { background: #ef4444; }

        /* Modal */
        #modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 9998;
            align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s ease;
            pointer-events: none;
        }
        #modal-overlay:not(.hidden) { display: flex; opacity: 1; pointer-events: all; }
        #modal-box {
            background: white; padding: 2.5rem; border-radius: 2rem;
            max-width: 420px; width: 90%;
            box-shadow: 0 40px 80px rgba(0,0,0,0.2);
        }

        /* Edit Patient Modal */
        #edit-modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.55);
            backdrop-filter: blur(6px);
            z-index: 9999;
            align-items: center; justify-content: center;
            display: flex;
            opacity: 0; pointer-events: none;
            transition: opacity 0.22s ease;
        }
        #edit-modal-overlay.active { opacity: 1; pointer-events: all; }
        #edit-modal-box {
            background: white; padding: 2.5rem; border-radius: 2rem;
            max-width: 580px; width: 94%; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 40px 80px rgba(0,0,0,0.25);
        }
        body.dark-mode #edit-modal-box { background: #1e293b; }

        /* Filter chips */
        .filter-chip { padding: 6px 14px; border-radius: 999px; font-size: 10px; font-weight: 800; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.05em; }
        .filter-chip:hover { border-color: #6366f1; color: #6366f1; }
        .filter-chip.active { background: #6366f1; color: white; border-color: #6366f1; }

        /* Today's appointments badge */
        .citas-hoy-badge { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border-radius: 999px; padding: 2px 8px; font-size: 9px; font-weight: 900; }

        /* Weekly calendar */
        .week-slot { min-height: 48px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: flex-start; padding: 6px; gap: 4px; flex-wrap: wrap; }
        .week-slot:hover { background: rgba(99,102,241,0.03); }
        .week-col-header { text-align: center; padding: 8px 4px; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #94a3b8; }
        .week-col-today { color: #6366f1 !important; }
        .week-pill { font-size: 8px; font-weight: 800; padding: 2px 6px; border-radius: 6px; background: #e0e7ff; color: #4f46e5; white-space: nowrap; cursor: pointer; max-width: 100%; overflow: hidden; text-overflow: ellipsis; }
        body.dark-mode .week-pill { background: rgba(99,102,241,0.25); color: #a5b4fc; }
        /* ===== IA IMAGEN MÉDICA ===== */
        .img-tipo-chip input:checked + span {
            border-color: #6366f1 !important;
            background: rgba(99,102,241,0.08);
            color: #4f46e5 !important;
        }
        .img-tipo-chip span:hover { border-color: #818cf8; }
        body.dark-mode .img-tipo-chip span { border-color: rgba(255,255,255,0.12) !important; color: #94a3b8 !important; }
        body.dark-mode .img-tipo-chip input:checked + span { border-color: #6366f1 !important; background: rgba(99,102,241,0.2) !important; color: #a5b4fc !important; }

        @keyframes loadingBar { 0%{width:0%} 70%{width:85%} 100%{width:95%} }
        .loading-bar-anim { animation: loadingBar 20s ease-out forwards; }

        .ia-section-card { background: #f8fafc; border-radius: 1rem; padding: 1.25rem 1.5rem; }
        body.dark-mode .ia-section-card { background: rgba(15,23,42,0.6) !important; }

        .hallazgo-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:999px; font-size:10px; font-weight:800; }
        .hallazgo-normal { background:#dcfce7; color:#16a34a; }
        .hallazgo-leve { background:#fef3c7; color:#d97706; }
        .hallazgo-moderado { background:#fee2e2; color:#dc2626; }
        .hallazgo-severo { background:#fce7f3; color:#9d174d; }
        body.dark-mode .hallazgo-normal { background:rgba(22,163,74,0.2); color:#4ade80; }
        body.dark-mode .hallazgo-leve { background:rgba(217,119,6,0.2); color:#fbbf24; }
        body.dark-mode .hallazgo-moderado { background:rgba(220,38,38,0.2); color:#f87171; }
        body.dark-mode .hallazgo-severo { background:rgba(157,23,77,0.2); color:#f472b6; }
    
    </style>
</head>
    <script>
        let pinBuffer = '';
        const PIN_KEY = 'jelian_pin_v2'; // v2 = hashed

        async function _hashPin(pin) {
            const msgBuffer = new TextEncoder().encode(pin + '_jelianft_salt');
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
        }

        function pinPress(d) {
            if (pinBuffer.length >= 4) return;
            pinBuffer += d;
            document.querySelectorAll('.pin-dot').forEach((dot, i) => dot.classList.toggle('filled', i < pinBuffer.length));
            if (pinBuffer.length === 4) setTimeout(checkPin, 150);
        }
        function pinClear() {
            pinBuffer = pinBuffer.slice(0,-1);
            document.querySelectorAll('.pin-dot').forEach((dot, i) => dot.classList.toggle('filled', i < pinBuffer.length));
        }
        function pinSkip() { unlockApp(); }

        async function checkPin() {
            const saved = localStorage.getItem(PIN_KEY);
            if (!saved) { unlockApp(); return; }
            const hashed = await _hashPin(pinBuffer);
            if (hashed === saved) {
                unlockApp();
            } else {
                document.getElementById('pin-error').classList.remove('hidden');
                pinBuffer = '';
                document.querySelectorAll('.pin-dot').forEach(dot => dot.classList.remove('filled'));
                setTimeout(() => document.getElementById('pin-error').classList.add('hidden'), 2000);
            }
        }

        function unlockApp() {
            const pinEl = document.getElementById('pin-screen');
            pinEl.style.transition = 'opacity 0.35s ease';
            pinEl.style.opacity = '0';
            setTimeout(() => {
                pinEl.style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                document.body.classList.toggle('dark-mode', localStorage.getItem('jelian_darkmode') === '1');
                showSection('dashboard');
            }, 350);
        }
    </script>
    <!-- PIN SCREEN -->
    <div id="pin-screen">
        <div class="text-center mb-4">
            <h1 class="text-white text-3xl font-extrabold italic tracking-tighter">JELIAN <span class="text-indigo-400">FT</span></h1>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-2">Ingresa tu PIN</p>
        </div>
        <div class="flex gap-3" id="pin-dots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <p id="pin-error" class="text-rose-400 text-xs font-bold hidden">PIN incorrecto</p>
        <div class="grid grid-cols-3 gap-3 mt-2">
            <button type="button" class="pin-key" onclick="pinPress('1')" aria-label="Dígito 1">1</button>
            <button type="button" class="pin-key" onclick="pinPress('2')" aria-label="Dígito 2">2</button>
            <button type="button" class="pin-key" onclick="pinPress('3')" aria-label="Dígito 3">3</button>
            <button type="button" class="pin-key" onclick="pinPress('4')" aria-label="Dígito 4">4</button>
            <button type="button" class="pin-key" onclick="pinPress('5')" aria-label="Dígito 5">5</button>
            <button type="button" class="pin-key" onclick="pinPress('6')" aria-label="Dígito 6">6</button>
            <button type="button" class="pin-key" onclick="pinPress('7')" aria-label="Dígito 7">7</button>
            <button type="button" class="pin-key" onclick="pinPress('8')" aria-label="Dígito 8">8</button>
            <button type="button" class="pin-key" onclick="pinPress('9')" aria-label="Dígito 9">9</button>
            <button type="button" class="pin-key text-slate-500 text-sm" onclick="pinClear()" aria-label="Borrar último dígito">⌫</button>
            <button type="button" class="pin-key" onclick="pinPress('0')" aria-label="Dígito 0">0</button>
            <button type="button" class="pin-key text-slate-400 text-[10px] font-black tracking-wide" onclick="pinSkip()" aria-label="Omitir PIN y entrar">Omitir</button>
        </div>
        <p class="text-slate-600 text-[10px] mt-2">Presiona <strong>Omitir</strong> para entrar sin PIN o configúralo desde Ajustes</p>
    </div>

    <div id="app-content" class="hidden h-screen overflow-hidden flex flex-col lg:flex-row">

    <div class="lg:hidden p-4 bg-slate-900 flex justify-between items-center no-print z-[60]">
        <div class="flex items-center gap-2">
            <h1 class="text-white text-xl font-extrabold italic">JELIAN <span class="text-indigo-400">FT</span></h1>
            <span id="offline-badge" class="hidden text-[9px] font-black bg-rose-500 text-white px-2 py-0.5 rounded-full uppercase tracking-wide">sin red</span>
        </div>
        <div class="flex gap-2">
            <button onclick="forceReload()" id="btn-reload" title="Recargar / Actualizar app" class="text-white p-2 bg-slate-700 rounded-xl active:scale-90 transition-transform relative">
                <svg id="reload-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                <span id="reload-badge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full border-2 border-slate-900"></span>
            </button>
            <button onclick="openGlobalSearch()" class="text-white p-2 bg-slate-700 rounded-xl active:scale-90 transition-transform">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </button>
            <button onclick="toggleMenu()" class="text-white p-2 bg-indigo-600 rounded-xl active:scale-90 transition-transform">
                <svg id="menu-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/></svg>
            </button>
        </div>
    </div>

    <div id="overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden lg:hidden"></div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Modal Confirmación -->
    <div id="modal-overlay" class="hidden">
        <div id="modal-box">
            <h3 class="text-xl font-extrabold text-slate-900 mb-2">¿Dar de Alta?</h3>
            <p class="text-sm text-slate-500 mb-2">Esta acción eliminará el expediente de:</p>
            <p id="modal-nombre-paciente" class="text-base font-black text-rose-500 mb-6"></p>
            <p class="text-xs text-slate-400 mb-8">Esta acción es permanente y no se puede deshacer.</p>
            <div class="flex gap-3">
                <button onclick="cerrarModal()" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">Cancelar</button>
                <button id="modal-confirm-btn" class="flex-1 bg-rose-500 text-white py-3 rounded-xl font-bold text-sm hover:bg-rose-600 transition-colors">Sí, dar de alta</button>
            </div>
        </div>
    </div>

    <!-- GLOBAL SEARCH OVERLAY -->
    <div id="global-search-overlay" onclick="if(event.target===this)closeGlobalSearch()">
        <div class="w-full max-w-2xl px-4">
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
                <div class="flex items-center gap-3 p-4 border-b border-slate-100">
                    <svg class="w-5 h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input id="global-search-input" type="text" placeholder="Buscar atletas, diagnósticos, sesiones..." class="flex-1 outline-none text-sm font-medium text-slate-700 placeholder-slate-400" oninput="_debouncedGlobalSearch(this.value)">
                    
                </div>
                <div id="global-search-results" class="p-3 max-h-80 overflow-y-auto">
                    <p class="text-xs text-slate-400 text-center py-6">Empieza a escribir para buscar...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- KIOSK OVERLAY -->
    <div id="kiosk-overlay">
        <div class="text-center">
            <p class="text-slate-500 text-xs font-black uppercase tracking-widest mb-2">Progreso de Recuperación</p>
            <h2 id="kiosk-nombre" class="text-white text-4xl font-extrabold tracking-tight mb-8"></h2>
        </div>
        <div id="kiosk-eva-ring" class="kiosk-eva-ring">
            <span id="kiosk-eva-num" class="text-white text-6xl font-black"></span>
            <span class="text-slate-400 text-sm font-bold">EVA</span>
        </div>
        <div class="grid grid-cols-3 gap-6 text-center">
            <div><p class="text-slate-500 text-[10px] font-black uppercase">Sesiones</p><p id="kiosk-sesiones" class="text-white text-2xl font-black"></p></div>
            <div><p class="text-slate-500 text-[10px] font-black uppercase">Deporte</p><p id="kiosk-deporte" class="text-white text-2xl font-black"></p></div>
            <div><p class="text-slate-500 text-[10px] font-black uppercase">Estado</p><p id="kiosk-status" class="text-white text-2xl font-black"></p></div>
        </div>
        <button onclick="closeKiosk()" class="text-slate-600 text-xs font-bold mt-8 hover:text-slate-400">Presiona ESC o toca aquí para salir</button>
    </div>


    <!-- EDIT PATIENT MODAL -->
    <div id="edit-modal-overlay" onclick="if(event.target===this)closeEditModal()">
        <div id="edit-modal-box">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-extrabold text-slate-900">✏️ Editar Expediente</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">×</button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="sm:col-span-2">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Nombre Completo</label>
                    <input id="edit-nombre" type="text" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                </div>
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Cédula / ID</label>
                    <input id="edit-ci" type="text" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                </div>
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Fecha de Nacimiento</label>
                    <input id="edit-nacimiento" type="date" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white" onchange="calcularEdadEdit(this)">
                    <p class="text-[10px] text-indigo-500 font-bold mt-1" id="edit-edad-calculada"></p>
                    <input type="hidden" id="edit-edad">
                </div>
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Deporte</label>
                    <input id="edit-deporte" type="text" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                </div>
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Sexo</label>
                    <select id="edit-sexo" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Teléfono</label>
                    <input id="edit-telefono" type="tel" placeholder="Ej: 0999123456" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                </div>
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Contacto Emergencia</label>
                    <input id="edit-emergencia" type="text" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                </div>
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Zona Lesionada</label>
                    <select id="edit-zona" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                        <option value="Rodilla">Rodilla</option>
                        <option value="Hombro">Hombro</option>
                        <option value="Tobillo">Tobillo</option>
                        <option value="Espalda">Espalda</option>
                        <option value="Cadera">Cadera</option>
                        <option value="Cuello/Cervical">Cuello/Cervical</option>
                        <option value="Codo">Codo</option>
                        <option value="Muñeca/Mano">Muñeca/Mano</option>
                        <option value="Ingle/Pubis">Ingle/Pubis</option>
                        <option value="Isquiotibiales">Isquiotibiales</option>
                        <option value="Pierna/Tibial">Pierna/Tibial</option>
                        <option value="Pie">Pie</option>
                        <option value="Otra">Otra</option>
                    </select>
                </div>
                <div class="sm:col-span-2">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Diagnóstico y Plan Clínico</label>
                    <textarea id="edit-diag" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-medium mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white h-28 resize-none"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="guardarEdicion()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-black text-sm hover:bg-indigo-700 transition-all">Guardar Cambios</button>
                <button onclick="closeEditModal()" class="bg-slate-100 text-slate-700 px-6 py-3 rounded-xl font-bold text-sm hover:bg-slate-200">Cancelar</button>
            </div>
        </div>
    </div>

    <aside id="sidebar" class="w-72 sidebar-gradient text-slate-400 flex flex-col no-print shadow-2xl z-50 sidebar-adaptive lg:translate-x-0">
        <div class="p-10">
            <h1 class="text-white text-2xl font-extrabold tracking-tighter italic">JELIAN <span class="text-indigo-400">FT</span></h1>
            <div class="h-1 w-12 bg-indigo-500 mt-2 rounded-full"></div>
            <p class="text-[9px] font-bold uppercase tracking-[0.3em] mt-4 opacity-50">Clinical Sport </p>
        </div>

        <nav class="flex-1 px-6 space-y-2 overflow-y-auto custom-scrollbar">
            <button onclick="showSection('dashboard')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Dashboard
            </button>
            <button onclick="showSection('calendario')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Agenda
            </button>
            <button onclick="showSection('lista-pacientes')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 005.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                Expedientes
            </button>
            <button onclick="showSection('biblioteca')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                Protocolos
            </button>
            <button onclick="showSection('lista-espera')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Lista de Espera
                <span id="espera-badge-nav" class="ml-auto hidden text-[8px] font-black bg-amber-500 text-white px-2 py-0.5 rounded-full tracking-wide">0</span>
            </button>
            <button onclick="showSection('plantillas')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                Plantillas
            </button>
            <button onclick="showSection('reportes')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Reportes
            </button>
            <button onclick="showSection('imagen-ia')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                IA Imagen Médica
                <span class="ml-auto text-[8px] font-black bg-indigo-500 text-white px-2 py-0.5 rounded-full tracking-wide">BETA</span>
            </button>
            <button onclick="showSection('anatomia')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                Anatomía
                <span class="ml-auto text-[8px] font-black bg-emerald-500 text-white px-2 py-0.5 rounded-full tracking-wide">NEW</span>
            </button>
            <button onclick="showSection('documentos')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Documentos
                <span class="ml-auto text-[8px] font-black bg-rose-500 text-white px-2 py-0.5 rounded-full tracking-wide">NEW</span>
            </button>
            <button onclick="showSection('facturacion')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Facturación
                <span class="ml-auto text-[8px] font-black bg-emerald-500 text-white px-2 py-0.5 rounded-full tracking-wide">NEW</span>
            </button>
            <button onclick="showSection('inventario')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                Inventario
                <span class="ml-auto text-[8px] font-black bg-amber-500 text-white px-2 py-0.5 rounded-full tracking-wide">NEW</span>
            </button>
            <button onclick="showSection('calculadoras')" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                Calculadoras
                <span class="ml-auto text-[8px] font-black bg-violet-500 text-white px-2 py-0.5 rounded-full tracking-wide">NEW</span>
            </button>

            <button onclick="openGlobalSearch()" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                Búsqueda Global
            </button>

            <!-- CHAT PACIENTES -->
            <button onclick="abrirChatPanel()" class="nav-btn w-full text-left p-4 flex items-center gap-4 font-semibold text-sm relative group">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                Chat Pacientes
                <span id="chat-nav-badge" class="ml-auto hidden text-[8px] font-black bg-green-500 text-white px-2 py-0.5 rounded-full tracking-wide animate-pulse">●</span>
            </button>
            
            <div class="mt-8 pt-8 border-t border-slate-800/50">
                <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4">Mantenimiento</p>
                <button id="pwa-install-btn" onclick="instalarPWA()" class="w-full text-left px-4 py-2 text-xs hover:text-white transition-colors flex items-center gap-3 hidden">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                    Instalar App
                </button>
                <button onclick="exportarBackup()" class="w-full text-left px-4 py-2 text-xs hover:text-white transition-colors flex items-center gap-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    Exportar DB
                </button>
                <label class="w-full text-left px-4 py-2 text-xs hover:text-white cursor-pointer flex items-center gap-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4-4v12"/></svg>
                    Importar / Sincronizar
                    <input type="file" id="importFile" class="hidden" onchange="importarBackup(event)">
                </label>
                <button onclick="exportarExcel()" class="w-full text-left px-4 py-2 text-xs hover:text-white transition-colors flex items-center gap-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    Exportar a CSV
                </button>
            </div>
        </nav>
        <div class="p-6 border-t border-slate-800/50 space-y-2">
            <button onclick="mostrarDiagnosticoSchema()" class="w-full text-left px-4 py-2 text-xs hover:text-white transition-colors flex items-center gap-3 text-amber-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2v-4M9 21H5a2 2 0 01-2-2v-4m0 0h18"/></svg>
                    Ver Schema DB
                </button>
            <button onclick="toggleDarkMode()" class="w-full text-left px-4 py-2 text-xs hover:text-white transition-colors flex items-center gap-3">
                <svg id="dark-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                </svg>
                Modo Oscuro
            </button>
            <button onclick="activarNotificacionesCitas()" class="w-full text-left px-4 py-2 text-xs hover:text-white transition-colors flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                Notificaciones Citas
            </button>
            <button onclick="setupPin()" class="w-full text-left px-4 py-2 text-xs hover:text-white transition-colors flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                Configurar PIN
            </button>
            <button onclick="setupApiKey()" class="w-full text-left px-4 py-2 text-xs hover:text-white transition-colors flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                <span id="sidebar-apikey-label">API Key IA</span>
            </button>

        </div>
        <div class="p-6 pt-0">
            <button onclick="forceReload()" id="btn-reload-sidebar" title="Buscar actualizaciones" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-xs font-black text-slate-500 hover:text-white hover:bg-slate-700/50 transition-all group">
                <svg id="reload-icon-sidebar" class="w-4 h-4 transition-transform duration-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                <span id="reload-label-sidebar">Buscar actualizaciones</span>
                <span id="offline-dot" class="ml-auto w-2 h-2 rounded-full bg-rose-500 hidden"></span>
            </button>
        </div>
        <div class="p-6 pt-0 text-[10px] text-slate-600 font-bold">
            v136.0.0 • 2026 STABLE
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-8 lg:p-12 relative custom-scrollbar main-content">
        
        <section id="dashboard" class="max-w-7xl mx-auto space-y-12">
            <!-- Banner diagnóstico Supabase (oculto por defecto) -->
            <div id="supabase-banner" class="hidden"></div>
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <span class="text-indigo-600 font-bold text-xs uppercase tracking-widest">Resumen Operativo</span>
                    <h2 class="text-4xl md:text-6xl font-extrabold tracking-tighter text-slate-900 mt-2">Hola, <span id="greeting-name" class="text-indigo-600 cursor-pointer" title="Haz clic para cambiar tu nombre" onclick="cambiarNombre()">Jelian</span></h2>
                </div>
                <div class="bg-white px-6 py-3 rounded-2xl shadow-sm border border-slate-100">
                    <p id="current-date" class="text-xs font-black text-slate-400 uppercase tracking-tighter"></p>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="glass-card p-8 rounded-[2rem] metric-card">
                    <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center mb-6">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    </div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Atletas Activos</p>
                    <h3 id="dash-total" class="text-5xl font-black text-slate-900 mt-2">0</h3>
                </div>

                <div class="glass-card p-8 rounded-[2rem] metric-card">
                    <div class="w-10 h-10 bg-rose-50 text-rose-600 rounded-xl flex items-center justify-center mb-6">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                    </div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">EVA Promedio</p>
                    <h3 id="dash-eva" class="text-5xl font-black text-slate-900 mt-2">0.0</h3>
                </div>
                <div class="glass-card p-8 rounded-[2rem] metric-card">
                    <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center mb-6">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                    </div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sesiones Mes</p>
                    <h3 id="dash-sesiones" class="text-5xl font-black text-slate-900 mt-2">0</h3>
                </div>
                <div class="glass-card p-8 rounded-[2rem] metric-card">
                    <div class="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center mb-6">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    </div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Alertas Rojas</p>
                    <h3 id="dash-alertas" class="text-5xl font-black text-amber-500 mt-2">0</h3>
                </div>
            </div>

            <div class="glass-card p-4 md:p-10 rounded-[2rem] md:rounded-[3rem] border border-slate-100">
                <div class="flex justify-between items-center mb-10">
                    <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest">Distribución de Lesiones por Región</h4>
                </div>
                <div class="h-64 md:h-80">
                    <canvas id="chartRegiones"></canvas>
                </div>
            </div>

            <!-- Comparativa + Notas -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass-card p-8 rounded-[2rem] border border-slate-100">
                    <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-6">Top EVA Esta Semana</h4>
                    <div id="comparativa-list" class="space-y-4"></div>
                </div>
                <!-- CITAS DE HOY -->
                <div class="glass-card p-8 rounded-[2rem] border border-slate-100">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest">📅 Citas de Hoy</h4>
                        <span id="dash-citas-badge" class="citas-hoy-badge hidden">0</span>
                    </div>
                    <div id="dash-citas-hoy" class="space-y-3">
                        <p class="text-xs text-slate-400 italic">Sin citas para hoy.</p>
                    </div>
                    <button onclick="showSection('calendario')" class="mt-4 w-full text-center text-[10px] font-black text-indigo-500 hover:text-indigo-700 uppercase tracking-widest">Ver agenda completa →</button>
                </div>
                <div class="glass-card p-8 rounded-[2rem] border border-slate-100">
                    <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-4">📌 Notas Rápidas</h4>
                    <textarea id="sticky-notes" oninput="saveNotes()" class="w-full h-40 bg-amber-50 border border-amber-200 rounded-2xl p-4 text-sm font-medium text-slate-700 outline-none resize-none focus:ring-2 focus:ring-amber-300" placeholder="Escribe recordatorios del día..."></textarea>
                </div>
            </div>
        </section>

        <section id="biblioteca" class="hidden max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
                <div>
                    <h2 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">Protocolos Clínicos</h2>
                    <p class="text-slate-500 font-medium mt-1">Selecciona una patología para iniciar un nuevo ingreso</p>
                </div>
                <div class="relative w-full md:w-96">
                    <input type="text" id="busqueda-biblioteca" oninput="_debouncedBiblioteca()" placeholder="Buscar lesión o zona..." class="w-full bg-white border border-slate-200 rounded-2xl p-4 pl-12 text-sm focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-500 outline-none">
                    <svg class="w-5 h-5 absolute left-4 top-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>
            <div id="contenedor-biblioteca" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
        </section>

        <section id="lista-pacientes" class="hidden max-w-7xl mx-auto">
    <div class="flex flex-col gap-6 mb-10">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900">Expedientes</h2>
            <button onclick="showSection('biblioteca')" class="w-full sm:w-auto bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold text-sm hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-200">
                + Nuevo Atleta
            </button>
        </div>
        
        <div class="bg-white p-4 rounded-[2rem] border border-slate-100 shadow-sm space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="relative col-span-1 md:col-span-1">
                    <input type="text" id="busqueda-atleta" oninput="_debouncedSearch()" placeholder="Buscar por nombre o ID..." class="w-full bg-slate-50 border-none rounded-xl p-3 pl-10 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    <svg class="w-4 h-4 absolute left-3 top-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase">Desde:</label>
                    <input type="date" id="filtro-fecha-inicio" onchange="renderPacientes()" class="flex-1 bg-slate-50 border-none rounded-xl p-3 text-xs focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase">Hasta:</label>
                    <input type="date" id="filtro-fecha-fin" onchange="renderPacientes()" class="flex-1 bg-slate-50 border-none rounded-xl p-3 text-xs focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            <!-- Filter chips -->
            <div class="flex flex-wrap gap-2 pt-2 border-t border-slate-50">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest self-center mr-1">Zona:</span>
                <button class="filter-chip" data-filter="zona" data-val="" onclick="toggleFilterChip(this)">Todas</button>
                <button class="filter-chip" data-filter="zona" data-val="Rodilla" onclick="toggleFilterChip(this)">Rodilla</button>
                <button class="filter-chip" data-filter="zona" data-val="Hombro" onclick="toggleFilterChip(this)">Hombro</button>
                <button class="filter-chip" data-filter="zona" data-val="Tobillo" onclick="toggleFilterChip(this)">Tobillo</button>
                <button class="filter-chip" data-filter="zona" data-val="Espalda" onclick="toggleFilterChip(this)">Espalda</button>
                <button class="filter-chip" data-filter="zona" data-val="Cadera" onclick="toggleFilterChip(this)">Cadera</button>
                <button class="filter-chip" data-filter="zona" data-val="Cuello/Cervical" onclick="toggleFilterChip(this)">Cuello</button>
                <button class="filter-chip" data-filter="zona" data-val="Codo" onclick="toggleFilterChip(this)">Codo</button>
                <button class="filter-chip" data-filter="zona" data-val="Muñeca/Mano" onclick="toggleFilterChip(this)">Muñeca</button>
                <button class="filter-chip" data-filter="zona" data-val="Ingle/Pubis" onclick="toggleFilterChip(this)">Ingle</button>
                <button class="filter-chip" data-filter="zona" data-val="Isquiotibiales" onclick="toggleFilterChip(this)">Isquios</button>
                <button class="filter-chip" data-filter="zona" data-val="Pierna/Tibial" onclick="toggleFilterChip(this)">Pierna</button>
                <button class="filter-chip" data-filter="zona" data-val="Pie" onclick="toggleFilterChip(this)">Pie</button>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest self-center ml-3 mr-1">Estado:</span>
                <button class="filter-chip" data-filter="status" data-val="" onclick="toggleFilterChip(this)">Todos</button>
                <button class="filter-chip" data-filter="status" data-val="activo" onclick="toggleFilterChip(this)">Activo</button>
                <button class="filter-chip" data-filter="status" data-val="reposo" onclick="toggleFilterChip(this)">Reposo</button>
                <button class="filter-chip" data-filter="status" data-val="aguda" onclick="toggleFilterChip(this)">Aguda</button>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest self-center ml-3 mr-1">EVA:</span>
                <button class="filter-chip" data-filter="eva" data-val="" onclick="toggleFilterChip(this)">Todos</button>
                <button class="filter-chip" data-filter="eva" data-val="alto" onclick="toggleFilterChip(this)">≥7 Crítico</button>
                <button class="filter-chip" data-filter="eva" data-val="medio" onclick="toggleFilterChip(this)">4-6 Medio</button>
                <button class="filter-chip" data-filter="eva" data-val="bajo" onclick="toggleFilterChip(this)">≤3 Bajo</button>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-[2rem] border border-slate-100 overflow-x-auto shadow-sm">
        <table class="w-full text-left min-w-[600px]">
                    <thead class="bg-slate-50/50 border-b border-slate-100">
                        <tr>
                            <th class="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">Atleta</th>
                            <th class="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">Deporte</th>
                            <th class="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">Último EVA</th>
                            <th class="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest hidden md:table-cell">Último Contacto</th>
                            <th class="px-8 py-6 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-pacientes" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </section>

        <section id="nuevo-paciente" class="hidden max-w-4xl mx-auto">
            <div class="bg-white p-6 md:p-12 rounded-[2rem] md:rounded-[3rem] shadow-2xl border border-slate-100">
                <div class="mb-12">
                    <span class="text-indigo-600 font-bold text-xs uppercase tracking-[0.3em]">Módulo de Admisión</span>
                    <h2 class="text-3xl font-extrabold text-slate-900 mt-2">Nueva Ficha Clínica</h2>
                </div>
                <form id="formRegistro" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Nombre Completo</label>
                        <input type="text" id="reg-nombre" class="w-full bg-slate-50 rounded-xl p-4 mt-2 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/10 border border-transparent focus:border-indigo-500 font-bold text-slate-700" required>
                    </div>

                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Cédula / ID</label>
                        <input type="text" id="reg-ci" class="w-full bg-slate-50 rounded-xl p-4 mt-2 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/10 border border-transparent focus:border-indigo-500 font-bold text-slate-700" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Deporte</label>
                        <input type="text" id="reg-deporte" class="w-full bg-slate-50 rounded-xl p-4 mt-2 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/10 border border-transparent focus:border-indigo-500 font-bold text-slate-700" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Fecha de Nacimiento</label>
                        <input type="date" id="reg-nacimiento" class="w-full bg-slate-50 rounded-xl p-4 mt-2 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/10 border border-transparent focus:border-indigo-500 font-bold text-slate-700" onchange="calcularEdadReg(this)" required>
                        <p class="text-[10px] text-indigo-500 font-bold mt-1 ml-1" id="reg-edad-calculada"></p>
                        <input type="hidden" id="reg-edad">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Sexo</label>
                        <select id="reg-sexo" class="w-full bg-slate-50 rounded-xl p-4 mt-2 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/10 border border-transparent focus:border-indigo-500 font-bold text-slate-700">
                            <option value="Masculino">Masculino</option>
                            <option value="Femenino">Femenino</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Contacto Emergencia</label>
                        <input type="text" id="reg-emergencia" class="w-full bg-slate-50 rounded-xl p-4 mt-2 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/10 border border-transparent focus:border-indigo-500 font-bold text-slate-700">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Zona Lesionada</label>
                        <select id="reg-zona" class="w-full bg-slate-50 rounded-xl p-4 mt-2 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/10 border border-transparent focus:border-indigo-500 font-bold text-slate-700">
                            <option value="">— Auto-detectar —</option>
                            <option value="Rodilla">Rodilla</option>
                            <option value="Hombro">Hombro</option>
                            <option value="Tobillo">Tobillo</option>
                            <option value="Espalda">Espalda</option>
                            <option value="Cadera">Cadera</option>
                            <option value="Cuello/Cervical">Cuello/Cervical</option>
                            <option value="Codo">Codo</option>
                            <option value="Muñeca/Mano">Muñeca/Mano</option>
                            <option value="Ingle/Pubis">Ingle/Pubis</option>
                            <option value="Isquiotibiales">Isquiotibiales</option>
                            <option value="Pierna/Tibial">Pierna/Tibial</option>
                            <option value="Pie">Pie</option>
                            <option value="Otra">Otra</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Teléfono del Atleta</label>
                        <input type="tel" id="reg-telefono" placeholder="Ej: 0999123456" class="w-full bg-slate-50 rounded-xl p-4 mt-2 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/10 border border-transparent focus:border-indigo-500 font-bold text-slate-700">
                    </div>
                    <div class="md:col-span-3 p-6 md:p-8 bg-indigo-50/50 rounded-3xl border border-indigo-100">
                        <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-6">Pruebas del Protocolo</p>
                        <div id="reg-eval-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Impresión Diagnóstica y Plan</label>
                        <textarea id="reg-diag" class="w-full bg-slate-50 rounded-2xl p-6 mt-2 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/10 border border-transparent focus:border-indigo-500 font-medium text-sm h-44 leading-relaxed"></textarea>
                    </div>
                    <button type="submit" class="md:col-span-3 bg-slate-900 text-white p-6 rounded-2xl font-black text-lg shadow-xl hover:bg-indigo-600 transition-all uppercase tracking-widest">
                        Guardar Expediente
                    </button>
                </form>
            </div>
        </section>

        <section id="detalle-paciente" class="hidden max-w-7xl mx-auto pb-20">
            <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4 no-print">
                <button onclick="showSection('lista-pacientes')" class="text-indigo-600 font-black flex items-center gap-2 group self-start">
                    <svg class="w-5 h-5 transition-transform group-hover:-translate-x-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    REGRESAR
                </button>
                <div class="flex gap-3 w-full md:w-auto flex-wrap">
                    <button onclick="openEditModal()" class="flex-1 bg-indigo-50 text-indigo-700 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-indigo-100 transition-colors">✏️ Editar</button>
                    <button onclick="openKiosk()" class="flex-1 bg-slate-800 text-white px-4 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-slate-700 transition-colors">📺 Modo Vista</button>
                    <button onclick="exportarPDF()" class="flex-1 bg-indigo-600 text-white px-4 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-indigo-700 transition-colors">📄 PDF</button>
                    <button onclick="exportarCSVPaciente()" class="flex-1 bg-emerald-600 text-white px-4 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-emerald-700 transition-colors">📊 CSV</button>
                    <button onclick="window.print()" class="flex-1 bg-white border border-slate-200 text-slate-700 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-slate-50 transition-colors">Imprimir</button>
                    <button onclick="mostrarNotaAlta()" class="flex-1 bg-rose-50 text-rose-600 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-rose-600 hover:text-white transition-colors">Dar de Alta</button>
                </div>
            </div>

            <!-- RESUMEN RÁPIDO DEL PACIENTE -->
            <div id="resumen-rapido" class="bg-slate-900 rounded-2xl px-6 py-4 mb-6 flex flex-wrap gap-4 items-center no-print">
                <div class="flex items-center gap-2">
                    <span class="text-slate-500 text-[9px] font-black uppercase tracking-widest">Última sesión</span>
                    <span id="rr-ultima" class="text-white text-xs font-black">—</span>
                </div>
                <div class="w-px h-4 bg-slate-700 hidden sm:block"></div>
                <div class="flex items-center gap-2">
                    <span class="text-slate-500 text-[9px] font-black uppercase tracking-widest">EVA actual</span>
                    <span id="rr-eva" class="text-xs font-black">—</span>
                </div>
                <div class="w-px h-4 bg-slate-700 hidden sm:block"></div>
                <div class="flex items-center gap-2">
                    <span class="text-slate-500 text-[9px] font-black uppercase tracking-widest">Sesiones</span>
                    <span id="rr-sesiones" class="text-white text-xs font-black">—</span>
                </div>
                <div class="w-px h-4 bg-slate-700 hidden sm:block"></div>
                <div class="flex items-center gap-2">
                    <span class="text-slate-500 text-[9px] font-black uppercase tracking-widest">Próxima cita</span>
                    <span id="rr-cita" class="text-white text-xs font-black">—</span>
                </div>
                <div class="w-px h-4 bg-slate-700 hidden sm:block"></div>
                <div class="flex items-center gap-2">
                    <span class="text-slate-500 text-[9px] font-black uppercase tracking-widest">Tendencia EVA</span>
                    <span id="rr-tendencia" class="text-xs font-black">—</span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] shadow-sm border border-slate-100">
                        <div class="flex flex-col items-center text-center">
                            <!-- Avatar con foto -->
                            <div class="avatar-upload mb-6" onclick="triggerPhotoUpload()">
                                <div id="p-inicial" class="w-24 h-24 bg-indigo-600 rounded-3xl flex items-center justify-center text-white text-4xl font-black shadow-2xl shadow-indigo-100 italic overflow-hidden"></div>
                                <div class="avatar-overlay">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                </div>
                            </div>
                            <input type="file" id="photo-file-input" class="hidden" accept="image/*" onchange="handlePhotoUpload(event)">
                            <h3 id="p-nombre" class="text-2xl font-extrabold text-slate-900 leading-tight"></h3>
                            <span id="p-deporte-tag" class="text-indigo-500 font-black text-[10px] uppercase tracking-widest mt-2 px-4 py-1 bg-indigo-50 rounded-full"></span>
                            <!-- Status badge clickeable -->
                            <div id="p-status-badge" class="mt-3 cursor-pointer" title="Clic para cambiar estado"></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mt-8">
                            <div class="bg-slate-50 p-4 rounded-2xl">
                                <span class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Edad</span>
                                <span id="p-edad" class="text-sm font-bold text-slate-700"></span>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl">
                                <span class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Sexo</span>
                                <span id="p-sexo" class="text-sm font-bold text-slate-700"></span>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl">
                                <span class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Sesiones Totales</span>
                                <span id="p-total-sesiones" class="text-sm font-bold text-slate-700"></span>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl">
                                <span class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Este Mes</span>
                                <span id="p-sesiones-mes" class="text-sm font-bold text-indigo-600"></span>
                            </div>
                            <div id="p-telefono-card" class="bg-slate-50 p-4 rounded-2xl col-span-2 hidden">
                                <span class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">📱 Teléfono</span>
                                <div class="flex items-center justify-between gap-2 mt-1">
                                    <span id="p-telefono" class="text-sm font-bold text-slate-700"></span>
                                    <button onclick="abrirWhatsApp()" title="Enviar recordatorio por WhatsApp" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-xl text-[10px] font-black transition-all flex items-center gap-1.5 active:scale-95">
                                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                        WhatsApp
                                    </button>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl col-span-2">
                                <span class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Último Contacto</span>
                                <span id="p-ultimo-contacto" class="text-sm font-bold text-slate-700"></span>
                            </div>
                        </div>

                        <!-- Predicción de alta -->
                        <div id="p-prediccion" class="mt-6 hidden"></div>

                        <!-- Bienestar del Paciente (datos desde app móvil) -->
                        <div id="p-bienestar-card" class="mt-6 hidden">
                            <div class="bg-violet-50 border border-violet-100 p-5 rounded-2xl">
                                <h4 class="text-[9px] font-black text-violet-400 uppercase tracking-widest mb-3">📱 Bienestar · Último registro</h4>
                                <div id="p-bienestar-content" class="space-y-2"></div>
                            </div>
                        </div>

                        <div class="mt-10 pt-10 border-t border-slate-50">
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Hallazgos Iniciales</h4>
                            <div id="p-eval-list" class="space-y-3"></div>
                        </div>

                        <div class="mt-10 pt-10 border-t border-slate-50">
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Plan Clínico</h4>
                            <div id="p-diag" class="text-xs font-medium text-slate-600 bg-slate-50 p-6 rounded-2xl whitespace-pre-line leading-relaxed italic"></div>
                        </div>
                    </div>

                    <div class="bg-slate-900 p-8 rounded-[2rem] md:rounded-[3rem] shadow-2xl no-print">
                        <p class="text-white text-[10px] font-black uppercase tracking-widest mb-6 opacity-40">Evolución EVA</p>
                        <div class="h-64">
                            <canvas id="chartEvolucion"></canvas>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div class="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] shadow-sm border border-slate-100 mb-8 no-print">
                        <h4 class="text-xl font-extrabold text-slate-900 mb-4">Registrar Sesión</h4>
                        <!-- Cronómetro -->
                        <div class="flex items-center gap-4 mb-6 p-4 bg-slate-50 rounded-2xl">
                            <div>
                                <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Duración Sesión</p>
                                <p id="chrono-display" class="text-2xl font-black text-slate-800 mt-1">00:00:00</p>
                            </div>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="chronoToggle()" id="chrono-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-black hover:bg-indigo-700 transition-all">▶ Iniciar</button>
                                <button onclick="chronoReset()" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-black hover:bg-slate-300 transition-all">↺</button>
                            </div>
                        </div>
                        <!-- ASISTENCIA -->
                        <div class="flex gap-3 mb-6">
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest self-center">Asistencia:</span>
                            <label id="asis-btn-vino" class="asis-btn flex-1 cursor-pointer">
                                <input type="radio" name="s-asistencia" value="vino" class="hidden" checked>
                                <span class="block text-center py-2.5 rounded-xl text-xs font-black border-2 border-transparent bg-emerald-50 text-emerald-600 transition-all">✅ Vino</span>
                            </label>
                            <label id="asis-btn-falto" class="asis-btn flex-1 cursor-pointer">
                                <input type="radio" name="s-asistencia" value="falto" class="hidden">
                                <span class="block text-center py-2.5 rounded-xl text-xs font-black border-2 border-transparent bg-slate-50 text-slate-500 transition-all">❌ Faltó</span>
                            </label>
                            <label id="asis-btn-cancelo" class="asis-btn flex-1 cursor-pointer">
                                <input type="radio" name="s-asistencia" value="cancelo" class="hidden">
                                <span class="block text-center py-2.5 rounded-xl text-xs font-black border-2 border-transparent bg-slate-50 text-slate-500 transition-all">🔄 Canceló</span>
                            </label>
                        </div>

                        <!-- BODY MAP -->
                        <div class="mb-6">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Mapa de Dolor — Toca la zona afectada</p>
                            <div class="flex gap-4 justify-center items-start">
                                <div class="relative select-none" style="width:110px">
                                    <p class="text-[9px] text-center font-black text-slate-300 uppercase mb-1">Frontal</p>
                                    <svg id="bodymap-front" viewBox="0 0 110 280" width="110" height="280" style="cursor:crosshair">
                                        <!-- Cabeza -->
                                        <ellipse cx="55" cy="28" rx="22" ry="26" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Cuello -->
                                        <rect x="46" y="52" width="18" height="14" rx="4" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Tronco -->
                                        <rect x="28" y="64" width="54" height="80" rx="10" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Brazo izq -->
                                        <rect x="8" y="66" width="18" height="64" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Brazo der -->
                                        <rect x="84" y="66" width="18" height="64" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Antebrazo izq -->
                                        <rect x="6" y="132" width="16" height="52" rx="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Antebrazo der -->
                                        <rect x="88" y="132" width="16" height="52" rx="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Mano izq -->
                                        <ellipse cx="14" cy="194" rx="9" ry="12" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Mano der -->
                                        <ellipse cx="96" cy="194" rx="9" ry="12" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Pelvis -->
                                        <rect x="26" y="142" width="58" height="26" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Muslo izq -->
                                        <rect x="28" y="166" width="24" height="60" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Muslo der -->
                                        <rect x="58" y="166" width="24" height="60" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Pierna izq -->
                                        <rect x="30" y="228" width="20" height="42" rx="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Pierna der -->
                                        <rect x="60" y="228" width="20" height="42" rx="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Pie izq -->
                                        <ellipse cx="36" cy="274" rx="13" ry="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <!-- Pie der -->
                                        <ellipse cx="74" cy="274" rx="13" ry="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                    </svg>
                                </div>
                                <div class="relative select-none" style="width:110px">
                                    <p class="text-[9px] text-center font-black text-slate-300 uppercase mb-1">Posterior</p>
                                    <svg id="bodymap-back" viewBox="0 0 110 280" width="110" height="280" style="cursor:crosshair">
                                        <ellipse cx="55" cy="28" rx="22" ry="26" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="46" y="52" width="18" height="14" rx="4" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="28" y="64" width="54" height="80" rx="10" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="8" y="66" width="18" height="64" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="84" y="66" width="18" height="64" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="6" y="132" width="16" height="52" rx="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="88" y="132" width="16" height="52" rx="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <ellipse cx="14" cy="194" rx="9" ry="12" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <ellipse cx="96" cy="194" rx="9" ry="12" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="26" y="142" width="58" height="26" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="28" y="166" width="24" height="60" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="58" y="166" width="24" height="60" rx="8" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="30" y="228" width="20" height="42" rx="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <rect x="60" y="228" width="20" height="42" rx="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <ellipse cx="36" cy="274" rx="13" ry="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                        <ellipse cx="74" cy="274" rx="13" ry="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1.5"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div id="bodymap-puntos-lista" class="text-[10px] text-slate-500 space-y-1 max-h-40 overflow-y-auto">
                                        <p class="text-slate-300 italic">Toca la figura para marcar zonas de dolor</p>
                                    </div>
                                    <button onclick="limpiarBodyMap()" class="mt-3 text-[9px] font-black text-slate-400 hover:text-rose-500 uppercase tracking-wide transition-colors">✕ Limpiar mapa</button>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div>
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Fecha</label>
                                <input type="date" id="s-fecha" class="w-full bg-slate-50 p-4 rounded-xl text-xs font-bold mt-1 border-transparent focus:border-indigo-500 focus:bg-white outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">EVA (0-10)</label>
                                <input type="number" id="s-eva" min="0" max="10" class="w-full bg-slate-50 p-4 rounded-xl text-xs font-bold mt-1 border-transparent focus:border-indigo-500 focus:bg-white outline-none transition-all" oninput="updateEvaColor(this)">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Métrica Progreso</label>
                                <input type="text" id="s-fuerza" placeholder="Ej: +15° ROM" class="w-full bg-slate-50 p-4 rounded-xl text-xs font-bold mt-1 border-transparent focus:border-indigo-500 focus:bg-white outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Funcionalidad PSFS (0-100%)</label>
                                <input type="number" id="s-psfs" min="0" max="100" placeholder="Ej: 70" class="w-full bg-slate-50 p-4 rounded-xl text-xs font-bold mt-1 border-transparent focus:border-indigo-500 focus:bg-white outline-none">
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Técnicas Utilizadas</label>
                                <div class="flex flex-wrap gap-2 mt-2" id="tecnicas-chips">
                                    <label class="tecnica-chip"><input type="checkbox" value="Electroterapia" class="hidden"><span>⚡ Electroterapia</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Masaje terapéutico" class="hidden"><span>🤲 Masaje</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Crioterapia" class="hidden"><span>🧊 Crioterapia</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Termoterapia" class="hidden"><span>🔥 Termoterapia</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Vendaje funcional" class="hidden"><span>🩹 Vendaje</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Ultrasonido" class="hidden"><span>🔊 Ultrasonido</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Punción seca" class="hidden"><span>💉 Punción seca</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Terapia manual" class="hidden"><span>🖐 T. Manual</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Ejercicio terapéutico" class="hidden"><span>🏋 Ejercicio</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Propiocepción" class="hidden"><span>⚖️ Propiocepción</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Ondas de choque" class="hidden"><span>💥 Ondas de choque</span></label>
                                    <label class="tecnica-chip"><input type="checkbox" value="Kinesiotaping" class="hidden"><span>🎽 Kinesiotape</span></label>
                                </div>
                            </div>
                        </div>
                        <!-- RPE Slider -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Esfuerzo Percibido (RPE)</label>
                                <span id="rpe-label" class="text-xs font-black text-indigo-600">5 — Moderado</span>
                            </div>
                            <input type="range" id="s-rpe" min="1" max="10" value="5" class="rpe-slider" oninput="updateRPELabel(this.value)">
                            <div class="flex justify-between text-[9px] text-slate-400 mt-1"><span>Muy Fácil</span><span>Máximo</span></div>
                        </div>
                        <textarea id="s-notas" class="w-full bg-slate-50 p-6 rounded-2xl text-sm font-medium h-32 border-transparent focus:border-indigo-500 focus:bg-white outline-none mb-6" placeholder="Detalles del tratamiento..." oninput="marcarSesionPendiente()"></textarea>
                        
                        <div class="flex flex-col md:flex-row gap-4 mb-8">
                            <button onclick="ejecutarMotorIA()" class="flex-1 bg-slate-900 text-white py-5 rounded-2xl font-black text-sm uppercase tracking-widest hover:bg-indigo-600 transition-all shadow-lg">
                                Generar Plan IA
                            </button>
                            <button onclick="agregarSesion()" class="flex-1 bg-indigo-600 text-white py-5 rounded-2xl font-black text-sm uppercase tracking-widest hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all">
                                Guardar Sesión
                            </button>
                        </div>

                        <div id="display-plan-ia" class="hidden border-t border-slate-100 pt-8"></div>
                    </div>

                    <div id="sesiones-container" class="space-y-6"></div>

                    <!-- OBJETIVOS DE RECUPERACIÓN -->
                    <div class="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] shadow-sm border border-slate-100 mt-8">
                        <h4 class="text-xl font-extrabold text-slate-900 mb-6">🎯 Objetivos de Recuperación</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input id="obj-texto" type="text" placeholder="Descripción del objetivo" class="bg-slate-50 p-3 rounded-xl text-xs font-bold outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                            <input id="obj-eva" type="number" min="0" max="10" placeholder="Meta EVA (ej: 2)" class="bg-slate-50 p-3 rounded-xl text-xs font-bold outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                            <input id="obj-semanas" type="number" min="1" placeholder="Semanas estimadas" class="bg-slate-50 p-3 rounded-xl text-xs font-bold outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                        </div>
                        <button onclick="addObjetivo()" class="mb-6 bg-indigo-600 text-white px-6 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-indigo-700 transition-all">+ Agregar Objetivo</button>
                        <div id="objetivos-list" class="space-y-3"></div>
                    </div>

                    <!-- VUELTA AL DEPORTE (RTS) -->
                    <div class="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] shadow-sm border border-slate-100 mt-8">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-xl font-extrabold text-slate-900">🏃 Vuelta al Deporte (RTS)</h4>
                            <div id="rts-semaforo" class="text-xs font-black px-4 py-2 rounded-xl bg-slate-100 text-slate-500">— Sin evaluar</div>
                        </div>
                        <div id="rts-criterios" class="space-y-3 mb-6"></div>
                        <button onclick="agregarCriterioRTS()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">+ Agregar Criterio</button>
                    </div>

                    <!-- GALERÍA FOTOGRÁFICA CLÍNICA MEJORADA -->
                    <div class="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] shadow-sm border border-slate-100 mt-8">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                            <div>
                                <h4 class="text-xl font-extrabold text-slate-900">📸 Seguimiento Fotográfico</h4>
                                <p class="text-xs text-slate-400 mt-1">Comparativa visual antes/después por fase de recuperación</p>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="abrirComparativaFotos()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">⚖️ Comparar</button>
                                <button onclick="document.getElementById('foto-clinica-input-new').click()" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl text-xs font-black hover:bg-indigo-100 transition-all">+ Agregar Foto</button>
                                <input type="file" id="foto-clinica-input-new" class="hidden" accept="image/*" onchange="abrirModalFoto(event)">
                                <!-- Mantener compatibilidad con input anterior -->
                                <input type="file" id="foto-clinica-input" class="hidden" accept="image/*" onchange="abrirModalFoto(event)">
                            </div>
                        </div>

                        <!-- Filtro por fase -->
                        <div class="flex gap-2 flex-wrap mb-5" id="fotos-filtros">
                            <button onclick="filtrarFotos('all')" class="foto-filtro-btn active text-xs font-black px-3 py-1.5 rounded-full bg-indigo-600 text-white transition-all">Todas</button>
                            <button onclick="filtrarFotos('inicial')" class="foto-filtro-btn text-xs font-black px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 transition-all">Inicial</button>
                            <button onclick="filtrarFotos('progreso')" class="foto-filtro-btn text-xs font-black px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 transition-all">Progreso</button>
                            <button onclick="filtrarFotos('alta')" class="foto-filtro-btn text-xs font-black px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 transition-all">Alta</button>
                        </div>

                        <div id="fotos-clinicas-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                        <p id="fotos-empty" class="text-xs text-slate-400 italic">Sin fotografías clínicas. Agrega fotos para seguimiento visual de la evolución.</p>
                    </div>

                    <!-- MODAL AGREGAR FOTO -->
                    <div id="modal-agregar-foto" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[9990] hidden items-center justify-center p-4">
                        <div class="bg-white rounded-[2rem] p-8 max-w-md w-full shadow-2xl">
                            <h4 class="text-lg font-extrabold text-slate-900 mb-6">📸 Nueva Foto Clínica</h4>
                            <div id="modal-foto-preview-wrap" class="mb-6 rounded-2xl overflow-hidden bg-slate-50 flex items-center justify-center" style="height:200px">
                                <img id="modal-foto-preview" src="" class="max-h-full max-w-full object-contain rounded-2xl hidden">
                                <span class="text-slate-400 text-sm" id="modal-foto-noimg">Sin imagen</span>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Fase</label>
                                    <select id="modal-foto-fase" class="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold mt-1 outline-none border border-transparent focus:border-indigo-500">
                                        <option value="inicial">📌 Inicial (primera consulta)</option>
                                        <option value="progreso">📈 Progreso (seguimiento)</option>
                                        <option value="alta">✅ Alta / Final</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Zona / Descripción</label>
                                    <input id="modal-foto-zona" type="text" placeholder="Ej: Rodilla derecha — vista anterior" class="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold mt-1 outline-none border border-transparent focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Notas clínicas</label>
                                    <textarea id="modal-foto-notas" rows="2" placeholder="Observaciones, cambios observados..." class="w-full bg-slate-50 p-3 rounded-xl text-xs font-medium mt-1 outline-none border border-transparent focus:border-indigo-500 resize-none"></textarea>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="cerrarModalFoto()" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">Cancelar</button>
                                <button onclick="guardarFotoModal()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-xs font-black hover:bg-indigo-700 transition-all">💾 Guardar Foto</button>
                            </div>
                        </div>
                    </div>

                    <!-- MODAL COMPARATIVA -->
                    <div id="modal-comparativa" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[9991] hidden items-center justify-center p-4">
                        <div class="bg-white rounded-[2rem] p-8 max-w-3xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="text-lg font-extrabold text-slate-900">⚖️ Comparativa Antes / Después</h4>
                                <button onclick="cerrarComparativa()" class="text-slate-400 hover:text-slate-700 font-black text-lg">✕</button>
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">📌 Antes (Inicial)</p>
                                    <select id="comp-sel-antes" class="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold mb-3 outline-none border border-transparent focus:border-indigo-500" onchange="actualizarComparativa()"></select>
                                    <div class="bg-slate-50 rounded-2xl overflow-hidden flex items-center justify-center" style="height:220px">
                                        <img id="comp-img-antes" src="" class="max-h-full max-w-full object-contain rounded-2xl hidden">
                                        <span id="comp-empty-antes" class="text-slate-300 text-sm">Sin foto</span>
                                    </div>
                                    <p id="comp-nota-antes" class="text-xs text-slate-500 mt-2 italic"></p>
                                </div>
                                <div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">✅ Después (Progreso/Alta)</p>
                                    <select id="comp-sel-despues" class="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold mb-3 outline-none border border-transparent focus:border-indigo-500" onchange="actualizarComparativa()"></select>
                                    <div class="bg-slate-50 rounded-2xl overflow-hidden flex items-center justify-center" style="height:220px">
                                        <img id="comp-img-despues" src="" class="max-h-full max-w-full object-contain rounded-2xl hidden">
                                        <span id="comp-empty-despues" class="text-slate-300 text-sm">Sin foto</span>
                                    </div>
                                    <p id="comp-nota-despues" class="text-xs text-slate-500 mt-2 italic"></p>
                                </div>
                            </div>
                            <div id="comp-evolucion" class="mt-6 p-4 bg-indigo-50 rounded-2xl hidden">
                                <p class="text-xs font-black text-indigo-700 uppercase tracking-widest mb-1">📊 Evolución registrada</p>
                                <p id="comp-dias" class="text-sm font-bold text-indigo-900"></p>
                            </div>
                        </div>
                    </div>

                    <!-- HOJA DE EJERCICIOS PARA IMPRIMIR -->
                    <div class="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] shadow-sm border border-slate-100 mt-8 no-print">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-xl font-extrabold text-slate-900">📋 Hoja de Ejercicios</h4>
                            <button onclick="imprimirHojaEjercicios()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-black hover:bg-indigo-700 transition-all">🖨 Imprimir Hoja</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" id="ejercicios-personalizados-container">
                            <p class="text-xs text-slate-400 italic col-span-2">Usa el Motor IA para generar ejercicios o agrégalos manualmente:</p>
                        </div>
                        <button onclick="agregarEjercicioManual()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">+ Ejercicio Manual</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== SECCIÓN AGENDA / CALENDARIO ===== -->
        <section id="calendario" class="hidden max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                <div>
                    <span class="text-indigo-600 font-bold text-xs uppercase tracking-widest">Gestión de Tiempo</span>
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mt-1">Agenda</h2>
                </div>
                <div class="flex gap-3 flex-wrap">
                    <!-- Search -->
                    <div class="relative">
                        <input type="text" id="cal-busqueda" oninput="filtrarCitasBusqueda(this.value)" placeholder="Buscar atleta en agenda..." class="bg-white border border-slate-200 rounded-2xl p-3 pl-10 text-sm font-bold outline-none focus:border-indigo-500 w-56">
                        <svg class="w-4 h-4 absolute left-3 top-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <!-- View toggle -->
                    <div class="flex bg-slate-100 p-1 rounded-2xl gap-1">
                        <button id="cal-btn-mes" onclick="setCalView('mes')" class="px-4 py-2 rounded-xl text-xs font-black transition-all bg-white shadow-sm text-indigo-600">Mes</button>
                        <button id="cal-btn-semana" onclick="setCalView('semana')" class="px-4 py-2 rounded-xl text-xs font-black transition-all text-slate-500">Semana</button>
                    </div>
                    <button onclick="abrirFormCita()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold text-sm hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">+ Nueva Cita</button>
                </div>
            </div>

            <!-- Search results panel -->
            <div id="cal-search-results" class="hidden glass-card p-6 rounded-[2rem] border border-indigo-100 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest">Resultados de búsqueda</h4>
                    <button onclick="limpiarBusquedaCal()" class="text-xs text-slate-400 hover:text-slate-600 font-bold">✕ Cerrar</button>
                </div>
                <div id="cal-search-list" class="space-y-2"></div>
            </div>

            <!-- Nav Mes -->
            <div id="cal-vista-mes">
            <div class="glass-card p-6 rounded-[2rem] border border-slate-100 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="cambiarMes(-1)" class="p-2 hover:bg-slate-100 rounded-xl transition-colors">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <h3 id="cal-mes-titulo" class="text-lg font-extrabold text-slate-900"></h3>
                    <button onclick="cambiarMes(1)" class="p-2 hover:bg-slate-100 rounded-xl transition-colors">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>
                <div id="cal-dias-semana" class="grid grid-cols-7 mb-2"></div>
                <div id="cal-grid" class="grid grid-cols-7 gap-1"></div>
            </div>
            <!-- Citas del día -->
            <div class="glass-card p-6 rounded-[2rem] border border-slate-100">
                <h4 id="cal-dia-titulo" class="text-sm font-black text-slate-800 uppercase tracking-widest mb-4">Citas de hoy</h4>
                <div id="cal-citas-dia" class="space-y-3">
                    <p class="text-xs text-slate-400 italic">Selecciona un día para ver las citas.</p>
                </div>
            </div>
            </div>

            <!-- Vista Semanal -->
            <div id="cal-vista-semana" class="hidden">
                <div class="glass-card p-6 rounded-[2rem] border border-slate-100">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="cambiarSemana(-1)" class="p-2 hover:bg-slate-100 rounded-xl transition-colors">
                            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <h3 id="cal-semana-titulo" class="text-lg font-extrabold text-slate-900"></h3>
                        <button onclick="cambiarSemana(1)" class="p-2 hover:bg-slate-100 rounded-xl transition-colors">
                            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                    <div id="cal-semana-grid" class="overflow-x-auto">
                        <!-- rendered by JS -->
                    </div>
                </div>
            </div>

            <!-- Form nueva cita (oculto) -->
            <div id="form-cita-container" class="hidden glass-card p-8 rounded-[2rem] border border-indigo-100 mt-6">
                <h4 class="font-extrabold text-slate-900 mb-6">Nueva Cita</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Atleta</label>
                        <select id="cita-atleta" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white"></select>
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Fecha</label>
                        <input type="date" id="cita-fecha" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Hora</label>
                        <input type="time" id="cita-hora" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Tipo</label>
                        <select id="cita-tipo" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold mt-1 outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                            <option>Sesión de rehabilitación</option>
                            <option>Evaluación inicial</option>
                            <option>Control de seguimiento</option>
                            <option>Alta médica</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3 mt-4">
                    <button onclick="guardarCita()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-sm hover:bg-indigo-700 transition-all">Guardar Cita</button>
                    <button onclick="document.getElementById('form-cita-container').classList.add('hidden')" class="bg-slate-100 text-slate-700 px-6 py-3 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">Cancelar</button>
                </div>
            </div>
        </section>

        <!-- ===== SECCIÓN PLANTILLAS ===== -->
        <section id="plantillas" class="hidden max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                <div>
                    <span class="text-indigo-600 font-bold text-xs uppercase tracking-widest">Reutilización Clínica</span>
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mt-1">Plantillas de Sesión</h2>
                </div>
                <button onclick="abrirFormPlantilla()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold text-sm hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">+ Nueva Plantilla</button>
            </div>
            <div id="form-plantilla-container" class="hidden glass-card p-8 rounded-[2rem] border border-indigo-100 mb-8">
                <h4 class="font-extrabold text-slate-900 mb-4">Crear Plantilla</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input id="pl-nombre" type="text" placeholder="Nombre de la plantilla (ej: Protocolo LCA Fase 2)" class="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                    <input id="pl-zona" type="text" placeholder="Zona (ej: Rodilla, Hombro)" class="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none focus:border-indigo-500 border border-transparent focus:bg-white">
                </div>
                <textarea id="pl-ejercicios" placeholder="Lista de ejercicios (uno por línea)..." class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-medium h-28 outline-none focus:border-indigo-500 border border-transparent focus:bg-white resize-none mb-4"></textarea>
                <div class="flex gap-3">
                    <button onclick="guardarPlantilla()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-sm hover:bg-indigo-700 transition-all">Guardar</button>
                    <button onclick="document.getElementById('form-plantilla-container').classList.add('hidden')" class="bg-slate-100 text-slate-700 px-6 py-3 rounded-xl font-bold text-sm">Cancelar</button>
                </div>
            </div>
            <div id="plantillas-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- ===== SECCIÓN REPORTES ===== -->
        <section id="reportes" class="hidden max-w-7xl mx-auto">
            <div class="mb-10">
                <span class="text-indigo-600 font-bold text-xs uppercase tracking-widest">Análisis Avanzado</span>
                <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mt-1">Reportes</h2>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="glass-card p-8 rounded-[2rem] border border-slate-100">
                    <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-6">Tendencia EVA Global</h4>
                    <div class="h-56"><canvas id="chartEvaGlobal"></canvas></div>
                </div>
                <div class="glass-card p-8 rounded-[2rem] border border-slate-100">
                    <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-6">RPE vs EVA (Correlación)</h4>
                    <div class="h-56"><canvas id="chartRpeEva"></canvas></div>
                </div>
            </div>
            <div class="glass-card p-8 rounded-[2rem] border border-slate-100 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest">Reporte Mensual — Todos los Atletas</h4>
                    <button onclick="exportarReporteMensualPDF()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-black hover:bg-indigo-700 transition-all">📄 Exportar PDF</button>
                </div>
                <div id="reporte-mensual-tabla"></div>
            </div>
            <div class="glass-card p-8 rounded-[2rem] border border-slate-100">
                <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-6">Tendencia por Zona Lesionada</h4>
                <div class="h-64"><canvas id="chartTendenciaZona"></canvas></div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- SECCIÓN: IA IMAGEN MÉDICA                                     -->
        <!-- ============================================================ -->
        <section id="imagen-ia" class="hidden max-w-5xl mx-auto">
            <div class="mb-8">
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight">IA Imagen Médica</h2>
                <p class="text-slate-400 text-sm mt-1">Análisis asistido por inteligencia artificial de resonancias magnéticas, radiografías y ecografías. <strong class="text-amber-600">Solo orientativo — no reemplaza diagnóstico clínico.</strong></p>
            </div>

            <!-- DISCLAIMER BANNER -->
            <div class="bg-amber-50 border border-amber-200 rounded-2xl p-5 mb-8 flex gap-4 items-start">
                <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center flex-shrink-0 text-xl">⚠️</div>
                <div>
                    <p class="font-black text-amber-800 text-sm">Aviso Clínico Importante</p>
                    <p class="text-amber-700 text-xs mt-1 leading-relaxed">Este módulo utiliza IA (Claude Vision) para asistir en la interpretación de imágenes médicas. El análisis es <strong>orientativo y de apoyo</strong> al criterio clínico del profesional. No constituye diagnóstico médico definitivo. Siempre contrastar con la clínica del paciente y consultar con el especialista correspondiente.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- PANEL IZQUIERDO: UPLOAD + CONFIGURACIÓN -->
                <div class="space-y-6">
                    <!-- Tipo de imagen -->
                    <div class="glass-card p-6 rounded-[2rem] border border-slate-100">
                        <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-4">1. Tipo de Imagen</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <label class="img-tipo-chip cursor-pointer">
                                <input type="radio" name="img-tipo" value="resonancia" class="hidden" checked>
                                <span class="block text-center p-3 rounded-2xl border-2 border-slate-200 text-xs font-black text-slate-500 transition-all hover:border-indigo-400">
                                    🧲<br>Resonancia<br>Magnética
                                </span>
                            </label>
                            <label class="img-tipo-chip cursor-pointer">
                                <input type="radio" name="img-tipo" value="rayos-x" class="hidden">
                                <span class="block text-center p-3 rounded-2xl border-2 border-slate-200 text-xs font-black text-slate-500 transition-all hover:border-indigo-400">
                                    ☢️<br>Radiografía<br>(Rx)
                                </span>
                            </label>
                            <label class="img-tipo-chip cursor-pointer">
                                <input type="radio" name="img-tipo" value="ecografia" class="hidden">
                                <span class="block text-center p-3 rounded-2xl border-2 border-slate-200 text-xs font-black text-slate-500 transition-all hover:border-indigo-400">
                                    🔊<br>Ecografía<br>/ Eco
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Zona anatómica -->
                    <div class="glass-card p-6 rounded-[2rem] border border-slate-100">
                        <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-4">2. Zona Anatómica</h3>
                        <select id="img-zona" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none border border-slate-200 focus:border-indigo-500 focus:bg-white transition-all">
                            <option value="">Seleccionar zona...</option>
                            <option>Rodilla</option>
                            <option>Hombro</option>
                            <option>Tobillo / Pie</option>
                            <option>Columna Lumbar</option>
                            <option>Columna Cervical</option>
                            <option>Columna Dorsal</option>
                            <option>Cadera / Pelvis</option>
                            <option>Muñeca / Mano</option>
                            <option>Codo</option>
                            <option>Isquiotibiales / Muslo</option>
                            <option>Ingle / Pubis</option>
                            <option>Pierna / Tibia</option>
                            <option>Otra</option>
                        </select>
                    </div>

                    <!-- Contexto clínico -->
                    <div class="glass-card p-6 rounded-[2rem] border border-slate-100">
                        <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-2">3. Contexto Clínico <span class="text-slate-400 font-medium normal-case">(opcional pero recomendado)</span></h3>
                        <p class="text-xs text-slate-400 mb-3">Describe brevemente: deporte, mecanismo de lesión, síntomas, tiempo de evolución...</p>
                        <textarea id="img-contexto" rows="4" placeholder="Ej: Futbolista de 24 años, esguince de rodilla hace 3 semanas, dolor medial persistente, test de McMurray positivo..." class="w-full bg-slate-50 rounded-xl p-4 text-xs font-medium outline-none border border-slate-200 focus:border-indigo-500 focus:bg-white resize-none transition-all"></textarea>
                    </div>

                    <!-- Upload de imagen -->
                    <div class="glass-card p-6 rounded-[2rem] border border-slate-100">
                        <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-4">4. Cargar Imagen</h3>
                        <div id="img-dropzone" class="border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/30 transition-all" onclick="document.getElementById('img-file-input').click()">
                            <div class="text-4xl mb-3">🩻</div>
                            <p class="font-black text-slate-600 text-sm">Toca para seleccionar imagen</p>
                            <p class="text-xs text-slate-400 mt-1">JPG, PNG, WEBP — Máx 20MB</p>
                            <input type="file" id="img-file-input" class="hidden" accept="image/jpeg,image/png,image/webp,image/gif" onchange="onImgSelected(event)">
                        </div>
                        <!-- Preview -->
                        <div id="img-preview-container" class="hidden mt-4">
                            <div class="relative rounded-2xl overflow-hidden border border-indigo-200 bg-slate-900">
                                <img id="img-preview" class="w-full max-h-64 object-contain" alt="Preview">
                                <div class="absolute top-2 right-2 flex gap-2">
                                    <span id="img-preview-label" class="text-[9px] font-black bg-indigo-600 text-white px-2 py-1 rounded-full"></span>
                                    <button onclick="clearImgUpload()" class="w-7 h-7 bg-rose-500 text-white rounded-full text-xs font-black hover:bg-rose-600 transition-colors flex items-center justify-center">✕</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón analizar -->
                    <button id="btn-analizar-img" onclick="analizarImagenIA()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-extrabold text-sm hover:bg-indigo-700 active:scale-95 transition-all shadow-xl shadow-indigo-200 flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.347.347a3.75 3.75 0 01-2.651 1.098H10.68a3.75 3.75 0 01-2.651-1.098l-.347-.347z"/></svg>
                        Analizar con IA
                    </button>
                </div>

                <!-- PANEL DERECHO: RESULTADO -->
                <div class="space-y-6">
                    <!-- Estado inicial -->
                    <div id="img-estado-inicial" class="glass-card p-10 rounded-[2rem] border border-slate-100 flex flex-col items-center justify-center text-center min-h-96">
                        <div class="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center text-4xl mb-6">🧠</div>
                        <h3 class="font-extrabold text-slate-700 text-lg">Motor de Análisis IA</h3>
                        <p class="text-slate-400 text-sm mt-3 max-w-xs leading-relaxed">Carga una imagen médica y configura el contexto clínico para obtener un análisis detallado asistido por inteligencia artificial.</p>
                        <div class="mt-8 grid grid-cols-3 gap-4 text-center w-full max-w-xs">
                            <div class="bg-slate-50 rounded-2xl p-4">
                                <p class="text-2xl">🧲</p>
                                <p class="text-[9px] font-black text-slate-500 uppercase mt-2">RMN</p>
                            </div>
                            <div class="bg-slate-50 rounded-2xl p-4">
                                <p class="text-2xl">☢️</p>
                                <p class="text-[9px] font-black text-slate-500 uppercase mt-2">Rx</p>
                            </div>
                            <div class="bg-slate-50 rounded-2xl p-4">
                                <p class="text-2xl">🔊</p>
                                <p class="text-[9px] font-black text-slate-500 uppercase mt-2">ECO</p>
                            </div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="img-loading" class="hidden glass-card p-10 rounded-[2rem] border border-indigo-100 flex flex-col items-center justify-center text-center min-h-96">
                        <div class="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center mb-6 relative">
                            <svg class="animate-spin w-10 h-10 text-indigo-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                        </div>
                        <h3 class="font-extrabold text-indigo-700 text-lg">Analizando imagen...</h3>
                        <p class="text-indigo-400 text-sm mt-3">La IA está procesando la imagen médica.<br>Esto puede tomar 15-30 segundos.</p>
                        <div class="mt-6 w-full max-w-xs">
                            <div class="h-1.5 bg-indigo-100 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500 rounded-full loading-bar-anim"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Resultado del análisis -->
                    <div id="img-resultado" class="hidden space-y-4">
                        <!-- Header resultado -->
                        <div class="glass-card p-6 rounded-[2rem] border border-emerald-200 bg-emerald-50/40">
                            <div class="flex items-center gap-4 mb-2">
                                <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center text-xl flex-shrink-0">✅</div>
                                <div>
                                    <p class="text-[10px] font-black text-emerald-600 uppercase tracking-widest">Análisis Completado</p>
                                    <p id="img-res-titulo" class="font-extrabold text-slate-800 text-sm mt-0.5"></p>
                                </div>
                                <button onclick="copiarAnalisis()" class="ml-auto bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-black hover:bg-slate-50 transition-all flex-shrink-0">📋 Copiar</button>
                            </div>
                        </div>

                        <!-- Contenido del análisis -->
                        <div id="img-res-contenido" class="glass-card p-8 rounded-[2rem] border border-slate-100 space-y-6"></div>

                        <!-- Historial de análisis -->
                        <div class="glass-card p-6 rounded-[2rem] border border-slate-100">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-xs font-black text-slate-500 uppercase tracking-widest">Historial de Análisis</h4>
                                <button onclick="clearHistorialImg()" class="text-[10px] text-rose-400 font-black hover:text-rose-600">Limpiar</button>
                            </div>
                            <div id="img-historial" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                                <p class="text-xs text-slate-400 italic">Sin análisis previos.</p>
                            </div>
                        </div>

                        <!-- Nuevo análisis -->
                        <button onclick="nuevoAnalisis()" class="w-full border-2 border-indigo-200 text-indigo-600 py-4 rounded-2xl font-extrabold text-sm hover:bg-indigo-50 transition-all">
                            + Nuevo Análisis
                        </button>
                    </div>

                    <!-- Error -->
                    <div id="img-error" class="hidden glass-card p-8 rounded-[2rem] border border-rose-200 bg-rose-50/40 text-center">
                        <div class="text-4xl mb-4">❌</div>
                        <h3 class="font-extrabold text-rose-700 text-base">Error en el análisis</h3>
                        <p id="img-error-msg" class="text-rose-500 text-xs mt-2"></p>
                        <button onclick="nuevoAnalisis()" class="mt-6 bg-rose-500 text-white px-6 py-3 rounded-xl font-bold text-xs hover:bg-rose-600 transition-all">Intentar de nuevo</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== SECCIÓN ANATOMÍA ===== -->
        <section id="anatomia" class="hidden max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                <div>
                    <span class="text-emerald-600 font-bold text-xs uppercase tracking-widest">Referencia Clínica</span>
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mt-1">Biblioteca de Anatomía</h2>
                    <p class="text-slate-500 text-sm mt-1">Diagramas interactivos y referencias por región corporal</p>
                </div>
            </div>

            <!-- Tabs región -->
            <div class="flex gap-2 flex-wrap mb-8">
                <button onclick="setAnatomiaRegion('rodilla')" class="anat-tab-btn active px-5 py-2.5 rounded-2xl text-xs font-black transition-all bg-emerald-600 text-white">🦵 Rodilla</button>
                <button onclick="setAnatomiaRegion('hombro')" class="anat-tab-btn px-5 py-2.5 rounded-2xl text-xs font-black transition-all bg-slate-100 text-slate-600">💪 Hombro</button>
                <button onclick="setAnatomiaRegion('tobillo')" class="anat-tab-btn px-5 py-2.5 rounded-2xl text-xs font-black transition-all bg-slate-100 text-slate-600">🦶 Tobillo / Pie</button>
                <button onclick="setAnatomiaRegion('columna')" class="anat-tab-btn px-5 py-2.5 rounded-2xl text-xs font-black transition-all bg-slate-100 text-slate-600">🦴 Columna</button>
                <button onclick="setAnatomiaRegion('cadera')" class="anat-tab-btn px-5 py-2.5 rounded-2xl text-xs font-black transition-all bg-slate-100 text-slate-600">⚙️ Cadera / Pelvis</button>
                <button onclick="setAnatomiaRegion('codo')" class="anat-tab-btn px-5 py-2.5 rounded-2xl text-xs font-black transition-all bg-slate-100 text-slate-600">🤲 Codo / Muñeca</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Diagrama interactivo SVG -->
                <div class="lg:col-span-3 glass-card rounded-[2rem] p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="anat-region-title" class="text-lg font-extrabold text-slate-900">Rodilla</h3>
                        <span class="text-xs text-slate-400 font-bold">Haz clic en una estructura</span>
                    </div>
                    <div id="anat-svg-container" class="flex justify-center items-center" style="min-height:340px">
                        <!-- SVG se inyecta dinámicamente -->
                    </div>
                </div>

                <!-- Panel info estructura seleccionada -->
                <div class="lg:col-span-2 space-y-6">
                    <div id="anat-info-panel" class="glass-card rounded-[2rem] p-8">
                        <div id="anat-info-default" class="flex flex-col items-center justify-center h-48 text-center">
                            <div class="text-5xl mb-4">👆</div>
                            <p class="text-sm font-bold text-slate-500">Selecciona una estructura en el diagrama para ver información detallada</p>
                        </div>
                        <div id="anat-info-content" class="hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div id="anat-info-icon" class="w-12 h-12 rounded-2xl bg-emerald-100 flex items-center justify-center text-xl"></div>
                                <div>
                                    <h4 id="anat-info-nombre" class="text-base font-extrabold text-slate-900"></h4>
                                    <p id="anat-info-tipo" class="text-[10px] font-black text-emerald-600 uppercase tracking-widest"></p>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="bg-slate-50 p-4 rounded-2xl">
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Función principal</p>
                                    <p id="anat-info-funcion" class="text-xs font-medium text-slate-700 leading-relaxed"></p>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-2xl">
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Lesiones frecuentes</p>
                                    <p id="anat-info-lesiones" class="text-xs font-medium text-slate-700 leading-relaxed"></p>
                                </div>
                                <div class="bg-emerald-50 p-4 rounded-2xl">
                                    <p class="text-[9px] font-black text-emerald-600 uppercase tracking-widest mb-1">Tests clínicos</p>
                                    <p id="anat-info-tests" class="text-xs font-medium text-slate-700 leading-relaxed"></p>
                                </div>
                                <div class="bg-indigo-50 p-4 rounded-2xl">
                                    <p class="text-[9px] font-black text-indigo-600 uppercase tracking-widest mb-1">Referencia de dolor</p>
                                    <p id="anat-info-dolor" class="text-xs font-medium text-slate-700 leading-relaxed"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tarjetas de estructuras (lista estática) -->
                    <div class="glass-card rounded-[2rem] p-6">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Estructuras de la región</p>
                        <div id="anat-estructuras-list" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>
            </div>

            <!-- Referencia rápida: Tests clínicos por región -->
            <div class="mt-10 glass-card rounded-[2rem] p-8">
                <h3 class="text-lg font-extrabold text-slate-900 mb-6">🔬 Tests Clínicos de Referencia</h3>
                <div id="anat-tests-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </section>

        <!-- ===== SECCIÓN DOCUMENTOS ===== -->
        <section id="documentos" class="hidden max-w-5xl mx-auto pb-20">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                <div>
                    <span class="text-rose-500 font-bold text-xs uppercase tracking-widest">Documentos Clínicos</span>
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mt-1">Documentos</h2>
                    <p class="text-slate-500 text-sm mt-1">Consentimientos informados y fichas de valoracion para imprimir o guardar en PDF</p>
                </div>
            </div>
            <div class="flex gap-3 mb-8 flex-wrap">
                <button onclick="docTab('consentimiento')" id="doc-tab-consentimiento" class="px-6 py-2.5 rounded-2xl text-xs font-black bg-indigo-600 text-white transition-all">Consentimiento Informado</button>
                <button onclick="docTab('ficha')" id="doc-tab-ficha" class="px-6 py-2.5 rounded-2xl text-xs font-black bg-slate-100 text-slate-600 transition-all">Ficha de Valoracion Inicial</button>
            </div>

            <!-- CONSENTIMIENTO -->
            <div id="doc-panel-consentimiento">
                <div class="glass-card rounded-[2rem] p-6 mb-6 no-print">
                    <h3 class="font-extrabold text-slate-900 text-sm mb-4">Datos del documento</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Paciente</label>
                        <select id="cons-paciente-sel" onchange="llenarConsentimiento()" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm font-semibold"><option value="">Seleccionar paciente</option></select></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Tipo de tratamiento</label>
                        <select id="cons-tipo" onchange="llenarConsentimiento()" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm font-semibold">
                            <option>Fisioterapia deportiva general</option>
                            <option>Rehabilitacion post-quirurgica</option>
                            <option>Terapia manual y movilizacion</option>
                            <option>Electroterapia y agentes fisicos</option>
                            <option>Puncion seca</option>
                            <option>Vendaje funcional / kinesiotape</option>
                            <option>Retorno al deporte (RTS)</option>
                        </select></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Fisioterapeuta</label>
                        <input id="cons-fisio" type="text" placeholder="Dr./Lic. Nombre Apellido" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm" oninput="llenarConsentimiento()"></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Ciudad y fecha</label>
                        <input id="cons-ciudad" type="text" placeholder="Quito, 20 de febrero de 2026" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm" oninput="llenarConsentimiento()"></div>
                    </div>
                    <div class="flex gap-3 mt-5">
                        <button onclick="imprimirDoc('cons-preview')" class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl text-xs font-black hover:bg-indigo-700 transition-all">Imprimir / PDF</button>
                        <button onclick="llenarConsentimiento()" class="bg-slate-100 text-slate-700 px-6 py-2.5 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">Actualizar</button>
                    </div>
                </div>
                <div id="cons-preview" class="bg-white rounded-[2rem] shadow border border-slate-100 p-10 print-area" style="font-family:Georgia,serif;line-height:1.8;">
                    <div style="text-align:center;border-bottom:2px solid #6366f1;padding-bottom:16px;margin-bottom:24px;">
                        <div style="font-size:22px;font-weight:900;color:#6366f1;font-family:Arial,sans-serif;">JELIAN FT - Clinical Sport</div>
                        <div style="font-size:13px;color:#64748b;margin-top:4px;font-family:Arial,sans-serif;">Fisioterapia y Rehabilitacion Deportiva</div>
                    </div>
                    <h2 style="text-align:center;font-size:17px;font-weight:900;color:#0f172a;margin-bottom:24px;font-family:Arial,sans-serif;letter-spacing:1px;">CONSENTIMIENTO INFORMADO</h2>
                    <p id="cons-intro" style="margin-bottom:16px;font-size:14px;color:#1e293b;"></p>
                    <p style="font-size:13px;font-weight:900;color:#0f172a;margin:20px 0 6px;font-family:Arial,sans-serif;">1. DESCRIPCION DEL TRATAMIENTO</p>
                    <p id="cons-desc" style="font-size:13px;color:#334155;margin-bottom:12px;"></p>
                    <p style="font-size:13px;font-weight:900;color:#0f172a;margin:20px 0 6px;font-family:Arial,sans-serif;">2. BENEFICIOS ESPERADOS</p>
                    <p style="font-size:13px;color:#334155;margin-bottom:12px;">La intervencion tiene como objetivo la reduccion del dolor, recuperacion funcional, mejora del rendimiento deportivo y prevencion de recidivas, adaptando la progresion a la respuesta individual del paciente.</p>
                    <p style="font-size:13px;font-weight:900;color:#0f172a;margin:20px 0 6px;font-family:Arial,sans-serif;">3. POSIBLES RIESGOS</p>
                    <p style="font-size:13px;color:#334155;margin-bottom:12px;">Los riesgos son generalmente leves y transitorios: molestia local post-sesion, hematomas superficiales, fatiga muscular o reaccion vasovagal. El profesional adoptara todas las medidas de seguridad para minimizarlos.</p>
                    <p style="font-size:13px;font-weight:900;color:#0f172a;margin:20px 0 6px;font-family:Arial,sans-serif;">4. DERECHO A RETIRARSE Y CONFIDENCIALIDAD</p>
                    <p style="font-size:13px;color:#334155;margin-bottom:20px;">El paciente puede en cualquier momento retirar este consentimiento. Los datos clinicos seran tratados con estricta confidencialidad conforme a la normativa vigente.</p>
                    <p style="font-size:13px;color:#1e293b;margin-bottom:36px;">He leido y comprendido la informacion anterior. Doy mi consentimiento libre e informado para la realizacion del tratamiento descrito.</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:48px;margin-top:40px;">
                        <div style="text-align:center;"><div style="border-top:1.5px solid #94a3b8;padding-top:10px;">
                            <div id="cons-sig-paciente" style="font-size:12px;color:#475569;font-weight:700;font-family:Arial,sans-serif;"></div>
                            <div style="font-size:11px;color:#94a3b8;font-family:Arial,sans-serif;">Firma del Paciente / Representante</div>
                        </div></div>
                        <div style="text-align:center;"><div style="border-top:1.5px solid #94a3b8;padding-top:10px;">
                            <div id="cons-sig-fisio" style="font-size:12px;color:#475569;font-weight:700;font-family:Arial,sans-serif;"></div>
                            <div style="font-size:11px;color:#94a3b8;font-family:Arial,sans-serif;">Firma del Fisioterapeuta</div>
                        </div></div>
                    </div>
                    <div id="cons-fecha-lugar" style="text-align:right;font-size:12px;color:#94a3b8;margin-top:24px;font-family:Arial,sans-serif;"></div>
                </div>
            </div>

            <!-- FICHA VALORACION -->
            <div id="doc-panel-ficha" class="hidden">
                <div class="glass-card rounded-[2rem] p-6 mb-6 no-print">
                    <h3 class="font-extrabold text-slate-900 text-sm mb-4">Datos para la ficha</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Cargar desde paciente</label>
                        <select id="ficha-paciente-sel" onchange="llenarFicha()" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm font-semibold"><option value="">Seleccionar paciente</option></select></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Fisioterapeuta</label>
                        <input id="ficha-fisio" type="text" placeholder="Dr./Lic. Nombre Apellido" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm" oninput="llenarFicha()"></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Motivo de consulta</label>
                        <input id="ficha-motivo" type="text" placeholder="Dolor rodilla derecha post-ACL..." class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm" oninput="llenarFicha()"></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Fecha de valoracion</label>
                        <input id="ficha-fecha" type="date" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm" oninput="llenarFicha()"></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Antecedentes relevantes</label>
                        <textarea id="ficha-antecedentes" rows="2" placeholder="Cirugias, patologias previas, medicacion..." class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm resize-none" oninput="llenarFicha()"></textarea></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Exploracion fisica</label>
                        <textarea id="ficha-exploracion" rows="2" placeholder="ROM, fuerza, tests especiales..." class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm resize-none" oninput="llenarFicha()"></textarea></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">EVA inicial (0-10)</label>
                        <input id="ficha-eva" type="number" min="0" max="10" placeholder="7" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm" oninput="llenarFicha()"></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Objetivos terapeuticos</label>
                        <input id="ficha-objetivos-doc" type="text" placeholder="Retorno al deporte en 12 semanas" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm" oninput="llenarFicha()"></div>
                    </div>
                    <div class="flex gap-3 mt-5">
                        <button onclick="imprimirDoc('ficha-preview')" class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl text-xs font-black hover:bg-indigo-700 transition-all">Imprimir / PDF</button>
                        <button onclick="llenarFicha()" class="bg-slate-100 text-slate-700 px-6 py-2.5 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">Actualizar</button>
                    </div>
                </div>
                <div id="ficha-preview" class="bg-white rounded-[2rem] shadow border border-slate-100 p-10 print-area" style="font-family:Georgia,serif;line-height:1.7;">
                    <div style="text-align:center;border-bottom:2px solid #6366f1;padding-bottom:16px;margin-bottom:24px;">
                        <div style="font-size:22px;font-weight:900;color:#6366f1;font-family:Arial,sans-serif;">JELIAN FT - Clinical Sport</div>
                        <div style="font-size:13px;color:#64748b;margin-top:4px;font-family:Arial,sans-serif;">Fisioterapia y Rehabilitacion Deportiva</div>
                    </div>
                    <h2 style="text-align:center;font-size:17px;font-weight:900;color:#0f172a;margin-bottom:20px;font-family:Arial,sans-serif;letter-spacing:1px;">FICHA DE VALORACION INICIAL</h2>
                    <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:18px;font-family:Arial,sans-serif;">
                        <tr style="background:#f8fafc;"><td style="padding:8px 12px;font-weight:700;color:#475569;width:25%;border:1px solid #e2e8f0;">Paciente</td><td id="fv-nombre" style="padding:8px 12px;border:1px solid #e2e8f0;"></td><td style="padding:8px 12px;font-weight:700;color:#475569;width:20%;border:1px solid #e2e8f0;">Edad</td><td id="fv-edad" style="padding:8px 12px;border:1px solid #e2e8f0;"></td></tr>
                        <tr><td style="padding:8px 12px;font-weight:700;color:#475569;border:1px solid #e2e8f0;">Deporte</td><td id="fv-deporte" style="padding:8px 12px;border:1px solid #e2e8f0;"></td><td style="padding:8px 12px;font-weight:700;color:#475569;border:1px solid #e2e8f0;">Sexo</td><td id="fv-sexo" style="padding:8px 12px;border:1px solid #e2e8f0;"></td></tr>
                        <tr style="background:#f8fafc;"><td style="padding:8px 12px;font-weight:700;color:#475569;border:1px solid #e2e8f0;">Diagnostico / Zona</td><td id="fv-diag" style="padding:8px 12px;border:1px solid #e2e8f0;" colspan="3"></td></tr>
                        <tr><td style="padding:8px 12px;font-weight:700;color:#475569;border:1px solid #e2e8f0;">Motivo consulta</td><td id="fv-motivo" style="padding:8px 12px;border:1px solid #e2e8f0;" colspan="3"></td></tr>
                        <tr style="background:#f8fafc;"><td style="padding:8px 12px;font-weight:700;color:#475569;border:1px solid #e2e8f0;">Fecha</td><td id="fv-fecha" style="padding:8px 12px;border:1px solid #e2e8f0;"></td><td style="padding:8px 12px;font-weight:700;color:#475569;border:1px solid #e2e8f0;">Fisioterapeuta</td><td id="fv-fisio-out" style="padding:8px 12px;border:1px solid #e2e8f0;"></td></tr>
                    </table>
                    <p style="font-size:13px;font-weight:900;color:#0f172a;margin:14px 0 4px;font-family:Arial,sans-serif;">ESCALA DE DOLOR EVA</p>
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;font-family:Arial,sans-serif;">
                        <span style="font-size:11px;color:#64748b;">0</span>
                        <div style="flex:1;height:10px;background:#e2e8f0;border-radius:99px;overflow:hidden;"><div id="fv-eva-bar" style="height:100%;border-radius:99px;background:linear-gradient(90deg,#10b981,#f59e0b,#ef4444);width:0%;transition:width 0.4s;"></div></div>
                        <span style="font-size:11px;color:#64748b;">10</span>
                        <span id="fv-eva-num" style="font-size:22px;font-weight:900;color:#ef4444;min-width:28px;text-align:right;"></span>
                    </div>
                    <p style="font-size:13px;font-weight:900;color:#0f172a;margin:14px 0 4px;font-family:Arial,sans-serif;">ANTECEDENTES RELEVANTES</p>
                    <div id="fv-antecedentes" style="font-size:13px;color:#334155;min-height:44px;border:1px solid #e2e8f0;border-radius:10px;padding:10px 14px;margin-bottom:12px;"></div>
                    <p style="font-size:13px;font-weight:900;color:#0f172a;margin:14px 0 4px;font-family:Arial,sans-serif;">EXPLORACION FISICA</p>
                    <div id="fv-exploracion" style="font-size:13px;color:#334155;min-height:44px;border:1px solid #e2e8f0;border-radius:10px;padding:10px 14px;margin-bottom:12px;"></div>
                    <p style="font-size:13px;font-weight:900;color:#0f172a;margin:14px 0 4px;font-family:Arial,sans-serif;">OBJETIVOS TERAPEUTICOS</p>
                    <div id="fv-objetivos" style="font-size:13px;color:#334155;min-height:36px;border:1px solid #e2e8f0;border-radius:10px;padding:10px 14px;margin-bottom:28px;"></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:48px;margin-top:36px;">
                        <div style="text-align:center;"><div style="border-top:1.5px solid #94a3b8;padding-top:10px;">
                            <div id="fv-sig-paciente" style="font-size:12px;color:#475569;font-weight:700;font-family:Arial,sans-serif;"></div>
                            <div style="font-size:11px;color:#94a3b8;font-family:Arial,sans-serif;">Firma del Paciente</div>
                        </div></div>
                        <div style="text-align:center;"><div style="border-top:1.5px solid #94a3b8;padding-top:10px;">
                            <div id="fv-sig-fisio2" style="font-size:12px;color:#475569;font-weight:700;font-family:Arial,sans-serif;"></div>
                            <div style="font-size:11px;color:#94a3b8;font-family:Arial,sans-serif;">Firma del Fisioterapeuta</div>
                        </div></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== FACTURACIÓN ===== -->
        <section id="facturacion" class="hidden max-w-7xl mx-auto pb-20">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                <div>
                    <span class="text-emerald-500 font-bold text-xs uppercase tracking-widest">Gestión Financiera</span>
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mt-1">Facturación</h2>
                    <p class="text-slate-500 text-sm mt-1">Registro de cobros y pagos por sesión</p>
                </div>
                <button onclick="abrirModalFactura()" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black text-sm hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-100">+ Nueva Factura</button>
            </div>
            <!-- Métricas -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-card rounded-2xl p-5">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Este Mes</p>
                    <p id="fact-mes" class="text-2xl font-extrabold text-emerald-600">$0</p>
                </div>
                <div class="glass-card rounded-2xl p-5">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Pendientes</p>
                    <p id="fact-pendiente" class="text-2xl font-extrabold text-amber-500">$0</p>
                </div>
                <div class="glass-card rounded-2xl p-5">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Sesiones Cobradas</p>
                    <p id="fact-sesiones" class="text-2xl font-extrabold text-slate-800">0</p>
                </div>
                <div class="glass-card rounded-2xl p-5">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total General</p>
                    <p id="fact-total" class="text-2xl font-extrabold text-indigo-600">$0</p>
                </div>
            </div>
            <!-- Filtros -->
            <div class="flex gap-3 mb-6 flex-wrap">
                <select id="fact-filtro-estado" onchange="renderFacturas()" class="bg-slate-50 border-none rounded-xl px-4 py-2.5 text-xs font-bold focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="todos">Todos</option>
                    <option value="pagado">Pagado</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="cancelado">Cancelado</option>
                </select>
                <select id="fact-filtro-paciente" onchange="renderFacturas()" class="bg-slate-50 border-none rounded-xl px-4 py-2.5 text-xs font-bold focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">Todos los pacientes</option>
                </select>
                <button onclick="exportarFacturasCSV()" class="ml-auto bg-slate-100 text-slate-700 px-4 py-2.5 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">📊 Exportar CSV</button>
            </div>
            <!-- Tabla -->
            <div class="glass-card rounded-3xl overflow-hidden">
                <div id="fact-tabla" class="divide-y divide-slate-100"></div>
            </div>
            <!-- Modal nueva factura -->
            <div id="modal-factura" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl">
                    <h3 class="text-xl font-extrabold text-slate-900 mb-6">Nueva Factura</h3>
                    <div class="space-y-4">
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Paciente</label>
                        <select id="fact-pac" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-semibold"><option value="">Seleccionar...</option></select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500 block mb-1">Monto ($)</label>
                            <input id="fact-monto" type="number" placeholder="50" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm"></div>
                            <div><label class="text-xs font-bold text-slate-500 block mb-1">Fecha</label>
                            <input id="fact-fecha" type="date" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm"></div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Tipo de sesión</label>
                        <select id="fact-tipo" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-semibold">
                            <option>Sesión de fisioterapia</option>
                            <option>Evaluación inicial</option>
                            <option>Rehabilitación deportiva</option>
                            <option>Terapia manual</option>
                            <option>Punción seca</option>
                            <option>Vendaje funcional</option>
                            <option>Control / seguimiento</option>
                            <option>Otro</option>
                        </select></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Estado de pago</label>
                        <div class="flex gap-2">
                            <button onclick="setFactEstado('pagado')" id="fest-pagado" class="flex-1 py-2 rounded-xl text-xs font-black bg-emerald-600 text-white transition-all">Pagado</button>
                            <button onclick="setFactEstado('pendiente')" id="fest-pendiente" class="flex-1 py-2 rounded-xl text-xs font-black bg-slate-100 text-slate-600 transition-all">Pendiente</button>
                        </div></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Método de pago</label>
                        <select id="fact-metodo" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-semibold">
                            <option>Efectivo</option><option>Transferencia</option><option>Tarjeta</option><option>Otro</option>
                        </select></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Notas</label>
                        <input id="fact-notas" type="text" placeholder="Opcional..." class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm"></div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="cerrarModalFactura()" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">Cancelar</button>
                        <button onclick="guardarFactura()" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl text-xs font-black hover:bg-emerald-700 transition-all">Guardar</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== INVENTARIO ===== -->
        <section id="inventario" class="hidden max-w-7xl mx-auto pb-20">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                <div>
                    <span class="text-amber-500 font-bold text-xs uppercase tracking-widest">Materiales Clínicos</span>
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mt-1">Inventario</h2>
                    <p class="text-slate-500 text-sm mt-1">Control de materiales y equipamiento</p>
                </div>
                <button onclick="abrirModalInventario()" class="bg-amber-500 text-white px-6 py-3 rounded-2xl font-black text-sm hover:bg-amber-600 transition-all shadow-lg shadow-amber-100">+ Agregar Material</button>
            </div>
            <!-- Alertas stock bajo -->
            <div id="inv-alertas" class="mb-6"></div>
            <!-- Filtro categoría -->
            <div class="flex gap-2 mb-6 flex-wrap">
                <button onclick="filtrarInv('todos')" id="inv-cat-todos" class="px-4 py-2 rounded-xl text-xs font-black bg-indigo-600 text-white transition-all">Todos</button>
                <button onclick="filtrarInv('consumible')" id="inv-cat-consumible" class="px-4 py-2 rounded-xl text-xs font-black bg-slate-100 text-slate-600 transition-all">Consumibles</button>
                <button onclick="filtrarInv('equipo')" id="inv-cat-equipo" class="px-4 py-2 rounded-xl text-xs font-black bg-slate-100 text-slate-600 transition-all">Equipos</button>
                <button onclick="filtrarInv('accesorio')" id="inv-cat-accesorio" class="px-4 py-2 rounded-xl text-xs font-black bg-slate-100 text-slate-600 transition-all">Accesorios</button>
            </div>
            <!-- Grid de items -->
            <div id="inv-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <!-- Modal agregar -->
            <div id="modal-inventario" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl">
                    <h3 class="text-xl font-extrabold text-slate-900 mb-6" id="inv-modal-titulo">Nuevo Material</h3>
                    <input type="hidden" id="inv-edit-id">
                    <div class="space-y-4">
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Nombre</label>
                        <input id="inv-nombre" type="text" placeholder="Ej: Kinesiotape azul" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500 block mb-1">Categoría</label>
                            <select id="inv-cat" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-semibold">
                                <option value="consumible">Consumible</option>
                                <option value="equipo">Equipo</option>
                                <option value="accesorio">Accesorio</option>
                            </select></div>
                            <div><label class="text-xs font-bold text-slate-500 block mb-1">Unidad</label>
                            <input id="inv-unidad" type="text" placeholder="rollos, unidades..." class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500 block mb-1">Stock actual</label>
                            <input id="inv-stock" type="number" min="0" placeholder="10" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm"></div>
                            <div><label class="text-xs font-bold text-slate-500 block mb-1">Stock mínimo</label>
                            <input id="inv-min" type="number" min="0" placeholder="3" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm"></div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Notas</label>
                        <input id="inv-notas" type="text" placeholder="Proveedor, ubicación..." class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm"></div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="cerrarModalInventario()" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">Cancelar</button>
                        <button onclick="guardarInventario()" class="flex-1 bg-amber-500 text-white py-3 rounded-xl text-xs font-black hover:bg-amber-600 transition-all">Guardar</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== CALCULADORAS CLÍNICAS ===== -->
        <section id="calculadoras" class="hidden max-w-5xl mx-auto pb-20">
            <div class="mb-10">
                <span class="text-violet-500 font-bold text-xs uppercase tracking-widest">Herramientas Clínicas</span>
                <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mt-1">Calculadoras</h2>
                <p class="text-slate-500 text-sm mt-1">Escalas y cálculos para apoyo diagnóstico y seguimiento</p>
            </div>
            <!-- Tabs calculadoras -->
            <div class="flex gap-2 mb-8 flex-wrap">
                <button onclick="calcTab('imc')" id="calc-tab-imc" class="px-5 py-2.5 rounded-2xl text-xs font-black bg-indigo-600 text-white transition-all">IMC</button>
                <button onclick="calcTab('carga')" id="calc-tab-carga" class="px-5 py-2.5 rounded-2xl text-xs font-black bg-slate-100 text-slate-600 transition-all">Carga Entrenamiento</button>
                <button onclick="calcTab('karvonen')" id="calc-tab-karvonen" class="px-5 py-2.5 rounded-2xl text-xs font-black bg-slate-100 text-slate-600 transition-all">FC Objetivo (Karvonen)</button>
                <button onclick="calcTab('rpe')" id="calc-tab-rpe" class="px-5 py-2.5 rounded-2xl text-xs font-black bg-slate-100 text-slate-600 transition-all">Escala RPE</button>
                <button onclick="calcTab('oswestry')" id="calc-tab-oswestry" class="px-5 py-2.5 rounded-2xl text-xs font-black bg-slate-100 text-slate-600 transition-all">Oswestry (columna)</button>
                <button onclick="calcTab('dash')" id="calc-tab-dash" class="px-5 py-2.5 rounded-2xl text-xs font-black bg-slate-100 text-slate-600 transition-all">QuickDASH (hombro/brazo)</button>
            </div>

            <!-- IMC -->
            <div id="calc-panel-imc" class="glass-card rounded-3xl p-8">
                <h3 class="text-xl font-extrabold text-slate-900 mb-6">Índice de Masa Corporal (IMC)</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                    <div><label class="text-xs font-bold text-slate-500 block mb-2">Peso (kg)</label>
                    <input id="imc-peso" type="number" placeholder="70" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg font-bold" oninput="calcIMC()"></div>
                    <div><label class="text-xs font-bold text-slate-500 block mb-2">Altura (cm)</label>
                    <input id="imc-altura" type="number" placeholder="175" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg font-bold" oninput="calcIMC()"></div>
                </div>
                <div id="imc-resultado" class="hidden bg-slate-50 rounded-2xl p-6 text-center">
                    <p class="text-5xl font-black" id="imc-valor">0</p>
                    <p class="text-sm font-bold text-slate-500 mt-1" id="imc-categoria"></p>
                    <div class="mt-4 h-3 bg-slate-200 rounded-full overflow-hidden"><div id="imc-bar" class="h-full rounded-full transition-all duration-500"></div></div>
                    <div class="flex justify-between text-[10px] font-bold text-slate-400 mt-1"><span>16</span><span>18.5</span><span>25</span><span>30</span><span>40</span></div>
                    <p class="text-[10px] text-slate-400 mt-3">Bajo peso &lt;18.5 · Normal 18.5–24.9 · Sobrepeso 25–29.9 · Obesidad ≥30</p>
                </div>
            </div>

            <!-- Carga de entrenamiento -->
            <div id="calc-panel-carga" class="hidden glass-card rounded-3xl p-8">
                <h3 class="text-xl font-extrabold text-slate-900 mb-2">Carga de Entrenamiento (Session RPE)</h3>
                <p class="text-sm text-slate-500 mb-6">Multiplica la duración por el esfuerzo percibido para obtener la carga interna de sesión.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                    <div><label class="text-xs font-bold text-slate-500 block mb-2">Duración sesión (min)</label>
                    <input id="carga-min" type="number" placeholder="60" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg font-bold" oninput="calcCarga()"></div>
                    <div><label class="text-xs font-bold text-slate-500 block mb-2">RPE percibido (1–10)</label>
                    <input id="carga-rpe" type="number" min="1" max="10" placeholder="6" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg font-bold" oninput="calcCarga()"></div>
                </div>
                <div id="carga-resultado" class="hidden bg-slate-50 rounded-2xl p-6 text-center">
                    <p class="text-5xl font-black text-indigo-600" id="carga-valor">0</p>
                    <p class="text-sm font-bold text-slate-500 mt-1">UA (Unidades de Carga)</p>
                    <p class="text-sm font-bold mt-3" id="carga-nivel"></p>
                    <p class="text-[10px] text-slate-400 mt-2">Baja &lt;300 · Moderada 300–500 · Alta 500–700 · Muy alta &gt;700</p>
                </div>
            </div>

            <!-- Karvonen FC -->
            <div id="calc-panel-karvonen" class="hidden glass-card rounded-3xl p-8">
                <h3 class="text-xl font-extrabold text-slate-900 mb-2">FC Objetivo — Método Karvonen</h3>
                <p class="text-sm text-slate-500 mb-6">Calcula la zona de frecuencia cardíaca de entrenamiento personalizada.</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                    <div><label class="text-xs font-bold text-slate-500 block mb-2">Edad (años)</label>
                    <input id="karv-edad" type="number" placeholder="30" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg font-bold" oninput="calcKarvonen()"></div>
                    <div><label class="text-xs font-bold text-slate-500 block mb-2">FC Reposo (lpm)</label>
                    <input id="karv-reposo" type="number" placeholder="60" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg font-bold" oninput="calcKarvonen()"></div>
                    <div><label class="text-xs font-bold text-slate-500 block mb-2">Intensidad (%)</label>
                    <div class="flex gap-2">
                        <input id="karv-int-min" type="number" placeholder="60" class="w-full border border-slate-200 rounded-xl px-3 py-3 text-sm font-bold" oninput="calcKarvonen()">
                        <span class="self-center text-slate-400 font-bold">–</span>
                        <input id="karv-int-max" type="number" placeholder="80" class="w-full border border-slate-200 rounded-xl px-3 py-3 text-sm font-bold" oninput="calcKarvonen()">
                    </div></div>
                </div>
                <div id="karv-resultado" class="hidden bg-slate-50 rounded-2xl p-6">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">FC Máx</p><p class="text-3xl font-black text-slate-800" id="karv-fcmax">0</p><p class="text-xs text-slate-400">lpm</p></div>
                        <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">FC Mínima</p><p class="text-3xl font-black text-indigo-600" id="karv-min">0</p><p class="text-xs text-slate-400">lpm</p></div>
                        <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">FC Máxima</p><p class="text-3xl font-black text-indigo-600" id="karv-max">0</p><p class="text-xs text-slate-400">lpm</p></div>
                    </div>
                </div>
            </div>

            <!-- RPE Borg -->
            <div id="calc-panel-rpe" class="hidden glass-card rounded-3xl p-8">
                <h3 class="text-xl font-extrabold text-slate-900 mb-2">Escala de Esfuerzo Percibido (RPE / Borg)</h3>
                <p class="text-sm text-slate-500 mb-6">Selecciona el nivel de esfuerzo del paciente.</p>
                <div id="rpe-grid" class="grid grid-cols-2 sm:grid-cols-5 gap-3"></div>
                <div id="rpe-resultado" class="hidden mt-6 bg-slate-50 rounded-2xl p-6">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Interpretación</p>
                    <p class="text-xl font-extrabold text-slate-900" id="rpe-desc"></p>
                    <p class="text-sm text-slate-500 mt-2" id="rpe-recom"></p>
                </div>
            </div>

            <!-- Oswestry -->
            <div id="calc-panel-oswestry" class="hidden glass-card rounded-3xl p-8">
                <h3 class="text-xl font-extrabold text-slate-900 mb-2">Índice de Discapacidad de Oswestry</h3>
                <p class="text-sm text-slate-500 mb-6">Evalúa el impacto del dolor lumbar en las actividades de la vida diaria. Selecciona la opción que mejor describe al paciente en cada ítem.</p>
                <div id="oswestry-items" class="space-y-6"></div>
                <button onclick="calcOswestry()" class="mt-8 w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-sm hover:bg-indigo-700 transition-all">Calcular Índice</button>
                <div id="oswestry-resultado" class="hidden mt-6 bg-slate-50 rounded-2xl p-6 text-center">
                    <p class="text-5xl font-black" id="oswestry-valor">0%</p>
                    <p class="text-sm font-bold mt-2" id="oswestry-nivel"></p>
                    <p class="text-xs text-slate-400 mt-2" id="oswestry-desc"></p>
                </div>
            </div>

            <!-- QuickDASH -->
            <div id="calc-panel-dash" class="hidden glass-card rounded-3xl p-8">
                <h3 class="text-xl font-extrabold text-slate-900 mb-2">QuickDASH — Hombro, Brazo y Mano</h3>
                <p class="text-sm text-slate-500 mb-6">11 preguntas sobre la capacidad funcional del miembro superior (1 = sin dificultad, 5 = imposible).</p>
                <div id="dash-items" class="space-y-4"></div>
                <button onclick="calcDASH()" class="mt-8 w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-sm hover:bg-indigo-700 transition-all">Calcular QuickDASH</button>
                <div id="dash-resultado" class="hidden mt-6 bg-slate-50 rounded-2xl p-6 text-center">
                    <p class="text-5xl font-black" id="dash-valor">0</p>
                    <p class="text-sm font-bold text-slate-500 mt-1">/ 100 puntos</p>
                    <p class="text-sm font-bold mt-2" id="dash-nivel"></p>
                    <p class="text-xs text-slate-400 mt-1">0 = sin discapacidad · 100 = máxima discapacidad</p>
                </div>
            </div>
        </section>



    </main>

    <script>
        // ── HTML ESCAPE UTILITY ──────────────────────────────────────
        function escHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/`/g, '&#96;');
        }
        
        // --- 1. BIBLIOTECA CLÍNICA EXTENSA (Nivel Alto Rendimiento) ---
        const BibliotecaClinicaIA = {
    "Cadera": {
        "Fase 1": [
            { n: "Isométrico de Aductores", d: "Presionar una pelota entre las rodillas sentado o en supino.", o: "Activación de aductores en pubalgias", s: 5, r: "10s", p: "Con piernas extendidas", c: "Dolor inguinal >5 EVA" },
            { n: "Deslizamiento de Talón (Isquios)", d: "Sentado, flexionar rodilla arrastrando talón contra resistencia.", o: "Activación suave de isquios post-desgarro", s: 3, r: "15", p: "Usar banda elástica", c: "Dolor localizado en vientre muscular" },
            { n: "Extensión en decúbito", d: "Elevar pierna estirada boca abajo sin arquear lumbar.", o: "Activación de glúteo mayor", s: 3, r: "12", p: "Sostener 3s arriba", c: "Psoítis aguda" },
            { n: "Clamshells (Fase Inicial)", d: "Apertura de rodillas tumbado lateralmente, pies juntos.", o: "Reclutamiento de glúteo medio", s: 3, r: "15", p: "Sin banda elástica", c: "Bursitis trocantérea severa" },
            { n: "Rotación Externa Pasiva", d: "Movilidad en figura de 4 (tobillo sobre rodilla opuesta).", o: "Flexibilidad de rotadores externos", s: 3, r: "30s", p: "Presión sutil manual", c: "Choque femoroacetabular" }
        ],
        "Fase 2": [
            { n: "Copenhague Plank (Nivel 1)", d: "Plancha lateral con pierna superior apoyada en silla (rodilla flexionada).", o: "Fortalecimiento específico de aductores", s: 3, r: "20s", p: "Pierna extendida (Nivel 2)", c: "Inestabilidad de rodilla" },
            { n: "Curl de Isquios con Fitball", d: "Puente glúteo sobre balón y flexionar rodillas acercando el balón.", o: "Fuerza isotónica de isquiotibiales", s: 3, r: "12", p: "Unipodal", c: "Dolor en inserción proximal" },
            { n: "Monster Walk", d: "Pasos laterales con banda elástica en rodillas o tobillos.", o: "Fuerza abductora dinámica", s: 3, r: "20", p: "Banda de mayor tensión", c: "Pubalgia reactiva" },
            { n: "Zancada Estática (Split)", d: "Bajada controlada manteniendo el eje vertical.", o: "Fuerza de cuádriceps y glúteo", s: 3, r: "10", p: "Añadir mancuernas", c: "Pinzamiento anterior" },
            { n: "Step Up Frontal", d: "Subida al cajón con control de caída.", o: "Fuerza funcional concéntrica", s: 3, r: "12", p: "Aumentar altura del cajón", c: "Dolor articular agudo" }
        ],
        "Fase 3": [
            { n: "Nordic Hamstring (Excéntrico)", d: "Arrodillado, bajar el tronco lentamente controlando con isquios.", o: "Prevención de recaídas en desgarros", s: 3, r: "6", p: "Aumentar rango de caída libre", c: "Fase subaguda (solo fase funcional)" },
            { n: "Step Up Explosivo", d: "Subida al cajón con impulso potente y bajada controlada.", o: "Potencia de extensores de cadera", s: 3, r: "10", p: "Cargar mancuernas", c: "Falta de control de valgo" },
            { n: "Split Squat Búlgara (Cadera)", d: "Sentadilla con pie posterior elevado enfocado en glúteo y aductores.", o: "Fuerza máxima unilateral cadera", s: 4, r: "8", p: "Carga axial pesada", c: "Mala técnica de eje" },
            { n: "Skater Jumps", d: "Saltos laterales pliométricos con amortiguación.", o: "Potencia lateral y agilidad", s: 3, r: "12", p: "Aumentar distancia de salto", c: "Inestabilidad de tobillo" },
            { n: "Peso Muerto Sumo", d: "Apertura amplia de pies con carga central.", o: "Fuerza global de cadera/aductores", s: 3, r: "10", p: "Barra olímpica", c: "Hernia discal activa" }
        ]
    },
    "Espalda": {
        "Fase 1": [
            { n: "Respiración Diafragmática", d: "Inhalar expandiendo abdomen y exhalar activando transverso.", o: "Control de presión intraabdominal", s: 3, r: "10 ciclos", p: "Añadir elevación de brazos", c: "Dolor irradiado agudo" },
            { n: "Gato-Camello", d: "En cuadrupedia, arquear y redondear espalda lento.", o: "Lubricación discal y movilidad", s: 2, r: "12", p: "Focalizar zona dorsal", c: "Mareo o dolor punzante" },
            { n: "Puente Glúteo Isométrico", d: "Elevar pelvis y sostener con columna neutra.", o: "Activación de cadena posterior", s: 3, r: "20s", p: "Unipodal", c: "Calambres o dolor lumbar" },
            { n: "Basculación Pélvica", d: "Movimiento sutil de anteversión y retroversión.", o: "Control propioceptivo lumbar", s: 3, r: "20", p: "Sobre fitball", c: "Dolor agudo al movimiento" },
            { n: "Bird-Dog (Piernas)", d: "En cuadrupedia, deslizar solo pierna atrás sin arquear.", o: "Estabilidad base", s: 3, r: "10", p: "Levantar la pierna 5cm", c: "Inestabilidad severa" }
        ],
        "Fase 2": [
            { n: "Bird-Dog (Completo)", d: "Extender brazo y pierna contraria en cuadrupedia.", o: "Estabilidad rotacional y multífidos", s: 3, r: "10 c/u", p: "Mantener 10s", c: "Incapacidad de neutro" },
            { n: "Pallof Press (Banda)", d: "Resistir tracción lateral de banda empujando al frente.", o: "Antirrotación de core", s: 3, r: "12", p: "Base estrecha", c: "Hernia fase aguda" },
            { n: "Deadbug", d: "Bajar brazo/pierna opuesta controlando la lumbar.", o: "Control de pared abdominal anterior", s: 3, r: "10 c/u", p: "Con peso en manos", c: "Dolor sacroilíaco" },
            { n: "Plancha Lateral (Rodillas)", d: "Sostener alineación desde rodillas.", o: "Fuerza de cuadrado lumbar", s: 3, r: "30s", p: "Piernas extendidas", c: "Escoliosis dolorosa" },
            { n: "Remo un brazo (Banco)", d: "Tracción horizontal manteniendo espalda plana.", o: "Fuerza de tracción y control escapular", s: 3, r: "12", p: "Aumentar carga", c: "Carga axial alta" }
        ],
        "Fase 3": [
            { n: "Peso Muerto Rumano (Espalda)", d: "Bisagra de cadera con carga y espalda recta, énfasis lumbar.", o: "Fuerza excéntrica cadena posterior lumbar", s: 4, r: "8", p: "Aumentar carga axial", c: "Pérdida de técnica lumbar" },
            { n: "Plancha Lateral Dinámica", d: "Elevar cadera y bajar de forma controlada.", o: "Fuerza de oblicuos", s: 3, r: "12", p: "Abducción de pierna superior", c: "Dolor hombro de apoyo" },
            { n: "Farmer Walk", d: "Caminar con carga pesada en una mano (postura erguida).", o: "Estabilidad dinámica y transferencia", s: 3, r: "30m", p: "Carga asimétrica extrema", c: "Pérdida de alineación" },
            { n: "Swing de Kettlebell", d: "Balanceo explosivo desde la cadera.", o: "Potencia de cadena posterior", s: 3, r: "15", p: "Mayor carga", c: "Inestabilidad lítica" },
            { n: "Sentadilla Goblet", d: "Sentadilla con carga frontal pegada al pecho.", o: "Fuerza funcional y core", s: 3, r: "10", p: "Profundidad máxima técnica", c: "Dolor facetario" }
        ]
    },
    "Hombro": {
        "Fase 1": [
            { n: "Péndulos de Codman", d: "Brazo relajado colgando, círculos pequeños.", o: "Movilidad pasiva y decoaptación", s: 1, r: "3 min", p: "Mancuerna 1kg", c: "Luxación aguda" },
            { n: "Isométrico en Neutro GH", d: "Empuje lateral contra pared (codo 90°).", o: "Estabilidad manguito rotador", s: 3, r: "10s", p: "Ángulos variables", c: "Post-op inmediato" },
            { n: "Isométrico Extensores", d: "Presionar dorso de mano contra mesa.", o: "Activación epicondílea sin cizalla", s: 3, r: "15s", p: "Más intensidad", c: "Dolor >7 EVA" },
            { n: "Retracción Escapular", d: "Juntar escápulas sentado erguido.", o: "Estabilidad basal", s: 3, r: "15", p: "Sostener 5s", c: "Dolor cervical agudo" },
            { n: "Flexión Asistida (Bastón)", d: "Subir brazo con ayuda del brazo sano.", o: "Ganancia de ROM pasivo/asistido", s: 3, r: "10", p: "Rango máximo tolerable", c: "Pinzamiento severo" }
        ],
        "Fase 2": [
            { n: "Rotación Externa con Banda", d: "RE con toalla bajo axila.", o: "Fortalecer infraespinoso", s: 3, r: "12", p: "Banda mayor tensión", c: "Signos de atrapamiento" },
            { n: "Push Up Plus", d: "En plancha, empujar suelo separando escápulas.", o: "Activación del serrato anterior", s: 3, r: "15", p: "En el suelo (sin inclinación)", c: "Inestabilidad de codo" },
            { n: "Excéntrico Muñeca (Tyler)", d: "Extensión con barra flexible, bajar lento.", o: "Tratamiento de Epicondilitis", s: 3, r: "15", p: "Banda más fuerte", c: "Inflamación aguda" },
            { n: "Serrato Punch", d: "Tumbado, empujar mancuerna hacia techo.", o: "Estabilidad escapulotorácica", s: 3, r: "15", p: "Peso progresivo", c: "Dolor costal" },
            { n: "Remo con Banda", d: "Tracción horizontal neutra.", o: "Fortalecimiento retractores", s: 3, r: "12", p: "Retracción máxima", c: "Epitrocleitis" }
        ],
        "Fase 3": [
            { n: "Lanzamiento Balón Med", d: "Pase de pecho explosivo contra pared.", o: "Potencia y estabilidad", s: 3, r: "12", p: "Aumentar peso balón", c: "Inestabilidad anterior" },
            { n: "Landmine Press", d: "Empuje diagonal con barra.", o: "Fuerza funcional overhead", s: 3, r: "10", p: "Carga progresiva", c: "Arco doloroso agudo" },
            { n: "Dominadas / Remo Invertido", d: "Tracción en barra o anillas.", o: "Fuerza cadena posterior superior", s: 3, r: "8", p: "Lastre", c: "Epitrocleitis reactiva" },
            { n: "Turkish Get Up (Medio)", d: "Levantamiento turco hasta posición sentado.", o: "Estabilidad y propiocepción global", s: 3, r: "5", p: "Kettlebell pesada", c: "Mala técnica core" },
            { n: "Y-W-T Isométrico", d: "Mantener posiciones de brazos en aire.", o: "Resistencia postural escapular", s: 3, r: "30s", p: "Pesas de 1kg", c: "Dolor subacromial" }
        ]
    },
    "Tobillo": {
        "Fase 1": [
            { n: "Movilidad Circular", d: "Círculos lentos en ambos sentidos.", o: "Mantener ROM sin carga", s: 3, r: "10 c/u", p: "Dibujar abecedario", c: "Dolor punzante" },
            { n: "Isométrico Inversión", d: "Presionar borde interno contra objeto.", o: "Activar tibial posterior", s: 3, r: "10s", p: "Aumentar tiempo", c: "Fase aguda esguince" },
            { n: "Bombeos de Tobillo", d: "Flexo-extensión activa sin carga.", o: "Drenaje y movilidad inicial", s: 3, r: "20", p: "Con hielo", c: "Fractura no consolidada" },
            { n: "Recoger Toalla", d: "Arrugar toalla con los dedos.", o: "Fuerza intrínseca", s: 3, r: "15", p: "Con peso encima", c: "Fascitis aguda" },
            { n: "Isométrico Peroneos", d: "Empuje lateral contra pared.", o: "Estabilidad lateral inicial", s: 3, r: "10s", p: "Banda elástica leve", c: "Dolor maleolar agudo" }
        ],
        "Fase 2": [
            { n: "Elevación de Talones", d: "Subir y bajar talones bipodal.", o: "Fuerza de tríceps sural", s: 3, r: "15", p: "Hacerlo unipodal", c: "Tendinitis aquilea reactiva" },
            { n: "Equilibrio Unipodal", d: "Mantenerse en un pie sobre suelo firme.", o: "Propiocepción básica", s: 4, r: "30s", p: "Suelo inestable (foam)", c: "Inestabilidad grado III" },
            { n: "Caminata en Talones", d: "Desplazamiento apoyando solo talón.", o: "Fuerza tibial anterior", s: 3, r: "15m", p: "Caminata pato", c: "Fascitis plantar" },
            { n: "Eversión con Banda", d: "Rotación externa del pie contra resistencia.", o: "Fortalecimiento peroneos", s: 3, r: "12", p: "Banda más fuerte", c: "Dolor maleolar" },
            { n: "Sentadilla en Bosu", d: "Sentadilla en superficie inestable.", o: "Estabilidad global tobillo/rodilla", s: 3, r: "12", p: "Con carga", c: "Vértigo" }
        ],
        "Fase 3": [
            { n: "Saltos de Tijera (Jacks)", d: "Saltos controlados abriendo/cerrando.", o: "Reintroducción al impacto", s: 3, r: "20", p: "Aumentar velocidad", c: "Dolor residual >3 EVA" },
            { n: "Carga Excéntrica Aquiles", d: "Bajar talón lento desde escalón.", o: "Remodelación tendinosa", s: 3, r: "12", p: "Añadir peso", c: "Rotura parcial reciente" },
            { n: "Saltos en Y", d: "Saltos coordinados en 3 direcciones.", o: "Agilidad y control motor", s: 3, r: "6", p: "Unipodal", c: "Falta control valgo" },
            { n: "Sprint con Frenada", d: "Carrera corta y parada en seco.", o: "Potencia y absorción de carga", s: 5, r: "10m", p: "Frenada unipodal", c: "Inestabilidad mecánica" },
            { n: "Zancada con Giro", d: "Lunge frontal + rotación de tronco.", o: "Control dinámico global", s: 3, r: "12", p: "Balón medicinal", c: "Dolor articular" }
        ]
    },
    "Muñeca/Mano": {
        "Fase 1": [
            { n: "Isométrico Flexores Muñeca", d: "Flexión de muñeca contra resistencia manual suave con codo a 90°.", o: "Activación sin carga del tendón", s: 3, r: "10s", p: "Incrementar intensidad gradual", c: "Inflamación aguda >7 EVA" },
            { n: "Bombeos de muñeca", d: "Movimiento lento de flexo-extensión en rango libre de dolor.", o: "Drenaje y movilidad inicial", s: 3, r: "20", p: "Añadir peso pequeño (0.5 kg)", c: "Fractura sin consolidar" },
            { n: "Oposición pulgar-dedos", d: "Tocar cada dedo con el pulgar de forma secuencial.", o: "Coordinación y movilidad fina", s: 3, r: "10 ciclos", p: "Aumentar velocidad", c: "Dedo en gatillo agudo" },
            { n: "Pelota antiestrés (agarre suave)", d: "Apretones suaves de pelota blanda.", o: "Activar musculatura intrínseca", s: 3, r: "15", p: "Pelota más dura", c: "Síndrome túnel carpiano agudo" },
            { n: "Estiramientos tenores/hipotenores", d: "Extensión suave de dedos con muñeca neutra.", o: "Flexibilidad intrínseca", s: 3, r: "30s", p: "Con ayuda del otro mano", c: "Artritis inflamatoria aguda" }
        ],
        "Fase 2": [
            { n: "Excéntrico Extensores Muñeca (Tyler Twist)", d: "Con barra flexible, extender muñeca y bajar lentamente con la mano sana.", o: "Fortalecimiento excéntrico para epicondilitis", s: 3, r: "15", p: "Barra más resistente", c: "Inflamación activa" },
            { n: "Pronación/Supinación con Barra", d: "Rotar el antebrazo sosteniendo un martillo por el mango.", o: "Fortalecimiento de pronadores y supinadores", s: 3, r: "12", p: "Desplazar mano más alejada", c: "Síndrome túnel carpiano activo" },
            { n: "Pinza con Ropa Pinzas", d: "Comprimir y soltar pinzas de ropa de distintos tamaños.", o: "Fuerza de pinza lateral", s: 3, r: "15", p: "Pinzas de mayor tensión", c: "Tendón dañado" },
            { n: "Puño cerrado-abierto con banda", d: "Extender dedos contra resistencia de una banda.", o: "Fuerza extrínseca extensora", s: 3, r: "12", p: "Mayor resistencia", c: "Rotura parcial de tendón extensor" },
            { n: "Neurodinamia del Mediano", d: "Elongación del nervio mediano con muñeca en extensión, codo extendido y rotación cervical.", o: "Movilización neural carpal", s: 3, r: "10", p: "Añadir depresión escapular", c: "Dolor >6 EVA en neurodinamia" }
        ],
        "Fase 3": [
            { n: "Press en Suelo (push up modificado)", d: "Flexiones con muñeca en puño (sobre nudillos) o con barras paralelas.", o: "Carga progresiva en muñeca", s: 3, r: "10", p: "Flexiones convencionales", c: "Fractura de escafoides no consolidada" },
            { n: "Agarre de Barra con Carga", d: "Colgarse de barra con agarre en pronación y supinación.", o: "Fuerza máxima de agarre", s: 3, r: "30s", p: "Añadir peso corporal", c: "Inestabilidad escafolunar" },
            { n: "Lanzamientos de Pelota Medicinal", d: "Lanzamiento al rebotador con rotación de muñeca.", o: "Potencia funcional de muñeca", s: 3, r: "12", p: "Aumentar peso y distancia", c: "Epifisitis en adolescentes" },
            { n: "Farmer Walk con agarre", d: "Marcha cargando kettlebells o barras pesadas.", o: "Fuerza de agarre bajo fatiga", s: 3, r: "30m", p: "Carga mayor", c: "Síndrome canal de Guyon activo" },
            { n: "Gesto Deportivo Específico", d: "Replicar el gesto técnico del deporte (raqueta, bate, remo) con carga progresiva.", o: "Transferencia funcional al deporte", s: 3, r: "10", p: "Velocidad y potencia completa", c: "Dolor >3 EVA en gesto" }
        ]
    },
    "Cuello/Cervical": {
        "Fase 1": [
            { n: "Flexión Craneocervical Isométrica", d: "Asentir la cabeza (chin tuck) suavemente en decúbito supino.", o: "Activación de flexores profundos (LCCapitis)", s: 3, r: "10s", p: "Añadir carga manual suave", c: "Radiculopatía aguda con parestesias" },
            { n: "Movilidad Cervical Activa Asistida", d: "Rotar, flexionar y extender el cuello guiado por la mano.", o: "Recuperar ROM sin dolor", s: 2, r: "10", p: "Sin asistencia", c: "Inestabilidad atlanto-axoidea" },
            { n: "Retracción Cervical (Chin Tuck)", d: "Empujar el occipital hacia atrás sin inclinar la cabeza.", o: "Corrección postural y descompresión foraminal", s: 3, r: "15", p: "Con resistencia manual", c: "Dolor irradiado que aumenta con el gesto" },
            { n: "Isométrico Cervical en Neutro", d: "Resistir movimiento lateral o rotacional con mano sobre sien.", o: "Activación estabilizadores sin movimiento", s: 3, r: "10s", p: "Más intensidad", c: "Fractura cervical sospecha" },
            { n: "Estiramiento Suboccipital", d: "Manos entrelazadas detrás de la cabeza, tracción suave hacia el pecho.", o: "Liberación musculatura suboccipital", s: 3, r: "30s", p: "Rotación añadida", c: "Cefalea posicional aguda" }
        ],
        "Fase 2": [
            { n: "Flexión-Rotación Cervical", d: "Flexionar el cuello al pecho y luego rotar izquierda-derecha.", o: "Movilidad C1-C2 diferenciada", s: 2, r: "10 c/u", p: "Velocidad progresiva", c: "Dolor radicular que aumenta" },
            { n: "Fortalecimiento Trapecio Inferior", d: "Boca abajo, elevar el brazo en Y por encima de la cabeza.", o: "Depresión escapular y postura", s: 3, r: "15", p: "Pesos en mano", c: "Dolor de hombro asociado activo" },
            { n: "Press Cervical Isométrico Progresivo", d: "Resistir con mano en frente, laterales y occipital con mayor intensidad.", o: "Hipertrofia estabilizadores cervicales", s: 3, r: "12s", p: "Theraband de mayor resistencia", c: "Hernia aguda C4-C5" },
            { n: "Deep Neck Flexor con Biofeedback", d: "Chin tuck sobre almohada con feedback de manómetro (20-22 mmHg).", o: "Control preciso de flexores profundos", s: 3, r: "10 repeticiones", p: "Incrementar presión objetivo", c: "Dificultad de aislamiento" },
            { n: "Movilización SNAG Autoadministrada", d: "Presión del pulgar hacia arriba en la vértebra afecta mientras mueve en el sentido doloroso.", o: "Técnica de Mulligan autoadministrada", s: 3, r: "10", p: "Con banda de Mulligan", c: "Inestabilidad cervical" }
        ],
        "Fase 3": [
            { n: "Carry con Control Cervical", d: "Farmer walk con carga asimétrica manteniendo columna cervical neutra.", o: "Estabilidad dinámica cervical bajo carga", s: 3, r: "30m", p: "Carga mayor", c: "Pérdida de postura con carga" },
            { n: "Turkish Get Up (Parte Cervical)", d: "Transición al suelo/de pie con control cervical y mano extendida.", o: "Integración funcional del raquis cervical", s: 3, r: "5 c/l", p: "Aumentar carga kettlebell", c: "Vértigo postural" },
            { n: "Rotación Cervical en Plank", d: "En posición de plancha, rotar la cabeza izquierda-derecha.", o: "Disociación cervical-torácica bajo carga axial", s: 3, r: "10 c/u", p: "Plank sobre manos", c: "Contractura aguda" },
            { n: "Gesto técnico con carga cervical", d: "Reproducir el gesto deportivo específico (nadar, golpear, empujar) controlando la posición cervical.", o: "Transferencia al deporte", s: 3, r: "10", p: "Velocidad real", c: "Dolor >3 EVA en gesto" },
            { n: "Sprint con Control de Postura", d: "Aceleración corta (10m) vigilando postura cervical.", o: "Retorno funcional con eficiencia neuromuscular", s: 5, r: "10m", p: "Velocidad máxima", c: "Radiculopatía no resuelta" }
        ]
    },
    "Ingle/Pubis": {
        "Fase 1": [
            { n: "Isométrico de Aductores en Supino", d: "Presionar una pelota entre las rodillas en decúbito supino, manteniendo 10s.", o: "Activación de aductores sin cizalla pubiana", s: 3, r: "10s", p: "Piernas semi-extendidas (más difícil)", c: "Osteítis de pubis aguda" },
            { n: "Contracción Abdominal Profunda (Hipopresivo)", d: "Respiración hipopresiva para activar transverso sin presión intraabdominal.", o: "Estabilización lumbopélvica sin dolor", s: 3, r: "6 respiraciones", p: "Posición de pie", c: "Hernia abdominal activa" },
            { n: "Retroversión Pélvica Suave", d: "Bascular la pelvis hacia atrás suavemente desde posición supina.", o: "Control lumbopélvico basal", s: 3, r: "20", p: "Sobre fitball", c: "Dolor lumbar irradiado" },
            { n: "SLR en Aducción", d: "Elevar pierna estirada cruzando la línea media sin dolor.", o: "Activación aductor sin compresión sinfisaria", s: 3, r: "10", p: "Añadir peso de tobillo", c: "Dolor en sínfisis al movimiento" },
            { n: "Isométrico Psoas (sedestación)", d: "Sentado, elevar rodilla suavemente contra resistencia manual.", o: "Activación psoas sin carga de columna", s: 3, r: "10s", p: "Incrementar resistencia", c: "Tendinopatía psoas aguda" }
        ],
        "Fase 2": [
            { n: "Copenhagen Plank (rodilla flexionada)", d: "Plancha lateral con pierna superior apoyada sobre silla, mantener.", o: "Fortalecimiento excéntrico de aductores", s: 3, r: "20s", p: "Pierna extendida", c: "Osteítis pubiana moderada" },
            { n: "Ejercicio de Adductor Lateral", d: "Tumbado lateral, elevar pierna inferior hacia el techo.", o: "Fortalecimiento aductor sin carga axial", s: 3, r: "15", p: "Añadir tobillera con peso", c: "Dolor en sínfisis >5 EVA" },
            { n: "Sentadilla Sumo Asistida", d: "Sentadilla con apertura amplia y manos en TRX o barra fija.", o: "Fortalecimiento global cadera y aductores", s: 3, r: "10", p: "Sin asistencia, con carga", c: "Hernia inguinal no estabilizada" },
            { n: "Dead Bug con Presión de Piernas", d: "Posición Dead Bug con pelota entre rodillas siendo presionada.", o: "Co-contracción core-aductores", s: 3, r: "10 c/u", p: "Extensión total de extremidades", c: "Dolor lumbar agudo" },
            { n: "Step Up con Énfasis en Aducción", d: "Subida al cajón cruzando ligeramente la línea media.", o: "Fuerza funcional en aducción", s: 3, r: "12", p: "Cajón más alto", c: "Inestabilidad de rodilla" }
        ],
        "Fase 3": [
            { n: "Copenhagen Plank (pierna extendida)", d: "Plancha lateral con pierna superior extendida sobre cajón.", o: "Máxima fuerza excéntrica aductora", s: 3, r: "8-10", p: "Movimiento dinámico (bajar y subir)", c: "Osteítis fase aguda/subaguda" },
            { n: "Cambios de Dirección (COD 45°)", d: "Sprint corto con cambio de dirección a 45°.", o: "Carga deportiva específica en aductores", s: 4, r: "6 reps", p: "Reducir ángulo a 90° y mayor velocidad", c: "Dolor >3 EVA en deporte" },
            { n: "Kick de Futbolista con Control", d: "Gesto de golpeo con pelota enfatizando desaceleración del aductor.", o: "Transferencia al gesto deportivo", s: 3, r: "10", p: "Potencia máxima", c: "Pubalgia activa" },
            { n: "Peso Muerto Sumo con Barra", d: "Apertura amplia, carga central, cadena posterior activa.", o: "Fuerza máxima en aductores y cadera", s: 3, r: "8", p: "Carga axial progresiva", c: "Hernia inguinal no resuelta" },
            { n: "Entrenamiento Pliométrico Lateral", d: "Saltos laterales con caída controlada.", o: "Potencia y absorción de carga en aductores", s: 3, r: "10", p: "Distancia mayor", c: "Inestabilidad de tobillo/rodilla" }
        ]
    },
    "Isquiotibiales": {
        "Fase 1": [
            { n: "Isométrico Isquio en Larga Longitud", d: "Tumbado boca arriba, pierna elevada a 70-80°, presionar el talón contra la pared.", o: "Activar isquios a larga longitud sin dolor", s: 3, r: "45s", p: "Mayor ángulo (extensión)", c: "Dolor >7 EVA en inserción proximal" },
            { n: "Deslizamiento de Talón (Supino)", d: "Desde supino, flexionar la rodilla arrastrando el talón sin elevar la pelvis.", o: "Movilidad activa sin carga tendinosa", s: 3, r: "15", p: "Con fitball", c: "Rotura grado III aguda" },
            { n: "Propiocepción de Rodilla en Descarga", d: "Sentado, detectar posición articular de rodilla sin mirar.", o: "Re-educación sensoriomotriz", s: 3, r: "30s", p: "Con Biofeedback", c: "No aplica contraindicaciones" },
            { n: "Estiramiento Activo en Larga Longitud (Askling L1)", d: "Desde posición supina, elevar pierna lentamente en amplitud máxima tolerable.", o: "Elongación activa controlada", s: 3, r: "6", p: "Mayor amplitud", c: "Avulsión isquiática aguda" },
            { n: "Activación Glútea (Clamshell)", d: "Tumbado lateral, apertura de rodillas.", o: "Reducir carga compensatoria en isquios", s: 3, r: "15", p: "Con banda elástica", c: "No aplica contraindicaciones específicas" }
        ],
        "Fase 2": [
            { n: "Curl de Isquiotibiales con Fitball", d: "Puente glúteo sobre fitball y acercar el balón flexionando rodillas.", o: "Fuerza isotónica concéntrica/excéntrica", s: 3, r: "12", p: "Unipodal", c: "Inserción proximal reactiva" },
            { n: "Peso Muerto Rumano (RDL)", d: "Bisagra de cadera con espalda recta, carga en manos.", o: "Carga excéntrica progresiva en larga longitud", s: 3, r: "10", p: "Mayor carga axial", c: "Desgarro agudo no cicatrizado" },
            { n: "Hip Hinge con Banda (Entrenamiento de bisagra)", d: "Empujar la cadera hacia atrás contra resistencia de banda en cadera.", o: "Control de bisagra y fuerza isquio-glútea", s: 3, r: "15", p: "Carga axial mayor", c: "Lumbalgia activa" },
            { n: "Askling L-Protocol Intermedio", d: "Zancada diagonal con carga manual: inclinación del tronco hacia adelante.", o: "Fortalecimiento en larga longitud deportivo", s: 3, r: "8", p: "Mayor inclinación del tronco", c: "Desgarro muscular reciente" },
            { n: "Ejercicios de Cadera en Extensión (Hip Thrust)", d: "Puente glúteo con espalda en banco, carga axial sobre caderas.", o: "Potencia de cadena posterior", s: 3, r: "10", p: "Barra olímpica", c: "Dolor lumbar o sacroilíaco" }
        ],
        "Fase 3": [
            { n: "Nordic Hamstring Curl", d: "Arrodillado con pies sujetos, descender controlando la caída con los isquios.", o: "Máxima fuerza excéntrica preventiva", s: 3, r: "6", p: "Mayor rango libre (caída total)", c: "Fase aguda o subaguda (solo funcional)" },
            { n: "Sprint Controlado 60%", d: "Carrera lineal al 60% de velocidad máxima.", o: "Reintroducción a carga de alta velocidad", s: 5, r: "20m", p: "Ir a 80-95% velocidad", c: "Dolor residual >3 EVA" },
            { n: "Sprints con Fly-In (inicio en movimiento)", d: "Carrera 10m de preparación + 10m a velocidad máxima.", o: "Máximo estrés en isquiotibiales a alta velocidad", s: 4, r: "30m", p: "Sprints con cambio de dirección", c: "Ecografía sin cierre lesional" },
            { n: "Pliometría Unilateral (Bounding)", d: "Saltos progresivos en desplazamiento lineal con caída amortiguada.", o: "Potencia y absorción de carga en isquios", s: 3, r: "8", p: "Cambio de dirección", c: "Inestabilidad articular rodilla" },
            { n: "Gesto técnico de Deporte (Sprint + Kick)", d: "Reproducir el gesto deportivo real con velocidad progresiva.", o: "Transferencia final al deporte", s: 3, r: "10", p: "Juego real/partido", c: "Falta de clearance clínico" }
        ]
    },
    "Rodilla": {
        "Fase 1": [
            { n: "Isométrico Cuádriceps", d: "Contracción 10s con toalla bajo hueco poplíteo.", o: "Activar VMO y reducir inhibición", s: 3, r: "10 holds", p: "Sostener 15s", c: "Dolor >7 EVA" },
            { n: "Heel Slides", d: "Deslizamiento talón en cadena cerrada.", o: "Recuperar ROM", s: 3, r: "15", p: "Rango activo-asistido", c: "Bloqueo mecánico" },
            { n: "SLR (Straight Leg Raise)", d: "Elevación pierna recta.", o: "Fuerza base cadena anterior", s: 3, r: "10", p: "Pesas de tobillo 1kg", c: "Lag de extensión" },
            { n: "Movilización de rótula", d: "Deslizamientos superior, inferior y medial.", o: "Mantener movilidad patelar", s: 1, r: "5 min", p: "N/A", c: "Post-op con grapas" },
            { n: "Isométrico Isquios", d: "Presionar talón contra el suelo a 90°.", o: "Co-contracción muscular", s: 3, r: "10s", p: "Ángulos variables", c: "Quiste de Baker" }
        ],
        "Fase 2": [
            { n: "Wall Sit 45°", d: "Sentadilla isométrica contra pared.", o: "Resistencia muscular sub-máxima", s: 4, r: "45s", p: "Aumentar a 90°", c: "Dolor femoropatelar" },
            { n: "Step up Lateral", d: "Subida al escalón controlando valgo.", o: "Control motor y cadera", s: 3, r: "12", p: "Aumentar altura cajón", c: "Pérdida eje mecánico" },
            { n: "Puente Glúteo Bipodal", d: "Elevación de pelvis.", o: "Fortalecer cadena posterior", s: 3, r: "15", p: "Unipodal", c: "Dolor lumbar" },
            { n: "Prensa (Rango Corto)", d: "Empuje controlado en máquina.", o: "Hipertrofia inicial", s: 3, r: "12", p: "Carga progresiva", c: "Tendinitis reactiva" },
            { n: "Propiocepción Bipodal", d: "Equilibrio en superficie inestable.", o: "Estabilidad articular", s: 3, r: "45s", p: "Ojos cerrados", c: "Vértigo" }
        ],
        "Fase 3": [
            { n: "Split Squat Búlgara (Rodilla)", d: "Sentadilla con pie posterior elevado con control patelofemoral.", o: "Fuerza máxima y estabilidad de rodilla", s: 4, r: "8", p: "Carga axial", c: "Mala técnica" },
            { n: "Box Jump (Landing)", d: "Salto y caída controlada.", o: "Pliometría y absorción", s: 3, r: "10", p: "Salto reactivo", c: "Inestabilidad articular" },
            { n: "Peso Muerto Rumano (Rodilla)", d: "Bisagra de cadera con barra, énfasis en isquios.", o: "Fuerza cadena posterior isquios", s: 3, r: "10", p: "Barra olímpica", c: "Hernia activa" },
            { n: "Sprint de Control", d: "Carrera lineal al 50%.", o: "Retorno deportivo", s: 5, r: "20m", p: "Cambios de dirección", c: "Inestabilidad mecánica" },
            { n: "Nordic Curls", d: "Descenso excéntrico controlado.", o: "Prevención de lesiones", s: 3, r: "6", p: "Asistido con banda", c: "Desgarro reciente" }
        ]
    }
};
const MAPEO_ZONAS = {
    "Rodilla": ["Condromalacia rotuliana", "Síndrome patelofemoral", "Tendinitis rotuliana", "Lesión LCA", "Lesión LCP", "Meniscopatía medial", "Meniscopatía lateral", "Bursitis prerrotuliana", "Síndrome de banda iliotibial", "Artrosis temprana de rodilla", "Contractura cuádriceps", "Fractura por estrés fémur", "Contusión muscular profunda", "Rodilla del saltador", "Rodilla del corredor", "Contusión ósea", "Contusión muscular", "Desgarro grado I", "Desgarro grado II", "Desgarro grado III", "Desequilibrios musculares", "Desalineación biomecánica", "Bloqueo articular", "Recaída muscular", "Síndrome de Osgood-Schlatter", "Síndrome de Sinding-Larsen-Johansson", "Condropatía femoral", "Neuropatía del ciático poplíteo externo (CPE)", "Calambres musculares", "DOMS", "Edema óseo", "Pinzamiento articular", "Sobrecarga cuádriceps", "Síndrome de Osgood-Schlatter", "Condromalacia rotuliana", "Síndrome de Sinding-Larsen-Johansson", "Síndrome de banda iliotibial (ITBS)", "Lesión LCP (ligamento cruzado posterior)", "Meniscopatía medial", "Meniscopatía lateral", "Bursitis prerrotuliana", "Artrosis temprana de rodilla", "Rodilla del saltador (tendinopatía rotuliana)", "Rodilla del corredor (síndrome patelofemoral)", "Edema óseo de rodilla", "Pinzamiento articular de rodilla", "Contractura de cuádriceps", "Desequilibrios musculares (rodilla)", "Rehabilitación post-LCA (6 meses)", "Síndrome del corredor (ITBS avanzado)"],
    "Hombro": [
      "Síndrome de impingement subacromial (SIS)",
      "Manguito rotador — tendinopatía global (todos los tendones)",
      "Supraespinoso — tendinopatía (arco doloroso)",
      "Infraespinoso — tendinopatía y debilidad de RE",
      "Subescapular — tendinopatía y debilidad de RI",
      "Redondo menor — tendinopatía (RE a 90° ABD)",
      "Rotura del supraespinoso (parcial — cara articular)",
      "Rotura del supraespinoso (total)",
      "Rotura del manguito rotador (parcial)",
      "Rotura del manguito rotador (total, post-quirúrgico)",
      "Rotura del infraespinoso y redondo menor",
      "Rotura del subescapular",
      "Tendinitis calcificante del manguito rotador",
      "Bursitis subacromial",
      "Bursitis subdeltoidea",
      "Tendinitis supraespinoso",
      "Tendinopatía del bíceps (porción larga) — crónica",
      "Rotura del tendón del bíceps (porción larga)",
      "Síndrome SLAP tipo I",
      "Síndrome SLAP tipo II-IV",
      "Inestabilidad glenohumeral anterior (TUBS)",
      "Inestabilidad glenohumeral multidireccional (AMBRI)",
      "Lesión de Bankart (labrum anterior)",
      "Luxación hombro anterior",
      "Luxación hombro posterior",
      "Luxación acromioclavicular",
      "Artropatía acromioclavicular",
      "Osteoartritis acromioclavicular",
      "Osteólisis distal de clavícula (hombro del levantador)",
      "Fractura de clavícula",
      "Fractura de cabeza humeral (Garden/Neer)",
      "Fractura de escápula (cuerpo, cuello, glenoides)",
      "Luxación esternoclavicular (anterior/posterior)",
      "Capsulitis adhesiva (hombro congelado) — fase aguda",
      "Capsulitis adhesiva — fase proliferativa",
      "Capsulitis adhesiva — fase resolución",
      "Artritis glenohumeral (degenerativa/OA)",
      "Artritis reumatoide del hombro",
      "Discinesia escapular",
      "Síndrome escapulotorácico (escápula alada / crujido)",
      "Síndrome del pectoral menor (compresión subcoracoidea)",
      "Hombro del lanzador (Thrower's shoulder)",
      "Síndrome de hipomovilidad glenohumeral posterior",
      "Hombro del nadador",
      "Neuropatía del nervio supraescapular",
      "Parálisis del nervio axilar",
      "Síndrome del túnel cuadrilátero (nervio axilar)",
      "Discinesia escapular",
      "Lesión tríceps (rotura distal)",
      "Fractura de olécranon",
      "Epicondilitis (codo tenista)",
      "Epitrocleitis (codo golfista)",
      "Codo del lanzador (UCL medial)",
      "Síndrome del nervio ulnar en codo (cubital tardío)"
    ],
    "Tobillo": ["Fascitis plantar", "Espolón calcáneo", "Esguince de tobillo grado I", "Esguince grado II", "Esguince grado III", "Tendinitis aquilea", "Rotura parcial del Aquiles", "Fractura metatarsiana", "Neuroma de Morton", "Sesamoiditis", "Periostitis tibial", "Fractura por estrés tibial", "Síndrome compartimental crónico", "Tobillo del basquetbolista", "Inflamación tendinosa crónica", "Sobrecarga de gemelos", "Lesión condral de tobillo (OCD talar)", "Tendinitis del tibial posterior", "Tendinopatía peroneal", "Pinzamiento posterior de tobillo (FHL)", "Síndrome del tendón del tibial anterior", "Esguince de la articulación de Lisfranc", "Fractura de Jones (5º metatarsiano)", "Inestabilidad crónica de tobillo (CAI)", "Síndrome de Achilles insertional", "Rotura total del Aquiles (post-quirúrgico)", "Lesión del cartílago de crecimiento (fisis) en tobillo", "Periostitis tibial (Shin Splints)", "Tendinitis aquilea", "Fractura por estrés tibial", "Síndrome compartimental crónico", "Neuroma de Morton", "Inestabilidad crónica de tobillo (CAI)", "Tendinopatía peroneal", "Rotura parcial del Aquiles", "Rotura total del Aquiles (post-quirúrgico)", "Lesión condral de tobillo (OCD talar)", "Tobillo del basquetbolista", "Fascitis plantar resistente (crónica)", "Fractura metatarsiana", "Sesamoiditis", "Esguince de la articulación de Lisfranc", "Fractura de Jones (5º metatarsiano)", "Síndrome de Achilles insertional"],
    "Espalda": ["Lumbalgia mecánica", "Hernia discal lumbar", "Ciatalgia", "Cervicalgia mecánica", "Dorsalgia postural", "Escoliosis funcional", "Espondilolistesis", "Pinzamiento lumbar", "Latigazo cervical", "Contractura paravertebral", "Síndrome sobreentrenamiento", "Fatiga neuromuscular", "Contractura generalizada", "Espalda del remero", "Síndrome del ciclista", "Lumbar del levantador", "Sobrecarga lumbar", "Sobrecarga cervical", "Sobrecarga trapecial", "Fatiga del core", "Hipermovilidad", "Hipomovilidad", "Rigidez miofascial", "Síndrome miofascial", "Dolor crónico deportivo", "Microtraumatismos repetitivos", "Espondilolistesis", "Latigazo cervical", "Dorsalgia postural", "Contractura paravertebral", "DOMS (dolor muscular de aparición tardía)", "Calambres musculares", "Síndrome miofascial", "Lumbar del levantador"],
    "Cadera": ["Pubalgia", "Desgarro aductores", "Desgarro isquiotibial", "Síndrome piriforme", "Bursitis trocantérica", "Lesión labrum acetabular", "Síndrome cadera en resorte", "Pubalgia futbolista", "Fatiga glútea", "Sobrecarga isquios", "Fractura por estrés de cadera (cuello femoral)", "Meralgia parestésica", "Síndrome cadera en resorte", "Fractura por estrés de cadera (cuello femoral)", "Meralgia parestésica"],
    "Muñeca/Mano": ["Esguince de muñeca", "Tendinitis de De Quervain", "Fractura de escafoides", "Síndrome del canal de Guyon", "Dedo en gatillo (tenosinovitis flexora)", "Rotura del ligamento colateral cubital pulgar", "Artritis de la base del pulgar (rizartrosis)", "Síndrome del nervio interóseo posterior", "Síndrome túnel carpiano", "Tendinitis extensores muñeca", "Muñeca del gimnasta", "Fractura de escafoides", "Síndrome del canal de Guyon", "Dedo en gatillo (tenosinovitis flexora)", "Artritis de la base del pulgar (rizartrosis)", "Síndrome del nervio interóseo posterior", "Muñeca del gimnasta", "Rotura del ligamento colateral cubital pulgar"],
    "Cuello/Cervical": ["Contractura cervical aguda (tortícolis)", "Radiculopatía cervical", "Síndrome de salida torácica", "Cefalea cervicogénica", "Lesión de disco cervical C5-C6", "Miositis cervical del nadador", "Conmoción cerebral", "Radiculopatía cervical", "Síndrome de salida torácica", "Cefalea cervicogénica", "Miositis cervical del nadador"],
    "Ingle/Pubis": ["Tendinopatía del psoas-ilíaco", "Osteítis de pubis", "Hernia inguinal deportiva (Gilmore Groin)", "Contractura del aductor largo", "Neuropatía del nervio femoral", "Bursitis iliopectínea", "Tendinopatía del psoas-ilíaco", "Osteítis de pubis", "Hernia inguinal deportiva (Gilmore Groin)", "Contractura del aductor largo", "Neuropatía del nervio femoral", "Bursitis iliopectínea"],
    "Isquiotibiales": ["Desgarro proximal de isquiotibiales", "Síndrome del ángulo isquio-femoral", "Tendinopatía proximal de isquiotibiales", "Avulsión apofisaria isquiática (adolescente)", "Síndrome de fricción ciático-isquiática", "Desgarro proximal de isquiotibiales", "Tendinopatía proximal de isquiotibiales", "Avulsión apofisaria isquiática (adolescente)", "Síndrome del ángulo isquio-femoral", "Síndrome de fricción ciático-isquiática"]
};
        // --- 2. LISTA MAESTRA DE LESIONES (Diagnósticos y Pruebas) ---
       const bibliotecaLesiones = [
    // ===== 🦶 PIE Y TOBILLO =====
    { n:"Fascitis plantar", z:"Tobillo",
      e:["Windlass Test","Dolor matutino en talón (EVA)","Palpación inserción fascia plantar","Test de dorsiflexión de tobillo"],
      p:"F1(0-2sem): Descarga, crioterapia, estiramientos fascia y pantorrilla, férula nocturna.\nF2(2-6sem): Fortalecimiento intrínseco (short foot, towel curls), excéntricos, vendaje.\nF3(6-12sem): Carrera progresiva, pliometría, corrección biomecánica.",
      fases:[
        {f:"Fase 1 — Aguda (0-2 sem)",ejs:["Estiramiento pasivo fascia plantar: tirar dedos hacia dorso, 3x30seg","Estiramiento pantorrilla en escalón (Gastro+Soleus), 3x45seg","Crioterapia 15min x3/día","Férula nocturna en dorsiflexión 5°"]},
        {f:"Fase 2 — Subaguda (2-6 sem)",ejs:["Short foot: contraer arco sin doblar dedos, 3x15","Towel curls con dedos del pie, 3x20","Elevaciones de talón excéntricas en escalón, 3x15","Ondas de choque si persiste (6 sesiones)"]},
        {f:"Fase 3 — Funcional (6-12 sem)",ejs:["Saltos monopodales con aterrizaje suave, 3x10","Carrera progresiva (caminar-trotar-correr)","Equilibrio en superficie inestable, 3x30seg","Corrección de cadena posterior completa"]}
      ],
      rts:"Sin dolor matutino · Windlass negativo · Trote 20min sin dolor · Fuerza plantar flexora simétrica"},

    { n:"Espolón calcáneo", z:"Tobillo",
      e:["Rx lateral calcáneo","Dolor puntual bajo el talón","Windlass Test"],
      p:"F1: Ondas de choque, ortesis de descarga posterior.\nF2: Fortalecimiento intrínseco, estiramientos.\nF3: Calzado adecuado, retorno progresivo.",
      fases:[
        {f:"Fase 1 — Descarga (0-3 sem)",ejs:["Plantilla con descarga del talón","Crioterapia 15min x3/día","Ondas de choque (6 sesiones)","Evitar caminar descalzo"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["Short foot exercise 3x15","Elevaciones de talón con descarga 3x20","Estiramiento de fascia plantar 3x30seg","Caminar con calzado con absorción"]},
        {f:"Fase 3 — Retorno (8-12 sem)",ejs:["Carrera progresiva en superficie blanda","Pliometría de bajo impacto","Control de calzado deportivo","Revisión biomecánica de la marcha"]}
      ],
      rts:"Sin dolor en bipedestación prolongada · Rx estable · Marcha sin cojera"},

    { n:"Esguince de tobillo grado I", z:"Tobillo",
      e:["Test de cajón anterior","Bostezo lateral","Palpación LFA/LFC","Ottawa Ankle Rules","Balance Star Excursion Test"],
      p:"F1(0-72h): PEACE & LOVE, movilidad sagital activa.\nF2(3-14d): Isométricos peroneos, propiocepción básica.\nF3(2-4sem): Pliometría, cambios de dirección.",
      fases:[
        {f:"Fase 1 — Aguda (0-72h)",ejs:["Bombeos tobillo: flexo-extensión activa 3x20","Compresión y elevación del miembro","Movilidad en plano sagital sin dolor","Marcha con apoyo total si tolera"]},
        {f:"Fase 2 — Subaguda (3-14 días)",ejs:["Isométrico peroneos contra pared, 5x10seg","Propiocepción monopodal ojos abiertos 3x30seg","Fortalecimiento tibial anterior y posterior","Marcha en terreno irregular controlado"]},
        {f:"Fase 3 — Funcional (2-4 sem)",ejs:["Saltos laterales con aterrizaje controlado 3x10","Cambios de dirección a 45° y 90°","Sprint progresivo 50-75-100%","Equilibrio reactivo con perturbaciones"]}
      ],
      rts:"Balance monopodal ≥90% · CAIT>24 · Sprint sin dolor · Cambios de dirección sin restricción"},

    { n:"Esguince grado II", z:"Tobillo",
      e:["Cajón anterior positivo","Equimosis","Prueba de esfuerzo en varo","Ottawa Ankle Rules","Ecografía ligamentosa"],
      p:"F1(0-1sem): Bota walker o vendaje rígido.\nF2(1-3sem): Movilidad progresiva, fortalecimiento peroneos.\nF3(3-6sem): Propiocepción avanzada, pliometría, retorno.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-1 sem)",ejs:["Bota walker o vendaje rígido","Bombeos circulatorios distales","Ejercicios cadera y rodilla (SLR)","Crioterapia 15min x4/día"]},
        {f:"Fase 2 — Fortalecimiento (1-3 sem)",ejs:["Movilidad activa tobillo en todas direcciones","Isométricos peroneos multiángulo 5x10seg","Propiocepción en tabla wobble","Marcha normal progresiva"]},
        {f:"Fase 3 — Funcional (3-6 sem)",ejs:["Pliometría bilateral a unilateral","Agilidad en escalera de coordinación","Sprint con cambios de dirección","Entrenamiento reactivo con estímulo externo"]}
      ],
      rts:"Laxitud simétrica · Balance ≥90% · Hop test >85% · Sprint y COD sin dolor"},

    { n:"Esguince grado III", z:"Tobillo",
      e:["Inestabilidad grosera","Cajón anterior >10mm","RMN","Ottawa Ankle Rules"],
      p:"F1(0-2sem): Evaluación quirúrgica, inmovilización rígida.\nF2(2-6sem): Carga progresiva con bota.\nF3(6-16sem): Rehabilitación propioceptiva intensa.",
      fases:[
        {f:"Fase 1 — Aguda (0-2 sem)",ejs:["Yeso o bota walker rígida","Ejercicios cadera y rodilla no cargados","Electroanalgesia TENS","Circulación con bombas distales"]},
        {f:"Fase 2 — Subaguda (2-6 sem)",ejs:["Carga progresiva con bota","Movilidad activa del tobillo sin dolor","Fortalecimiento peroneos, tibiales y tríceps","Propiocepción fase inicial"]},
        {f:"Fase 3 — Funcional (6-16 sem)",ejs:["Propiocepción dinámica avanzada","Pliometría progresiva","Carrera y cambios de dirección","Entrenamiento específico del deporte"]}
      ],
      rts:"CAIT≥27 · Fuerza peroneal >90% · Balance ≥90% · Hop test >85% · Sin dolor en gesto deportivo"},

    { n:"Tendinitis aquilea", z:"Tobillo",
      e:["Dolor a la dorsiflexión pasiva","Engrosamiento del tendón","VISA-A cuestionario","Arc sign","Ecografía Doppler"],
      p:"F1(0-2sem): Isométricos pesados 5x45seg 2x/día.\nF2(2-8sem): HSR decline 4x15→4x6.\nF3(8-16sem): Excéntricos, pliometría, carrera.",
      fases:[
        {f:"Fase 1 — Control dolor (0-2 sem)",ejs:["Isométrico leg press 70%RM, 5x45seg, 2x/día","Crioterapia post-ejercicio","Sin carrera ni saltos","Heel lift si dolor insertional"]},
        {f:"Fase 2 — Carga progresiva (2-8 sem)",ejs:["Elevaciones de talón en máquina: 4x15→4x8 (añadir peso)","Sentadilla con talones elevados 4x15","Peso muerto rumano 3x12","Ciclismo o natación como cardio"]},
        {f:"Fase 3 — Retorno (8-16 sem)",ejs:["Excéntricos en decline board unilateral 3x15","Saltos en caja (drop jumps) progresivos","Carrera: 5-10-20min progresivo","Triple hop test para medir simetría"]}
      ],
      rts:"VISA-A≥90 · Salto monopodal >90% simetría · Trote 5km sin dolor · Fuerza plantar >90%"},

    { n:"Rotura parcial del Aquiles", z:"Tobillo",
      e:["Test de Thompson","Brecha palpable","Ecografía","Dolor agudo en pantorrilla"],
      p:"F1: Inmovilización en equino.\nF2: Carga progresiva según cicatrización.\nF3: Excéntricos, retorno deportivo.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-4 sem)",ejs:["Bota en equino 20°","Movilidad dedos y rodilla","Isométrico glúteo y cuádriceps","Crioterapia y elevación"]},
        {f:"Fase 2 — Carga progresiva (4-10 sem)",ejs:["Bota plana con carga progresiva","Elevaciones de talón bilaterales suaves","Bicicleta estática","Fortalecimiento de cadera y rodilla"]},
        {f:"Fase 3 — Funcional (10-20 sem)",ejs:["Excéntricos en decline board 3x15","Carrera progresiva","Pliometría controlada","Gestos deportivos específicos"]}
      ],
      rts:"Thompson negativo · VISA-A≥80 · Salto bilateral simétrico · Carrera 5km sin dolor"},

    { n:"Inestabilidad crónica de tobillo (CAI)", z:"Tobillo",
      e:["Cumberland CAIT (<24 puntos)","Balance Star Excursion Test","Historia de esguinces repetidos (≥2)","Test de cajón anterior"],
      p:"F1(0-3sem): Fortalecimiento peroneal, propiocepción básica.\nF2(3-8sem): Superficie inestable, entrenamiento reactivo.\nF3(8-16sem): Agilidad, pliometría, retorno.",
      fases:[
        {f:"Fase 1 — Base (0-3 sem)",ejs:["Isométricos de eversión con banda 3x15","Fortalecimiento glúteo medio (clamshell) 3x20","Propiocepción monopodal ojos abiertos 3x30seg","Marcha en superficies variadas"]},
        {f:"Fase 2 — Reactivo (3-8 sem)",ejs:["Balance en BOSU unilateral con perturbaciones 3x30seg","Saltos laterales con control 3x10","Mini-vallas de agilidad lateral","Fortalecimiento cadera: abducción resistida 3x15"]},
        {f:"Fase 3 — Específico (8-16 sem)",ejs:["Pliometría unipodal con cambios de dirección","Sprint con stops y arranques","Gestos específicos del deporte","Tobillera funcional si persiste aprensión"]}
      ],
      rts:"CAIT≥27 · Balance SEBT≥90% · Hop test >85% · Sprint y giro sin aprensión"},

    { n:"Periostitis tibial", z:"Tobillo",
      e:["Dolor cresta tibial en carrera","Palpación difusa cresta tibial medial","Test de percusión tibial","RMN"],
      p:"F1(0-2sem): Pausa de carrera, crioterapia, cambio calzado.\nF2(2-6sem): Fortalecimiento tibial y peroneal.\nF3(6-12sem): Retorno carrera +10%/sem.",
      fases:[
        {f:"Fase 1 — Descarga (0-2 sem)",ejs:["Pausa de carrera completa","Crioterapia tibial 15min x3/día","Bicicleta o natación alternativo","Análisis de calzado"]},
        {f:"Fase 2 — Fortalecimiento (2-6 sem)",ejs:["Inversión con banda elástica 3x15","Eversión con banda 3x15","Elevaciones de talón 3x20","Técnica de carrera: aumento de cadencia"]},
        {f:"Fase 3 — Retorno (6-12 sem)",ejs:["Walk-run progressions: caminar-trotar alternado","Carrera +10% km por semana","Superficies blandas (hierba, tierra)","Control de km con GPS"]}
      ],
      rts:"Palpación tibial sin dolor · Carrera 5km sin dolor · Cadencia >170"},

    { n:"Fractura por estrés tibial", z:"Tobillo",
      e:["Test de percusión tibial positivo","RMN (edema óseo)","Dolor focal en punto específico","DEXA si baja densidad"],
      p:"F1(0-4sem): Descarga TOTAL, evaluar DEXA y nutrición.\nF2(4-8sem): Carga progresiva con bota.\nF3(8-16sem): Carrera progresiva con control radiológico.",
      fases:[
        {f:"Fase 1 — Descarga total (0-4 sem)",ejs:["Muletas o descarga completa","Ejercicio en agua (acuaeróbics, natación)","DEXA ósea + suplemento Ca 1200mg + Vit D3 2000UI","Sin impacto"]},
        {f:"Fase 2 — Carga progresiva (4-8 sem)",ejs:["Bota walker con carga progresiva","Bicicleta estática sin impacto","Fortalecimiento muscular sin impacto","Control radiológico"]},
        {f:"Fase 3 — Retorno (8-16 sem)",ejs:["Walk-run con monitor de dolor","Carrera progresiva previa RMN","Calzado con absorción de impacto","Seguimiento médico"]}
      ],
      rts:"RMN: curación completa · Sin dolor focal · Carrera 5km sin dolor · DEXA normal"},

    // ===== 🦵 RODILLA =====
    { n:"Lesión LCA", z:"Rodilla",
      e:["Lachman Test","Pivot Shift Test","Cajón Anterior","RMN","IKDC cuestionario","Limb Symmetry Index (LSI)"],
      p:"Pre-op: Prehab 4-6sem.\nF1(0-6sem): Control dolor/edema, extensión completa.\nF2(6-12sem): Fuerza cuádriceps, bicicleta.\nF3(3-6mes): Fuerza máxima, carrera.\nF4(6-9mes): Pliometría, agilidad, retorno.",
      fases:[
        {f:"Fase 1 — Control inflamatorio (0-6 sem)",ejs:["SLR (straight leg raise) 3x20","Isométrico cuádriceps en extensión","Movilidad pasiva: extensión completa desde día 1","Bicicleta sin resistencia desde sem 2","Crioterapia post-sesión"]},
        {f:"Fase 2 — Fortalecimiento (6-12 sem)",ejs:["Prensa 0-60° 4x12 con carga progresiva","Sentadilla búlgara bilateral a unilateral 3x10","Step up frontal y lateral con carga 3x12","Leg curl acostado 3x12","Propiocepción en balance board"]},
        {f:"Fase 3 — Potencia (3-6 mes)",ejs:["Sentadilla con salto bilateral 3x8","Peso muerto unilateral 4x8","Carrera progresiva plana","Cambios de dirección a 45°","Box jump bilateral"]},
        {f:"Fase 4 — Retorno deportivo (6-9 mes)",ejs:["Pliometría unipodal: drop jump 3x8","Sprint 100% con cambios de dirección","Gestos específicos del deporte","Triple hop test para LSI"]}
      ],
      rts:"LSI cuádriceps ≥90% · Triple hop ≥90% · Pivot shift negativo · IKDC>85 · Mínimo 9 meses post-op"},

    { n:"Lesión LCP", z:"Rodilla",
      e:["Cajón posterior","Sag Sign","RMN","Dial Test (30° y 90°)"],
      p:"F1(0-4sem): Inmovilización en extensión, cuádriceps máximo.\nF2(4-10sem): Fortalecimiento agresivo cuádriceps.\nF3(10-20sem): Fuerza máxima, pliometría.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-4 sem)",ejs:["Cuádriceps isométrico en extensión 5x10x10seg","SLR con peso en tobillo 3x20","Movilidad cadera y tobillo","Crioterapia frecuente"]},
        {f:"Fase 2 — Cuádriceps (4-10 sem)",ejs:["Prensa bilateral 0-70° 4x15 alta carga","Terminal knee extension (TKE) con banda 3x20","Step down excéntrico 3x12","Ciclismo con resistencia moderada"]},
        {f:"Fase 3 — Funcional (10-20 sem)",ejs:["Sentadilla con barra 4x6","Pliometría bilateral progresiva","Carrera progresiva","Gestos específicos del deporte"]}
      ],
      rts:"Cuádriceps ≥90% · Cajón posterior <5mm · Triple hop ≥90% · Sin dolor en actividad"},

    { n:"Meniscopatía medial", z:"Rodilla",
      e:["Test de McMurray (rotación externa)","Test de Appley","Test de Thessaly 20°","RMN","Dolor en interlínea medial"],
      p:"F1(0-2sem): Descarga, control de edema.\nF2(2-6sem): Fortalecimiento cuádriceps e isquios.\nF3(6-12sem): Sentadilla profunda, carrera, pivotes.",
      fases:[
        {f:"Fase 1 — Descarga (0-2 sem)",ejs:["Cuádriceps isométrico multiángulo 5x10seg","Extensión rodilla OKC 0-60°","Crioterapia y TENS analgésico","Movilidad pasiva sin forzar flexión"]},
        {f:"Fase 2 — Fortalecimiento (2-6 sem)",ejs:["Prensa 0-90° con carga progresiva 4x12","Leg curl acostado 3x15","Fortalecimiento aductores con banda 3x15","Ciclismo estático sin dolor"]},
        {f:"Fase 3 — Funcional (6-12 sem)",ejs:["Sentadilla profunda progresiva","Lunges con rotación de tronco","Carrera progresiva en pista","Cambios de dirección y pivotes controlados"]}
      ],
      rts:"McMurray negativo · Sentadilla profunda sin dolor · Rotación sin bloqueo · Carrera 5km sin dolor"},

    { n:"Meniscopatía lateral", z:"Rodilla",
      e:["Test de McMurray (rotación interna)","Test de Appley","Dolor en interlínea lateral","RMN"],
      p:"F1: Antiinflamatorio, descarga.\nF2: Fortalecimiento de cuádriceps y control de valgo.\nF3: Carrera y pivotes controlados.",
      fases:[
        {f:"Fase 1 — Aguda (0-2 sem)",ejs:["Cuádriceps isométrico en extensión 5x10seg","Crioterapia y reposo relativo","Evitar rotación interna forzada","TENS analgésico"]},
        {f:"Fase 2 — Fortalecimiento (2-6 sem)",ejs:["Prensa unilateral 4x12","Leg curl 3x15","Fortalecimiento glúteo medio (valgo control) 3x20","Bicicleta sin dolor"]},
        {f:"Fase 3 — Funcional (6-12 sem)",ejs:["Sentadilla profunda sin valgo","Carrera progresiva","Pivotes controlados con espejo","Pliometría bilateral progresiva"]}
      ],
      rts:"McMurray negativo (RI) · Sentadilla profunda sin dolor · Sprint y pivote sin restricción"},

    { n:"Tendinitis rotuliana", z:"Rodilla",
      e:["Dolor polo inferior rotuliano","Decline Squat Test","VISA-P cuestionario","Palpación polo inferior en extensión"],
      p:"F1(0-2sem): Isométricos 5x45seg 2x/día.\nF2(2-8sem): HSR decline 4x15→4x6.\nF3(8-16sem): Pliometría, carrera, retorno.",
      fases:[
        {f:"Fase 1 — Analgesia (0-2 sem)",ejs:["Isométrico prensa 70%RM 5x45seg x2/día","Crioterapia post-sesión","Reducción de saltos/sprint","TENS si dolor >4 EVA"]},
        {f:"Fase 2 — Carga lenta pesada (2-8 sem)",ejs:["Sentadilla decline bilateral 4x15 a 4x6 con carga","Sentadilla unilateral decline progresiva","Prensa unilateral 4x8","Sin impacto (bicicleta, natación)"]},
        {f:"Fase 3 — Pliometría y retorno (8-16 sem)",ejs:["Drop jumps bilaterales a unilaterales 3x8","Saltos horizontales con aterrizaje controlado","Carrera progresiva con velocidad incremental","Gestos específicos del deporte"]}
      ],
      rts:"VISA-P≥80 · Decline squat sin dolor · Salto unipodal ≥90% simetría"},

    { n:"Condromalacia rotuliana", z:"Rodilla",
      e:["Test de Clarke","Dolor retropatelar en escaleras","Cepillo rotuliano","RMN (grado I-IV)","Tracking rotuliano"],
      p:"F1(0-3sem): Evitar dolor PF, VMO en rangos cortos.\nF2(3-8sem): Cuádriceps completo + abductores cadera, taping.\nF3(8-16sem): Reeducación biomecánica.",
      fases:[
        {f:"Fase 1 — Descarga PF (0-3 sem)",ejs:["Isométrico cuádriceps en extensión 5x10seg","Extensión terminal 0-30° con banda 3x15","Abducción cadera lateral con banda 3x20","Taping rotuliano McConnell"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["Sentadilla parcial 0-60° control valgo 4x12","Step up frontal con carga 3x12","Prensa unilateral rango completo 4x10","Fortalecimiento glúteo medio: clamshell y puente"]},
        {f:"Fase 3 — Reeducación (8-16 sem)",ejs:["Sentadilla completa con espejo (control rodilla)","Carrera con cadencia alta (>170 pasos/min)","Saltos con aterrizaje en triple flexión","Escaleras con control de postura"]}
      ],
      rts:"Escaleras sin dolor · Clarke negativo · Tracking rotuliano normal · Carrera 5km sin molestia"},

    { n:"Síndrome de banda iliotibial", z:"Rodilla",
      e:["Test de Ober","Test de Noble","Palpación epicóndilo lateral","Test de Renne (sentadilla a 30°)"],
      p:"F1(0-2sem): Reducción km carrera, liberación TFL.\nF2(2-6sem): Fortalecimiento glúteo medio, corrección marcha.\nF3(6-12sem): Retorno carrera progresivo.",
      fases:[
        {f:"Fase 1 — Control (0-2 sem)",ejs:["Foam roller TFL y glúteo menor 5min/día","Reducción volumen carrera 50%","Crioterapia post-carrera","Estiramiento TFL en posición Thomas"]},
        {f:"Fase 2 — Fortalecimiento cadera (2-6 sem)",ejs:["Clamshell con banda 3x20","Abducción lateral con cable 3x15","Hip thrust unilateral 4x10","Sentadilla monopodal con control valgo 3x10"]},
        {f:"Fase 3 — Retorno a carrera (6-12 sem)",ejs:["Walk-run progressions","Análisis de cadencia y zancada","Carrera en cinta con inclinación variable","Control valgo en salto con drop landing"]}
      ],
      rts:"Noble negativo · Ober sin restricción · Cadencia >170 · Carrera 10km sin dolor"},

    { n:"Síndrome patelofemoral", z:"Rodilla",
      e:["Dolor en escaleras/sentadilla","Tracking rotuliano","Test J-sign","Clarke Test"],
      p:"F1: VMO + abductores cadera, taping.\nF2: Sentadilla controlada, cadera.\nF3: Biomecánica carrera, retorno.",
      fases:[
        {f:"Fase 1 — Descarga PF (0-3 sem)",ejs:["Isométrico VMO 0-30° 3x15","Taping McConnell rotuliano","Abducción cadera con banda 3x20","Evitar escaleras y sentadilla profunda"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["Sentadilla parcial con control valgo 4x12","Hip thrust 4x10","Step up con carga 3x12","Propiocepción monopodal 3x30seg"]},
        {f:"Fase 3 — Funcional (8-16 sem)",ejs:["Carrera con cadencia corregida","Saltos con control de aterrizaje","Escaleras sin dolor","Gestos deportivos específicos"]}
      ],
      rts:"Escaleras sin dolor · Sentadilla profunda sin dolor · Carrera 5km sin molestia"},

    { n:"Artrosis temprana de rodilla", z:"Rodilla",
      e:["Rx Kellgren-Lawrence I-II","Rigidez matutina <30min","Crepitación","KOOS cuestionario"],
      p:"F1: Educación en dolor, aeróbico bajo impacto.\nF2: Fuerza cuádriceps e isquios.\nF3: Mantenimiento con ejercicio crónico.",
      fases:[
        {f:"Fase 1 — Educación y base (0-4 sem)",ejs:["Educación en biología del dolor articular","Ciclismo estático 20-30min/día","Cuádriceps isométrico multiángulo 3x10x10seg","Hidroterapia si disponible"]},
        {f:"Fase 2 — Fortalecimiento (1-3 mes)",ejs:["Prensa bilateral baja carga 4x15","Sentadilla parcial 0-60° 3x15","Natación estilo libre 30min","Fortalecimiento cadera: puente, clamshell"]},
        {f:"Fase 3 — Mantenimiento (3-6 mes)",ejs:["Programa ejercicio supervisado 3x/sem","Marcha nórdica o caminata 45min/día","Flexibilidad general diaria","Control IMC y nutrición antiinflamatoria"]}
      ],
      rts:"KOOS≥70 · Sin exacerbaciones con actividad moderada · Fuerza cuádriceps adecuada"},

    { n:"Rodilla del saltador", z:"Rodilla",
      e:["Dolor polo inferior rotuliano","VISA-P cuestionario","Decline Squat Test","Salto monopodal"],
      p:"F1: Isométricos pesados analgesia.\nF2: HSR decline 4x15→4x6.\nF3: Pliometría progresiva, retorno al salto.",
      fases:[
        {f:"Fase 1 — Analgesia (sem 1-2)",ejs:["Isométrico decline 70%RM 5x45seg 2x/día","Crioterapia post-sesión","Reducción volumen saltos 70%","TENS analgésico"]},
        {f:"Fase 2 — HSR (sem 2-8)",ejs:["Decline squat bilateral con mochila 4x15 a 4x6","Prensa unilateral 0-90° 4x10","Leg curl 3x15","Bicicleta como aeróbico bajo impacto"]},
        {f:"Fase 3 — Pliometría (sem 8-16)",ejs:["Drop jump bilateral a unilateral 3x8","Salto vertical máximo progresivo","CMJ (salto con contraataque)","Gestos de remate y salto del deporte"]}
      ],
      rts:"VISA-P≥80 · Decline squat sin dolor · Salto unipodal ≥90% · Gesto de remate sin dolor"},

    { n:"Rodilla del corredor", z:"Rodilla",
      e:["Test de Noble","Test de Ober","Palpación epicóndilo lateral","Km semanales previos"],
      p:"F1: Reducción km 50%, liberación TFL.\nF2: Fortalecimiento cadera, corrección técnica.\nF3: Retorno carrera +10%/semana.",
      fases:[
        {f:"Fase 1 — Reducción de carga (0-2 sem)",ejs:["Foam roller TFL 5min/día","Reducción km 50%","Análisis cadencia (objetivo >170 pasos/min)","Crioterapia post-carrera"]},
        {f:"Fase 2 — Fortalecimiento cadera (2-6 sem)",ejs:["Clamshell con banda 3x20","Single-leg hip thrust 4x10","Sentadilla unilateral control valgo 3x10","Corrección técnica aterrizaje"]},
        {f:"Fase 3 — Retorno (6-12 sem)",ejs:["Programa 10%: aumentar km 10% cada semana","Carrera plana a irregular a cuestas","Monitor cadencia en reloj deportivo","Análisis de carrera (gait analysis)"]}
      ],
      rts:"Noble negativo · Cadencia >170 · Carrera 10km sin dolor · Control valgo en aterrizaje"},

    // ===== 💪 HOMBRO =====
    // ── MANGUITO ROTADOR — Los 4 músculos + conjunto ──────────────────────────

    { n:"Manguito rotador — tendinopatía global (todos los tendones)", z:"Hombro",
      e:["Test de Jobe/Empty Can (supraespinoso)","Full Can Test","Test de Patte (infraespinoso)","Test de Gerber/Lift-off (subescapular)","Test de Hornblower (redondo menor)","Ecografía dinámica 4 tendones","RMN hombro con gadolinio"],
      p:"F1(0-4sem): Descarga, isométricos indoloros por músculo.\nF2(4-10sem): Excéntrico individualizado, control escapular.\nF3(10-20sem): Concéntrico-excéntrico, overhead, retorno.",
      fases:[
        {f:"Fase 1 — Descarga y analgesia (0-4 sem)",ejs:["Isométrico supraespinoso (empty can a 30°) 3x10x45seg","Isométrico infraespinoso (RE en neutro) 3x10x45seg","Isométrico subescapular (RI en neutro) 3x10x45seg","Isométrico redondo menor (RE a 90° ABD) 3x10x45seg","Péndulos Codman 3x5min","Crioterapia 15min x3/día","Control escapular básico"]},
        {f:"Fase 2 — Excéntrico por músculo (4-10 sem)",ejs:["Excéntrico supraespinoso: full can bajada lenta 4x15","Excéntrico infraespinoso: RE lateral decúbito 4x15","Excéntrico subescapular: RI con banda 4x15","RE a 90° ABD (redondo menor) con banda 3x15","Serrato anterior: serratus punch 3x15","Trapecio inferior: Y en decúbito prono 3x15","Remo horizontal con RE final 3x15"]},
        {f:"Fase 3 — Carga completa y overhead (10-20 sem)",ejs:["Full can con mancuerna 4x12","RE con mancuerna en plano escapular 4x12","Press en plano escapular 4x10","Remo con supinación 4x10","Diagonal D2 con banda 3x15","Ejercicios isocinéticos RE/RI","Overhead progresivo hasta rango completo"]}
      ],
      rts:"Ratio RE/RI >66% · Jobe, Patte, Lift-off, Hornblower negativos · Overhead sin dolor · Fuerza ≥85%"},

    { n:"Supraespinoso — tendinopatía (arco doloroso)", z:"Hombro",
      e:["Test de Jobe (Empty Can a 90°/30°)","Full Can Test","Test de Neer","Test de Hawkins-Kennedy","Arco doloroso 60°-120°","Ecografía (engrosamiento, hipoecogenicidad)","RMN (señal aumentada sin rotura)"],
      p:"F1(0-3sem): Analgesia, isométrico indoloro.\nF2(3-8sem): Excéntrico supraespinoso, espacio subacromial.\nF3(8-16sem): Full can progresivo, overhead.",
      fases:[
        {f:"Fase 1 — Analgesia (0-3 sem)",ejs:["Isométrico abducción 30° (empty can) 3x10x45seg","Péndulos Codman sin carga 3x5min","Crioterapia 15min x3","TENS intereferencial subacromial","Corrección postural escapular"]},
        {f:"Fase 2 — Excéntrico (3-8 sem)",ejs:["Full can excéntrico con mancuerna ligera 4x15 (bajar 4seg)","Elevación lateral excéntrica en plano escapular 4x15","Depresión escapular activa con polea 3x15","RE con banda en neutro 3x15","Wall slides 3x12"]},
        {f:"Fase 3 — Carga y overhead (8-16 sem)",ejs:["Full can con carga progresiva 4x12","Elevación plano escapular hasta 150° 4x12","Press militar controlado 4x10","Pulldown con control escapular 4x10","Gestos deportivos específicos"]}
      ],
      rts:"Jobe y Hawkins negativos · Arco completo sin dolor · Fuerza abducción ≥85%"},

    { n:"Infraespinoso — tendinopatía y debilidad de RE", z:"Hombro",
      e:["Test de Patte (RE a 90° ABD)","Test de Hornblower (RE a 90° codo flexo)","Fuerza RE isocinética","Ecografía infraespinoso","RMN (señal, atrofia)","Palpación fosa infraespinosa"],
      p:"F1(0-3sem): Isométrico RE, descarga.\nF2(3-8sem): Excéntrico RE, diagonal D2.\nF3(8-16sem): Potencia RE, lanzamiento.",
      fases:[
        {f:"Fase 1 — Isométrico RE (0-3 sem)",ejs:["Isométrico RE en neutro contra pared 3x10x45seg","Isométrico RE a 45° ABD 3x10x45seg","Crioterapia fosa infraespinosa","Evitar carga excéntrica máxima inicial","Péndulos Codman 2x5min"]},
        {f:"Fase 2 — Excéntrico RE (3-8 sem)",ejs:["Side-lying RE excéntrico con mancuerna 4x15 (bajar 4seg)","RE con banda a 0° excéntrico 4x15","Diagonal D2 con banda 3x15","Remo con RE final 3x15","RE a 90° ABD con banda 3x15"]},
        {f:"Fase 3 — Potencia (8-16 sem)",ejs:["RE a 90° con carga progresiva 4x12","Test isocinético RE (objetivo >66% RI)","Pliometría RE con pelota medicinal 3x10","Lanzamiento progresivo si deportista","Análisis biomecánico RE en gesto deportivo"]}
      ],
      rts:"Patte negativo · RE/RI ratio >66% · Pliometría sin dolor · Lanzamiento completo"},

    { n:"Subescapular — tendinopatía y debilidad de RI", z:"Hombro",
      e:["Test de Lift-off (Gerber)","Test de presión abdominal (Belly Press)","Test de Bear-Hug","Test de Napoleon","Ecografía subescapular (cara anterior)","RMN (porción superior más vulnerable)"],
      p:"F1(0-3sem): Isométrico RI, evitar RE forzada.\nF2(3-8sem): Excéntrico RI, diagonal D1.\nF3(8-16sem): Press, RI funcional, retorno.",
      fases:[
        {f:"Fase 1 — Isométrico RI (0-3 sem)",ejs:["Isométrico RI en neutro contra pared 3x10x45seg","Isométrico RI a 45° 3x10x45seg","Crioterapia región anterior hombro","Evitar RE pasiva forzada","Educación sobre posición protegida"]},
        {f:"Fase 2 — Excéntrico RI (3-8 sem)",ejs:["RI excéntrica con banda en neutro 4x15 (volver 4seg)","Diagonal D1 con banda (RI+ADD+flex) 3x15","Bear-hug con resistencia progresiva 3x15","Press cerrado (push-up) con control 3x12","Remo con RI final 3x15"]},
        {f:"Fase 3 — Press y retorno (8-16 sem)",ejs:["Press plano progresivo con control escapular 4x10","RI con polea a velocidades 4x12","Belly press test como control de progreso","Gestos de empuje/lanzamiento","Test Lift-off: objetivo simetría"]}
      ],
      rts:"Lift-off, Belly-press y Bear-hug negativos · Fuerza RI ≥85% · Press sin dolor"},

    { n:"Redondo menor — tendinopatía (RE a 90° ABD)", z:"Hombro",
      e:["Test de Hornblower (RE a 90° con codo flexo)","Test de Patte (diferencial infraespinoso)","Palpación borde axilar escápula","Ecografía redondo menor","RMN (músculo, atrofia grasa)","EMG si neuropatía axilar asociada"],
      p:"F1(0-3sem): Isométrico RE a 90°, descargar.\nF2(3-8sem): Excéntrico RE a 90°.\nF3(8-16sem): Potencia RE, retorno.",
      fases:[
        {f:"Fase 1 — Isométrico a 90° (0-3 sem)",ejs:["Isométrico RE a 90° ABD contra pared 3x10x30seg","Isométrico RE en decúbito lateral a 90° 3x10x30seg","Crioterapia borde axilar escapular","Evitar RE máxima bajo carga","Péndulos Codman 2x5min"]},
        {f:"Fase 2 — Excéntrico RE a 90° (3-8 sem)",ejs:["RE excéntrica a 90° ABD con banda 4x15","Decúbito lateral RE a 90° con mancuerna 4x15","Diagonal D2 énfasis RE final 3x15","Control motor escapular 3x15","Propiocepción a 90° ABD 3x30seg"]},
        {f:"Fase 3 — Potencia a 90° (8-16 sem)",ejs:["RE a 90° con carga alta 4x10","Pliometría RE a 90° con pelota 3x10","Lanzamiento con énfasis fase de aceleración","Test Hornblower: objetivo simetría","Retorno deportivo progresivo"]}
      ],
      rts:"Hornblower negativo · RE a 90° fuerza ≥80% · Sin compensación deltoides"},



    { n:"Bursitis subacromial", z:"Hombro",
      e:["Arco doloroso 60°-120°","Test de Neer","Test de Kennedy-Hawkins","Test de Yocum","Ecografía"],
      p:"F1(0-2sem): Fisioterapia analgésica, isométricos en neutro.\nF2(2-6sem): Movilización subacromial, rotadores externos.\nF3(6-12sem): Overhead progresivo.",
      fases:[
        {f:"Fase 1 — Analgesia (0-2 sem)",ejs:["Ultrasonido terapéutico en bursa","Isométrico RE en 0° 5x10seg","Evitar abducción sobre 60°","Péndulos Codman suaves"]},
        {f:"Fase 2 — Descompresión (2-6 sem)",ejs:["Movilización GH posteroinferior grado III/IV","Fortalecimiento depresores cabeza humeral","Rotación externa con banda 3x15","Control escapular: retracción y depresión"]},
        {f:"Fase 3 — Overhead (6-12 sem)",ejs:["Press overhead progresivo 4x10","Ejercicios hombro en polea alta","Lanzamiento progresivo si deporte","Estabilización dinámica con perturbaciones"]}
      ],
      rts:"Neer y Hawkins negativos · Arco doloroso negativo · Overhead sin dolor · RE≥90%"},

    { n:"Luxación hombro", z:"Hombro",
      e:["Signo de la charretera","Rx AP+axial","Test de aprensión anterior","Test de recolocación"],
      p:"F1(0-3sem): Cabestrillo, isométricos en neutro.\nF2(3-8sem): Movilidad progresiva, manguito y serrato.\nF3(8-16sem): Estabilización dinámica, overhead.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-3 sem)",ejs:["Cabestrillo 0-30° RI","Movilidad activa codo, muñeca y mano","Isométrico RE en neutro 5x10seg","Crioterapia 3x/día"]},
        {f:"Fase 2 — Movilidad (3-8 sem)",ejs:["ROM GH progresivo (Codman a activo-asistido a activo)","Fortalecimiento RE 3x15","Press up sentado (serrato)","Estabilizadores escapulares"]},
        {f:"Fase 3 — Estabilización (8-16 sem)",ejs:["Ejercicios estabilización en plano inestable","Overhead progresivo con control","Lanzamiento progresivo si deporte","Pliometría de hombro con balón medicinal"]}
      ],
      rts:"Aprensión negativa · RE/RI ≥90% · Overhead sin restricción · Gesto deportivo sin aprensión"},

    { n:"Síndrome SLAP", z:"Hombro",
      e:["Test de OBrien","Speed Test","Crank Test","RMN artro-RM"],
      p:"F1: Evitar carga supinación forzada, isométricos.\nF2: Fortalecimiento rotadores y bíceps.\nF3: Overhead progresivo y gestos deportivos.",
      fases:[
        {f:"Fase 1 — Protección (0-4 sem)",ejs:["Isométrico hombro multiángulo sin provocar dolor","Evitar carga en supinación forzada","Péndulos Codman 2x5min","Control escapular básico"]},
        {f:"Fase 2 — Fortalecimiento (4-10 sem)",ejs:["Rotación externa con banda 3x15","Fortalecimiento bíceps con supinación 3x12","Remo 3x12","Fortalecimiento serrato anterior"]},
        {f:"Fase 3 — Overhead (10-20 sem)",ejs:["Overhead progresivo con control","Lanzamiento progresivo","Pliometría de hombro","Gestos deportivos específicos"]}
      ],
      rts:"OBrien negativo · Overhead sin dolor · Lanzamiento sin restricción · Sin aprensión"},

    { n:"Capsulitis adhesiva (hombro congelado)", z:"Hombro",
      e:["Pérdida ROM todas las direcciones","RE limitada 50%","Abducción limitada 50%","Rx normal","Duración >3 meses"],
      p:"F1(0-3mes): Analgesia, movilidad pasiva suave.\nF2(3-9mes): Movilizaciones grado III/IV, estiramientos cápsula.\nF3(9-18mes): Fortalecimiento progresivo.",
      fases:[
        {f:"Fase 1 — Dolor (0-3 mes)",ejs:["Movilizaciones pasivas grado I-II sin dolor","Péndulos Codman 3x5min/día","Termoterapia previa 15min","TENS analgésico"]},
        {f:"Fase 2 — Rigidez (3-9 mes)",ejs:["Movilizaciones articulares grado III/IV","Sleeper stretch cápsula posterior 3x30seg","Pulley overhead activo-asistido","Hidrodistensión si persiste"]},
        {f:"Fase 3 — Resolución (9-18 mes)",ejs:["Fortalecimiento manguito en rango ganado","Press de hombro progresivo","Ejercicios funcionales AVD","Retorno deportivo gradual"]}
      ],
      rts:"ROM ≥80% contralateral · AVD sin restricción · Fuerza manguito ≥80%"},

    { n:"Epicondilitis (codo tenista)", z:"Hombro",
      e:["Test de Cozen","Test de Maudsley","Palpación epicóndilo lateral","PRTEE cuestionario","Ecografía"],
      p:"F1(0-2sem): Descarga, isométricos extensores muñeca.\nF2(2-6sem): Tyler Twist o excéntrico con mancuerna.\nF3(6-12sem): Fortalecimiento agarre, retorno.",
      fases:[
        {f:"Fase 1 — Descarga (0-2 sem)",ejs:["Isométrico extensores muñeca en neutro 5x45seg","Evitar gesto provocador","Crioterapia post-trabajo 10min","Codadera (epicondyle strap)"]},
        {f:"Fase 2 — Excéntrico (2-6 sem)",ejs:["Tyler Twist con Theraband Flexbar: 3x15/día","Extensión muñeca con mancuerna excéntrica 3x15","Fortalecimiento supinador y pronador 3x15","Masaje transverso profundo (Cyriax)"]},
        {f:"Fase 3 — Funcional (6-12 sem)",ejs:["Fortalecimiento agarre progresivo","Cadena cinética miembro superior","Retorno al gesto deportivo (raqueta)","Análisis biomecánico del gesto"]}
      ],
      rts:"PRTEE<10 · Cozen negativo · Agarre sin dolor · 3 meses sin recaída"},

    { n:"Hombro del nadador", z:"Hombro",
      e:["Test de Neer","Test de Hawkins-Kennedy","GIRD (déficit rotación interna)","Test de aprensión","Análisis de la brazada"],
      p:"F1(0-2sem): Reducción volumen nado, movilidad cápsula posterior.\nF2(2-6sem): Retractores escapulares y RE, corrección GIRD.\nF3(6-12sem): Retorno progresivo al nado.",
      fases:[
        {f:"Fase 1 — Reducción carga (0-2 sem)",ejs:["Sleeper stretch cápsula posterior 3x30seg","Reducción volumen 50%","Crioterapia post-entreno","Cross-body stretch 3x30seg"]},
        {f:"Fase 2 — Fortalecimiento (2-6 sem)",ejs:["Rotación externa con banda plano escapular 3x15","Remo en T 3x12","Face pull con cable 3x15","Push up plus (serrato) 3x15"]},
        {f:"Fase 3 — Retorno nado (6-12 sem)",ejs:["Análisis de brazada con coach","Nado con palas de mano","Retorno progresivo de metros +10%/semana","Ejercicios movilidad específicos de la brazada"]}
      ],
      rts:"GIRD<15° · Neer y Hawkins negativos · Nado completo sin dolor · Técnica corregida"},

    // ===== 🦴 COLUMNA =====
    { n:"Lumbalgia mecánica", z:"Espalda",
      e:["Test de movilidad lumbar (Schober)","Test de flexión anterior","Evaluación postural","STarT Back Tool","Oswestry Disability Index"],
      p:"F1(0-2sem): Educación, marcha suave, cat-camel.\nF2(2-6sem): McGill Big 3, glúteos, cadera.\nF3(6-12sem): Carga funcional, retorno deportivo.",
      fases:[
        {f:"Fase 1 — Educación y movilidad (0-2 sem)",ejs:["Marcha suave 20-30min/día","Movilidad lumbar: cat-camel 3x10","Bird-dog isométrico 3x10x10seg","Educación en neurociencia del dolor"]},
        {f:"Fase 2 — Estabilización (2-6 sem)",ejs:["McGill Big 3: curl-up, side plank, bird-dog","Puente glúteo bilateral a unilateral 3x15","Peso muerto desde rodillas 4x8","Fortalecimiento rotadores cadera"]},
        {f:"Fase 3 — Carga funcional (6-12 sem)",ejs:["Sentadilla con barra 4x8","Peso muerto completo 4x6","Paloff press (anti-rotación) 3x10","Gestos deportivos específicos bajo carga"]}
      ],
      rts:"Oswestry<20% · Carga axial sin dolor · Core simétrico · Deporte sin restricción"},

    { n:"Hernia discal lumbar", z:"Espalda",
      e:["RMN (nivel y grado)","Test de Lasègue (SLR)","Test de Bragard","Déficit neurológico focal","Oswestry Index"],
      p:"F1(0-4sem): McKenzie si centraliza, evitar flexión lumbar.\nF2(4-10sem): Estabilización segmentaria, extensión progresiva.\nF3(10-20sem): Fortalecimiento global, retorno.",
      fases:[
        {f:"Fase 1 — Centralización (0-4 sem)",ejs:["McKenzie extensiones en prono 3x10 si centraliza","Marcha suave 20min/día","Postura sedente correcta con lordosis","Neurodinamia suave (SLR activo) si tolera"]},
        {f:"Fase 2 — Estabilización (4-10 sem)",ejs:["Activación transverso abdominal 3x10x10seg","Bird-dog progresivo 3x10","Extensión lumbar en máquina 3x15","Puente glúteo progresivo 3x15"]},
        {f:"Fase 3 — Carga (10-20 sem)",ejs:["Peso muerto con barra desde bloques 4x8","Sentadilla con carga 4x8","Rotación controlada con resistencia","Retorno deportivo progresivo"]}
      ],
      rts:"Lasègue negativo · Déficit neurológico resuelto · Oswestry<20% · Carga axial sin irradiación"},

    { n:"Ciatalgia", z:"Espalda",
      e:["Test de Lasègue (SLR)","Test de Bragard","Test de Slump","Evaluación neurológica L4-S1","RMN"],
      p:"F1(0-3sem): Neurodinamia del nervio ciático, educación.\nF2(3-8sem): Estabilización lumbar, movilidad cadera.\nF3(8-16sem): Fortalecimiento integrado, retorno.",
      fases:[
        {f:"Fase 1 — Neurodinamia (0-3 sem)",ejs:["SLR activo: deslizamiento neuromeníngeo 3x10","Slump stretch suave sentado 3x10","Movilidad lumbar en decúbito (cat-camel)","Educación en sensibilización central"]},
        {f:"Fase 2 — Estabilización (3-8 sem)",ejs:["Apertura foraminal lateral en flexión","Core: bird-dog, puente, side plank","Estiramiento piriforme (FAIR) 3x30seg","Fortalecimiento glúteo mayor y medio"]},
        {f:"Fase 3 — Carga (8-16 sem)",ejs:["Peso muerto progresivo","Sentadilla con control lumbar","Cadena posterior integrada","Retorno deportivo gradual"]}
      ],
      rts:"SLR y Slump negativos · Fuerza neurológica recuperada · Marcha sin déficit"},

    { n:"Cervicalgia mecánica", z:"Espalda",
      e:["ROM cervical (goniometría)","Test flexión craneocervical","Palpación paravertebral","Evaluación postural"],
      p:"F1: Movilidad cervical, isométricos flexores profundos.\nF2: Fortalecimiento flexores profundos y trapecio.\nF3: Ergonomía y retorno funcional.",
      fases:[
        {f:"Fase 1 — Movilidad (0-2 sem)",ejs:["Movilidad cervical activa en todos los planos 3x10","Retracciones cervicales suaves 3x15","TENS cervical si dolor agudo","Termoterapia local"]},
        {f:"Fase 2 — Fortalecimiento (2-6 sem)",ejs:["Test y ejercicio CCFT (craniocervical flexion) 3x10","Fortalecimiento trapecio inferior 3x15","Estiramiento angular suboccipital 3x30seg","Ergonomía de pantalla y escritorio"]},
        {f:"Fase 3 — Funcional (6-12 sem)",ejs:["Control motor cervical bajo carga","Fortalecimiento de hombro integrado","Gestos deportivos específicos","Pausas activas en trabajo"]}
      ],
      rts:"ROM cervical completo · CCFT normalizado · Sin dolor en actividad laboral/deportiva"},


    // ===== 💪 HOMBRO — LESIONES COMPLETAS (DEPORTIVAS Y CLÍNICAS) =====

    { n:"Síndrome de impingement subacromial (SIS)", z:"Hombro",
      e:["Test de Neer","Test de Hawkins-Kennedy","Test de Yocum","Arco doloroso (60-120°)","Ecografía dinámica subacromial","RMN hombro"],
      p:"F1(0-3sem): Analgesia, reposo relativo, postura.\nF2(3-8sem): Espacio subacromial, control escapular, rotadores externos.\nF3(8-16sem): Fortalecimiento completo, overhead progresivo.",
      fases:[
        {f:"Fase 1 — Analgesia y postura (0-3 sem)",ejs:["Crioterapia 15min x3/día","Corrección postural en espejo","Retracción escapular isométrica 3x10x10seg","Péndulos Codman 2x5min","TENS o ultrasonido subacromial"]},
        {f:"Fase 2 — Control escapular (3-8 sem)",ejs:["Rotación externa con banda en neutro 3x15","Depresión escapular con polea 3x15","Remo horizontal con control escapular 3x15","Wall slides en plano escapular 3x12","Fortalecimiento serrato anterior (serratus punch) 3x15"]},
        {f:"Fase 3 — Overhead progresivo (8-16 sem)",ejs:["Press militar con control escapular 4x10","Rotación externa a 90° abducción 3x15","Elevación lateral en plano escapular hasta 150° 4x12","Ejercicios funcionales overhead","Análisis biomecánico del gesto deportivo"]}
      ],
      rts:"Arco sin dolor · Fuerza RE/RI ≥80% contralateral · Overhead sin compensación"},

    { n:"Inestabilidad glenohumeral anterior (TUBS)", z:"Hombro",
      e:["Test de aprensión anterior (Crank Test)","Test de recolocación (Jobe Relocation)","Test del surco (Sulcus Sign)","Test de Gagey","Rx anteroposterior y axilar","RMN o artroRMN (lesión Bankart)"],
      p:"F1(0-4sem): Control dolor, isométricos seguros, evitar RE+ABD.\nF2(4-12sem): Propiocepción, co-contracción, rotadores.\nF3(12-24sem): Estabilidad dinámica, gestos deportivos.",
      fases:[
        {f:"Fase 1 — Protección (0-4 sem)",ejs:["Isométrico RI/RE en neutro 3x10x10seg","Evitar posición de riesgo (ABD+RE+Ext)","Activación deltoides isométrico multiángulo","Control postural escapular","Crioterapia y educación al paciente"]},
        {f:"Fase 2 — Estabilización (4-12 sem)",ejs:["Co-contracción glenohumeral en apoyo 3x15","Propiocepción en tablero inestable 3x30seg","RE con banda a 45° y 90° de ABD 3x15","Remo en plano escapular 3x15","Push-up plus (activación serrato) 3x15"]},
        {f:"Fase 3 — Dinámico (12-24 sem)",ejs:["Lanzamiento progresivo (programa 8 semanas)","Pliometría de hombro con pelota medicinal 3x10","Gestos deportivos específicos con control","Prueba de RTS con dinamometría","Entrenamiento de fuerza overhead completo"]}
      ],
      rts:"Test aprensión negativo · Fuerza RE/RI ratio >66% · Sin aprehensión en gesto deportivo"},

    { n:"Inestabilidad glenohumeral multidireccional (AMBRI)", z:"Hombro",
      e:["Sulcus Sign bilateral","Test de carga y desplazamiento","Test de aprensión multidireccional","Beighton Score (hiperlaxitud)","RMN para descartar patología estructural"],
      p:"F1(0-6sem): Educación, evitar posiciones extremas, isométricos.\nF2(6-16sem): Programa Rockwood, co-contracción, escapular.\nF3(16-30sem): Fuerza completa, retorno progresivo.",
      fases:[
        {f:"Fase 1 — Educación y base (0-6 sem)",ejs:["Educación sobre hiperlaxitud y control motor","Isométrico multiángulo en rango seguro 3x10x10seg","Activación rotadores en plano escapular 3x15","Evitar tracciones y colgarse","Control postural en AVD"]},
        {f:"Fase 2 — Programa Rockwood (6-16 sem)",ejs:["Rotación externa con banda en plano escapular 4x15","Co-contracción con pelota en pared 3x30seg","Fortalecimiento deltoides en plano escapular 3x15","Serrato anterior progresivo 3x15","Estabilización escapular completa 4x12"]},
        {f:"Fase 3 — Fuerza y retorno (16-30 sem)",ejs:["Press en plano escapular con cargas progresivas","Remo y tracción con control proximal 4x10","Gestos deportivos con feedback visual","Programa de mantenimiento domiciliario","Retorno deportivo progresivo"]}
      ],
      rts:"Control motor articular normalizado · Sin sensación de inestabilidad · Fuerza ≥85% contralateral"},

    { n:"Lesión de Bankart (labrum anterior)", z:"Hombro",
      e:["Test de aprensión y recolocación","Test de Clunk","Test de O'Brien","ArtroRMN (gold standard)","Rx para valorar Hill-Sachs asociado"],
      p:"Post-quirúrgico: F1(0-6sem): Cabestrillo, isométricos suaves.\nF2(6-14sem): ROM activo, rotadores, escapular.\nF3(14-24sem): Fuerza completa, gestos deportivos.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-6 sem)",ejs:["Cabestrillo 4-6 semanas (RE limitada a 0°)","Péndulos Codman sin carga 2x5min","Isométrico RI en neutro 3x10x10seg","Movilidad codo y muñeca","Control edema y dolor"]},
        {f:"Fase 2 — ROM y fortalecimiento (6-14 sem)",ejs:["ROM activo-asistido progresivo sin forzar RE","Rotación interna con banda 3x15","Depresión escapular y retracción 3x15","Bíceps y tríceps sin carga axial 3x15","Propiocepción glenohumeral 3x30seg"]},
        {f:"Fase 3 — Retorno deportivo (14-24 sem)",ejs:["RE progresiva hasta rango completo 4x15","Lanzamiento progresivo (Thrower's Ten)","Pliometría de hombro 3x10","Gestos específicos del deporte","Test de RTS (dinamometría, ROM completo)"]}
      ],
      rts:"ROM completo · Fuerza RE/RI >66% · Test aprensión negativo · Sin episodios inestabilidad"},

    { n:"Lesión SLAP tipo II-IV", z:"Hombro",
      e:["Test de O'Brien (compresión activa)","Test de Speed","Test de Yergason","Test de Mayo Shear","ArtroRMN (gold standard)","Evaluación bíceps larga porción"],
      p:"F1(0-6sem): Protección, evitar ABD+RE+Ext, isométricos.\nF2(6-14sem): ROM controlado, bíceps, manguito.\nF3(14-26sem): Overhead progresivo, gestos deportivos.",
      fases:[
        {f:"Fase 1 — Protección (0-6 sem)",ejs:["Evitar ABD+RE+extensión combinados","Isométrico manguito en neutro 3x10x10seg","Movilidad activa del codo 3x15","Crioterapia y control inflamatorio","Corrección postural escapular"]},
        {f:"Fase 2 — ROM y bíceps (6-14 sem)",ejs:["ROM glenohumeral activo-asistido","Fortalecimiento bíceps concéntrico suave 3x15","Rotación externa con banda 45° ABD 3x15","Push-up plus 3x15","Remo escapular 3x15"]},
        {f:"Fase 3 — Overhead y lanzamiento (14-26 sem)",ejs:["Overhead progresivo desde 90° a completo","Programa de lanzamiento escalonado (12 semanas)","Pliometría de hombro con pelota medicinal","Ejercicios de Thrower's Ten","Retorno deporte con test funcional"]}
      ],
      rts:"O'Brien negativo · ROM completo · Lanzamiento sin dolor · Fuerza manguito ≥85%"},

    { n:"Rotura del supraespinoso (parcial — cara articular)", z:"Hombro",
      e:["Test de Jobe (arco de 90°)","Test de Neer y Hawkins","Ecografía dinámica","RMN hombro (clasificación Ellman)","Test de fuerza isocinética"],
      p:"F1(0-4sem): Descarga relativa, analgesia, isométricos indoloros.\nF2(4-10sem): Fortalecimiento excéntrico, control escapular.\nF3(10-20sem): Carga progresiva, overhead.",
      fases:[
        {f:"Fase 1 — Descarga y analgesia (0-4 sem)",ejs:["Isométrico supraespinoso en plano escapular 30° 3x10x10seg","Crioterapia 15min x3","TENS intereferencial","Corrección postural en sedestación","Péndulos Codman 2x5min"]},
        {f:"Fase 2 — Excéntrico y escapular (4-10 sem)",ejs:["Elevación excéntrica en plano escapular 3x15","Rotación externa excéntrica con banda 3x15","Fortalecimiento serrato y trapecio inferior 3x15","Full can en plano escapular 4x12","Wall slides 3x12"]},
        {f:"Fase 3 — Carga completa (10-20 sem)",ejs:["Elevación lateral en plano escapular 4x12 con carga","Press en plano escapular 4x10","Remo horizontal 4x10","Ejercicios de potencia (velocidades altas)","Retorno progresivo al deporte"]}
      ],
      rts:"Jobe negativo · Fuerza supraespinoso ≥80% · Overhead sin dolor · Ecografía control"},

    { n:"Rotura del infraespinoso y redondo menor", z:"Hombro",
      e:["Test de Patte (RE a 90°)","Test de Hornblower","Fuerza RE isocinética","RMN (extensión y retracción muscular)","Ecografía dinámica"],
      p:"F1(0-4sem): Protección RE, isométricos indoloros.\nF2(4-12sem): RE excéntrica, ABD plano escapular.\nF3(12-24sem): Potencia RE, gestos deportivos.",
      fases:[
        {f:"Fase 1 — Protección (0-4 sem)",ejs:["Isométrico RE en 0° ABD 3x10x10seg","Crioterapia","Movilidad activa codo y muñeca","Corrección postural","Educación sobre posición de riesgo"]},
        {f:"Fase 2 — RE progresiva (4-12 sem)",ejs:["RE excéntrica con banda en neutro 4x15","RE a 45° ABD con banda 3x15","Side-lying RE con mancuerna 3x12","Remo con RE final 3x15","Propiocepción con ojos cerrados 3x30seg"]},
        {f:"Fase 3 — Potencia (12-24 sem)",ejs:["RE a 90° ABD con carga 4x12","Pliometría de RE con pelota medicinal","Lanzamiento progresivo","Gestos deportivos específicos de RE","Test isocinético de control"]}
      ],
      rts:"Patte negativo · RE fuerza ≥80% · Ratio RE/RI >66% · Gestos sin compensación"},

    { n:"Rotura del subescapular", z:"Hombro",
      e:["Test de Lift-off (Gerber)","Test de presión abdominal (belly press)","Test de Bear-Hug","RMN hombro (extensión lesión)","Ecografía dinámica"],
      p:"F1(0-6sem): Cabestrillo, evitar RE, isométricos RI.\nF2(6-14sem): RI progresiva, press, escapular.\nF3(14-24sem): Fuerza completa, overhead.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-6 sem)",ejs:["Cabestrillo con RI mantenida","Isométrico RI suave en neutro 3x10x10seg","Evitar RE activa y pasiva forzada","Movilidad codo, muñeca y mano","Crioterapia y control edema"]},
        {f:"Fase 2 — RI progresiva (6-14 sem)",ejs:["RI con banda en neutro 4x15","Progresión a 45° y 90° ABD","Press cerrado (push-up) 3x12","Remo en RI final 3x15","Fortalecimiento escapular completo"]},
        {f:"Fase 3 — Fuerza completa (14-24 sem)",ejs:["Press plano progresivo 4x10","RI isocinética a velocidades","Gestos de empuje overhead","Actividades funcionales con RI","Test Lift-off y Bear-Hug negativos"]}
      ],
      rts:"Lift-off y Belly-press negativos · Fuerza RI ≥85% · Press sin dolor"},

    { n:"Tendinopatía del bíceps (porción larga) — crónica", z:"Hombro",
      e:["Test de Speed","Test de Yergason","Palpación corredera bicipital","Test de O'Brien","Ecografía (engrosamiento, hipoecogenicidad)","RMN"],
      p:"F1(0-3sem): Descarga, analgesia, isométricos.\nF2(3-8sem): Excéntrico, fortalecimiento gradual.\nF3(8-16sem): Carga completa, gestos deportivos.",
      fases:[
        {f:"Fase 1 — Descarga y analgesia (0-3 sem)",ejs:["Isométrico bíceps en diferentes ángulos 3x10x45seg","Crioterapia corredera bicipital","TENS local","Evitar supinación cargada","Corrección postural escapular"]},
        {f:"Fase 2 — Carga excéntrica (3-8 sem)",ejs:["Excéntrico bíceps con barra (curl excéntrico) 3x15","Supinación resistida excéntrica 3x15","Fortalecimiento manguito y trapecio 3x15","Estiramiento pectoral menor 3x30seg","Estabilización escapular 3x15"]},
        {f:"Fase 3 — Carga completa (8-16 sem)",ejs:["Curl bíceps progresivo 4x10","Remo supino 4x10","Gestos deportivos específicos","Lanzamiento progresivo si indicado","Test de velocidad isocinética"]}
      ],
      rts:"Speed y Yergason negativos · Carga excéntrica sin dolor · Fuerza bíceps ≥85%"},

    { n:"Rotura del tendón del bíceps (porción larga)", z:"Hombro",
      e:["Signo de Popeye (deformidad distal)","Test de Speed (debilidad)","Test de Yergason","Ecografía (ausencia tendón)","RMN confirmatoria"],
      p:"Conservador (mayores, baja demanda): F1-F3 fortalecimiento.\nQuirúrgico (jóvenes, atletas): F1(0-6sem) cabestrillo.\nF2(6-14sem): ROM y fuerza.\nF3(14-24sem): Retorno.",
      fases:[
        {f:"Fase 1 — Post-op o conservadora (0-6 sem)",ejs:["Cabestrillo 4-6 semanas","Isométrico RI/RE suave","Movilidad codo y muñeca activa","Crioterapia y control edema","Educación sobre actividades a evitar"]},
        {f:"Fase 2 — ROM y fortalecimiento (6-14 sem)",ejs:["ROM codo y hombro activo-asistido","Curl bíceps suave con mancuerna 3x15","Supinación resistida 3x15","Fortalecimiento manguito 3x15","Escapular completo 3x15"]},
        {f:"Fase 3 — Fuerza completa (14-24 sem)",ejs:["Curl bíceps progresivo 4x12","Remo supino 4x10","Test de fuerza supinación","Gestos deportivos específicos","Criterios de alta funcional"]}
      ],
      rts:"Fuerza supinación ≥80% · Curl bíceps simétrico · Gesto deportivo sin compensación"},

    { n:"Artropatía acromioclavicular (AC)", z:"Hombro",
      e:["Test de O'Brien (compresión AC)","Test de Paxinos","Palpación directa AC","Rx de estrés AC bilateral","RMN para tejidos blandos"],
      p:"F1(0-3sem): Analgesia, descarga, postura.\nF2(3-8sem): Movilidad, control escapular.\nF3(8-16sem): Fuerza completa, overhead.",
      fases:[
        {f:"Fase 1 — Analgesia (0-3 sem)",ejs:["Crioterapia articulación AC 15min x3","Evitar aducción horizontal forzada","Corrección postural hombro","Isométrico deltoides suave 3x10x10seg","TENS local AC"]},
        {f:"Fase 2 — Movilidad y escapular (3-8 sem)",ejs:["Movilidad glenohumeral activa controlada","Fortalecimiento trapecio inferior 3x15","Retracción escapular con banda 3x15","Evitar press plano y fondos","Remo vertical con control AC 3x12"]},
        {f:"Fase 3 — Fuerza completa (8-16 sem)",ejs:["Press en plano escapular progresivo 4x10","Remo horizontal 4x10","Overhead progresivo si tolerado","Reintroducción press plano","Gestos deportivos específicos"]}
      ],
      rts:"O'Brien negativo · Overhead sin dolor · Press plano sin dolor · Fuerza simétrica"},

    { n:"Fractura de cabeza humeral (Garden/Neer)", z:"Hombro",
      e:["Rx anteroposterior y axilar (clasificación Neer)","TC 3D (desplazamiento, fragmentos)","RMN (vascularización cabeza)","Evaluación neurológica (axilar)","Valoración funcional pre-cirugía"],
      p:"No desplazada: conservadora (cabestrillo 3-6sem).\nDesplazada/quirúrgica: F1(0-6sem) protección.\nF2(6-14sem): ROM progresivo.\nF3(14-26sem): Fuerza y retorno.",
      fases:[
        {f:"Fase 1 — Protección (0-6 sem)",ejs:["Cabestrillo con almohadilla de abducción","Péndulos Codman sin carga 2x5min","Movilidad activa codo, muñeca y mano","Crioterapia 15min x3","Control edema y dolor farmacológico"]},
        {f:"Fase 2 — ROM activo (6-14 sem)",ejs:["Elevación activo-asistida en plano escapular","Rotación externa activa con bastón","Movilidad glenohumeral progresiva","Isométrico deltoides y manguito 3x15","Hidroterapia si disponible"]},
        {f:"Fase 3 — Fuerza y funcional (14-26 sem)",ejs:["Fortalecimiento manguito progresivo 4x12","Press en plano escapular 4x10","Actividades funcionales AVD","Gestos deportivos progresivos","Test de función hombro (DASH, ASES)"]}
      ],
      rts:"Consolidación radiológica · ROM >150° elevación · Fuerza ≥75% · AVD sin dolor"},

    { n:"Fractura de escápula (cuerpo, cuello, glenoides)", z:"Hombro",
      e:["Rx lateral de escápula (Y-view)","TC para glenoides y cuello","Evaluación neurológica (supraescapular, axilar)","RMN lesiones asociadas (manguito, SLAP)"],
      p:"F1(0-6sem): Cabestrillo, isométricos distales.\nF2(6-12sem): ROM glenohumeral controlado.\nF3(12-20sem): Fuerza completa, retorno.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-6 sem)",ejs:["Cabestrillo con almohadilla","Movilidad activa codo, muñeca, mano","Isométrico suave deltoides y manguito","Crioterapia y control edema","Prevención TVP miembro superior"]},
        {f:"Fase 2 — ROM controlado (6-12 sem)",ejs:["Péndulos Codman con peso ligero","ROM activo-asistido en plano escapular","Isométrico manguito multiángulo 3x15","Hidroterapia si consolidación confirmada","Fortalecimiento distal progresivo"]},
        {f:"Fase 3 — Fuerza completa (12-20 sem)",ejs:["Fortalecimiento manguito y deltoides 4x12","Press y remo progresivos","Actividades funcionales overhead","Test de retorno deportivo","Gestión de dolor crónico si presente"]}
      ],
      rts:"Consolidación confirmada · ROM ≥80% · Fuerza funcional · Sin neuropatía residual"},

    { n:"Parálisis del nervio axilar", z:"Hombro",
      e:["EMG y velocidad de conducción","Test fuerza deltoides (grados MRC)","Evaluación sensibilidad región axilar","RMN neurografía","Valoración funcional DASH"],
      p:"F1(0-8sem): Espera regeneración, evitar estiramiento, TENS.\nF2(8-20sem): Reeducación muscular deltoides.\nF3(20-36sem): Potencia, retorno funcional.",
      fases:[
        {f:"Fase 1 — Neuroproteción (0-8 sem)",ejs:["Evitar tracción y estiramiento del nervio","TENS de baja frecuencia en deltoides 20min","Movilidad pasiva glenohumeral 3x15","Control escapular con musculatura conservada","Educación al paciente sobre pronóstico"]},
        {f:"Fase 2 — Reeducación (8-20 sem)",ejs:["Facilitación proprioceptiva neuromuscular (FNP)","Electroestimulación funcional deltoides","Isométrico deltoides en posición neutra","Ejercicios con feedback visual/EMG","Control motor escapular compensatorio"]},
        {f:"Fase 3 — Potencia y retorno (20-36 sem)",ejs:["Fortalecimiento deltoides progresivo 4x12","Elevación lateral con carga creciente","Gestos funcionales AVD","Test fuerza isocinética","Retorno deportivo progresivo"]}
      ],
      rts:"Deltoides MRC ≥4 · Fuerza ≥70% contralateral · ROM completo · EMG normalizado"},

    { n:"Neuropatía del nervio supraescapular", z:"Hombro",
      e:["EMG y velocidad de conducción","Atrofia infra/supraespinoso (inspección)","RMN neurografía","Test de Patte y Jobe (debilidad)","Ecografía ganglio o compresión"],
      p:"F1(0-8sem): Descompresión si indicada, TENS.\nF2(8-16sem): Reeducación manguito posterior.\nF3(16-28sem): Fuerza RE/ABD, retorno.",
      fases:[
        {f:"Fase 1 — Neuroprotección (0-8 sem)",ejs:["Evitar posiciones de compresión (cruce de brazos)","TENS paraescapular 20min","Ecografía guiada si ganglio (drenaje)","Movilidad glenohumeral suave","Educación postural específica"]},
        {f:"Fase 2 — Reeducación muscular (8-16 sem)",ejs:["Electroestimulación supraespinoso e infraespinoso","FNP con resistencia manual","RE y ABD asistidas progresivas","Control escapular con musculatura sana","Ejercicios con biofeedback EMG"]},
        {f:"Fase 3 — Fuerza y retorno (16-28 sem)",ejs:["RE progresiva con banda y mancuerna 4x12","Elevación en plano escapular 4x12","Gestos deportivos específicos","Test isocinético RE/RI","Retorno deportivo por fases"]}
      ],
      rts:"EMG mejorado · Fuerza RE ≥70% · Sin atrofia visible progresiva · Patte negativo"},

    { n:"Capsulitis adhesiva (hombro congelado) fase aguda", z:"Hombro",
      e:["ROM pasivo y activo limitado en todos los planos","Test de Apley","Radiografía (osteopenia yuxta-articular)","RMN (engrosamiento cápsula, receso axilar)","Diagnóstico diferencial con artritis"],
      p:"Fase inflamatoria: analgesia, movilidad suave, no forzar.\nFase proliferativa: movilización progresiva.\nFase resolución: fortalecimiento y retorno.",
      fases:[
        {f:"Fase inflamatoria — Analgesia (0-8 sem)",ejs:["Crioterapia o termoterapia según tolerancia","Péndulos Codman 3x5min sin carga","TENS para analgesia 20min","Movilidad activa en rango indoloro","Educación: no forzar, no bloquear movimiento"]},
        {f:"Fase proliferativa — Movilización (2-9 meses)",ejs:["Movilización articular grado III-IV (Maitland)","Estiramiento capsular posterior 3x60seg","ROM activo-asistido con bastón 3x15","Ejercicios en piscina (temperatura neutra)","Hidrodistensión guiada por imagen si indicado"]},
        {f:"Fase resolución — Funcional (9-18 meses)",ejs:["Fortalecimiento manguito en rango ganado 3x15","Press hombro progresivo 4x10","Ejercicios funcionales AVD","Fortalecimiento escapular completo","Retorno progresivo al deporte"]}
      ],
      rts:"ROM ≥80% contralateral · AVD sin restricción · Fuerza manguito ≥80%"},

    { n:"Artritis glenohumeral (degenerativa/OA)", z:"Hombro",
      e:["Rx (pinzamiento articular, osteofitos)","Clasificación Samilson-Prieto","RMN (cartílago, manguito asociado)","TC (morfología glenoides)","Valoración funcional ASES, DASH"],
      p:"F1: Analgesia, mantenimiento ROM, evitar degeneración.\nF2: Fortalecimiento muscular periarticular.\nF3: Funcional, educación, gestión crónica.",
      fases:[
        {f:"Fase 1 — Analgesia y ROM (0-6 sem)",ejs:["Termoterapia húmeda 20min pre-ejercicio","Movilidad activa en rango indoloro 3x15","Péndulos Codman 3x5min","TENS o ultrasonido terapéutico","Educación sobre carga articular óptima"]},
        {f:"Fase 2 — Fortalecimiento (6-16 sem)",ejs:["Isométrico manguito en posición media 3x15","Rotación externa con banda en neutro 3x15","Fortalecimiento escapular 3x15","Aquagym si disponible","Trabajo de postura y alineación"]},
        {f:"Fase 3 — Gestión crónica (>16 sem)",ejs:["Programa domiciliario de mantenimiento","Ejercicio aeróbico adaptado (natación, bici)","Técnicas de conservación de energía","Adaptación de AVD y deporte","Seguimiento periódico y ajuste de carga"]}
      ],
      rts:"Dolor manejable · ROM funcional para deporte/trabajo · Fuerza estabilizadora ≥70%"},

    { n:"Artritis reumatoide del hombro", z:"Hombro",
      e:["Rx (erosiones, pinzamiento simétrico)","RMN (sinovitis, erosiones tempranas)","Ecografía (derrame, pannus)","Analítica FR, Anti-CCP, PCR, VSG","Valoración funcional DAS28"],
      p:"F1: Fase aguda: reposo relativo, crioterapia, isométricos.\nF2: Fase subaguda: movilidad protegida.\nF3: Remisión: fortalecimiento y funcional.",
      fases:[
        {f:"Fase aguda — Protección (según brote)",ejs:["Reposo relativo del hombro afecto","Crioterapia sobre articulación 10-15min","Ortesis nocturna en posición funcional","Isométrico suave en posición media 3x10x10seg","Coordinación con reumatología (FAME/biológicos)"]},
        {f:"Fase subaguda — Movilidad (remisión parcial)",ejs:["Péndulos Codman suaves 2x5min","ROM activo en rango sin dolor 3x15","Hidroterapia en agua caliente 3x/sem","Termoterapia pre-ejercicio","Educación sobre autocuidado articular"]},
        {f:"Fase remisión — Fortalecimiento",ejs:["Isométrico manguito progresivo 3x15","Rotadores externos con banda suave 3x15","Escapular: retracción y depresión 3x15","Actividades funcionales adaptadas","Mantenimiento a largo plazo"]}
      ],
      rts:"DAS28 en remisión · ROM funcional · Sin dolor en carga · Brotes controlados"},

    { n:"Osteoartritis acromioclavicular", z:"Hombro",
      e:["Test de O'Brien","Test de Paxinos","Palpación dolorosa AC","Rx AC bilateral (Zanca view)","Infiltración diagnóstica AC"],
      p:"F1: Analgesia, evitar aducción horizontal.\nF2: Fortalecimiento sin compresión AC.\nF3: Retorno con modificación de carga.",
      fases:[
        {f:"Fase 1 — Control del dolor (0-4 sem)",ejs:["Evitar aducción horizontal (press plano, fondos)","Crioterapia AC 15min x3","TENS local 20min","Corrección postural escapular","Isométrico en rango seguro 3x10x10seg"]},
        {f:"Fase 2 — Fortalecimiento adaptado (4-12 sem)",ejs:["Press en plano escapular (no plano) 3x12","Remo horizontal 3x15","Rotación externa con banda 3x15","Fortalecimiento trapecio bajo 3x15","Evitar overhead máximo si dolor"]},
        {f:"Fase 3 — Retorno modificado (12-20 sem)",ejs:["Reintroducción gradual de aducción horizontal","Press plano con agarre ancho si tolerado","Evaluación de modificaciones técnicas en deporte","Programa de mantenimiento domiciliario","Infiltración AC si recaída"]}
      ],
      rts:"Paxinos negativo · Press plano sin dolor · Overhead sin compensación"},

    { n:"Hombro del lanzador (Thrower's shoulder)", z:"Hombro",
      e:["GIRD (Glenohumeral Internal Rotation Deficit)","Test de Jobe (supraespinoso)","Test de aprensión en 90° ABD+RE","Evaluación biomecánica del lanzamiento","RMN (SLAP, Bennett lesion, pseudolaxitud posterior)"],
      p:"F1(0-4sem): Corregir GIRD, equilibrar rotadores.\nF2(4-12sem): Programa específico lanzadores.\nF3(12-24sem): Retorno progresivo al lanzamiento.",
      fases:[
        {f:"Fase 1 — Corrección GIRD (0-4 sem)",ejs:["Estiramiento capsular posterior (sleeper stretch) 3x60seg","Cross-body stretch 3x60seg","RI glenohumeral pasiva en decúbito 3x60seg","Evaluación y corrección de la técnica","Isométrico RE a 90° 3x10x10seg"]},
        {f:"Fase 2 — Thrower's Ten (4-12 sem)",ejs:["RE con banda a 0° 3x15","RE con banda a 90° ABD 3x15","RI con banda a 90° ABD 3x15","Diagonal D2 con banda 3x15","Remo con RE final 3x15","Press plano con control escapular 3x15"]},
        {f:"Fase 3 — Programa lanzamiento (12-24 sem)",ejs:["Protocolo de lanzamiento progresivo por distancias","Lanzamiento desde montículo por fases","Mecánica de lanzamiento con análisis de video","Pliometría específica lanzadores","Test de retorno al lanzamiento"]}
      ],
      rts:"GIRD <20° · Test aprensión negativo · Lanzamiento a velocidad máxima sin dolor · Temporada completa"},

    { n:"Síndrome de hipomovilidad glenohumeral posterior", z:"Hombro",
      e:["Medición GIRD (>20° con respecto a contralateral)","Posterior capsule tightness test","Rx (bennett lesion si crónico)","Evaluación del ritmo escapulohumeral"],
      p:"F1: Movilización capsular posterior, estiramientos.\nF2: Equilibrio rotadores, control escapular.\nF3: Retorno deportivo con mantenimiento.",
      fases:[
        {f:"Fase 1 — Movilidad posterior (0-4 sem)",ejs:["Sleeper stretch 3x60seg en decúbito lateral","Cross-body stretch 3x60seg","Movilización posteroinferior grado III-IV","RI pasiva en decúbito con carga 3x60seg","Termoterapia pre-estiramiento"]},
        {f:"Fase 2 — Equilibrio muscular (4-10 sem)",ejs:["RE excéntrica con banda 4x15","Diagonal FNP D2 3x15","Control escapular en posición de lanzador","Wall slides 3x12","Evaluación y corrección técnica deportiva"]},
        {f:"Fase 3 — Mantenimiento (10-20 sem)",ejs:["Programa de mantenimiento diario de estiramientos","Retorno al deporte con control GIRD","Monitorización carga de lanzamiento","Análisis videográfico periódico","Temporada completa con mantenimiento"]}
      ],
      rts:"GIRD <20° · Sin dolor · Ritmo escapulohumeral normalizado"},

    { n:"Síndrome del pectoral menor (compresión subcoracoidea)", z:"Hombro",
      e:["Test de Wright (hiperabducción)","Palpación pectoral menor","Test de Halsted","Evaluación postural (protracción escapular)","Ecografía o RMN estructura subcoracoidea"],
      p:"F1: Estiramientos pectoral menor, corrección postural.\nF2: Fortalecimiento escapular, control neuromotor.\nF3: Retorno funcional y mantenimiento.",
      fases:[
        {f:"Fase 1 — Liberación pectoral (0-4 sem)",ejs:["Estiramiento pectoral menor en esquina 3x60seg","Liberación miofascial pectoral menor (foam roller o fisio)","Corrección postural activa en espejo","Retracción escapular activa 3x20","Movilización coracoidea si indicado"]},
        {f:"Fase 2 — Escapular y postural (4-10 sem)",ejs:["Fortalecimiento trapecio inferior (Y en decúbito prono) 3x15","Serrato anterior (serratus punch) 3x15","Wall slides 3x12","Control postural en sedestación prolongada","Ergonomía workstation"]},
        {f:"Fase 3 — Retorno funcional (10-18 sem)",ejs:["Press con control escapular y sin protracción","Overhead con control postural","Actividades deportivas con monitorización","Programa de mantenimiento domiciliario","Evaluación ergonómica laboral"]}
      ],
      rts:"Wright negativo · Postura corregida · Sin síntomas neurológicos · Fuerza simétrica"},

    { n:"Bursitis subdeltoidea", z:"Hombro",
      e:["Palpación bursa subdeltoidea (lateral)","Test de Neer y Hawkins","Ecografía (derrame bursal)","Diagnóstico diferencial con bursitis subacromial","Rx para descartar calcificaciones"],
      p:"F1(0-2sem): Analgesia, reposo relativo, crioterapia.\nF2(2-6sem): Movilidad, control escapular.\nF3(6-12sem): Fortalecimiento progresivo.",
      fases:[
        {f:"Fase 1 — Analgesia (0-2 sem)",ejs:["Crioterapia subdeltoidea 15min x4/día","Reposo relativo de movimientos irritantes","TENS intereferencial lateral hombro","Ultrasonido terapéutico 3MHz","Posicionamiento en descarga con almohadilla"]},
        {f:"Fase 2 — Movilidad y escapular (2-6 sem)",ejs:["Péndulos Codman 3x5min","ROM activo en plano escapular 3x15","Rotación externa con banda en neutro 3x15","Fortalecimiento trapecio inferior 3x15","Evitar elevación lateral pura (más subacromial)"]},
        {f:"Fase 3 — Fortalecimiento (6-12 sem)",ejs:["Elevación en plano escapular progresiva 4x12","Remo horizontal 4x10","Press en plano escapular 4x10","Gestos deportivos progresivos","Infiltración guiada por ecografía si recidiva"]}
      ],
      rts:"Palpación indolora · Overhead sin dolor · Fuerza simétrica · Ecografía sin derrame"},

    { n:"Tendinitis calcificante del manguito rotador", z:"Hombro",
      e:["Rx anteroposterior (Gärtner I-III)","Ecografía dinámica (sombra acústica)","Test de Neer y Hawkins","Intensidad dolor en escala EVA","TC para planificación si quirúrgico"],
      p:"F1(agudo): Analgesia intensa, TENS, crioterapia.\nF2: Ondas de choque, movilidad.\nF3: Fortalecimiento completo.",
      fases:[
        {f:"Fase aguda — Crisis (días-semanas)",ejs:["Crioterapia inmediata 20min x4-6/día","TENS alta frecuencia (analgesia) 30min","Reposo absoluto del hombro","AINE tópico o sistémico","Infiltración ecoguiada (lavado calcificación) si indicado"]},
        {f:"Fase subaguda — Ondas de choque (4-8 sem)",ejs:["Ondas de choque radiales 3 sesiones cada 2 semanas","ROM activo suave en rango indoloro 3x15","Péndulos Codman 3x5min","Isométrico manguito en neutro 3x10x10seg","Control escapular básico"]},
        {f:"Fase crónica — Fortalecimiento (8-20 sem)",ejs:["Fortalecimiento manguito progresivo 4x12","Elevación en plano escapular 4x12","Press y remo progresivos 4x10","Gestos deportivos específicos","Seguimiento radiológico a 6 meses"]}
      ],
      rts:"EVA <2/10 · ROM completo · Fuerza ≥80% · Rx mejora o reabsorción"},

    { n:"Síndrome escapulotorácico (escápula alada / crujido)", z:"Hombro",
      e:["Test de Kibler (escápula alada)","Auscultación/palpación crujido","Test de serrato anterior","Evaluación ritmo escapulohumeral","RMN (osteocondroma, bursa anómala)","EMG (parálisis serrato / romboides)"],
      p:"F1: Reeducación neuromuscular escapular.\nF2: Fortalecimiento serrato, romboides, trapecio.\nF3: Integración funcional y deportiva.",
      fases:[
        {f:"Fase 1 — Reeducación (0-6 sem)",ejs:["Concienciación escapular en espejo 3x10","Retracción escapular activa 3x20","Activación serrato (serratus punch) 3x15","Movilidad torácica en foam roller","Corrección postural en todas las AVD"]},
        {f:"Fase 2 — Fortalecimiento (6-14 sem)",ejs:["Push-up plus 3x15","Y-W-T en decúbito prono 3x12","Remo con retracción final 3x15","Wall slides 3x12","Fortalecimiento romboides con banda 3x15"]},
        {f:"Fase 3 — Funcional (14-24 sem)",ejs:["Integración en gestos deportivos","Overhead con control escapular dinámico","Lanzamiento o gestos técnicos","Evaluación ritmo escapulohumeral normalizado","Programa de mantenimiento"]}
      ],
      rts:"Escápula alada ausente · Ritmo escapulohumeral normal · Sin crujido doloroso"},

    { n:"Luxación esternoclavicular (anterior/posterior)", z:"Hombro",
      e:["Rx anteroposterior y Serendipity view","TC (gold standard — posterior)","Evaluación vascular y neurológica (posterior urgente)","Palpación asimetría ECM","Valoración deglución y respiración (posterior)"],
      p:"Anterior: Reducción cerrada + cabestrillo 4-6sem.\nPosterior: Urgencia médica, reducción hospitalaria.\nF1(0-6sem): Inmovilización.\nF2(6-14sem): ROM.\nF3(14-24sem): Fuerza.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-6 sem)",ejs:["Cabestrillo con almohadilla entre escápulas","Movilidad activa codo y mano","Isométrico suave pectoral y deltoides","Crioterapia ECM","Evitar RI y aducción forzadas"]},
        {f:"Fase 2 — ROM progresivo (6-14 sem)",ejs:["ROM glenohumeral activo-asistido","Elevación en plano escapular 3x15","Fortalecimiento pectoral y deltoides suave 3x15","Fortalecimiento trapecio y romboides 3x15","Control escapular activo"]},
        {f:"Fase 3 — Fuerza completa (14-24 sem)",ejs:["Fortalecimiento completo cintura escapular 4x12","Press plano progresivo 4x10","Gestos deportivos específicos","Evaluación estabilidad ECM dinámica","Retorno al deporte por fases"]}
      ],
      rts:"Estabilidad ECM · ROM completo · Fuerza simétrica · Sin síntomas neurológicos/vasculares"},

    { n:"Síndrome del túnel cuadrilátero (nervio axilar)", z:"Hombro",
      e:["EMG y velocidad de conducción axilar","Atrofia deltoides y redondo menor","Test de compresión en 90° ABD+RE","RMN neurografía","Palpación espacio cuadrilátero"],
      p:"F1: Descompresión conservadora, evitar posición gatillo.\nF2: Reeducación deltoides.\nF3: Fuerza y retorno deportivo.",
      fases:[
        {f:"Fase 1 — Descompresión (0-6 sem)",ejs:["Evitar 90° ABD+RE mantenido","Liberación miofascial espacio cuadrilátero","TENS perineural","Movilidad glenohumeral segura","Educación sobre posiciones de riesgo"]},
        {f:"Fase 2 — Reeducación (6-16 sem)",ejs:["Electroestimulación funcional deltoides","FNP facilitación manual deltoides","Isométrico progresivo deltoides multiángulo","Fortalecimiento compensatorio manguito sano","Feedback EMG si disponible"]},
        {f:"Fase 3 — Potencia (16-28 sem)",ejs:["Elevación lateral progresiva 4x12","Gestos deportivos específicos","Test isocinético deltoides","Retorno deportivo progresivo","Programa de mantenimiento"]}
      ],
      rts:"EMG normalizado · Deltoides MRC ≥4 · Sin parestesias · Gesto deportivo completo"},

    { n:"Osteólisis distal de clavícula (hombro del levantador)", z:"Hombro",
      e:["Rx AC (rarefacción extremo distal clavícula)","Gammagrafía ósea (hipercaptación)","RMN (edema óseo, erosiones)","Test de O'Brien y Paxinos","Historia de entrenamiento con pesas"],
      p:"F1(0-8sem): Cese total de press y overhead, descarga.\nF2(8-16sem): Fortalecimiento sin compresión AC.\nF3(16-28sem): Reintroducción progresiva.",
      fases:[
        {f:"Fase 1 — Descarga total (0-8 sem)",ejs:["Suspender press plano, fondos, overhead completamente","Crioterapia AC 15min x3","Evaluación y corrección de técnica de entrenamiento","ROM glenohumeral sin compresión AC","Fortalecimiento cadena posterior sin AC"]}  ,
        {f:"Fase 2 — Fortalecimiento adaptado (8-16 sem)",ejs:["Remo horizontal 3x15","Rotación externa con banda 3x15","Elevación en plano escapular hasta 90° 3x15","Fortalecimiento trapecio bajo 3x15","Evitar aducción horizontal"]}  ,
        {f:"Fase 3 — Reintroducción (16-28 sem)",ejs:["Press en plano escapular con grip ancho","Reintroducción press plano con agarre ancho","Overhead progresivo con control AC","Evaluación Rx control antes de retorno a pesas","Técnica corregida documentada"]}
      ],
      rts:"Rx estabilización osteólisis · Press sin dolor · Técnica corregida · AC indolora"},


    // ===== 🍑 CADERA Y MUSLO =====
    { n:"Pubalgia", z:"Cadera",
      e:["Squeeze Test (0°, 45°, 90°)","Dolor aductor a resistencia","Palpación sínfisis","Test de Valsalva","Rx pelvis en carga"],
      p:"F1(0-3sem): Isométricos aductores, Core profundo.\nF2(3-8sem): Copenhagen Protocol, estabilidad lumbopélvica.\nF3(8-16sem): Gestos deportivos, carrera, pivotes.",
      fases:[
        {f:"Fase 1 — Descarga (0-3 sem)",ejs:["Isométrico aductores en neutro con pelota 5x10seg","Activación transverso 3x10x10seg","Movilidad cadera sin dolor","Crioterapia local"]},
        {f:"Fase 2 — Copenhagen Protocol (3-8 sem)",ejs:["Copenhagen adduction nivel 1 a 3 progresivo 3x10","Hip thrust unilateral 4x10","Side plank con abducción 3x10","Sentadilla lateral con banda 3x15"]},
        {f:"Fase 3 — Funcional (8-16 sem)",ejs:["Cambios de dirección con sprint","Gestos de patada y regate","Carrera curva y en zigzag","Equilibrio dinámico"]}
      ],
      rts:"Squeeze sin dolor · Copenhagen sin dolor · Carrera sin restricción · Patada sin dolor"},

    { n:"Pubalgia futbolista", z:"Cadera",
      e:["Cross-over test","Squeeze test","Dolor en sprint y cambio dirección","Rx pelvis","Ecografía sínfisis"],
      p:"F1: Descarga, isométricos aductores y Core.\nF2: Copenhagen Protocol, estabilidad lumbopélvica.\nF3: Retorno fútbol: carrera a sprint a COD a partido.",
      fases:[
        {f:"Fase 1 — Descarga (0-3 sem)",ejs:["Isométrico aductores con pelota 5x10seg","Transverso abdominal 3x10","Movilidad cadera sin dolor","Natación o bicicleta"]},
        {f:"Fase 2 — Copenhagen (3-8 sem)",ejs:["Copenhagen Adduction progresivo 3x10","Side plank abducción 3x10","Hip thrust bilateral a unilateral 4x10","Sentadilla lateral con banda 3x15"]},
        {f:"Fase 3 — Retorno al fútbol (8-16 sem)",ejs:["Carrera línea recta progresiva","Sprint 50-75-100%","Cambios de dirección con balón","Situaciones de partido con contacto"]}
      ],
      rts:"Squeeze sin dolor · Sprint y regate sin dolor · Sesión completa sin dolor · 2 semanas entrenando normal"},

    { n:"Desgarro aductores", z:"Cadera",
      e:["Squeeze Test","Dolor localizado","Palpación de rotura","Ecografía (grado)"],
      p:"F1(0-72h): PEACE & LOVE, sin estiramiento.\nF2(3días-3sem): Isométricos de aducción.\nF3(3-8sem): Copenhagen Protocol.\nF4(8-16sem): Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Aguda (0-72h)",ejs:["Crioterapia 15min x4/día","Compresión y elevación","Movilidad activa rodilla sin estirar aductor","Sin masaje en zona de rotura"]},
        {f:"Fase 2 — Isometría (3 días - 3 sem)",ejs:["Isométrico aducción en neutro 5x10seg","Marcha normal progresiva","Bicicleta suave si tolera","Fortalecimiento glúteo y cuádriceps"]},
        {f:"Fase 3-4 — Funcional (3-16 sem)",ejs:["Copenhagen Adduction progresivo","Sentadilla lateral y lunges","Sprint progresivo 50-100%","Gestos deportivos específicos"]}
      ],
      rts:"Squeeze sin dolor · Copenhagen sin dolor · Sprint 100% sin dolor"},

    { n:"Desgarro isquiotibial", z:"Cadera",
      e:["Prueba de Askling (H1,H2,H3)","Palpación de rotura","Ecografía/RMN (grado)","Active Knee Extension Test"],
      p:"F1(0-72h): PEACE & LOVE, sin estirar.\nF2(3días-3sem): Isométricos larga longitud.\nF3(3-8sem): Askling L Protocol, Nordic.\nF4(8-16sem): Sprint, gesto deportivo.",
      fases:[
        {f:"Fase 1 — Aguda (0-72h)",ejs:["Crioterapia 15min x4/día","Compresión con venda","Elevación del miembro","Sin estiramiento pasivo"]},
        {f:"Fase 2 — Isometría larga longitud (3 días-3 sem)",ejs:["Isométrico isquios cadera flexionada 90° 5x10seg","RDL parcial sin dolor","Marcha normal progresiva","Bicicleta suave si tolera"]},
        {f:"Fase 3 — Protocolo Askling (3-8 sem)",ejs:["Leg slide supino 3x10","Askling extensor: kick back controlado 3x10","Nordic Hamstring excéntrico 3x6 a 3x10","Peso muerto rumano con barra 4x8"]},
        {f:"Fase 4 — Sprint y retorno (8-16 sem)",ejs:["Sprint progresivo: 50%-75%-90%-100%","COD con sprint","Gestos deportivos (regate, salto, patada)","Field-based RTS criteria"]}
      ],
      rts:"AKE simétrico · Sprint 100% sin dolor · Nordic >90% contralateral · Askling negativo"},

    { n:"Síndrome piriforme", z:"Cadera",
      e:["Test de FAIR","Palpación glútea profunda","Signo de Lasègue modificado","Test de Pace"],
      p:"F1(0-2sem): Estiramiento piriforme, neurodinamia ciático.\nF2(2-6sem): Fortalecimiento glúteo y abductores.\nF3(6-12sem): Integración funcional.",
      fases:[
        {f:"Fase 1 — Estiramiento (0-2 sem)",ejs:["Estiramiento piriforme FAIR position 3x30seg","Neurodinamia ciático: SLR con dorsiflexión 3x10","Foam roller glúteo 5min","Punción seca si hipertonía"]},
        {f:"Fase 2 — Fortalecimiento glúteo (2-6 sem)",ejs:["Hip thrust bilateral a unilateral 4x10","Clamshell con banda 3x20","Abducción lateral en polea 3x15","Sentadilla unilateral con control rotación 3x10"]},
        {f:"Fase 3 — Funcional (6-12 sem)",ejs:["Carrera con técnica de rotación cadera","Ejercicios de pivote sin dolor","Gestos deportivos específicos","Fortalecimiento excéntrico glúteo mayor"]}
      ],
      rts:"FAIR negativo · Palpación glútea sin dolor · Carrera sin irradiación · Gesto sin restricción"},

    { n:"Bursitis trocantérica", z:"Cadera",
      e:["Dolor a presión lateral trocánter","Abducción resistida dolorosa","FABER positivo","Test de Ober","Ecografía de bursa"],
      p:"F1(0-2sem): Evitar decúbito lateral, crioterapia.\nF2(2-6sem): Fortalecimiento glúteo medio.\nF3(6-12sem): Corrección biomecánica.",
      fases:[
        {f:"Fase 1 — Control inflamatorio (0-2 sem)",ejs:["Evitar decúbito lateral y cruzar piernas","Crioterapia 15min x3/día","Foam roller lateral muslo (NO sobre trocánter)","Isométrico glúteo medio en neutro 5x10seg"]},
        {f:"Fase 2 — Glúteo medio (2-6 sem)",ejs:["Clamshell bilateral 3x20","Abducción lateral cadera en polea 3x15","Side-lying hip abduction 3x15","Single-leg stance control pelvis 3x30seg"]},
        {f:"Fase 3 — Biomecánica (6-12 sem)",ejs:["Carrera con control de caída pélvica","Sentadilla unilateral con espejo 3x10","Análisis de marcha y carrera","Fortalecimiento integrado glúteo mayor"]}
      ],
      rts:"Dolor lateral negativo · Abducción sin dolor · Marcha sin Trendelenburg · Carrera sin molestia"},

    { n:"Lesión labrum acetabular", z:"Cadera",
      e:["Test FADIR","Test FABER","Test FAIR","RMN artro-RM","VAS en rotación"],
      p:"F1(0-4sem): Evitar rangos extremos, isométricos en posición media.\nF2(4-10sem): Control motor lumbopélvico, rotadores externos.\nF3(10-20sem): Fortalecimiento funcional.",
      fases:[
        {f:"Fase 1 — Protección (0-4 sem)",ejs:["Isométrico cadera multiángulo sin dolor 5x10seg","Evitar flexión >90° y RI forzada","Control motor: activación glúteo en neutro","Marcha normal con cadencia controlada"]},
        {f:"Fase 2 — Control motor (4-10 sem)",ejs:["Clamshell con banda 3x20","Hip thrust unilateral 4x10","Sentadilla parcial con control cadera 3x12","Puente glúteo con extensión rodilla 3x10"]},
        {f:"Fase 3 — Funcional (10-20 sem)",ejs:["Sentadilla completa progresiva","Rotación controlada de cadera","Saltos con aterrizaje en triple flexión","Gestos deportivos graduales"]}
      ],
      rts:"FADIR negativo · Sentadilla profunda sin dolor · Gesto sin restricción"},

    // ===== 🤜 MUÑECA Y MANO =====
    { n:"Esguince de muñeca", z:"Muñeca/Mano",
      e:["Palpación ligamento escafolunar","Test de Watson","Compresión axial","Rx","ROM activo y pasivo"],
      p:"F1(0-2sem): Inmovilización, movilidad digital.\nF2(2-6sem): Movilidad activa, fortalecimiento.\nF3(6-12sem): Carga progresiva, gestos deportivos.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-2 sem)",ejs:["Ortesis muñeca en posición neutra","Movilidad activa dedos y pulgares 3x15","Crioterapia 10min x3/día","Ejercicios hombro y codo sin cargar muñeca"]},
        {f:"Fase 2 — Movilidad (2-6 sem)",ejs:["Flexo-extensión activa muñeca 3x15","Fortalecimiento con putty o pelota blanda 3x20","Pronación-supinación mancuerna ligera 3x15","Extensión muñeca excéntrica 3x15"]},
        {f:"Fase 3 — Carga (6-12 sem)",ejs:["Agarre progresivo con dinamómetro","Flexión muñeca con mancuerna 4x12","Ejercicios de apoyo (plancha)","Gestos deportivos progresivos"]}
      ],
      rts:"ROM ≥80% · Watson negativo · Agarre sin dolor · Apoyo sin dolor"},

    { n:"Síndrome túnel carpiano", z:"Muñeca/Mano",
      e:["Signo de Phalen (60seg)","Signo de Tinel","Monofilamento Semmes-Weinstein","Electroneurografía","BCTQ cuestionario"],
      p:"F1(0-4sem): Férula nocturna, neurodinamia del mediano.\nF2(4-8sem): Fortalecimiento tenar e interóseos.\nF3(8-16sem): Ergonomía avanzada, retorno.",
      fases:[
        {f:"Fase 1 — Conservador (0-4 sem)",ejs:["Férula nocturna en posición neutra","Neurodinamia mediano: deslizamiento neuromeníngeo 3x10","Evitar flexión prolongada de muñeca","Ergonomía del puesto"]},
        {f:"Fase 2 — Fortalecimiento (4-8 sem)",ejs:["Fortalecimiento tenar (abductor corto pulgar) 3x15","Interóseos con putty","Extensión muñeca resistida 3x15","Masaje cicatriz si post-quirúrgico"]},
        {f:"Fase 3 — Funcional (8-16 sem)",ejs:["Agarre dinamómetro progresivo","Destreza fina (pinza, pellizco)","Ergonomía avanzada y pausas activas","Retorno laboral/deportivo"]}
      ],
      rts:"Phalen y Tinel negativos · Velocidad conducción normal · Agarre ≥90% · BCTQ<20"},

    { n:"Tendinitis de De Quervain", z:"Muñeca/Mano",
      e:["Test de Finkelstein","Palpación estiloide radial","Resistencia en extensión pulgar","Ecografía"],
      p:"F1: Ortesis de pulgar, isométricos en neutro.\nF2: Excéntricos abductor largo y extensor corto pulgar.\nF3: Ejercicios funcionales de agarre.",
      fases:[
        {f:"Fase 1 — Descarga (0-3 sem)",ejs:["Ortesis de pulgar en posición funcional","Isométrico abducción pulgar en neutro 5x10seg","Crioterapia local 10min x3/día","Evitar pinza y gestos repetitivos"]},
        {f:"Fase 2 — Excéntrico (3-6 sem)",ejs:["Excéntrico abductor largo del pulgar con banda 3x15","Extensión corta del pulgar excéntrica 3x15","Movilidad activa del pulgar en rango indoloro","Masaje transverso del tendón"]},
        {f:"Fase 3 — Funcional (6-10 sem)",ejs:["Agarre y pinza con objetos de tamaño variable","Ejercicios de destreza fina","Retorno laboral/deportivo gradual","Análisis ergonómico del gesto"]}
      ],
      rts:"Finkelstein negativo · Pinza sin dolor · Agarre sin restricción"},

    // ===== 🧠 NEUROLÓGICO DEPORTIVO =====
    { n:"Conmoción cerebral", z:"Cuello/Cervical",
      e:["SCAT6 completo","HIT-6 cuestionario","Pruebas equilibrio BESS","King-Devick Test","Prueba de esfuerzo Buffalo"],
      p:"F1(24-48h): Reposo cognitivo y físico relativo.\nF2: Aeróbico suave sin síntomas.\nF3: Ejercicio específico sin contacto.\nF4: Entrenamiento completo sin contacto.\nF5: Contacto controlado.\nF6: Retorno completo.",
      fases:[
        {f:"Fases 1-2 — Reposo y aeróbico suave",ejs:["Reposo cognitivo relativo 24-48h","Caminar suave sin síntomas 15-20min","Bicicleta estática sin resistencia","Evitar pantallas brillantes y ruido"]},
        {f:"Fases 3-4 — Ejercicio específico",ejs:["Aeróbico moderado sin contacto","Ejercicios técnicos sin contacto","Coordinación y equilibrio","Fuerza moderada"]},
        {f:"Fases 5-6 — Retorno completo",ejs:["Entrenamiento completo con equipo","Sesión de contacto controlado","Partido de práctica","Competencia completa"]}
      ],
      rts:"SCAT6 en valores normativos · BESS normal · King-Devick sin deterioro · Buffalo sin síntomas · Aprobación médico especialista"},

    // ===== 🩹 LESIONES GENERALES =====
    { n:"Desgarro grado I", z:"Rodilla",
      e:["Dolor puntual","Resistencia levemente disminuida","Ecografía"],
      p:"F1: Isométricos tempranos.\nF2: Isotónica controlada.\nF3: Excéntrica y retorno.",
      fases:[
        {f:"Fase 1 — Aguda (0-72h)",ejs:["Crioterapia 15min x4/día","Compresión","Isométrico suave sin dolor 5x10seg","Marcha normal si tolera"]},
        {f:"Fase 2 — Subaguda (3 días-2 sem)",ejs:["Isotónica concéntrica en rango indoloro 3x15","Fortalecimiento proximal y distal","Bicicleta o marcha progresiva","Propiocepción básica"]},
        {f:"Fase 3 — Funcional (2-4 sem)",ejs:["Excéntrico específico del músculo afectado 3x15","Pliometría baja intensidad","Carrera progresiva","Gestos deportivos"]}
      ],
      rts:"Fuerza ≥90% contralateral · Sin dolor en gesto deportivo · 3 semanas sin recaída"},

    { n:"Desgarro grado II", z:"Rodilla",
      e:["Hachazo palpable","Hematoma visible","Ecografía (grado de rotura)","ROM limitado"],
      p:"F1: PEACE & LOVE, isometría.\nF2: Isotónica concéntrica.\nF3: Excéntrica.\nF4: Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Aguda (0-5 días)",ejs:["Crioterapia y compresión inmediata","Isométrico suave en posición acortada 5x10seg","Sin masaje ni calor","Movilidad activa sin dolor"]},
        {f:"Fase 2 — Concéntrico (5 días-3 sem)",ejs:["Isotónica concéntrica rango indoloro 3x15","Fortalecimiento muscular proximal y distal","Marcha progresiva a trote","Propiocepción básica"]},
        {f:"Fase 3 — Excéntrico (3-6 sem)",ejs:["Excéntrico específico progresivo 3x15","Pliometría progresiva","Sprint al 50-75%","Gestos deportivos sin dolor"]},
        {f:"Fase 4 — Retorno (6-12 sem)",ejs:["Sprint al 100%","Cambios de dirección","Gestos específicos del deporte","Test funcional de retorno"]}
      ],
      rts:"Fuerza ≥90% · Sprint sin dolor · Gesto deportivo sin restricción"},

    { n:"Desgarro grado III", z:"Rodilla",
      e:["Pérdida funcional total","Defecto palpable","RMN","Evaluación quirúrgica"],
      p:"F1: Evaluación quirúrgica urgente.\nF2: Inmovilización.\nF3: Rehabilitación fase a fase según protocolo post-quirúrgico.",
      fases:[
        {f:"Fase 1 — Aguda/Quirúrgica (0-4 sem)",ejs:["Evaluación quirúrgica urgente","Inmovilización o bota walker","Crioterapia frecuente","Ejercicios musculatura no afectada"]},
        {f:"Fase 2 — Subaguda (4-10 sem)",ejs:["Movilidad progresiva del segmento","Fortalecimiento isométrico e isotónico","Marcha normal progresiva","Propiocepción inicial"]},
        {f:"Fase 3 — Funcional (10-24 sem)",ejs:["Fortalecimiento excéntrico progresivo","Pliometría bilateral a unilateral","Carrera progresiva","Retorno deportivo según LSI"]}
      ],
      rts:"Fuerza ≥90% · LSI ≥90% · Gesto deportivo sin restricción · Mínimo 6 meses"},

    { n:"Contusión muscular", z:"Rodilla",
      e:["Equimosis","ROM limitado","Dolor a la palpación directa","Ecografía (hematoma)"],
      p:"F1: PEACE & LOVE, compresión y movilidad temprana indolora.\nF2: Movilidad progresiva, fortalecimiento.\nF3: Funcional y retorno.",
      fases:[
        {f:"Fase 1 — Aguda (0-72h)",ejs:["Crioterapia y compresión inmediata","Elevación del miembro","Movilidad activa suave en rango indoloro","Sin masaje profundo ni calor"]},
        {f:"Fase 2 — Subaguda (3 días-2 sem)",ejs:["Movilidad activa progresiva","Isotónica concéntrica en rango indoloro 3x15","Termoterapia superficial desde sem 2","Marcha normal"]}  ,
        {f:"Fase 3 — Funcional (2-4 sem)",ejs:["Fortalecimiento excéntrico","Pliometría progresiva","Carrera progresiva","Gestos deportivos"]}
      ],
      rts:"ROM completo sin dolor · Fuerza ≥90% · Marcha sin cojera · Sprint sin dolor"},

    { n:"Síndrome de sobreentrenamiento", z:"Espalda",
      e:["HRV reducida","Fatiga persistente >2 semanas","Rendimiento disminuido","RESTQ-Sport cuestionario","Cortisol/testosterona ratio"],
      p:"F1(1-3sem): Reposo activo, nutrición y sueño.\nF2(3-6sem): Entrenamiento bajo volumen con HRV.\nF3(6-12sem): Periodización progresiva.",
      fases:[
        {f:"Fase 1 — Recuperación activa (1-3 sem)",ejs:["Actividad muy ligera 30min/día (caminar, estiramientos)","Sueño ≥8-9 horas","Nutrición: surplus calórico, proteína 2g/kg","Evaluación psicológica si necesario"]},
        {f:"Fase 2 — Reintroducción (3-6 sem)",ejs:["Aeróbico suave 40-60% VO2max","Sesiones cortas 30-40min con HRV monitoring","Técnica sin intensidad máxima","Registro de sueño y recuperación"]},
        {f:"Fase 3 — Periodización (6-12 sem)",ejs:["Plan periodizado con descansos estructurados","Monitorización constante HRV y RPE","Técnicas recuperación: crioterapia, masaje","Planificación de competiciones"]}
      ],
      rts:"HRV normalizada · Rendimiento deportivo basal · RESTQ normal · Bienestar subjetivo recuperado"},

    // ===== 🦵 RODILLA — LESIONES ADICIONALES =====
    { n:"Síndrome de Osgood-Schlatter", z:"Rodilla",
      e:["Palpación tuberosidad tibial","Rx lateral rodilla (fragmento óseo)","Dolor con actividad y alivio en reposo","Prueba de extensión resistida"],
      p:"F1(aguda): Reducir carga, hielo post-actividad.\nF2: Fortalecimiento cuádriceps excéntrico, estiramientos.\nF3: Retorno progresivo al deporte.",
      fases:[
        {f:"Fase 1 — Control de carga (0-4 sem)",ejs:["Reducir volumen deportivo 50%","Crioterapia 15min post-actividad","Estiramiento cuádriceps pasivo 3x30seg","Isométrico cuádriceps sin dolor 3x10x10seg"]},
        {f:"Fase 2 — Fortalecimiento (4-10 sem)",ejs:["Excéntrico cuádriceps en escalón (decline squat) 3x15","Leg press en rango corto 3x15","Fortalecimiento glúteo y cadera 3x15","Vuelta al deporte progresiva sin dolor"]},
        {f:"Fase 3 — Retorno deportivo (10-20 sem)",ejs:["Pliometría de bajo impacto progresiva","Saltos con aterrizaje técnico 3x10","Gestos deportivos específicos","Entrenamiento completo sin restricción"]}
      ],
      rts:"Sin dolor en tuberosidad tibial · Extensión sin dolor · Salto sin restricción"},

    

    { n:"Síndrome de Sinding-Larsen-Johansson", z:"Rodilla",
      e:["Dolor polo inferior rótula en adolescentes","Rx rodilla lateral","Dolor en salto y carrera","Palpación polo inferior"],
      p:"F1: Reducción de carga deportiva.\nF2: Excéntrico tendón rotuliano, flexibilidad.\nF3: Retorno progresivo.",
      fases:[
        {f:"Fase 1 — Control carga (0-4 sem)",ejs:["Reducir saltos y sprints","Crioterapia post-entrenamiento","Estiramiento cuádriceps 3x30seg","Isométrico cuádriceps en extensión 3x10seg"]},
        {f:"Fase 2 — Excéntrico (4-10 sem)",ejs:["Decline squat excéntrico 3x15","Fortalecimiento isquiotibiales 3x15","Propiocepción progresiva 3x30seg","Bicicleta estática sin carga"]},
        {f:"Fase 3 — Retorno (10-20 sem)",ejs:["Saltos progresivos de bajo impacto","Sprint progresivo 50-75-100%","Gestos deportivos específicos","Entrenamiento completo"]}
      ],
      rts:"Sin dolor en polo inferior · Salto sin restricción · Actividad deportiva completa"},

    { n:"Síndrome de banda iliotibial (ITBS)", z:"Rodilla",
      e:["Test de Ober","Noble Compression Test","Dolor lateral rodilla en carrera (km concreto)","Inspección de pisada y biomecánica"],
      p:"F1(0-2sem): Reducir kilometraje, foam roller, crioterapia.\nF2(2-6sem): Fortalecimiento glúteo medio, cadera.\nF3(6-12sem): Retorno a carrera progresivo.",
      fases:[
        {f:"Fase 1 — Descarga (0-2 sem)",ejs:["Foam roller IT band y TFL 5min","Estiramiento TFL en decúbito lateral 3x30seg","Reducir kilómetros de carrera 50%","Crioterapia post-entrenamiento"]},
        {f:"Fase 2 — Glúteo (2-6 sem)",ejs:["Clamshell con banda 3x20","Abducción lateral en polea baja 3x15","Hip thrust unilateral 4x10","Step down con control caída pélvica 3x12"]},
        {f:"Fase 3 — Carrera (6-12 sem)",ejs:["Retorno a carrera: 10%-20%/semana","Técnica de carrera: cadencia, zancada","Carrera en terreno blando progresivamente","Análisis biomecánico completo"]}
      ],
      rts:"Noble compression negativo · Carrera sin dolor · Glúteo simétrico · Técnica corregida"},

    { n:"Lesión LCP (ligamento cruzado posterior)", z:"Rodilla",
      e:["Test del cajón posterior","Test de Godfrey (Sag sign)","RMN rodilla","Dial test (15° y 30°)","Evaluación inestabilidad posterolateral"],
      p:"F1(0-4sem): Inmovilización, isometría.\nF2(4-12sem): Fortalecimiento cuádriceps e isquios.\nF3(12-24sem): Funcional y retorno.",
      fases:[
        {f:"Fase 1 — Protección (0-4 sem)",ejs:["Ortesis funcional anti-cajón posterior","Isométrico cuádriceps en extensión 5x10seg","SLR 3x10","Marcha con muletas y apoyo parcial"]},
        {f:"Fase 2 — Fortalecimiento (4-12 sem)",ejs:["Leg press en cadena cerrada 3x15","Prensa bilateral a unilateral progresiva","Propiocepción dinámica 3x30seg","Bicicleta estática con progresión"]},
        {f:"Fase 3 — Funcional (12-24 sem)",ejs:["Sentadilla unilateral 3x10","Pliometría bilateral y unilateral","Cambios de dirección a velocidad","Retorno deportivo según criterios LSI"]}
      ],
      rts:"Cajón posterior negativo · Fuerza cuádriceps ≥90% · LSI ≥90% · Sprint sin dolor"},

    

    

    { n:"Bursitis prerrotuliana", z:"Rodilla",
      e:["Palpación prerrotuliana","Fluctuación local","Enrojecimiento y calor local","Ecografía bursa","Eritrosedimentación"],
      p:"F1: Aspiración si necesario, AINE, descarga.\nF2: Fortalecimiento progresivo.\nF3: Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Control inflamatorio (0-2 sem)",ejs:["Evitar arrodillarse","Crioterapia 15min x4/día","Compresión con vendaje","AINE tópico si prescrito"]},
        {f:"Fase 2 — Fortalecimiento (2-6 sem)",ejs:["Isométrico cuádriceps sin presión 3x10seg","SLR 3x15","Bicicleta estática suave","Fortalecimiento glúteo y cadera"]},
        {f:"Fase 3 — Retorno (6-10 sem)",ejs:["Deporte sin contacto en rodilla","Deportes de contacto con rodillera protectora","Fortalecimiento progresivo completo","Retorno completo al deporte"]}
      ],
      rts:"Sin fluctuación bursal · Arrodillarse sin dolor · Deporte sin restricción"},

    

    // ===== 🦶 PIE Y TOBILLO — LESIONES ADICIONALES =====
    { n:"Periostitis tibial (Shin Splints)", z:"Tobillo",
      e:["Dolor medial tibio 1/3 distal","Palpación dolorosa cresta tibial","Rx para descartar fractura estrés","Gammagrafía ósea si sospecha fractura"],
      p:"F1(0-2sem): Reducir carga de impacto.\nF2(2-6sem): Fortalecimiento intrínseco y tobillo.\nF3(6-12sem): Retorno a carrera progresivo.",
      fases:[
        {f:"Fase 1 — Descarga (0-2 sem)",ejs:["Sustituir carrera por bicicleta/natación","Crioterapia post-actividad 15min","Masaje en cresta tibial suave","Corrección de pisada y calzado"]},
        {f:"Fase 2 — Fortalecimiento (2-6 sem)",ejs:["Elevaciones de talón excéntricas 3x15","Tibial anterior: dorsiflexión con banda 3x15","Short foot exercise 3x15","Carrera en agua o piscina"]},
        {f:"Fase 3 — Retorno (6-12 sem)",ejs:["Retorno a carrera: +10% volumen/semana","Técnica de carrera (cadencia, postura)","Superficie blanda inicialmente","Análisis biomecánico de la marcha"]}
      ],
      rts:"Sin dolor en palpación · Carrera 30min sin dolor · Biomecánica corregida"},

    

    

    { n:"Síndrome compartimental crónico", z:"Tobillo",
      e:["Presión intracompartimental post-ejercicio (>30mmHg)","Dolor reproducible con ejercicio","Parestesias en ejercicio","Test de marcha en cinta con monitorización"],
      p:"F1: Modificación de entrenamiento, técnica de carrera.\nF2: Estiramiento y masaje de fascia.\nF3: Descompresión quirúrgica si no mejora.",
      fases:[
        {f:"Fase 1 — Modificación (0-4 sem)",ejs:["Reducir volumen e intensidad 50%","Técnica de carrera: aumentar cadencia","Calzado minimalista progresivo","Estiramiento compartimento anterior y posterior"]},
        {f:"Fase 2 — Conservador (4-12 sem)",ejs:["Masaje transverso profundo en compartimento","Foam roller cara lateral y anterior pierna","Fortalecimiento tobillo y pie 3x15","Superficie blanda para entrenar"]},
        {f:"Fase 3 — Retorno/Quirúrgico (12+ sem)",ejs:["Rehabilitación post-fasciotomía si fue necesaria","Retorno progresivo a carrera","Técnica de carrera con asesoramiento","Monitorización de presiones"]}
      ],
      rts:"Presión postejercicio <30mmHg · Carrera sin parestesias · Deporte sin restricción"},

    { n:"Neuroma de Morton", z:"Tobillo",
      e:["Signo de Mulder (click doloroso)","Palpación espacio 3-4 interdigital","Ecografía (tamaño del neuroma)","Anestesia diagnóstica local"],
      p:"F1: Plantillas con apoyo metatarsal, calzado ancho.\nF2: Infiltración corticoidea si necesario.\nF3: Neurectomía si falla conservador.",
      fases:[
        {f:"Fase 1 — Conservador (0-8 sem)",ejs:["Plantilla con barra metatarsal","Calzado ancho con caja de dedos amplia","Crioterapia en espacio interdigital","Evitar tacones y calzado estrecho"]},
        {f:"Fase 2 — Infiltración (4-12 sem si necesario)",ejs:["Infiltración corticoidea guiada por eco","Rehabilitación conservadora continua","Separadores interddigitales","Marcha consciente y técnica"]},
        {f:"Fase 3 — Post-neurectomía (si quirúrgico)",ejs:["Vendaje postoperatorio","Carga progresiva con calzado adecuado","Desensibilización zona operada","Retorno deportivo 6-8 semanas"]}
      ],
      rts:"Mulder negativo · Marcha sin parestesias · Calzado deportivo sin dolor"},

    

    { n:"Tendinopatía peroneal", z:"Tobillo",
      e:["Palpación retromaleolar lateral","Dolor en resistencia a eversión","Ecografía tendinosa","Test de single leg heel raise"],
      p:"F1: Descarga relativa, isometría.\nF2: Excéntrico peroneos, propiocepción.\nF3: Pliometría y retorno al deporte.",
      fases:[
        {f:"Fase 1 — Control carga (0-3 sem)",ejs:["Reducir actividad deportiva","Crioterapia post-actividad","Isométrico eversión en neutro 5x45seg","Cinta kinesiológica de soporte"]},
        {f:"Fase 2 — Excéntrico (3-8 sem)",ejs:["Eversión excéntrica con banda 3x15","Elevación lateral de talón 3x15","Propiocepción unipodal progresiva 3x30seg","Equilibrio con perturbación manual"]},
        {f:"Fase 3 — Pliometría (8-14 sem)",ejs:["Saltos laterales con aterrizaje 3x10","Cambios de dirección progresivos","Sprint sin dolor","Deporte específico con progresión"]}
      ],
      rts:"Eversión sin dolor · Hop test >90% · Carrera sin restricción"},

    // ===== 💪 HOMBRO — LESIONES ADICIONALES =====
    { n:"Rotura del manguito rotador (parcial)", z:"Hombro",
      e:["Test de Neer","Test de Hawkins-Kennedy","Test de Jobe (supraespinoso)","RMN hombro (grado de rotura)","Ecografía dinámica"],
      p:"F1(0-4sem): Descarga, analgesia, ROM.\nF2(4-12sem): Fortalecimiento progresivo manguito.\nF3(12-24sem): Carga funcional y retorno.",
      fases:[
        {f:"Fase 1 — Protección (0-4 sem)",ejs:["Cabestrillo si necesario","Péndulos de Codman sin carga 3x2min","Crioterapia y TENS para analgesia","ROM pasivo y activo-asistido"]},
        {f:"Fase 2 — Fortalecimiento (4-12 sem)",ejs:["Rotación interna y externa con banda 3x15","Elevación lateral en plano escapular 3x15","Remo en T con mancuerna 3x12","Push up plus (serrato anterior) 3x15"]},
        {f:"Fase 3 — Funcional (12-24 sem)",ejs:["Press hombro progresivo 4x10","Tracción y remo con carga 4x10","Gestos deportivos específicos (lanzar, nadar)","Análisis biomecánico del gesto técnico"]}
      ],
      rts:"ROM completo · Fuerza ≥80% · Gesto deportivo sin dolor · RMN de seguimiento"},

    { n:"Rotura del manguito rotador (total, post-quirúrgico)", z:"Hombro",
      e:["RMN pre/post-operatoria","ROM activo","Dinamometría isocinética","Constant Score","Protocolo post-quirúrgico según cirujano"],
      p:"F1(0-6sem): Cabestrillo, péndulos, ROM pasivo.\nF2(6-12sem): ROM activo, isometría, fortalecimiento inicial.\nF3(12-24sem): Fortalecimiento progresivo, retorno.",
      fases:[
        {f:"Fase 1 — Post-quirúrgico (0-6 sem)",ejs:["Cabestrillo abducción 30°","Péndulos de Codman sin carga 3x2min","ROM pasivo con fisioterapeuta","Ejercicios muñeca, codo y mano"]},
        {f:"Fase 2 — Activo (6-12 sem)",ejs:["ROM activo-asistido progresivo","Isométrico manguito en posición media 3x10seg","Fortalecimiento serrato y trapecio bajo 3x15","Elevación activa plano escapular a 90°"]},
        {f:"Fase 3 — Funcional (12-24 sem)",ejs:["Fortalecimiento manguito con banda progresiva","Press y remo progresivos","Trabajo de potencia hombro (velocidades)","Gestos deportivos específicos"]}
      ],
      rts:"Constant Score>70 · Elevación activa sin compensación · Fuerza ≥80% contralateral · 6 meses post-cirugía"},

    

    

    { n:"Luxación acromioclavicular", z:"Hombro",
      e:["Clasificación Rockwood (I-VI)","Rx bilateral en carga","Palpación ACJ","Cross-body adduction test","Piano key sign"],
      p:"F1(grado I-II): Cabestrillo 2-3sem, analgesia.\nF2: ROM progresivo, fortalecimiento.\nF3: Retorno deportivo con protección.",
      fases:[
        {f:"Fase 1 — Protección (0-3 sem)",ejs:["Cabestrillo o vendaje según grado","Crioterapia local 15min x3/día","ROM pasivo y péndulos","Ejercicios mano y codo"]},
        {f:"Fase 2 — ROM y fortalecimiento (3-8 sem)",ejs:["Movilidad activa-asistida hombro","Isométrico deltoides y manguito 3x10seg","Fortalecimiento trapecio bajo y serrato 3x15","Ejercicios de retracción escapular 3x15"]},
        {f:"Fase 3 — Retorno (8-14 sem)",ejs:["Fortalecimiento completo hombro 4x10","Gestos deportivos con protección (hombreras)","Entrenamiento sin contacto primero","Contacto completo según deporte"]}
      ],
      rts:"ROM completo · Fuerza ≥90% · Gestos sin dolor · Palpación ACJ indolora"},

    { n:"Discinesia escapular", z:"Hombro",
      e:["Observación de ritmo escapulohumeral","Test de Kibler (escápula alada)","Test de serrato anterior","Análisis de hombro en movimiento funcional","Prueba de manguito con corrección escapular"],
      p:"F1: Educación postural, activación serrato.\nF2: Fortalecimiento escapular completo.\nF3: Integración en gesto deportivo.",
      fases:[
        {f:"Fase 1 — Activación (0-3 sem)",ejs:["Push up plus en pared o suelo 3x15","Wall slide con retracción 3x15","Remo en Y y T con banda 3x12","Corrección postural en bipedestación"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["Fortalecimiento trapecio inferior: Y en prono 3x15","Serrato anterior: protracción con carga 3x15","Remo bilateral en cable 4x12","Ejercicios en supino con carga"]},
        {f:"Fase 3 — Integración (8-14 sem)",ejs:["Gestos deportivos con correcta activación","Técnica de lanzamiento o natación corregida","Análisis videográfico del gesto","Entrenamiento completo"]}
      ],
      rts:"Ritmo escapulohumeral simétrico · Manguito sin dolor con corrección · Gesto técnico óptimo"},

    { n:"Tendinitis bíceps larga porción", z:"Hombro",
      e:["Speed test","Yergason test","Palpación corredera bicipital","Ecografía de la corredera","Prueba de resistencia a la flexión de codo"],
      p:"F1: Descarga, crioterapia, TENS.\nF2: Excéntrico bíceps, estabilización escapular.\nF3: Carga completa, gestos deportivos.",
      fases:[
        {f:"Fase 1 — Control dolor (0-3 sem)",ejs:["Evitar flexión de codo con resistencia","Crioterapia 15min x3/día","TENS en corredera bicipital","Movilidad escapular en descarga"]},
        {f:"Fase 2 — Excéntrico (3-8 sem)",ejs:["Excéntrico bíceps con barra o mancuerna 3x15","Supinación resistida 3x15","Fortalecimiento manguito y serrato 3x15","Trabajo de control escapular"]},
        {f:"Fase 3 — Funcional (8-14 sem)",ejs:["Press y remo progresivos","Flexión de codo con carga completa 4x10","Gestos deportivos específicos","Lanzamiento y tracción progresivos"]}
      ],
      rts:"Speed y Yergason negativos · Flexión sin dolor · Deporte sin restricción"},

    // ===== 🦴 COLUMNA — LESIONES ADICIONALES =====
    { n:"Espondilolistesis", z:"Espalda",
      e:["Rx lateral con deslizamiento","Clasificación Meyerding (I-IV)","Test de hiperextensión (provocación)","Evaluación neurológica","RMN para partes blandas"],
      p:"F1: Evitar hiperextensión, estabilización lumbar.\nF2: Core profundo, glúteos, cadera.\nF3: Deportes con vigilancia biomecánica.",
      fases:[
        {f:"Fase 1 — Estabilización (0-6 sem)",ejs:["Activación transverso: respiración abdominal 3x10","Bird-dog sin extensión lumbar 3x10x10seg","Evitar gestes de hiperextensión","Educación postural: lordosis controlada"]},
        {f:"Fase 2 — Fortalecimiento (6-16 sem)",ejs:["McGill Big 3 progresivo","Hip thrust con pelvis neutra 4x10","Puente en anti-extensión 3x15","Fortalecimiento glúteo completo"]},
        {f:"Fase 3 — Funcional (16-24 sem)",ejs:["Sentadilla con carga moderada","Deporte adaptado sin hiperextensión forzada","Técnica de carrera con core activo","Monitorización de síntomas"]}
      ],
      rts:"Sin dolor en hiperextensión · Core estable · Deporte tolerado sin irradiación"},

    { n:"Latigazo cervical", z:"Espalda",
      e:["Clasificación WAD (I-IV)","ROM cervical goniométrico","Test de flexión craneocervical","NDI cuestionario","Prueba de esfuerzo cervical"],
      p:"F1(0-2sem): Movilización precoz (no inmovilización).\nF2(2-6sem): Fortalecimiento flexores profundos.\nF3(6-12sem): Retorno actividad completa.",
      fases:[
        {f:"Fase 1 — Movilización precoz (0-2 sem)",ejs:["Movilidad cervical activa en todos los planos 3x10","Calor local o crioterapia según preferencia","Educación: pronóstico favorable, moverse","Evitar collarín excepto WAD III-IV"]},
        {f:"Fase 2 — Fortalecimiento (2-6 sem)",ejs:["Chin tuck (retracción cervical) 3x15","Isométrico flexores profundos 3x10seg","Fortalecimiento trapecio inferior y serrato 3x15","Estiramiento angular suboccipital"]},
        {f:"Fase 3 — Funcional (6-12 sem)",ejs:["Control motor cervical en movimientos dinámicos","Aeróbico suave: caminar o nadar","Gestos laborales/deportivos específicos","Técnica ergonómica"]}
      ],
      rts:"NDI<10% · ROM completo · Trabajo sin restricción · Sin cefalea persistente"},

    { n:"Dorsalgia postural", z:"Espalda",
      e:["Evaluación postural sagital y coronal","ROM torácico","Movilidad costovertebral","Test de extensión torácica","Valoración muscular escapular"],
      p:"F1: Movilidad torácica, corrección postural.\nF2: Fortalecimiento escapular y core.\nF3: Ergonomía avanzada, retorno funcional.",
      fases:[
        {f:"Fase 1 — Movilidad (0-3 sem)",ejs:["Extensión torácica en rodillo espuma 3x10","Rotación torácica en decúbito 3x10","Movilidad costovertebral: respiración profunda 3x10","Estiramiento pectoral mayor en poste 3x30seg"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["Remo bilateral con banda 3x15","Retracción escapular isométrica 3x10seg","Remo en Y y T en prono 3x12","Plancha dorsal (remo con rotación) 3x10"]},
        {f:"Fase 3 — Ergonomía (8-12 sem)",ejs:["Adaptación postural en trabajo/deporte","Pausas activas cada 45min","Deporte sin restricción con técnica","Evaluación ergonómica del puesto"]}
      ],
      rts:"Postura mejora · Dolor <2 EVA · Jornada laboral sin restricción"},

    { n:"Contractura paravertebral", z:"Espalda",
      e:["Palpación de bandas tensas","ROM lumbar y dorsal","Test de flexión anterior","Test de Thomas para psoas","Evaluación de puntos gatillo"],
      p:"F1: Terapia manual, calor, estiramiento.\nF2: Fortalecimiento de antagonistas.\nF3: Prevención y retorno.",
      fases:[
        {f:"Fase 1 — Analgesia y liberación (0-2 sem)",ejs:["Calor local 20min x2/día","Masaje terapéutico paravertebral","Estiramiento lumbar: rodilla al pecho 3x30seg","Punción seca si puntos gatillo activos"]},
        {f:"Fase 2 — Fortalecimiento (2-6 sem)",ejs:["Cat-camel 3x10","Bird-dog 3x10x10seg","Plancha ventral 3x30seg","Fortalecimiento glúteo mayor 3x15"]},
        {f:"Fase 3 — Prevención (6-10 sem)",ejs:["Higiene postural en deporte","Calentamiento específico previo a la actividad","Entrenamiento de fuerza equilibrado","Técnica deportiva sin compensación"]}
      ],
      rts:"Palpación sin bandas tensas activas · ROM completo · Deporte sin restricción"},

    // ===== 🍑 CADERA — LESIONES ADICIONALES =====
    { n:"Síndrome cadera en resorte", z:"Cadera",
      e:["Snapping reproducible con ROM","Test de Thomas","Ober test","Evaluación de TFL y psoas","Ecografía dinámica de cadera"],
      p:"F1: Identificar estructura (TFL o psoas), estiramiento.\nF2: Fortalecimiento agonistas/antagonistas.\nF3: Control biomecánico.",
      fases:[
        {f:"Fase 1 — Estiramiento (0-3 sem)",ejs:["Estiramiento psoas ilíaco: zancada baja 3x30seg","Estiramiento TFL: lateral 3x30seg","Foam roller cuadrado de cadera 5min","Crioterapia si dolor local"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["Hip thrust bilateral a unilateral 4x10","Clamshell con banda 3x20","Abducción lateral en polea 3x15","Control motor cadera en sentadilla 3x12"]},
        {f:"Fase 3 — Control biomecánico (8-12 sem)",ejs:["Carrera con técnica adecuada","Sentadilla profunda con control","Gestos deportivos específicos","Evaluación de patrón de movimiento"]}
      ],
      rts:"Resalte sin dolor · Marcha normal · Deporte sin restricción"},

    { n:"Fractura por estrés de cadera (cuello femoral)", z:"Cadera",
      e:["RMN cadera (gold standard)","Gammagrafía","Clasificación: tensión vs compresión","Dolor inguinal con actividad","Test de la patada (FADRL positivo)"],
      p:"F1: Descarga total/parcial según tipo.\nF2: Carga progresiva sin dolor.\nF3: Retorno a carrera muy controlado.",
      fases:[
        {f:"Fase 1 — Descarga (0-8 sem)",ejs:["Muletas o descarga total (tipo tensión)","Bicicleta en agua si disponible","Ejercicios musculatura no cargada","Control radiológico mensual"]},
        {f:"Fase 2 — Carga progresiva (8-16 sem)",ejs:["Marcha progresiva sin dolor","Bicicleta con carga mínima","Fortalecimiento cadera en descarga","Piscina: caminar en agua"]},
        {f:"Fase 3 — Retorno carrera (16-24 sem)",ejs:["Protocolo: marcha→trote→carrera","Aumento 10% de volumen/semana","Monitorización de dolor con EVA","RMN de seguimiento"]}
      ],
      rts:"RMN consolidada · Marcha sin dolor · Carrera 30min sin dolor"},

    { n:"Meralgia parestésica", z:"Cadera",
      e:["Parestesias cara anterolateral muslo","Prueba de compresión inguinal","Tinnel en LMCI (ligamento inguinal)","Evaluación postura y ropa compresiva","Electromiografía"],
      p:"F1: Eliminar compresión, educación.\nF2: Neurodinamia femorocutáneo lateral.\nF3: Prevención recidiva.",
      fases:[
        {f:"Fase 1 — Descompresión (0-3 sem)",ejs:["Eliminar cinturones y ropa apretada","Estiramiento psoas ilíaco 3x30seg","Movilización neural: deslizamiento del FCL","Educación sobre postura y compresión"]},
        {f:"Fase 2 — Neurodinamia (3-6 sem)",ejs:["Deslizamiento neuromeníngeo FCL: 3x10","Estiramiento lateral de pelvis 3x30seg","Control postural en bipedestación","Fortalecimiento cadera para estabilidad"]},
        {f:"Fase 3 — Prevención (6-10 sem)",ejs:["Control postural en deporte","Evitar ropa compresiva en ejercicio","Análisis biomecánico de la marcha","Retorno completo sin restricción"]}
      ],
      rts:"Sin parestesias en actividad · Tinel negativo · Deporte sin restricción"},

    // ===== 💪 CODO — LESIONES ADICIONALES =====
    { n:"Epitrocleitis (codo golfista)", z:"Hombro",
      e:["Test de Golfer's elbow (flexión resistida muñeca con codo extendido)","Palpación epitróclea","ROM de codo","MEPS cuestionario"],
      p:"F1(0-4sem): Descarga, isométrico en neutro, crioterapia.\nF2(4-8sem): Excéntrico de flexores muñeca.\nF3(8-12sem): Retorno al gesto.",
      fases:[
        {f:"Fase 1 — Control dolor (0-4 sem)",ejs:["Isométrico flexores muñeca en neutro 5x45seg","Crioterapia post-actividad 15min","Codadera medial","Evitar gesto provocador"]},
        {f:"Fase 2 — Excéntrico (4-8 sem)",ejs:["Excéntrico flexores muñeca con mancuerna 3x15","Fortalecimiento pronadores 3x15","Masaje transverso profundo (Cyriax)","Liberación miofascial antebrazo medial"]},
        {f:"Fase 3 — Funcional (8-12 sem)",ejs:["Fortalecimiento agarre progresivo","Cadena cinética MMSS","Retorno al gesto deportivo (golf, béisbol)","Análisis biomecánico del swing o lanzamiento"]}
      ],
      rts:"Golfer's test negativo · Agarre sin dolor · Gesto completo sin restricción"},

    { n:"Codo del lanzador (UCL medial)", z:"Hombro",
      e:["Valgus Stress Test a 30°","Moving Valgus Stress Test","Palpación ligamento colateral medial","RMN artro (gold standard)","Evaluación del gesto de lanzamiento"],
      p:"F1(0-6sem): Descarga de lanzamiento, isometría.\nF2(6-12sem): Fortalecimiento progresivo.\nF3(12-24sem): Throwing program.",
      fases:[
        {f:"Fase 1 — Descarga (0-6 sem)",ejs:["Suspender lanzamiento completamente","Isométrico flexores codo y muñeca 3x10seg","ROM activo codo y muñeca sin dolor","Fortalecimiento escápula y hombro"]},
        {f:"Fase 2 — Fortalecimiento (6-12 sem)",ejs:["Fortalecimiento flexores codo 3x15","Fortalecimiento pronadores 3x15","Control valgo dinámico del codo","Cadena cinética MMSS"]},
        {f:"Fase 3 — Throwing program (12-24 sem)",ejs:["Tiro suave 10m progresivo","Aumento distancia gradual cada semana","Velocidades progresivas hasta 100%","Regreso a competición"]}
      ],
      rts:"Valgus stress negativo · Programa de lanzamiento completado · Sin dolor en competición"},

    { n:"Fractura de olécranon", z:"Hombro",
      e:["Rx lateral de codo","Palpación de olécranon","Test de extensión activa","Clasificación Mayo","Evaluación quirúrgica"],
      p:"F1(post-quirúrgico 0-6sem): ROM pasivo, movilidad muñeca.\nF2(6-12sem): ROM activo, fortalecimiento.\nF3(12-20sem): Fuerza completa, retorno.",
      fases:[
        {f:"Fase 1 — Post-quirúrgico (0-6 sem)",ejs:["Movilidad activa muñeca y dedos","ROM pasivo del codo 0-90°","Crioterapia post-ejercicio","Ejercicios isométricos distales"]},
        {f:"Fase 2 — ROM activo (6-12 sem)",ejs:["ROM activo codo progresivo","Isométrico tríceps en posición media 3x10seg","Bicicleta ergométrica con brazo","Fortalecimiento hombro sin extensión máxima"]},
        {f:"Fase 3 — Fuerza (12-20 sem)",ejs:["Fortalecimiento tríceps progresivo 4x10","Press tricipital en polea 4x10","Gestos deportivos progresivos","Retorno al deporte según Rx"]}
      ],
      rts:"Rx consolidada · Extensión activa completa · Fuerza ≥90% · Rx de seguimiento normal"},

    { n:"Síndrome del nervio ulnar en codo (cubital tardío)", z:"Hombro",
      e:["Tinel en canal de Guyon","Prueba de flexión de codo","Test de monofilamento 4-5 dedos","Electromiografía","Evaluación de la musculatura hipotenar"],
      p:"F1: Evitar flexión prolongada, férula nocturna.\nF2: Neurodinamia del cubital.\nF3: Fortalecimiento intrínseco, retorno.",
      fases:[
        {f:"Fase 1 — Protección (0-4 sem)",ejs:["Férula nocturna codo en 40° de flexión","Evitar apoyo del codo sobre superficies","Crioterapia local si inflamación","Educación sobre postura y ergonomía"]},
        {f:"Fase 2 — Neurodinamia (4-8 sem)",ejs:["Deslizamiento neuromeníngeo cubital: 3x10","Movilización activa codo y muñeca","Fortalecimiento musculatura intrínseca de mano","Evitar presión en canal de Guyon"]},
        {f:"Fase 3 — Funcional (8-14 sem)",ejs:["Fuerza de pinza y agarre lateral 3x15","Gestos deportivos específicos","Ergonomía del puesto de trabajo/deportivo","Retorno completo"]}
      ],
      rts:"Tinel negativo · Sensibilidad recuperada · Agarre sin debilidad · Deporte sin parestesias"},

    // ===== 🧠 NEUROLÓGICO DEPORTIVO — LESIONES ADICIONALES =====
    { n:"Radiculopatía cervical", z:"Cuello/Cervical",
      e:["Test de distracción cervical","Test de compresión (Spurling)","Evaluación neurológica C4-T1","RMN cervical (nivel y grado)","Evaluación sensitiva de dermatomas"],
      p:"F1(0-4sem): Tracción, TENS, postura descompresiva.\nF2(4-10sem): Neurodinamia, fortalecimiento cervical.\nF3(10-20sem): Funcional y retorno.",
      fases:[
        {f:"Fase 1 — Descompresión (0-4 sem)",ejs:["TENS cervical para analgesia","Tracción cervical manual o mecánica","Postura antiálgica (descompresiva)","Movilización grado I-II en nivel afectado"]},
        {f:"Fase 2 — Neurodinamia (4-10 sem)",ejs:["ULTT (Prueba neuromeníngea MMSS): 3x10","Fortalecimiento flexores cervicales profundos 3x10","Retracción cervical con resistencia 3x15","Fortalecimiento escapular 3x15"]},
        {f:"Fase 3 — Funcional (10-20 sem)",ejs:["Control cervical en movimientos funcionales","Gestos deportivos específicos con control","Ergonomía del puesto de trabajo","Retorno deportivo completo"]}
      ],
      rts:"Spurling negativo · Déficit neurológico resuelto · ROM sin restricción · Trabajo sin dolor"},

    { n:"Síndrome de salida torácica", z:"Cuello/Cervical",
      e:["Test de Adson","Test de hiperabducción (Wright)","Test de Roos (EAST)","Evaluación vascular y neurológica","Evaluación escapular y cervical"],
      p:"F1: Postura escapular, estiramiento descompresivo.\nF2: Fortalecimiento escapular, reducir hipertono.\nF3: Ergonomía, retorno funcional.",
      fases:[
        {f:"Fase 1 — Descompresión postural (0-4 sem)",ejs:["Corrección postura escapular: retracción 3x15","Estiramiento escalenos: lateral 3x30seg","Estiramiento pectoral menor 3x30seg","Evitar posturas provocadoras"]},
        {f:"Fase 2 — Fortalecimiento (4-10 sem)",ejs:["Fortalecimiento trapecio inferior: Y 3x15","Serrato anterior: protracción 3x15","Neurodinamia braquial suave 3x10","Respiración diafragmática 3x10"]},
        {f:"Fase 3 — Funcional (10-16 sem)",ejs:["Ergonomía laboral/deportiva","Control postural en actividad","Gestos deportivos sin compresión","Retorno completo al deporte"]}
      ],
      rts:"Roos <1min sin síntomas · Adson negativo · Trabajo sin parestesias"},

    { n:"Cefalea cervicogénica", z:"Cuello/Cervical",
      e:["Diagnostic Criteria (ICHD-3)","Test de flexión-rotación (flexo-rot test)","Palpación articulación C1-C2","ROM cervical completo","VAS cefalea"],
      p:"F1: Terapia manual C1-C2, TENS.\nF2: Fortalecimiento flexores profundos.\nF3: Ergonomía y mantenimiento.",
      fases:[
        {f:"Fase 1 — Terapia manual (0-4 sem)",ejs:["Movilización SNAG C1-C2 (Mulligan)","TENS occipital para analgesia","Estiramiento suboccipital 3x30seg","Educación sobre origen cervical de la cefalea"]},
        {f:"Fase 2 — Fortalecimiento (4-8 sem)",ejs:["CCFT: chin tuck con biofeedback 3x10","Fortalecimiento trapecio inferior 3x15","Retracción cervical con banda 3x15","Control postural en sedestación"]},
        {f:"Fase 3 — Mantenimiento (8-12 sem)",ejs:["Ergonomía de pantalla y trabajo","Pausas activas cada 45 minutos","Ejercicio aeróbico suave regular","Control de factores precipitantes"]}
      ],
      rts:"Flexo-rot test simétrico · VAS cefalea <2 · Jornada laboral sin restricción"},

    // ===== 🦶 PIERNA — LESIONES ADICIONALES =====
    

    { n:"Rotura total del Aquiles (post-quirúrgico)", z:"Tobillo",
      e:["Evaluación post-operatoria","ATRS cuestionario","Single-leg heel rise test","Análisis de la marcha","Retorno deportivo criteria (RTS criteria)"],
      p:"F1(0-6sem): Bota y carga progresiva.\nF2(6-14sem): ROM completo, fortalecimiento.\nF3(14-24sem): Pliometría y retorno deportivo.",
      fases:[
        {f:"Fase 1 — Post-quirúrgico (0-6 sem)",ejs:["Bota walker con cuñas de descarga","Carga con bota desde semana 2","ROM tobillo a 0° (neutro) semana 6","Ejercicios proximales: cadera y rodilla"]},
        {f:"Fase 2 — ROM y fuerza (6-14 sem)",ejs:["ROM activo tobillo sin restricción","Elevación bilateral talón progresiva","Fortalecimiento tríceps sural isométrico a concéntrico","Natación y bicicleta sin impacto"]},
        {f:"Fase 3 — Pliometría (14-24 sem)",ejs:["Protocolo Alfredson progresivo","Pliometría bilateral: saltos con cuerda","Pliometría unilateral progresiva","Sprint progresivo al 50-100%"]}
      ],
      rts:"ATRS>80 · 25 elevaciones monopodales · Sprint sin cojera · 9-12 meses post-cirugía"},

    { n:"Lesión condral de tobillo (OCD talar)", z:"Tobillo",
      e:["RMN tobillo (clasificación OCD)","Artroscopia diagnóstica","Rx con carga","Evaluación de inestabilidad ligamentaria","FAOS cuestionario"],
      p:"F1(0-6sem): Descarga o bota según tamaño.\nF2(6-14sem): Carga progresiva, propiocepción.\nF3(14-24sem): Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Protección (0-6 sem)",ejs:["Bota walker sin carga o descarga parcial","Crioterapia frecuente","Ejercicios MMSS y cadera","Natación sin apoyo de pie"]},
        {f:"Fase 2 — Carga progresiva (6-14 sem)",ejs:["Marcha sin bota con carga total","Fortalecimiento peroneos e intrínseco","Propiocepción básica unipodal","Bicicleta estática"]},
        {f:"Fase 3 — Retorno (14-24 sem)",ejs:["Pliometría progresiva bilateral a unilateral","Cambios de dirección","Sprint progresivo","Gestos deportivos"]}
      ],
      rts:"RMN con estabilización · FAOS>70 · Sprint sin dolor · Deporte sin restricción"},

    // ===== 🏃 LESIONES DE CORREDOR =====
    { n:"Síndrome del corredor (ITBS avanzado)", z:"Rodilla",
      e:["Noble Compression test","Test de Ober","Evaluación biomecánica de la carrera","Análisis de pisada","Ecografía del retináculo lateral"],
      p:"F1: Reducción de carga, técnica de carrera.\nF2: Fortalecimiento glúteo y cadera.\nF3: Retorno progresivo con corrección.",
      fases:[
        {f:"Fase 1 — Descarga y técnica (0-3 sem)",ejs:["Reducir km semanales 50-70%","Aumentar cadencia de carrera (170-180 pasos/min)","Foam roller TFL y cuadrado lumbar 5min","Crioterapia post-entrenamiento"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["Hip thrust unilateral 4x10","Single leg squat con control 3x12","Step down 3x15","Abducción cadera en polea 3x15"]},
        {f:"Fase 3 — Retorno (8-16 sem)",ejs:["Plan de retorno: 10% volumen/semana","Técnica de carrera con coach","Superficie variable","Análisis biomecánico completo"]}
      ],
      rts:"Noble negativo · Carrera sin dolor · Glúteo simétrico · Técnica de carrera corregida"},

    { n:"Fascitis plantar resistente (crónica)", z:"Tobillo",
      e:["Windlass test","Ecografía plantar (engrosamiento >4mm)","Rx lateral (espuelas)","FAAM cuestionario","Respuesta a tratamientos previos"],
      p:"F1: Ondas de choque, estiramientos nocturnos.\nF2: Excéntrico intrínseco, plantilla.\nF3: Retorno progresivo.",
      fases:[
        {f:"Fase 1 — Tratamiento intensivo (0-6 sem)",ejs:["Ondas de choque radiales: 6 sesiones","Férula nocturna en dorsiflexión","Estiramiento fascia: 3x30seg cada mañana","Plantilla con descarga del talón"]},
        {f:"Fase 2 — Fortalecimiento (6-12 sem)",ejs:["Short foot exercise 3x15","Towel curls 3x20","Excéntrico de talón en escalón 3x15","Marcha en superficie blanda"]},
        {f:"Fase 3 — Retorno deportivo (12-20 sem)",ejs:["Carrera progresiva en superficie suave","Pliometría de bajo impacto","Control de calzado y plantilla","Análisis de la marcha y pisada"]}
      ],
      rts:"EVA mañana <2 · Windlass negativo · Carrera 20min sin dolor"},

    // ===== 💥 LESIONES POST-QUIRÚRGICAS =====
    { n:"Rehabilitación post-LCA (6 meses)", z:"Rodilla",
      e:["Lachman test post-op","KOS-ADLS cuestionario","Isocinético (LSI cuádriceps/isquios)","Hop tests (single, triple, crossover)","Y-Balance test"],
      p:"Post-quirúrgico completo: F1 control dolor/ROM, F2 fuerza, F3 potencia, F4 deporte.",
      fases:[
        {f:"Fase 1 — Control (0-6 sem)",ejs:["ROM completo progresivo 0-130°","Isométrico cuádriceps y VMO","SLR sin lag de extensión","Marcha sin cojera sin muletas"]},
        {f:"Fase 2 — Fuerza (6-16 sem)",ejs:["Leg press bilateral a unilateral","Sentadilla búlgara 4x10","Curl isquios en fitball 3x15","Step up y down controlados"]},
        {f:"Fase 3 — Potencia y neuromuscular (16-24 sem)",ejs:["Pliometría bilateral: squat jump 3x10","Pliometría unilateral: single leg jump","CMJ y Hop tests criterio","Sprint 60-90-100% progresivo"]},
        {f:"Fase 4 — Retorno deporte (24-36 sem)",ejs:["Gestos deportivos específicos","Entrenamiento de grupo","Competición controlada","LSI ≥90% para retorno completo"]}
      ],
      rts:"LSI cuádriceps ≥90% · LSI isquios ≥90% · Hop test ≥90% · 9 meses mínimo · Psicológico ACL-RSI>56"},

    // ===== 🏊 LESIONES DE NATACIÓN =====
    { n:"Miositis cervical del nadador", z:"Cuello/Cervical",
      e:["Palpación muscular cervical","ROM cervical","Análisis de la técnica de respiración en el nado","Evaluación de la rotación cervical en brazada"],
      p:"F1: Calor, masaje, reducción de volumen.\nF2: Fortalecimiento cervical, corrección técnica.\nF3: Retorno al nado progresivo.",
      fases:[
        {f:"Fase 1 — Control inflamatorio (0-2 sem)",ejs:["Reducir volumen de nado 50%","Calor local 20min x2/día","Masaje terapéutico muscular cervical","Estiramiento cervical lateral 3x30seg"]},
        {f:"Fase 2 — Técnica y fuerza (2-6 sem)",ejs:["Fortalecimiento rotadores cervicales 3x15","Corrección de la respiración bilateral","Nado con tabla (sin girar cabeza) 3x100m","Análisis videográfico de la brazada"]},
        {f:"Fase 3 — Retorno (6-10 sem)",ejs:["Retorno progresivo al volumen habitual","Respiración bilateral en cada brazada","Calentamiento específico pre-sesión","Evaluación técnica con entrenador"]}
      ],
      rts:"ROM cervical completo · Nado sin dolor · Respiración bilateral técnica"},

    // ===== 🧤 LESIONES ESPECÍFICAS POR DEPORTE =====
    { n:"Rodilla del saltador (tendinopatía rotuliana)", z:"Rodilla",
      e:["VISA-P cuestionario","Palpación polo inferior rótula","Test de decline squat (provocación)","Ecografía del tendón rotuliano","Prueba de extensión resistida"],
      p:"F1(0-2sem): Reducción carga, isometría.\nF2(2-8sem): Excéntrico en decline (Alfredson).\nF3(8-16sem): Pliometría, retorno al salto.",
      fases:[
        {f:"Fase 1 — Control carga (0-2 sem)",ejs:["Reducir saltos y aterrizajes","Isométrico extensores rodilla (leg press isomético): 5x45seg","Crioterapia post-actividad","VISA-P semanal"]},
        {f:"Fase 2 — Decline squat (2-8 sem)",ejs:["Excéntrico en tabla de 25° decline: 3x15 x2/día","Carga progresiva semana a semana","Bicicleta sin restricción","VISA-P control"]},
        {f:"Fase 3 — Pliometría (8-16 sem)",ejs:["CMJ progresivo 3x10","Saltos con desaceleración 3x10","Salto de profundidad progresivo","Retorno al deporte específico"]}
      ],
      rts:"VISA-P>80 · Decline squat sin dolor · Salto sin restricción · Deporte completo"},

    { n:"Rodilla del corredor (síndrome patelofemoral)", z:"Rodilla",
      e:["Prueba de Clarke","McConnell test","Evaluación de pisada","Análisis biomecánico de la carrera","AKPS cuestionario"],
      p:"F1: Control inflamatorio, técnica.\nF2: VMO, glúteo, propiocepción.\nF3: Retorno carrera con corrección.",
      fases:[
        {f:"Fase 1 — Control (0-3 sem)",ejs:["Vendaje McConnell medial de la rótula","Crioterapia post-actividad","Reducir pendiente y distancia","Isométrico VMO en extensión"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["TKE con banda en cadena cerrada 3x15","Clamshell con banda 3x20","Hip thrust unilateral 4x10","Step up lateral con control 3x12"]},
        {f:"Fase 3 — Retorno (8-14 sem)",ejs:["Aumento kilómetros 10%/semana","Técnica de carrera: cadencia alta","Análisis biomecánico completo","Plantillas si pronación excesiva"]}
      ],
      rts:"AKPS>85 · Clarke negativo · Carrera 30min sin dolor · Técnica corregida"},

    { n:"Tobillo del basquetbolista", z:"Tobillo",
      e:["CAIT cuestionario","Hop test","Star Excursion Balance Test","Evaluación de inestabilidad funcional","Historia de esguinces previos"],
      p:"F1: Propiocepción básica, peroneos.\nF2: Propiocepción avanzada, pliometría.\nF3: Gestos de baloncesto específicos.",
      fases:[
        {f:"Fase 1 — Estabilización (0-4 sem)",ejs:["Peroneos: eversión con banda 3x20","Monopodal ojos abiertos 3x30seg","Tabla wobble básica 3x30seg","Vendaje preventivo en entrenamiento"]},
        {f:"Fase 2 — Avanzado (4-8 sem)",ejs:["BOSU unilateral 3x30seg","Salto con aterrizaje monopodal 3x10","Cambios de dirección laterales 3x6","Reactividad con estímulo externo"]},
        {f:"Fase 3 — Específico baloncesto (8-14 sem)",ejs:["1vs1 controlado","Ejercicios de aterrizaje en canasta","Salto con contacto controlado","Partido de práctica completo"]}
      ],
      rts:"CAIT≥24 · SEBT simétrico · Aterrizaje sin inestabilidad · Entrenamiento completo"},

    // ===== 🔥 LESIONES MUSCULARES ESPECÍFICAS =====
    { n:"Desgarro proximal de isquiotibiales", z:"Isquiotibiales",
      e:["Palpación tuberosidad isquiática","Test de Askling H1-H3","AKE (Active Knee Extension)","RMN (grado y localización)","Ecografía dinámica"],
      p:"F1(0-72h): PEACE & LOVE, sin estiramiento.\nF2(3días-4sem): Isométrico larga longitud.\nF3(4-10sem): Askling L Protocol.\nF4(10-20sem): Sprint y retorno.",
      fases:[
        {f:"Fase 1 — Aguda (0-72h)",ejs:["Crioterapia 15min x4/día","Compresión y elevación","Marcha asistida sin dolor","Sin estiramiento pasivo"]},
        {f:"Fase 2 — Isometría (3días-4sem)",ejs:["Isométrico isquios cadera 90°: 5x10seg","Leg curl isométrico en máquina 3x10seg","RDL asistido parcial sin dolor","Bicicleta suave si tolera"]},
        {f:"Fase 3 — Protocolo Askling (4-10 sem)",ejs:["Leg slide en supino 3x10","Kick back en cuadrupedia 3x10","RDL con barra progresivo 4x8","Nordic curl parcial 3x6"]},
        {f:"Fase 4 — Sprint (10-20 sem)",ejs:["Sprint 50-75-90-100%","COD con sprint","Gestos deportivos completos","Criterios de retorno: LSI y Askling"]}
      ],
      rts:"AKE simétrico · Nordic ≥90% · Sprint 100% sin dolor · Askling negativo"},

    { n:"Tendinopatía proximal de isquiotibiales", z:"Isquiotibiales",
      e:["VISA-H cuestionario","Prueba de provocación en sedestación sobre superficie dura","Slump test isquio","Palpación isquión","Ecografía / RMN"],
      p:"F1(0-4sem): Descarga compresión, isometría larga longitud.\nF2(4-10sem): Excéntrico RDL progresivo.\nF3(10-20sem): Sprint, carrera.",
      fases:[
        {f:"Fase 1 — Descarga (0-4 sem)",ejs:["Evitar sedestación en superficies duras","Isométrico: 5x45seg en posición de pie con flexión cadera 30°","Reducir volumen carrera 50%","Cojín de descarga en sedestación"]},
        {f:"Fase 2 — Excéntrico (4-10 sem)",ejs:["RDL unilateral progresivo 3x10","Nordic curl adaptado 3x6","Carga en larga longitud (flexión cadera)","Protocolo de aumento de carga semanal"]},
        {f:"Fase 3 — Carrera (10-20 sem)",ejs:["Trote progresivo 20-40min","Sprint 50-75-100%","VISA-H control mensual","Deporte completo"]}
      ],
      rts:"VISA-H>80 · Sedestación sin dolor · Carrera sin restricción · Sprint completo"},

    { n:"Avulsión apofisaria isquiática (adolescente)", z:"Isquiotibiales",
      e:["Rx pelvis AP (separación apofisaria)","RMN para tejidos blandos","Dolor súbito en sprint o estiramiento","Palpación isquión en adolescente","Evaluación de madurez ósea"],
      p:"F1(0-4sem): Reposo relativo, muletas si necesario.\nF2(4-10sem): Movilidad y carga progresiva.\nF3(10-20sem): Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Reposo (0-4 sem)",ejs:["Reposo relativo: evitar sprint y saltos","Muletas si dolor en marcha","Crioterapia local","ROM suave de cadera y rodilla"]},
        {f:"Fase 2 — Carga progresiva (4-10 sem)",ejs:["Marcha normal sin dolor","Bicicleta suave progresiva","Fortalecimiento proximal cadera sin dolor","Trote suave si Rx muestra consolidación"]},
        {f:"Fase 3 — Retorno (10-20 sem)",ejs:["Sprint progresivo al 60-80-100%","Gestos deportivos específicos","Control Rx de consolidación","Retorno deportivo completo"]}
      ],
      rts:"Rx consolidada · Sprint sin dolor · Fuerza simétrica · Actividad deportiva completa"},

    // ===== 🩹 LESIONES DE LA INGLE Y PUBIS ADICIONALES =====
    { n:"Tendinopatía del psoas-ilíaco", z:"Ingle/Pubis",
      e:["Test de Thomas (acortamiento)","Resistencia a flexión de cadera","Palpación tendón psoas en ingle","Ecografía del psoas","Test de Stinchfield"],
      p:"F1: Isométrico en posición media, estiramiento suave.\nF2: Excéntrico psoas, fortalecimiento.\nF3: Retorno funcional.",
      fases:[
        {f:"Fase 1 — Control dolor (0-3 sem)",ejs:["Isométrico flexión cadera en sedestación 5x10seg","Estiramiento psoas suave en zancada 3x20seg","Crioterapia inguinal post-actividad","Reducir actividad provocadora"]},
        {f:"Fase 2 — Excéntrico (3-8 sem)",ejs:["Elevación de rodilla excéntrica descendente 3x15","RDL isquio-psoas controlado 3x12","Fortalecimiento core profundo 3x10","Step up con énfasis en flexión cadera 3x12"]},
        {f:"Fase 3 — Funcional (8-14 sem)",ejs:["Sprint y cambios de dirección progresivos","Gestos deportivos específicos","Control motor en actividad deportiva","Retorno completo al deporte"]}
      ],
      rts:"Thomas negativo · Flexión sin dolor · Sprint sin restricción"},

    { n:"Osteítis de pubis", z:"Ingle/Pubis",
      e:["Squeeze test (0-45-90°)","Palpación sínfisis dolorosa","Rx pelvis (esclerosis, bordes irregulares)","RMN pelvis (edema óseo)","VAS en actividad deportiva"],
      p:"F1(0-4sem): Descarga, isométrico aductores y core.\nF2(4-10sem): Copenhagen, lumbopélvico.\nF3(10-20sem): Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Descarga (0-4 sem)",ejs:["Reposo deportivo relativo","Isométrico aductores con pelota 5x10seg","Activación core profundo sin carga","Bicicleta suave si tolera"]},
        {f:"Fase 2 — Copenhagen (4-10 sem)",ejs:["Copenhagen adduction nivel 1: 3x10","Hip thrust bilateral 4x10","Sentadilla sumo con control 3x12","Plancha lateral con abducción 3x10"]},
        {f:"Fase 3 — Retorno (10-20 sem)",ejs:["Carrera progresiva línea recta","Sprint progresivo 50-100%","Cambios de dirección con balón","Entrenamiento grupal completo"]}
      ],
      rts:"Squeeze sin dolor · Carrera sin restricción · Sprint completo · 2 semanas entrenando completo"},

    { n:"Hernia inguinal deportiva (Gilmore Groin)", z:"Ingle/Pubis",
      e:["Palpación del orificio inguinal superficial","Test de Valsalva","Dolor en sprint y cambio dirección","Ecografía dinámica inguinal","Artroscopia/RMN pelvis"],
      p:"F1: Tratamiento conservador o quirúrgico.\nF2: Recuperación y fortalecimiento core.\nF3: Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Post-quirúrgico o conservador (0-4 sem)",ejs:["Reposo 2-4 semanas post-cirugía","Movilidad suave sin Valsalva","Activación core suave","Marcha progresiva sin dolor"]},
        {f:"Fase 2 — Fortalecimiento (4-8 sem)",ejs:["Plancha ventral progresiva 3x30seg","Dead bug 3x10/lado","Sentadilla con carga ligera 3x12","Bicicleta y natación sin restricción"]},
        {f:"Fase 3 — Retorno (8-16 sem)",ejs:["Sprint progresivo al 50-100%","Cambios de dirección","Gestos deportivos específicos","Entrenamiento de grupo completo"]}
      ],
      rts:"Valsalva sin dolor · Sprint sin restricción · Deporte sin limitación"},

    // ===== 🤸 LESIONES GENERALES Y SISTÉMICAS =====
    { n:"DOMS (dolor muscular de aparición tardía)", z:"Espalda",
      e:["Inicio 24-72h post-ejercicio","Palpación muscular dolorosa difusa","Sin contractura aguda","Sin limitación funcional grave","Evaluación de rango de movimiento"],
      p:"F1: Actividad suave, nutrición.\nF2: Vuelta progresiva al entrenamiento.\nF3: Prevención con periodización.",
      fases:[
        {f:"Fase 1 — Recuperación activa (24-72h)",ejs:["Marcha suave 20-30min","Estiramientos suaves en rango sin dolor","Foam roller global 10min","Baño de contraste (calor/frío) si disponible"]},
        {f:"Fase 2 — Retorno (3-7 días)",ejs:["Entrenamiento de menor intensidad","Técnica correcta sin exceso de volumen","Hidratación y nutrición proteica adecuada","Sueño ≥8h"]},
        {f:"Fase 3 — Prevención",ejs:["Periodización adecuada del entrenamiento","Calentamiento específico pre-sesión","Vuelta a la calma post-sesión","Monitorización de cargas (RPE, HRV)"]}
      ],
      rts:"Sin dolor muscular · Rendimiento recuperado · Entrenamiento completo sin restricción"},

    { n:"Calambres musculares", z:"Espalda",
      e:["Historia clínica: frecuencia y condiciones","Evaluación de electrolitos","Hidratación y nutrición","EMG si calambres crónicos","Evaluación neurológica"],
      p:"F1: Hidratación y electrolitos, estiramiento inmediato.\nF2: Corrección de déficits nutricionales.\nF3: Plan de hidratación deportivo.",
      fases:[
        {f:"Fase 1 — Aguda",ejs:["Estiramiento pasivo del músculo afectado","Hidratación con sales minerales","Masaje suave del músculo","Compresión suave si persiste"]},
        {f:"Fase 2 — Corrección nutricional",ejs:["Evaluación de electrolitos (Na, K, Mg)","Plan de hidratación pre-intra-post entreno","Suplementación si déficit específico","Diario de alimentación e hidratación"]},
        {f:"Fase 3 — Prevención",ejs:["Protocolo de hidratación personalizado","Calentamiento adecuado pre-actividad","Control de temperatura y humedad","Periodización del entrenamiento"]}
      ],
      rts:"Sin calambres en entrenamiento · Electrolitos normales · Plan de hidratación implementado"},

    { n:"Síndrome miofascial", z:"Espalda",
      e:["Identificación de puntos gatillo activos","Bandas tensas palpables","Dolor referido reproducible","Escala de Travell y Simons","Evaluación postural global"],
      p:"F1: Punción seca o presión isquémica.\nF2: Estiramiento y fortalecimiento antagonistas.\nF3: Corrección postural y ergonómica.",
      fases:[
        {f:"Fase 1 — Tratamiento puntos gatillo (0-2 sem)",ejs:["Punción seca o presión isquémica 10seg x3","Estiramiento post-técnica 30seg","Calor local 20min post-punción","Educación sobre factores perpetuadores"]},
        {f:"Fase 2 — Corrección muscular (2-6 sem)",ejs:["Fortalecimiento de músculos inhibidos","Estiramiento de músculos acortados","Ejercicios de control postural","Técnicas de respiración"]},
        {f:"Fase 3 — Mantenimiento (6-12 sem)",ejs:["Ergonomía laboral/deportiva","Pausas activas","Técnica deportiva corregida","Automasaje con foam roller"]}
      ],
      rts:"Puntos gatillo inactivos · Palpación sin dolor referido · Actividad sin restricción"},

    { n:"Fractura de clavícula", z:"Hombro",
      e:["Rx clavícula AP y oblicua","Clasificación de Neer/Robinson","Evaluación neurológica y vascular","Palpación y deformidad visible","TC si fragmentación compleja"],
      p:"F1(0-6sem): Cabestrillo, ROM codo/mano.\nF2(6-12sem): ROM hombro progresivo, fortalecimiento.\nF3(12-20sem): Fuerza completa, retorno.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-6 sem)",ejs:["Cabestrillo tipo Velpeau 4-6 semanas","ROM activo codo, muñeca y dedos","Crioterapia local","Control Rx a las 4-6 semanas"]},
        {f:"Fase 2 — ROM hombro (6-12 sem)",ejs:["ROM activo-asistido hombro progresivo","Isométrico deltoides y manguito 3x10seg","Fortalecimiento trapecio bajo 3x15","Ejercicios en agua si disponible"]},
        {f:"Fase 3 — Fuerza completa (12-20 sem)",ejs:["Fortalecimiento manguito progresivo 4x10","Press hombro gradual","Gestos deportivos específicos","Contacto con equipo según deporte"]}
      ],
      rts:"Rx consolidada · ROM completo · Fuerza ≥90% · Deporte sin protección (no contacto) o con hombreras"},

    { n:"Fractura metatarsiana", z:"Tobillo",
      e:["Rx pie AP, lateral y oblicua","Clasificación (tipo y localización)","Ottawa Foot Rules","TC si sospecha fractura Jones","Evaluación biomecánica del pie"],
      p:"F1(0-6sem): Bota walker o yeso.\nF2(6-12sem): Carga progresiva.\nF3(12-20sem): Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-6 sem)",ejs:["Bota walker sin carga o carga parcial","Crioterapia y elevación","Ejercicios rodilla, cadera y MMSS","Control Rx a las 4-6 semanas"]},
        {f:"Fase 2 — Carga progresiva (6-12 sem)",ejs:["Marcha con zapato normal sin bota","Fortalecimiento intrínseco pie","Propiocepción básica","Bicicleta y natación progresiva"]},
        {f:"Fase 3 — Retorno (12-20 sem)",ejs:["Carrera en superficie blanda","Pliometría bilateral a unilateral","Sprint progresivo","Calzado apropiado y análisis biomecánico"]}
      ],
      rts:"Rx consolidada · Marcha sin dolor · Carrera sin restricción"},

    { n:"Sesamoiditis", z:"Tobillo",
      e:["Palpación sesamoideos plantares","Test de compresión","Rx pie (axial de sesamoideos)","Gammagrafía o RMN si fractura sospechada","Evaluación de la marcha"],
      p:"F1: Plantilla con descarga del sesamoideo, crioterapia.\nF2: Fortalecimiento intrínseco progresivo.\nF3: Retorno deportivo con protección.",
      fases:[
        {f:"Fase 1 — Descarga (0-4 sem)",ejs:["Plantilla con orificio en zona del sesamoideo","Calzado con caja amplia","Crioterapia 15min x3/día","Reducir actividad de impacto"]},
        {f:"Fase 2 — Fortalecimiento (4-10 sem)",ejs:["Short foot sin dolor 3x15","Elevación de talón bilateral 3x15","Intrínsecos con putty o toalla 3x20","Marcha descalzo en superficie blanda"]},
        {f:"Fase 3 — Retorno (10-18 sem)",ejs:["Carrera con plantilla de descarga","Pliometría progresiva con protección","Gestos deportivos con calzado adecuado","Retorno sin restricción"]}
      ],
      rts:"Palpación sin dolor · Elevación talón sin dolor · Carrera con calzado sin restricción"},

    { n:"Esguince de la articulación de Lisfranc", z:"Tobillo",
      e:["Rx con carga bilateral (diastasis)","TC sin carga (diagnóstico)","Piano key test","Palpación articulación Lisfranc","VAS en carga"],
      p:"F1(0-6sem): Bota sin carga (inestable) o bota con carga (estable).\nF2(6-14sem): Carga progresiva.\nF3(14-24sem): Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Protección (0-6 sem)",ejs:["Bota walker rígida o yeso","Crioterapia y elevación","Descarga total o parcial","Ejercicios MMSS y cadera"]},
        {f:"Fase 2 — Carga (6-14 sem)",ejs:["Marcha con bota y carga progresiva","Fortalecimiento peroneos y tibial posterior","Propiocepción básica sin torsión","Bicicleta y natación progresiva"]},
        {f:"Fase 3 — Retorno (14-24 sem)",ejs:["Marcha sin bota en calzado rígido","Carrera en línea recta","Torsión y pivote progresivos","Deporte completo con calzado apropiado"]}
      ],
      rts:"Rx sin diastasis · Marcha sin dolor · Pivote sin restricción"},

    { n:"Fractura de Jones (5º metatarsiano)", z:"Tobillo",
      e:["Rx pie lateral (unión meta-diáfisis)","TC para planificación quirúrgica","Clasificación: zona I-II-III","Historia de dolor crónico previo","Evaluación biomecánica del pie"],
      p:"F1(0-8sem): Bota sin carga o cirugía.\nF2(8-16sem): Carga progresiva.\nF3(16-24sem): Retorno deportivo.",
      fases:[
        {f:"Fase 1 — Protección (0-8 sem)",ejs:["Bota con descarga o fijación quirúrgica","Crioterapia y elevación","Ejercicios proximales sin carga","Control Rx a las 6-8 semanas"]},
        {f:"Fase 2 — Carga progresiva (8-16 sem)",ejs:["Marcha progresiva con bota","Fortalecimiento intrínseco sin dolor","Propiocepción básica","Bicicleta con zapato rígido"]},
        {f:"Fase 3 — Retorno (16-24 sem)",ejs:["Carrera en superficie blanda","Pliometría progresiva","Sprint con análisis biomecánico","Calzado y plantilla adecuados"]}
      ],
      rts:"Rx consolidada · Carrera sin dolor · Sprint sin restricción · Biomecánica corregida"},

    { n:"Síndrome de Achilles insertional", z:"Tobillo",
      e:["VISA-A cuestionario","Palpación inserción calcánea","Prominencia ósea (Haglund)","Ecografía del tendón en inserción","Rx lateral (calcificaciones)"],
      p:"F1: Tacón elevado, evitar dorsiflexión forzada.\nF2: Excéntrico con modificación (rango limitado).\nF3: Retorno progresivo.",
      fases:[
        {f:"Fase 1 — Descarga (0-4 sem)",ejs:["Elevación de talón permanente 1.5cm","Evitar estiramiento en dorsiflexión máxima","Isométrico tríceps: 5x45seg en posición de pie","Crioterapia post-actividad"]},
        {f:"Fase 2 — Excéntrico modificado (4-10 sem)",ejs:["Excéntrico en suelo plano (no escalón) 3x15","Elevación de talón bilateral a unilateral 3x15","Fortalecimiento cadera y rodilla complementario","VISA-A control mensual"]},
        {f:"Fase 3 — Retorno (10-20 sem)",ejs:["Trote progresivo en superficie plana","Sprint suave al 60-80%","Pliometría de bajo impacto","Deporte sin dorsiflexión forzada"]}
      ],
      rts:"VISA-A>80 · Marcha sin cojera · Carrera sin dolor · Deporte completo"},

    // ===== 🏋️ LESIONES DE FUERZA =====
    { n:"Lumbar del levantador", z:"Espalda",
      e:["Evaluación técnica de levantamiento","Test de Schober","Evaluación de hiperextensión","RMN si síntomas neurológicos","Análisis biomecánico de la sentadilla y peso muerto"],
      p:"F1: Corrección técnica, reducción de carga.\nF2: Estabilización lumbar bajo carga.\nF3: Retorno progresivo.",
      fases:[
        {f:"Fase 1 — Descarga técnica (0-4 sem)",ejs:["Reducir carga 40-50%","Corrección técnica de sentadilla y peso muerto","McGill Big 3 diario","Análisis videográfico de los levantamientos"]},
        {f:"Fase 2 — Estabilización bajo carga (4-10 sem)",ejs:["RDL con barra técnica progresiva 4x8","Sentadilla caja (box squat) 4x8","Plank con variaciones 3x30seg","Fortalecimiento glúteo y cadera"]},
        {f:"Fase 3 — Retorno (10-16 sem)",ejs:["Progresión de cargas semanal (5% max)","Evaluación técnica permanente","Carga máxima con técnica perfecta","Competición con supervisión"]}
      ],
      rts:"Técnica correcta · Sin dolor en levantamiento · Carga 90% sin restricción"},

    { n:"Lesión tríceps (rotura distal)", z:"Hombro",
      e:["Test de extensión activa de codo","Thompson de codo (si sospecha rotura total)","RMN codo (grado y localización)","Ecografía del tendón distal","Evaluación de fuerza extensora"],
      p:"F1(0-4sem): Inmovilización o cirugía.\nF2(4-10sem): ROM progresivo.\nF3(10-20sem): Fuerza progresiva.",
      fases:[
        {f:"Fase 1 — Protección (0-4 sem)",ejs:["Ortesis de codo en 45° de flexión","Evitar extensión activa contra gravedad","Movilidad muñeca y hombro","Crioterapia y control del edema"]},
        {f:"Fase 2 — ROM progresivo (4-10 sem)",ejs:["Extensión activa asistida progresiva","Isométrico tríceps en posición neutra 3x10seg","Bicicleta ergométrica sin resistencia","Ejercicios escapulares"]}  ,
        {f:"Fase 3 — Fuerza (10-20 sem)",ejs:["Press de banca progresivo 4x10","Extensiones tríceps en polea 4x12","Press militar 4x10","Retorno al deporte completo"]}
      ],
      rts:"Extensión activa completa · Fuerza ≥80% · Press sin restricción"},

    { n:"Neuropatía del supraescapular", z:"Hombro",
      e:["Electromiografía (velocidad conducción)","Palpación escotadura supraescapular","Test de Neer y Hawkins (diferencial)","Evaluación del infraespinoso y supraespinoso","RMN (quiste paraneural)"],
      p:"F1: Evitar atrapamiento, fortalecimiento escapular.\nF2: Neurodinamia supraescapular.\nF3: Fuerza completa, retorno.",
      fases:[
        {f:"Fase 1 — Control neural (0-4 sem)",ejs:["Evitar cruzar brazo por delante del cuerpo","Estiramiento escapular suave","Movilización neural suprascapular 3x10","Educación sobre postura escapular"]},
        {f:"Fase 2 — Fortalecimiento (4-10 sem)",ejs:["Fortalecimiento trapecio superior e inferior 3x15","Remo en T y Y 3x12","Ejercicios de retracción escapular 3x15","Neurodinamia progresiva"]},
        {f:"Fase 3 — Funcional (10-16 sem)",ejs:["Manguito completo 4x10","Press y remo funcional","Gestos deportivos específicos","Retorno deportivo progresivo"]}
      ],
      rts:"EMG normal · Fuerza infraespinoso ≥80% · Gesto sin dolor · Deporte completo"},

    { n:"Edema óseo de rodilla", z:"Rodilla",
      e:["RMN rodilla (Bone Marrow Edema)","EVA en carga","Evaluación de carga y actividad","VAS en reposo y actividad","Clasificación de Lafforgue"],
      p:"F1: Reducción de carga de impacto, AINE si prescrito.\nF2: Fortalecimiento en descarga.\nF3: Retorno progresivo con control.",
      fases:[
        {f:"Fase 1 — Descarga (0-6 sem)",ejs:["Reducir actividades de impacto","Bicicleta o natación como alternativa","Crioterapia post-actividad","Control de peso corporal"]},
        {f:"Fase 2 — Fortalecimiento en descarga (6-12 sem)",ejs:["Leg press bilateral en rango corto 3x15","Isométrico cuádriceps en extensión 3x10seg","Fortalecimiento glúteo sin impacto","Propiocepción básica"]},
        {f:"Fase 3 — Retorno progresivo (12-20 sem)",ejs:["Marcha en superficie blanda","Trote progresivo con monitoreo de EVA","RMN de control a los 3 meses","Sprint gradual"]}
      ],
      rts:"RMN sin edema activo · EVA <2 en carga · Carrera sin dolor · Deporte sin restricción"},

    { n:"Pinzamiento articular de rodilla", z:"Rodilla",
      e:["Test de compresión femorotibial","Evaluación de meniscos","RMN (cuerpo libre, plica, menisco)","Test de McMurray (diferencial)","Artroscopia diagnóstica si necesario"],
      p:"F1: Control inflamatorio, ROM.\nF2: Fortalecimiento perimuscular.\nF3: Retorno funcional.",
      fases:[
        {f:"Fase 1 — Control (0-3 sem)",ejs:["Crioterapia 15min x3/día","ROM activo suave evitando bloqueo","Isométrico cuádriceps e isquios 3x10seg","Evitar movimientos que provocan pinzamiento"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["Prensa en rango libre de pinzamiento 3x15","Fortalecimiento isquiotibiales 3x15","Propiocepción sin movimientos extremos 3x30seg","Bicicleta estática"]},
        {f:"Fase 3 — Funcional (8-16 sem)",ejs:["Sentadilla en rango completo sin pinzamiento","Pliometría progresiva","Gestos deportivos específicos","Retorno al deporte"]}
      ],
      rts:"Compresión sin dolor · Sentadilla sin restricción · Deporte sin bloqueo"},

    { n:"Contractura de cuádriceps", z:"Rodilla",
      e:["Test de Thomas (acortamiento)","ROM de flexión de rodilla","Palpación de bandas tensas","Evaluación de puntos gatillo","Ely test"],
      p:"F1: Estiramiento y liberación del músculo.\nF2: Fortalecimiento antagonistas.\nF3: Entrenamiento equilibrado.",
      fases:[
        {f:"Fase 1 — Liberación (0-2 sem)",ejs:["Estiramiento cuádriceps en decúbito prono 3x30seg","Foam roller cuádriceps 5min","Punción seca si puntos gatillo activos","Calor local 20min"]},
        {f:"Fase 2 — Fortalecimiento antagonistas (2-6 sem)",ejs:["Fortalecimiento isquiotibiales 3x15","Nordic curl 3x6","RDL con barra 4x8","Fortalecimiento glúteo 3x15"]},
        {f:"Fase 3 — Equilibrio (6-10 sem)",ejs:["Entrenamiento equilibrado cuádreps-isquios","Técnica de carrera corregida","Calentamiento específico pre-entreno","Deporte completo"]}
      ],
      rts:"Ely test negativo · ROM completo · Carrera sin restricción"},

    { n:"Desequilibrios musculares (rodilla)", z:"Rodilla",
      e:["Isocinético cuádriceps/isquiotibiales (ratio I/Q)","Test de single leg squat","Y-Balance test","Evaluación postural dinámica","Screening funcional FMS"],
      p:"F1: Identificar músculos débiles e inhibidos.\nF2: Fortalecimiento selectivo.\nF3: Equilibrio funcional.",
      fases:[
        {f:"Fase 1 — Evaluación y activación (0-3 sem)",ejs:["Activación VMO: terminal knee extension 3x15","Activación glúteo medio: clamshell 3x20","Evaluación isocinética o manual","Corrección de compensaciones"]},
        {f:"Fase 2 — Fortalecimiento selectivo (3-8 sem)",ejs:["Nordic curl 3x8 (si ratio I/Q bajo)","Hip thrust bilateral a unilateral 4x10","SL squat con espejo y control 3x12","Eccentric step down 3x15"]},
        {f:"Fase 3 — Integración (8-14 sem)",ejs:["Gestos deportivos con ratio equilibrado","Pliometría simétrica bilateral","Evaluación isocinética de seguimiento","Deporte completo"]}
      ],
      rts:"Ratio I/Q>0.6 · FMS≥14 · Y-Balance simétrico · Deporte sin restricción"},

    { n:"Contractura del aductor largo", z:"Ingle/Pubis",
      e:["Squeeze test (45°)","Palpación del aductor largo","ROM de abducción","Test de Thomas (diferencial psoas)","Ecografía si sospecha rotura parcial"],
      p:"F1: Estiramiento y liberación.\nF2: Fortalecimiento excéntrico.\nF3: Prevención y retorno.",
      fases:[
        {f:"Fase 1 — Liberación (0-2 sem)",ejs:["Estiramiento aductor en sedestación 3x30seg","Foam roller cara medial muslo 5min","Masaje transverso del músculo","Reducir actividad provocadora"]},
        {f:"Fase 2 — Excéntrico (2-6 sem)",ejs:["Copenhagen adduction nivel 1 3x10","Isométrico de aducción progresivo 5x10seg","Sentadilla sumo con control 3x12","Abducción excéntrica lateral 3x15"]},
        {f:"Fase 3 — Funcional (6-10 sem)",ejs:["Gestos deportivos con control","Cambios de dirección","Sprint y deporte completo","Calentamiento específico de aductores"]}
      ],
      rts:"Squeeze sin dolor · Abducción completa · Deporte sin restricción"},

    { n:"Fractura de escafoides", z:"Muñeca/Mano",
      e:["Rx muñeca (puede ser normal en inicio)","TC (gold standard)","Palpación tabaquera anatómica","VAS en compresión axial del pulgar","Gammagrafía si sospecha con Rx normal"],
      p:"F1(0-8sem): Yeso o cirugía.\nF2(8-14sem): ROM activo, fortalecimiento.\nF3(14-24sem): Carga progresiva, retorno.",
      fases:[
        {f:"Fase 1 — Inmovilización (0-8 sem)",ejs:["Yeso incluyendo pulgar 8-12 semanas","Ejercicios dedos, codo y hombro","Crioterapia y control edema","Control Rx/TC mensual"]},
        {f:"Fase 2 — ROM activo (8-14 sem)",ejs:["ROM activo muñeca en todos los planos","Fortalecimiento intrínseco con putty 3x15","Fortalecimiento pronadores/supinadores 3x15","Extensión muñeca excéntrica 3x15"]},
        {f:"Fase 3 — Carga (14-24 sem)",ejs:["Agarre progresivo con dinamómetro","Apoyo en muñeca progresivo (plancha)","Gestos deportivos específicos","Retorno deporte según consolidación"]}
      ],
      rts:"TC consolidada · Tabaquera sin dolor · Agarre ≥90% · Deporte sin restricción"},

    { n:"Síndrome del canal de Guyon", z:"Muñeca/Mano",
      e:["Tinel en canal de Guyon","Evaluación sensibilidad cubital (4-5 dedos)","Test de Froment (fuerza pinza)","Electromiografía","Evaluación de la musculatura hipotenar"],
      p:"F1: Evitar compresión, muñequera.\nF2: Neurodinamia cubital.\nF3: Fortalecimiento intrínseco.",
      fases:[
        {f:"Fase 1 — Descompresión (0-3 sem)",ejs:["Evitar apoyar el borde cubital de la mano","Muñequera en posición neutra","Neurodinamia cubital suave 3x10","Educación sobre posturas de riesgo"]},
        {f:"Fase 2 — Neurodinamia (3-6 sem)",ejs:["Deslizamiento neuromeníngeo cubital 3x10","Movilización articular muñeca 3x10","Fortalecimiento hipotenar 3x15","Destreza fina progresiva"]},
        {f:"Fase 3 — Funcional (6-12 sem)",ejs:["Agarre y pinza cubital progresivo","Ergonomía del puesto/deporte","Gestos deportivos específicos","Retorno completo"]}
      ],
      rts:"Tinel negativo · Sensibilidad recuperada · Froment negativo · Deporte sin restricción"},

    { n:"Dedo en gatillo (tenosinovitis flexora)", z:"Muñeca/Mano",
      e:["Nódulo palpable en polea A1","Bloqueo reproducible","ROM activo del dedo","Ecografía del tendón flexor","Test de flexión activa resistida"],
      p:"F1: Evitar movimientos repetitivos, ortesis.\nF2: Deslizamiento tendinoso, ultrasonidos.\nF3: Liberación quirúrgica si no mejora.",
      fases:[
        {f:"Fase 1 — Conservador (0-6 sem)",ejs:["Ortesis de extensión nocturna","Evitar agarre repetitivo","Masaje transverso en polea A1","Ultrasonidos terapéuticos"]},
        {f:"Fase 2 — Deslizamiento (6-12 sem)",ejs:["Ejercicios de deslizamiento tendinoso: 3x10","Movilidad activa del dedo en rango completo","Estiramientos suaves extensores","Carga progresiva con putty"]},
        {f:"Fase 3 — Post-liberación (si quirúrgico)",ejs:["ROM activo precoz post-cirugía","Fortalecimiento progresivo agarre","Destreza fina progresiva","Retorno laboral/deportivo"]}
      ],
      rts:"Sin bloqueo ni nódulo · ROM completo · Agarre sin dolor · Actividad sin restricción"},

    { n:"Artritis de la base del pulgar (rizartrosis)", z:"Muñeca/Mano",
      e:["Test de Grind (compresión axial con rotación)","Palpación articulación carpometacarpiana I","Rx mano (esclerosis articular)","VAS en pinza","DASH cuestionario"],
      p:"F1: Ortesis de pulgar, AINE si prescrito.\nF2: Fortalecimiento intrínseco.\nF3: Adaptación funcional.",
      fases:[
        {f:"Fase 1 — Control inflamatorio (0-4 sem)",ejs:["Ortesis de pulgar en posición funcional","Crioterapia local 10min x3/día","Evitar pinza forzada y torsión","Educación sobre manejo de la articulación"]},
        {f:"Fase 2 — Fortalecimiento (4-12 sem)",ejs:["Fortalecimiento tenar: abducción pulgar 3x15","Oposición con putty 3x15","Pinza progresiva con diferentes tamaños","Estiramientos capsulares suaves"]},
        {f:"Fase 3 — Adaptación (12-24 sem)",ejs:["Adaptación de utensilios deportivos/laborales","Técnica de agarre sin compresión axial","Actividades funcionales adaptadas","Deporte con protección si necesario"]}
      ],
      rts:"VAS<3 · Actividades cotidianas sin restricción · Deporte adaptado tolerado"},

    { n:"Síndrome del nervio interóseo posterior", z:"Muñeca/Mano",
      e:["Evaluación de extensión de dedos y muñeca","Prueba de resistencia a supinación","Evaluación sensorial cara dorsal 1-2 dedo","Electromiografía","Palpación en túnel del supinador"],
      p:"F1: Evitar supinación repetitiva, descompresión.\nF2: Neurodinamia radial.\nF3: Fuerza y retorno.",
      fases:[
        {f:"Fase 1 — Descompresión (0-4 sem)",ejs:["Evitar supinación repetitiva con resistencia","Codadera si extensión codo implicada","Neurodinamia radial suave 3x10","Crioterapia local"]},
        {f:"Fase 2 — Rehabilitación neural (4-8 sem)",ejs:["Deslizamiento nervio radial: 3x10","Extensión muñeca activa progresiva","Fortalecimiento supinadores y extensores 3x15","Control postural del codo en trabajo/deporte"]},
        {f:"Fase 3 — Funcional (8-14 sem)",ejs:["Extensión completa resistida 4x12","Gestos deportivos específicos","Ergonomía del puesto","Retorno completo"]}
      ],
      rts:"Extensión dedos completa · Supinación sin dolor · EMG normal · Deporte sin restricción"},

    { n:"Muñeca del gimnasta", z:"Muñeca/Mano",
      e:["Test de compresión en extensión de muñeca","RMN muñeca (cartílago distal radio)","Rx de muñeca (plano epifisario)","Evaluación de la carga de entrenamiento","Test de Finkelstein (diferencial)"],
      p:"F1: Reducción de carga en muñeca, ortesis.\nF2: Fortalecimiento intrínseco, movilidad.\nF3: Retorno progresivo a la gimnasia.",
      fases:[
        {f:"Fase 1 — Descarga (0-4 sem)",ejs:["Reducir tiempo de apoyo de muñeca","Ortesis de muñeca en entrenamiento","Crioterapia post-entrenamiento","Ejercicios sin apoyo de muñeca"]},
        {f:"Fase 2 — Fortalecimiento (4-10 sem)",ejs:["Fortalecimiento extensores y flexores de muñeca 3x15","Pronación-supinación con mancuerna 3x15","Agarre con dinamómetro progresivo","Exercises propioceptivos de muñeca"]},
        {f:"Fase 3 — Retorno (10-18 sem)",ejs:["Regreso progresivo a elementos de apoyo","Vendaje funcional preventivo","Técnica revisada con entrenador","Entrenamiento completo"]}
      ],
      rts:"Compresión sin dolor · ROM completo · Apoyo sin restricción · Técnica optimizada"},

    { n:"Rotura del ligamento colateral cubital pulgar", z:"Muñeca/Mano",
      e:["Test de estrés cubital del pulgar","Rx para descartar avulsión ósea","Ecografía (ligamento)","Clasificación: grado I-II-III","Test de Stener (palpación)"],
      p:"F1(0-3sem grados I-II): Ortesis pulgar.\nF2(3-8sem): Fortalecimiento tenar.\nF3(8-14sem): Retorno al deporte.",
      fases:[
        {f:"Fase 1 — Protección (0-3 sem)",ejs:["Ortesis de pulgar en posición de pinza (grado I-II)","Movilidad activa de los demás dedos","Crioterapia local","Control Rx a las 3 semanas"]},
        {f:"Fase 2 — Fortalecimiento (3-8 sem)",ejs:["Fortalecimiento tenar sin stress lateral 3x15","Movilidad activa del pulgar en rango seguro","Oposición pulgar-dedos progresiva","Agarre con putty o pelota de tennis 3x15"]},
        {f:"Fase 3 — Funcional (8-14 sem)",ejs:["Pinza lateral sin restricción","Deporte con protección (taping) si necesario","Gesto deportivo específico","Retorno completo"]}
      ],
      rts:"Stress test negativo · Pinza sin dolor · Gesto sin restricción"},

    { n:"Contractura cervical aguda (tortícolis)", z:"Cuello/Cervical",
      e:["ROM cervical activo","Palpación muscular dolorosa","Exclusión de fractura o inestabilidad","EVA en reposo y movimiento","Evaluación de postura cervical"],
      p:"F1: Calor, TENS, movilización precoz.\nF2: Movilidad activa, fortalecimiento.\nF3: Ergonomía y prevención.",
      fases:[
        {f:"Fase 1 — Analgesia (0-3 días)",ejs:["Calor local 20min","TENS cervical para analgesia","Movilidad activa suave en planos indoloros","Educación: mantener movilidad activa"]},
        {f:"Fase 2 — Movilidad (3 días-2 sem)",ejs:["ROM activo en todos los planos 3x10","Retracción cervical 3x15","Isométrico en posición antiálgica 3x10seg","Masaje paravertebral"]},
        {f:"Fase 3 — Prevención (2-4 sem)",ejs:["Control postural en sedestación","Ergonomía de pantalla","Fortalecimiento flexores profundos","Pausas activas cervicales"]}
      ],
      rts:"ROM completo · Sin dolor en movimiento · Trabajo sin restricción"},

    { n:"Neuropatía del nervio femoral", z:"Ingle/Pubis",
      e:["Test de Lasègue invertido (pronación)","Evaluación del cuádriceps (déficit)","Sensibilidad cara anterior muslo","Electromiografía","TC/RMN para compresión"],
      p:"F1: Evitar compresión, educación.\nF2: Neurodinamia femoral.\nF3: Fortalecimiento cuádriceps.",
      fases:[
        {f:"Fase 1 — Descompresión (0-3 sem)",ejs:["Identificar causa de compresión","Evitar flexión de cadera prolongada","Deslizamiento neuromeníngeo femoral suave 3x10","Educación sobre posición y actividad"]},
        {f:"Fase 2 — Neurodinamia (3-8 sem)",ejs:["ULNT femoral progresivo 3x10","Fortalecimiento cuádriceps proximal 3x15","Leg extension en rango indoloro 3x15","Control de la postura en actividad"]},
        {f:"Fase 3 — Funcional (8-14 sem)",ejs:["Fortalecimiento cuádriceps completo 4x10","Gestos deportivos específicos","Carrera y saltos progresivos","Retorno deportivo completo"]}
      ],
      rts:"Lasègue invertido negativo · Cuádriceps simétrico · Sensibilidad normalizada"},

    { n:"Bursitis iliopectínea", z:"Ingle/Pubis",
      e:["Palpación inguinal anterior","Resistencia a flexión de cadera","Ecografía de la bursa","FABER positivo","RMN pelvis"],
      p:"F1: Control inflamatorio, evitar compresión.\nF2: Movilidad y fortalecimiento.\nF3: Retorno funcional.",
      fases:[
        {f:"Fase 1 — Control inflamatorio (0-3 sem)",ejs:["Crioterapia local 15min x3/día","Evitar flexión de cadera forzada","Isométrico flexores en posición media 3x10seg","AINE si prescrito"]},
        {f:"Fase 2 — Movilidad y fuerza (3-8 sem)",ejs:["Flexión activa cadera en rango indoloro 3x15","Estiramiento psoas suave 3x20seg","Fortalecimiento glúteo 3x15","Bicicleta suave sin compresión"]},
        {f:"Fase 3 — Retorno (8-14 sem)",ejs:["Flexión de cadera sin restricción","Gestos deportivos específicos","Sprint y cambios de dirección","Deporte completo"]}
      ],
      rts:"Palpación sin dolor · Flexión sin restricción · FABER negativo · Deporte completo"},

    { n:"Síndrome del ángulo isquio-femoral", z:"Isquiotibiales",
      e:["RMN cadera (edema cuadrado femoral)","Test de isquio-femoral (extensión-ADE)","Dolor glúteo profundo en marcha","Evaluación del espacio isquio-femoral","Anestesia diagnóstica"],
      p:"F1: Evitar extensión+aducción+rotación interna, reducir carga.\nF2: Movilidad de cadera, fortalecimiento.\nF3: Biomecánica y retorno.",
      fases:[
        {f:"Fase 1 — Descarga (0-4 sem)",ejs:["Evitar posición de extensión+aducción+RI cadera","Reducir marcha rápida y carrera","Estiramiento rotadores externos 3x30seg","Crioterapia local"]},
        {f:"Fase 2 — Movilidad y fuerza (4-10 sem)",ejs:["Movilidad cadera en todos los planos","Fortalecimiento abductores y rotadores externos 3x15","Hip thrust con control de RI 4x10","Técnica de marcha corregida"]},
        {f:"Fase 3 — Retorno (10-18 sem)",ejs:["Carrera con técnica de cadera correcta","Sprint progresivo","Gestos deportivos específicos","Biomecánica de carrera analizada"]}
      ],
      rts:"RMN sin edema · Marcha sin dolor · Carrera sin restricción"},

    { n:"Síndrome de fricción ciático-isquiática", z:"Isquiotibiales",
      e:["Dolor glúteo profundo reproducible con actividad","Palpación isquión y nervio ciático","Test de Puranen-Orava","RMN de pelvis","Evaluación biomecánica de la carrera"],
      p:"F1: Descompresión neural, reducción de carga.\nF2: Neurodinamia y fortalecimiento.\nF3: Retorno progresivo.",
      fases:[
        {f:"Fase 1 — Descarga neural (0-4 sem)",ejs:["Reducir kilómetros de carrera","Neurodinamia ciático-isquiática suave 3x10","Estiramiento isquiotibiales suave 3x30seg","Foam roller glúteo profundo"]},
        {f:"Fase 2 — Fortalecimiento (4-10 sem)",ejs:["Fortalecimiento glúteo mayor y medio 3x15","Excéntrico isquiotibiales progresivo 3x12","Core stability 3x30seg","Neurodinamia progresiva ciática"]},
        {f:"Fase 3 — Retorno (10-18 sem)",ejs:["Carrera progresiva con técnica","Sprint al 50-75-100%","Gestos deportivos específicos","Biomecánica analizada"]}
      ],
      rts:"Puranen-Orava negativo · Carrera sin dolor · Sprint completo · Deporte sin restricción"}
]

        // --- 3. MOTOROR AUTOMÁTICO DE DECISIÓN (The Engine) ---
        const MotorClinico = {
            configuracionCarga: {
                aguda: { enfoque: "Analgesia y Control de Inflamación", contraccion: "Isometría Sub-máxima" },
                subaguda: { enfoque: "Movilidad Activa y Resistencia Muscular", contraccion: "Isotónica Controlada" },
                funcional: { enfoque: "Fuerza, Potencia y Gesto Motor", contraccion: "Excéntrica y Pliometría" }
            },
            generarPlan(paciente, evaActual) {
                const zona = paciente.zona || "General";
                let faseKey = "Fase 1";
                let configKey = "aguda";

                // Lógica de Progresión Automática basada en EVA
                if (evaActual <= 3) {
                    faseKey = "Fase 3";
                    configKey = "funcional";
                } else if (evaActual <= 6) {
                    faseKey = "Fase 2";
                    configKey = "subaguda";
                }

                // Selección inteligente de la biblioteca
                let bibliotecaZona = BibliotecaClinicaIA[zona] || BibliotecaClinicaIA["Rodilla"]; // Fallback a Rodilla
                let ejercicios = bibliotecaZona[faseKey] || [];
                
                return {
                    fase: faseKey,
                    metadata: this.configuracionCarga[configKey],
                    ejercicios: ejercicios
                };
            }
        };

        // --- 4. LÓGICA DE APLICACIÓN ---
        let pacientes = [];
        let currentId = null;
        let mainChart = null;
        let regionalChart = null;

        // --- Helper: extraer mensaje legible de error Supabase (NUNCA lanza excepción) ---
        function _sbErrMsg(error) {
            if (!error) return '';
            if (typeof error === 'string') return error;
            try {
                // Extraer propiedades serializables sin JSON.stringify (puede fallar con Headers)
                const parts = [];
                if (error.message) parts.push(error.message);
                if (error.details && error.details !== error.message) parts.push(error.details);
                if (error.hint) parts.push('Hint: ' + error.hint);
                if (error.code) parts.push('Code: ' + error.code);
                return parts.join(' | ') || 'Error desconocido de Supabase';
            } catch(_) {
                return 'Error de Supabase (no serializable)';
            }
        }

        // --- SUPABASE: cargar pacientes ---
        async function cargarPacientesDB() {
            if (IS_SANDBOX) return;
            let data, error;
            try {
                ({ data, error } = await sb.from('pacientes').select('*').order('created_at', { ascending: false }));
            } catch(e) {
                console.error('[JelianFT] Excepción cargando pacientes:', e.message);
                _mostrarBannerError(e.message || 'Error de red al conectar con Supabase');
                return;
            }
            if (error) {
                const msg = _sbErrMsg(error);
                console.error('[JelianFT] Error cargando pacientes:', msg);
                _mostrarBannerError(msg, error.code);
                return;
            }
            const colCedula = _cedulaCol(); // puede ser null si no existe la columna
            pacientes = (data || []).map(p => ({
                id: p.id,
                nombre: p.nombre || '',
                ci: (colCedula ? p[colCedula] : '') || '',
                edad: p.edad || '',
                sexo: p.sexo || '',
                deporte: p.deporte || '',
                emergencia: p.emergencia || '',
                telefono: p.telefono || '',
                diag: p.diagnostico || '',
                zona: p.zona || 'Rodilla',
                valoracion: p.valoracion || [],
                evoluciones: p.evoluciones || [],
                rts: p.rts || null,
                fotosClinicas: p.fotos || [],
                ejerciciosHoja: p.ejercicios_hoja || [],
                estado: p.estado || 'activo',
                status: p.estado || 'activo',
                foto: p.foto_avatar || null,
                objetivos: p.objetivos || [],
                _supaId: p.id
            }));
            renderPacientes();
            updateDashboard();
        }

        // Detectar nombre de columna cédula al iniciar
        // === SCHEMA INTROSPECTION ===
        let _dbCols = null;

        async function detectarSchemaDB() {
            if (IS_SANDBOX) return;
            // Columnas base conocidas de la tabla
            _dbCols = new Set([
                'nombre', 'edad', 'sexo', 'deporte', 'emergencia', 'telefono',
                'diagnostico', 'zona', 'valoracion', 'evoluciones', 'fotos',
                'ejercicios_hoja', 'estado', 'rts', 'objetivos', 'foto_avatar'
            ]);
            // Detectar columnas reales automáticamente
            try {
                const { data, error } = await sb.from('pacientes').select('*').limit(1);
                if (!error && data && data.length > 0) {
                    _dbCols = new Set(Object.keys(data[0]));
                    console.log('[JelianFT] Columnas detectadas:', [..._dbCols]);
                } else if (error) {
                    console.log('[JelianFT] Usando columnas base. Error schema:', _sbErrMsg(error));
                } else {
                    console.log('[JelianFT] Usando columnas base (tabla vacía)');
                }
            } catch(e) {
                // Incluye DataCloneError u otros errores internos de Supabase
                console.warn('[JelianFT] Excepción detectando schema:', e.message, '— usando columnas base');
            }
        }

        // Filtra un payload para incluir solo columnas que existen en la DB
        function _filtrarPayload(payload) {
            if (!_dbCols) return payload;
            const filtrado = {};
            for (const [k, v] of Object.entries(payload)) {
                if (k === 'id' || _dbCols.has(k)) filtrado[k] = v;
            }
            return filtrado;
        }

        // Detecta el nombre de la columna cédula (puede no existir)
        function _cedulaCol() {
            if (!_dbCols) return null;
            for (const name of ['ci','cedula','cedula_identidad','documento','identificacion','id_documento','id_paciente']) {
                if (_dbCols.has(name)) return name;
            }
            return null;
        }

        function _cedulaPayload(ci) {
            const col = _cedulaCol();
            if (!col) return {};
            return { [col]: ci || '' };
        }

        async function save() {
            if (!currentId) return;
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const rawPayload = {
                nombre: p.nombre,
                ..._cedulaPayload(p.ci),
                edad: p.edad, sexo: p.sexo,
                deporte: p.deporte, emergencia: p.emergencia, telefono: p.telefono,
                diagnostico: p.diag, zona: p.zona, valoracion: p.valoracion,
                evoluciones: p.evoluciones || [], fotos: p.fotosClinicas || [],
                ejercicios_hoja: p.ejerciciosHoja || [], estado: p.estado || p.status || 'activo',
                rts: p.rts || null, objetivos: p.objetivos || [],
                foto_avatar: p.foto || null
            };
            const payload = _filtrarPayload(rawPayload);
            try {
                const { error } = await sb.from('pacientes').update(payload).eq('id', p.id);
                if (error) {
                    const msg = _sbErrMsg(error);
                    console.error('[JelianFT] Error en save():', msg);
                    showToast('Error guardando: ' + msg, true);
                }
            } catch(e) {
                console.error('[JelianFT] Excepción en save():', e.message);
                showToast('Error de red al guardar cambios', true);
            }
        }

        async function upsertPaciente(p) {
            // FIX: id se asigna UNA sola vez. Si es número (id local temporal), lo omitimos para que Supabase genere uno real.
            const rawPayload = {
                ...(typeof p.id === 'number' ? {} : { id: p.id }),
                nombre: p.nombre,
                ..._cedulaPayload(p.ci),
                edad: p.edad,
                sexo: p.sexo,
                deporte: p.deporte,
                emergencia: p.emergencia,
                telefono: p.telefono,
                diagnostico: p.diag,
                zona: p.zona,
                valoracion: p.valoracion,
                evoluciones: p.evoluciones,
                rts: p.rts,
                fotos: p.fotosClinicas,
                ejercicios_hoja: p.ejerciciosHoja,
                estado: p.estado || 'activo'
            };
            // (FIX: línea duplicada eliminada — antes había rawPayload.id = p.id aquí de nuevo)
            const payload = _filtrarPayload(rawPayload);
            try {
                const { data, error } = await sb.from('pacientes').upsert(payload).select().single();
                if (error) {
                    const msg = _sbErrMsg(error);
                    console.error('[JelianFT] Error upsert paciente:', msg);
                    showToast('Error guardando datos: ' + msg, true);
                    return;
                }
                if (data && typeof p.id === 'number') {
                    p.id = data.id;
                    p._supaId = data.id;
                }
            } catch(e) {
                console.error('[JelianFT] Excepción upsert:', e.message);
                showToast('Error de red al sincronizar datos', true);
            }
        }

        let toastTimeout = null;
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'show' + (isError ? ' error' : '');
            if (toastTimeout) clearTimeout(toastTimeout);
            // Errors stay longer so the user can read them
            toastTimeout = setTimeout(() => { t.className = ''; }, isError ? 4500 : 2800);
        }

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const isOpen = sidebar.classList.toggle('sidebar-open');
            overlay.classList.toggle('hidden', !isOpen);
            // Animate hamburger → X
            const icon = document.getElementById('menu-icon');
            if (icon) {
                icon.innerHTML = isOpen
                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'
                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>';
            }
        }

function diasDesdeUltimaSesion(p) {
            if (!p.evoluciones || p.evoluciones.length === 0) return null;
            const ultima = p.evoluciones[0].fecha;
            if (!ultima) return null;
            const hoy = new Date();
            const d = new Date(ultima + 'T00:00:00');
            return Math.floor((hoy - d) / (1000 * 60 * 60 * 24));
        }
        function diasBadgeHTML(dias) {
            if (dias === null) return '<span class="dias-badge dias-alert">Sin sesiones</span>';
            if (dias === 0) return '<span class="dias-badge dias-ok">Hoy</span>';
            if (dias <= 7) return `<span class="dias-badge dias-ok">Hace ${dias}d</span>`;
            if (dias <= 14) return `<span class="dias-badge dias-warn">Hace ${dias}d</span>`;
            return `<span class="dias-badge dias-alert">Hace ${dias}d ⚠</span>`;
        }

function renderPacientes() { renderLista(); }

        // ============================================================
        // DEBOUNCE UTILITY
        // ============================================================
        function debounce(fn, delay) {
            let t;
            return function(...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), delay); };
        }
        const _debouncedSearch = debounce(renderLista, 180);
        const _debouncedGlobalSearch = debounce(runGlobalSearch, 200);
        // FIX: _debouncedBiblioteca delegaba a renderBiblioteca pero tenía una copia duplicada de la misma lógica.
        // Simplificado: el debounce llama directamente a renderBiblioteca.
        const _debouncedBiblioteca = debounce(() => renderBiblioteca(), 180);
        function renderBiblioteca() {
            const q = (document.getElementById('busqueda-biblioteca')?.value || '').toLowerCase();
            const cont = document.getElementById('contenedor-biblioteca');
            if (!cont) return;
            cont.innerHTML = bibliotecaLesiones
                .filter(l => l.n.toLowerCase().includes(q) || l.z.toLowerCase().includes(q))
                .map(l => `
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:border-indigo-500 transition-all cursor-pointer group" data-lesion="${l.n.replace(/'/g, '&apos;')}" onclick="cargarProtocolo(this.dataset.lesion)">
                        <span class="text-[8px] font-black text-indigo-500 uppercase bg-indigo-50 px-3 py-1 rounded-full tracking-widest">${l.z}</span>
                        <h4 class="font-extrabold text-slate-800 text-sm mt-4 uppercase italic group-hover:text-indigo-600">${l.n}</h4>
                    </div>
                `).join('');
        }

        function cargarProtocolo(nombre) {
            const l = bibliotecaLesiones.find(x => x.n === nombre);
            if (!l) return;
            const colores = ['border-rose-400','border-amber-400','border-emerald-400','border-indigo-400'];
            const fasesHtml = (l.fases||[]).length > 0
                ? l.fases.map((fase,i) => `
                    <div class="rounded-2xl p-4 border-l-4 ${colores[i%4]} bg-slate-50">
                      <p class="text-xs font-black text-slate-700 mb-2">${fase.f}</p>
                      <ul class="space-y-1">${(fase.ejs||[]).map(ej=>`<li class="text-xs text-slate-600 flex gap-2"><span class="text-indigo-400 font-black flex-shrink-0">→</span>${ej}</li>`).join('')}</ul>
                    </div>`).join('')
                : `<div class="bg-slate-50 rounded-2xl p-4"><p class="text-xs text-slate-600 leading-relaxed">${l.p}</p></div>`;
            const rtsHtml = l.rts
                ? `<div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4 mb-4">
                    <p class="text-[10px] font-black text-emerald-700 uppercase tracking-widest mb-2">🏆 Criterios RTS</p>
                    <div class="flex flex-wrap gap-2">${l.rts.split('·').map(c=>c.trim()).filter(Boolean).map(c=>`<span class="bg-white border border-emerald-200 text-emerald-700 text-xs font-bold px-3 py-1 rounded-full">${c}</span>`).join('')}</div>
                   </div>` : '';
            // Sesiones promedio chip
            const sesData = getSesionesPromedio(l.n);
            const realData = calcularSesionesRealPorLesion(l.n);
            const sesHtml = sesData || realData ? `<div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-4 mb-4">
                <p class="text-[10px] font-black text-indigo-700 uppercase tracking-widest mb-2">⏱ Tiempo Estimado de Recuperación</p>
                <div class="flex flex-wrap gap-3">
                    ${sesData ? `<div class="bg-white border border-indigo-200 rounded-xl px-4 py-2 text-center">
                        <p class="text-[9px] font-black text-indigo-400 uppercase">Estimado (literatura)</p>
                        <p class="text-lg font-extrabold text-indigo-700">${sesData.prom} sesiones</p>
                        <p class="text-[9px] text-slate-400">Rango: ${sesData.min}–${sesData.max} ses.</p>
                    </div>` : ''}
                    ${realData ? `<div class="bg-white border border-emerald-200 rounded-xl px-4 py-2 text-center">
                        <p class="text-[9px] font-black text-emerald-500 uppercase">Real (tus pacientes)</p>
                        <p class="text-lg font-extrabold text-emerald-600">${realData.real} sesiones</p>
                        <p class="text-[9px] text-slate-400">Basado en ${realData.n} caso${realData.n!==1?'s':''}</p>
                    </div>` : ''}
                </div>
                <p class="text-[9px] text-slate-400 mt-2">💡 Este estimado puede compartirse con el paciente cuando pregunte por su recuperación.</p>
            </div>` : '';
            const evalHtml = `<div class="mb-4"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">🔬 Evaluaciones</p><div class="flex flex-wrap gap-2">${l.e.map(ev=>`<span class="bg-indigo-50 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full">${ev}</span>`).join('')}</div></div>`;
            document.body.insertAdjacentHTML('beforeend', `
              <div id="modal-protocolo" class="fixed inset-0 z-[999] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" onclick="if(event.target===this)this.remove()">
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
                  <div class="flex items-start justify-between mb-4">
                    <div><span class="text-[8px] font-black text-indigo-500 uppercase bg-indigo-50 px-3 py-1 rounded-full tracking-widest">${l.z}</span>
                    <h2 class="text-lg font-extrabold text-slate-800 mt-2 uppercase italic">${l.n}</h2></div>
                    <button onclick="document.getElementById('modal-protocolo').remove()" class="text-slate-400 hover:text-slate-700 text-2xl font-bold leading-none ml-4">✕</button>
                  </div>
                  ${evalHtml}
                  <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">📋 Protocolo por Fases</p>
                  <div class="space-y-3 mb-4">${fasesHtml}</div>
                  ${sesHtml}
                  ${rtsHtml}
                  <div class="flex gap-3">
                    <button onclick="cargarEnFormulario('${l.n.replace(/'/g,"\'")}');document.getElementById('modal-protocolo').remove()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-2xl text-sm hover:bg-indigo-700 transition-all">+ Crear Paciente con este Diagnóstico</button>
                    <button onclick="document.getElementById('modal-protocolo').remove()" class="px-5 bg-slate-100 text-slate-600 font-bold py-3 rounded-2xl text-sm">Cerrar</button>
                  </div>
                </div>
              </div>`);
        }

        function cargarEnFormulario(nombre) {
            const l = bibliotecaLesiones.find(x => x.n === nombre);
            if (!l) return;
            const container = document.getElementById('reg-eval-container');
            container.innerHTML = l.e.map(test => `
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">${test}</label>
                    <input type="text" data-test="${test}" class="eval-input w-full bg-white border border-slate-200 rounded-xl p-3 text-xs font-bold mt-1 outline-none focus:border-indigo-500 transition-all shadow-sm">
                </div>`).join('');
            const protTexto = (l.fases||[]).length > 0
                ? 'DIAGNÓSTICO: '+l.n+'\nZONA: '+l.z+'\n\n'+l.fases.map(f=>f.f+':\n'+(f.ejs||[]).map(e=>'  • '+e).join('\n')).join('\n\n')+(l.rts?'\n\nRTS: '+l.rts:'')
                : 'DIAGNÓSTICO: '+l.n+'\nZONA: '+l.z+'\n\nTRATAMIENTO:\n'+l.p;
            document.getElementById('reg-diag').value = protTexto;
            const zonaSelect = document.getElementById('reg-zona');
            if (zonaSelect) {
                const opts = Array.from(zonaSelect.options).map(o => o.value);
                zonaSelect.value = opts.includes(l.z) ? l.z : '';
            }
            showSection('nuevo-paciente');
        }

        document.getElementById('formRegistro').onsubmit = async function(e) {
    e.preventDefault();
    const form = this;
    const diagText = document.getElementById('reg-diag').value;
    
    const lesionEncontrada = bibliotecaLesiones.find(l => diagText.includes(l.n));
    
    const zonaManual = document.getElementById('reg-zona').value;
    const detectZona = zonaManual || (lesionEncontrada ? lesionEncontrada.z : "Rodilla");

    const ciVal = document.getElementById('reg-ci').value;
    const rawPayload = {
        nombre: document.getElementById('reg-nombre').value,
        ..._cedulaPayload(ciVal),
        edad: document.getElementById('reg-edad').value,
        sexo: document.getElementById('reg-sexo').value,
        deporte: document.getElementById('reg-deporte').value,
        emergencia: document.getElementById('reg-emergencia').value,
        telefono: document.getElementById('reg-telefono').value,
        diagnostico: diagText,
        zona: detectZona,
        valoracion: Array.from(document.querySelectorAll('.eval-input')).map(i => ({ p: i.dataset.test, r: i.value })),
        evoluciones: [], fotos: [], ejercicios_hoja: [], estado: 'activo'
    };
    const payload = _filtrarPayload(rawPayload);

    let data, error;
    try {
        ({ data, error } = await sb.from('pacientes').insert(payload).select().single());
    } catch(e) {
        console.error('[JelianFT] Excepción INSERT:', e.message);
        showToast('Error de red al registrar atleta: ' + e.message, true);
        return;
    }
    if (error) {
        const msg = _sbErrMsg(error);
        console.error('[JelianFT] Error INSERT pacientes:', msg);
        console.error('[JelianFT] Payload:', JSON.stringify(payload));
        showToast('Error guardando paciente: ' + msg, true);
        return;
    }

    const newP = {
        id: data.id,
        nombre: payload.nombre, ci: ciVal, edad: payload.edad,
        sexo: payload.sexo, deporte: payload.deporte, emergencia: payload.emergencia,
        telefono: payload.telefono, diag: payload.diagnostico, zona: payload.zona,
        valoracion: payload.valoracion, evoluciones: [], rts: null,
        fotosClinicas: [], ejerciciosHoja: [], estado: 'activo', status: 'activo',
        foto: null, objetivos: [], _supaId: data.id
    };
    pacientes.unshift(newP);
    renderPacientes();
    updateDashboard();
    form.reset();
    showSection('lista-pacientes');
    showToast('✓ Atleta registrado correctamente.');
};
        function renderLista() {
            const t = document.getElementById('tabla-pacientes');
            const busqueda = (document.getElementById('busqueda-atleta')?.value || '').toLowerCase();
            const fechaInicio = document.getElementById('filtro-fecha-inicio')?.value || '';
            const fechaFin = document.getElementById('filtro-fecha-fin')?.value || '';
            // Advanced filter chips
            const filtroZona = window._filtroZona || '';
            const filtroStatus = window._filtroStatus || '';
            const filtroEva = window._filtroEva || '';

            const filtrados = pacientes.filter(p => {
                const coincideNombre = p.nombre.toLowerCase().includes(busqueda) || p.ci.includes(busqueda);
                const fechaAtleta = p.evoluciones.length > 0 ? p.evoluciones[0].fecha : new Date().toISOString().split('T')[0];
                let coincideFecha = true;
                if (fechaInicio) coincideFecha = coincideFecha && (fechaAtleta >= fechaInicio);
                if (fechaFin) coincideFecha = coincideFecha && (fechaAtleta <= fechaFin);
                const coincideZona = !filtroZona || p.zona === filtroZona;
                const coincideStatus = !filtroStatus || (p.status || p.estado || 'activo') === filtroStatus;
                const ultimoEva = p.evoluciones[0]?.eva ?? null;
                let coincideEva = true;
                if (filtroEva === 'alto') coincideEva = ultimoEva !== null && ultimoEva >= 7;
                if (filtroEva === 'medio') coincideEva = ultimoEva !== null && ultimoEva >= 4 && ultimoEva <= 6;
                if (filtroEva === 'bajo') coincideEva = ultimoEva !== null && ultimoEva <= 3;
                return coincideNombre && coincideFecha && coincideZona && coincideStatus && coincideEva;
            });

            if (filtrados.length === 0) {
                t.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-8 py-20 text-center">
                            <div class="flex flex-col items-center gap-4 opacity-40">
                                <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                <p class="font-black text-slate-400 text-sm uppercase tracking-widest">${pacientes.length === 0 ? 'Sin expedientes registrados' : 'No se encontraron resultados'}</p>
                                <p class="text-xs text-slate-400">${pacientes.length === 0 ? 'Ve a Protocolos para registrar tu primer atleta' : 'Intenta con otro término de búsqueda'}</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            t.innerHTML = filtrados.map(p => {
                const ultimoEva = p.evoluciones[0]?.eva ?? null;
                const dias = diasDesdeUltimaSesion(p);
                return `
                    <tr class="hover:bg-slate-50 cursor-pointer ${ultimoEva !== null && ultimoEva >= 7 ? 'red-flag' : ''}" onclick="verDetalle('${p.id}')">
                        <td class="px-8 py-5">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center font-black text-xs flex-shrink-0 overflow-hidden">
                                    ${p.foto ? `<img src="${p.foto}" class="w-full h-full object-cover" alt="${p.nombre}">` : p.nombre.charAt(0)}
                                </div>
                                <div>
                                    <p class="font-bold text-slate-800 text-sm">${p.nombre}</p>
                                    <p class="text-[10px] text-slate-400">ID: ${p.ci}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-8 py-5">
                            <p class="font-bold text-slate-600 text-[11px] uppercase">${p.deporte}</p>
                        </td>
                        <td class="px-8 py-5">
                            <span class="text-base font-black ${ultimoEva !== null && ultimoEva > 6 ? 'text-rose-500' : 'text-emerald-500'}">${ultimoEva !== null ? ultimoEva : '--'}</span>
                        </td>
                        <td class="px-8 py-5 hidden md:table-cell">${statusHTML(p.status || p.estado)}
                            <div class="mt-1">${diasBadgeHTML(dias)}</div>
                        </td>
                        <td class="px-8 py-5 text-right">
                            <button class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-4 py-2 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">Abrir</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function verDetalle(id) {
            currentId = String(id); // FIX: normalizar siempre a String
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) { showToast('Paciente no encontrado.', true); return; } // FIX: guard vs crash
            document.getElementById('p-nombre').innerText = p.nombre;
            document.getElementById('p-deporte-tag').innerText = p.deporte;
            document.getElementById('p-edad').innerText = p.edad + " AÑOS";
            document.getElementById('p-sexo').innerText = p.sexo;
            document.getElementById('p-diag').innerText = p.diag;
            document.getElementById('p-total-sesiones').innerText = p.evoluciones.length + " sesiones";
            document.getElementById('p-sesiones-mes').innerText = sesionesEsteMes(p) + " este mes";
            // Teléfono
            const telCard = document.getElementById('p-telefono-card');
            if (p.telefono) {
                document.getElementById('p-telefono').innerText = p.telefono;
                telCard.classList.remove('hidden');
            } else { telCard.classList.add('hidden'); }

            // Último contacto
            const diasEl = document.getElementById('p-ultimo-contacto');
            if (diasEl) {
                const dias = diasDesdeUltimaSesion(p);
                if (dias === null) diasEl.innerHTML = '<span class="dias-badge dias-alert">Sin sesiones</span>';
                else if (dias === 0) diasEl.innerHTML = '<span class="dias-badge dias-ok">Hoy</span>';
                else diasEl.innerHTML = `${diasBadgeHTML(dias)} (${p.evoluciones[0]?.fecha || ''})`;
            }

            // Status
            const statusEl = document.getElementById('p-status-badge');
            statusEl.innerHTML = statusHTML(p.status || p.estado);
            statusEl.onclick = () => cambiarStatus(id);

            // Foto
            renderAvatarDetalle(p);

            // Predicción
            const pred = calcularPrediccion(p);
            const predEl = document.getElementById('p-prediccion');
            if (pred !== null) {
                predEl.classList.remove('hidden');
                predEl.innerHTML = `<div class="prediction-chip">🔮 Alta estimada en ~${pred} sesiones</div>`;
            } else { predEl.classList.add('hidden'); }

            // Bienestar del paciente (datos registrados desde la app móvil)
            const bienCard = document.getElementById('p-bienestar-card');
            const bienContent = document.getElementById('p-bienestar-content');
            if (bienCard && bienContent) {
                // Buscar el último registro de bienestar en evoluciones
                const ultBien = (p.evoluciones || []).find(e =>
                    e.rpe != null || e.sleep || e.agua != null
                );
                if (ultBien) {
                    bienCard.classList.remove('hidden');
                    const sleepLabel = { '<5h':'< 5h', '5-6h':'5-6h', '6-7h':'6-7h', '+8h':'+8h' };
                    bienContent.innerHTML = `
                        <div class="text-[9px] font-black text-slate-400 uppercase mb-2">${ultBien.fecha || ''}</div>
                        <div class="flex flex-wrap gap-2">
                            ${ultBien.rpe != null ? `<span class="bg-violet-100 text-violet-700 px-3 py-1 rounded-full text-[10px] font-black">💪 Esfuerzo ${ultBien.rpe}/5</span>` : ''}
                            ${ultBien.sleep ? `<span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-black">💤 Sueño ${ultBien.sleep}</span>` : ''}
                            ${ultBien.agua != null ? `<span class="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-[10px] font-black">💧 ${ultBien.agua}/8 vasos</span>` : ''}
                        </div>
                        <div class="mt-3">
                            <p class="text-[9px] text-violet-400 font-bold">Racha de registros (EVA)</p>
                            <p class="text-sm font-black text-violet-600 mt-0.5">${calcularRacha(p)} días consecutivos 🔥</p>
                        </div>
                    `;
                } else {
                    bienCard.classList.add('hidden');
                }
            }

            document.getElementById('p-eval-list').innerHTML = p.valoracion.map(v => `
                <div class="flex justify-between items-center bg-slate-50/50 p-4 rounded-xl border border-slate-100">
                    <span class="text-[9px] font-black text-slate-400 uppercase">${v.p}</span>
                    <span class="text-[11px] font-black text-indigo-600">${v.r || '-'}</span>
                </div>
            `).join('');
            const planIAEl = document.getElementById('display-plan-ia');
            planIAEl.classList.add('hidden');
            planIAEl.style.display = '';
            // Establecer fecha de hoy por defecto
            document.getElementById('s-fecha').value = new Date().toISOString().split('T')[0];
            // Detener y resetear cronómetro al cambiar de paciente
            if (chronoRunning) chronoToggle();
            chronoReset();
            renderResumenRapido(p);
            renderSesiones();
            renderObjetivos();
            renderRTS();
            renderFotosClinicas();
            renderHojaEjercicios();
            updateChartEvolucion();
            showSection('detalle-paciente');
            document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function ejecutarMotorIA() {
            const eva = parseInt(document.getElementById('s-eva').value, 10);
            if(isNaN(eva)) { showToast("❌ Ingresa un valor EVA primero.", true); return; }
            
            const p = pacientes.find(x => String(x.id) === String(currentId));
            const plan = MotorClinico.generarPlan(p, eva);
            
            const display = document.getElementById('display-plan-ia');
            display.classList.remove('hidden');
            display.style.cssText = 'display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:1rem;';
            display.innerHTML = `
                <div class="md:col-span-2 bg-slate-900 p-6 rounded-3xl mb-4 text-white">
                    <p class="text-[10px] font-black uppercase tracking-widest text-indigo-400">Motor IA Generado: ${plan.fase}</p>
                    <p class="text-sm font-bold mt-1">${plan.metadata.enfoque}</p>
                    <p class="text-[10px] opacity-60 mt-2">Modalidad: ${plan.metadata.contraccion}</p>
                    <button onclick="exportarPlanIAaHoja()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-black hover:bg-indigo-500 transition-all">📋 Agregar a Hoja de Ejercicios</button>
                </div>
            ` + plan.ejercicios.map(ej => `
                <div class="bg-white border border-slate-100 p-6 rounded-3xl shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="text-xs font-black text-slate-800 uppercase italic">${ej.n}</h5>
                        <span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-[9px] font-black">${ej.s}x${ej.r}</span>
                    </div>
                    <p class="text-[10px] text-slate-500 leading-tight mb-4">${ej.d}</p>
                    <div class="space-y-1 border-t pt-3">
                        <p class="text-[8px] font-bold text-emerald-600 uppercase">● Obj: ${ej.o}</p>
                        <p class="text-[8px] font-bold text-rose-500 uppercase">✖ Precaución: ${ej.c}</p>
                        ${ej.p ? `<p class="text-[8px] font-bold text-amber-500 uppercase">↑ Progresión: ${ej.p}</p>` : ''}
                    </div>
                </div>
            `).join('');

            // Store plan for export
            window._lastIAPlan = plan;
        }

        async function exportarPlanIAaHoja() {
            const plan = window._lastIAPlan;
            if (!plan) return;
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            if (!p.ejerciciosHoja) p.ejerciciosHoja = [];
            plan.ejercicios.forEach(ej => {
                p.ejerciciosHoja.push({
                    nombre: ej.n,
                    series: ej.s,
                    reps: String(ej.r),
                    carga: '',
                    descanso: '60s',
                    descripcion: ej.d
                });
            });
            await save();
            renderHojaEjercicios();
            showToast(`✓ ${plan.ejercicios.length} ejercicios agregados a la hoja.`);
        }

        async function agregarSesion() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            const evaVal = parseInt(document.getElementById('s-eva').value, 10);
            if (isNaN(evaVal) || evaVal < 0 || evaVal > 10) {
                showToast("❌ EVA debe ser un número entre 0 y 10.", true);
                return;
            }
            if (!document.getElementById('s-fecha').value) {
                showToast("❌ Selecciona una fecha para la sesión.", true);
                return;
            }
            const tecnicas = Array.from(document.querySelectorAll('#tecnicas-chips input:checked')).map(cb => cb.value);
            const psfsVal = parseInt(document.getElementById('s-psfs').value, 10);
            const asistenciaVal = (document.querySelector('input[name="s-asistencia"]:checked') || {value:'vino'}).value;
            const s = {
                fecha: document.getElementById('s-fecha').value,
                eva: evaVal,
                rpe: parseInt(document.getElementById('s-rpe').value, 10) || 5,
                fuerza: document.getElementById('s-fuerza').value || '--',
                notas: document.getElementById('s-notas').value || 'Sin observaciones.',
                duracion: chronoSeconds > 0 ? chronoSeconds : null,
                tecnicas: tecnicas.length > 0 ? tecnicas : [],
                psfs: isNaN(psfsVal) ? null : psfsVal,
                asistencia: asistenciaVal,
                bodymap: _bodymapPuntos.map(p => ({...p}))
            };
            p.evoluciones.unshift(s);
            // Guardar en Supabase
            try {
                const { error } = await sb.from('pacientes').update({ evoluciones: p.evoluciones }).eq('id', currentId);
                if (error) { showToast('Error guardando sesión: ' + _sbErrMsg(error), true); return; }
            } catch(e) {
                showToast('Error de red al guardar sesión: ' + e.message, true); return;
            }
            verDetalle(currentId);
            ['s-eva', 's-fuerza', 's-notas', 's-psfs'].forEach(id => { const el = document.getElementById(id); el.value = ''; el.style.borderColor = ''; el.style.color = ''; });
            document.getElementById('s-rpe').value = 5;
            updateRPELabel(5);
            document.getElementById('s-fecha').value = new Date().toISOString().split('T')[0];
            // uncheck all técnicas
            document.querySelectorAll('#tecnicas-chips input').forEach(cb => cb.checked = false);
            // Reset asistencia a "vino"
            const radioVino = document.querySelector('input[name="s-asistencia"][value="vino"]');
            if (radioVino) { radioVino.checked = true; _actualizarAsistenciaBtns(); }
            // Reset body map
            limpiarBodyMap();
            showToast("✓ Sesión guardada correctamente.");
            limpiarSesionPendiente();
            // Scroll to sessions list smoothly
            setTimeout(() => {
                const cont = document.getElementById('sesiones-container');
                if (cont) cont.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 200);
        }

        function updateRPELabel(val) {
            const labels = ['','Muy fácil','Fácil','Suave','Moderado-bajo','Moderado','Moderado-alto','Duro','Muy duro','Casi máximo','Máximo'];
            document.getElementById('rpe-label').textContent = val + ' — ' + (labels[val] || '');
        }
        function updateEvaColor(input) {
            const v = parseInt(input.value, 10);
            if (isNaN(v)) { input.style.borderColor = ''; input.style.color = ''; return; }
            if (v >= 7) { input.style.borderColor = '#ef4444'; input.style.color = '#ef4444'; }
            else if (v >= 4) { input.style.borderColor = '#f59e0b'; input.style.color = '#f59e0b'; }
            else { input.style.borderColor = '#10b981'; input.style.color = '#10b981'; }
            input.style.borderWidth = '2px';
            input.style.borderStyle = 'solid';
        }

        function renderSesiones() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return; // FIX: guard vs crash si no hay paciente activo
            const cont = document.getElementById('sesiones-container');
            if (!p.evoluciones || p.evoluciones.length === 0) {
                cont.innerHTML = '<div class="text-center py-12 text-slate-400"><p class="font-black text-sm uppercase tracking-widest">Sin sesiones registradas</p><p class="text-xs mt-2">Agrega la primera sesión usando el formulario de arriba</p></div>';
                return;
            }
            cont.innerHTML = p.evoluciones.map((s, i) => `
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 relative animate-in">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-black text-slate-300 uppercase">${escHtml(s.fecha)}</span>
                                ${s.asistencia === 'falto' ? '<span class="text-[9px] font-black bg-rose-100 text-rose-500 px-2 py-0.5 rounded-full">❌ Faltó</span>' : s.asistencia === 'cancelo' ? '<span class="text-[9px] font-black bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">🔄 Canceló</span>' : '<span class="text-[9px] font-black bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full">✅ Vino</span>'}
                            </div>
                            <div class="mt-2 flex gap-2 flex-wrap">
                                    <span class="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-[10px] font-black">${escHtml(s.fuerza)}</span>
                                    ${s.rpe ? `<span class="bg-amber-50 text-amber-600 px-4 py-1.5 rounded-full text-[10px] font-black">RPE ${escHtml(s.rpe)}/10</span>` : ''}
                                    ${s.duracion ? `<span class="bg-emerald-50 text-emerald-600 px-4 py-1.5 rounded-full text-[10px] font-black">⏱ ${formatDuracion(s.duracion)}</span>` : ''}
                                    ${s.psfs != null ? `<span class="bg-sky-50 text-sky-600 px-4 py-1.5 rounded-full text-[10px] font-black">PSFS ${s.psfs}%</span>` : ''}
                                    ${(s.tecnicas && s.tecnicas.length > 0) ? s.tecnicas.map(t=>`<span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-[9px] font-bold">${escHtml(t)}</span>`).join('') : ''}
                                </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-3xl font-black ${s.eva > 6 ? 'text-rose-500' : 'text-slate-800'}">${s.eva}<span class="text-sm opacity-20">/10</span></span>
                            <button onclick="eliminarSesion(${i})" class="text-slate-300 hover:text-rose-500 transition-colors text-lg leading-none" title="Eliminar sesión">✕</button>
                        </div>
                    </div>
                    <p class="text-sm font-medium text-slate-600 italic border-l-2 border-indigo-200 pl-4">"${escHtml(s.notas || '')}"</p>
                    ${s.bodymap && s.bodymap.length > 0 ? `<div class="mt-4 flex flex-wrap gap-1.5">${s.bodymap.map(p=>`<span class="text-[9px] font-bold px-2 py-1 rounded-full bg-rose-50 text-rose-500">📍 ${escHtml(p.zona)} (${escHtml(p.vista)})</span>`).join('')}</div>` : ''}
                    ${(s.rpe != null && s.registradoPorPaciente) || s.sleep || s.agua != null ? `
                    <div class="mt-4 pt-4 border-t border-slate-50">
                        <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-2">📱 Registrado por el paciente</p>
                        <div class="flex flex-wrap gap-2">
                            ${s.rpe != null ? `<span class="bg-violet-50 text-violet-600 px-3 py-1 rounded-full text-[10px] font-black">💪 Esfuerzo RPE ${escHtml(s.rpe)}/5</span>` : ''}
                            ${s.sleep ? `<span class="bg-indigo-50 text-indigo-500 px-3 py-1 rounded-full text-[10px] font-black">💤 Sueño ${escHtml(s.sleep)}</span>` : ''}
                            ${s.agua != null ? `<span class="bg-sky-50 text-sky-500 px-3 py-1 rounded-full text-[10px] font-black">💧 ${escHtml(s.agua)}/8 vasos</span>` : ''}
                        </div>
                    </div>` : ''}
                </div>
            `).join('');
        }

        async function eliminarSesion(idx) {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            if (!confirm(`¿Eliminar la sesión del ${p.evoluciones[idx].fecha}?`)) return;
            p.evoluciones.splice(idx, 1);
            await save();
            renderSesiones();
            updateChartEvolucion();
            showToast('✓ Sesión eliminada.');
        }
async function updateDashboard() {
    // 1. Actualizar fecha y total de pacientes
    if(document.getElementById('current-date')) {
        const opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('es-ES', opcionesFecha);
    }
    // Cargar nombre guardado
    const nombreGuardado = localStorage.getItem('jelian_username') || 'Jelian';
    const greetEl = document.getElementById('greeting-name');
    if (greetEl) greetEl.innerText = nombreGuardado;
    document.getElementById('dash-total').innerText = pacientes.length;
    loadNotes();
    renderComparativa();
    renderCitasHoyDashboard();

    // 2. Inicializar contadores — dinámico con todas las zonas
    const ALL_ZONAS = ["Rodilla","Hombro","Tobillo","Espalda","Cadera","Cuello/Cervical","Codo","Muñeca/Mano","Ingle/Pubis","Isquiotibiales","Pierna/Tibial","Pie","Otra"];
    const stats = {};
    ALL_ZONAS.forEach(z => { stats[z] = 0; });
    let sumEva = 0;
    let countEva = 0;
    let alertas = 0;
    let totalSesiones = 0;

    // Para filtrar sesiones del mes actual
    const ahora = new Date();
    const mesActual = ahora.getMonth();
    const anioActual = ahora.getFullYear();

    // 3. Procesar datos de los pacientes
    pacientes.forEach(p => {
        // A) Contar por Región (Usamos p.zona que ya se guarda correctamente en el registro)
        // Si la zona existe en stats, sumamos. Si no, o es null, lo ignoramos o podrías sumar a "Otros".
        if (p.zona && stats.hasOwnProperty(p.zona)) {
            stats[p.zona]++;
        }
        // Si la zona no existe en stats, simplemente se ignora
        
        // B) Métricas de EVA y Alertas
        if (p.evoluciones && p.evoluciones.length > 0) {
            // Contar solo sesiones del mes actual
            p.evoluciones.forEach(s => {
                if (s.fecha) {
                    const partes = s.fecha.split('-');
                    if (partes.length === 3) {
                        const anioSesion = parseInt(partes[0], 10);
                        const mesSesion = parseInt(partes[1], 10) - 1;
                        if (anioSesion === anioActual && mesSesion === mesActual) {
                            totalSesiones++;
                        }
                    }
                }
                const evaVal = parseInt(s.eva, 10);
                if (!isNaN(evaVal)) {
                    sumEva += evaVal;
                    countEva++;
                }
            });
            
            // Alerta si el último EVA registrado es >= 7
            if (p.evoluciones && p.evoluciones.length > 0 && p.evoluciones[0].eva >= 7) {
                alertas++;
            }
        }
    });

    // 4. Actualizar las tarjetas (KPIs) en el HTML
    // Evitamos división por cero en el promedio
    const evaPromedio = countEva > 0 ? (sumEva / countEva).toFixed(1) : '0.0';
    
    document.getElementById('dash-eva').innerText = evaPromedio;
    document.getElementById('dash-alertas').innerText = alertas;
    document.getElementById('dash-sesiones').innerText = totalSesiones;

    // 5. Renderizar / Actualizar el Gráfico de Regiones
    const canvas = document.getElementById('chartRegiones');
    if (canvas) {
        const ctxR = canvas.getContext('2d');

        // Si ya existe una gráfica previa, la destruimos para no sobreponerlas
        if (window.regionalChart) {
            window.regionalChart.destroy();
        }

        // Only show zones with data > 0
        const statsFiltered = {};
        Object.entries(stats).forEach(([k,v]) => { if (v > 0) statsFiltered[k] = v; });
        const labelsFinal = Object.keys(statsFiltered).length > 0 ? Object.keys(statsFiltered) : Object.keys(stats).slice(0,5);
        const dataFinal = Object.keys(statsFiltered).length > 0 ? Object.values(statsFiltered) : Object.values(stats).slice(0,5);
        const CHART_COLORS = ['#6366f1','#818cf8','#a5b4fc','#c7d2fe','#e0e7ff','#8b5cf6','#7c3aed','#4f46e5','#3730a3','#312e81','#10b981','#6ee7b7'];

        window.regionalChart = new Chart(ctxR, {
            type: 'bar',
            data: {
                labels: labelsFinal,
                datasets: [{
                    label: 'Pacientes Activos',
                    data: dataFinal,
                    backgroundColor: labelsFinal.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]),
                    borderRadius: 8,
                    barThickness: 32
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        padding: 12,
                        cornerRadius: 10
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        grid: { borderDash: [5, 5], color: '#f1f5f9' },
                        ticks: { stepSize: 1, font: { family: "'Plus Jakarta Sans', sans-serif" } }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { font: { family: "'Plus Jakarta Sans', sans-serif", weight: 'bold' }, maxRotation: 30 }
                    }
                }
            }
        });
    }
}

        function updateChartEvolucion() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            const canvas = document.getElementById('chartEvolucion');
            if(!p || !p.evoluciones.length || !canvas) return;
            const evos = [...p.evoluciones].reverse();
            if(mainChart) mainChart.destroy();
            mainChart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { labels: evos.map(e => e.fecha), datasets: [{ data: evos.map(e => e.eva), borderColor: '#818cf8', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.15)' }] },
                options: { maintainAspectRatio: false, plugins: { legend: false }, scales: { y: { min: 0, max: 10 } } }
            });
        }

        function exportarBackup() {
            const blob = new Blob([JSON.stringify(pacientes)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `JelianFT_DB.json`; a.click();
        }

        function importarBackup(event) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const datos = JSON.parse(e.target.result);
                    if (!Array.isArray(datos)) throw new Error("Formato inválido");
                    // Upsert all patients to Supabase
                    for (const p of datos) {
                        await upsertPaciente(p);
                    }
                    await cargarPacientesDB();
                    showToast('✓ Backup importado correctamente.');
                } catch(err) {
                    showToast("❌ El archivo no es válido. Verifica que sea un backup de Jelian FT.", true);
                    document.getElementById('importFile').value = "";
                }
            };
            reader.readAsText(event.target.files[0]);
        }

        function eliminarPaciente() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            document.getElementById('modal-nombre-paciente').innerText = p.nombre;
            document.getElementById('modal-confirm-btn').onclick = async function() {
                try { await sb.from('pacientes').delete().eq('id', currentId); } catch(e) { console.error('[JelianFT] Error eliminando:', e.message); }
                pacientes = pacientes.filter(x => String(x.id) !== String(currentId));
                cerrarModal();
                showSection('lista-pacientes');
                showToast("✓ Atleta dado de alta correctamente.");
                updateDashboard();
            };
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        // ============================================================
        // NOTA DE ALTA CLÍNICA
        // ============================================================
        let _notaAltaTexto = '';

        function mostrarNotaAlta() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const totalSes = p.evoluciones.length;
            const evaInicial = totalSes > 0 ? p.evoluciones[p.evoluciones.length - 1].eva : 'N/D';
            const evaFinal   = totalSes > 0 ? p.evoluciones[0].eva : 'N/D';
            const fechaIngreso = totalSes > 0 ? p.evoluciones[p.evoluciones.length - 1].fecha : 'N/D';
            const fechaAlta   = new Date().toLocaleDateString('es-ES', { year:'numeric', month:'long', day:'numeric' });
            const evaOk = typeof evaInicial === 'number' && typeof evaFinal === 'number';
            const mejora = evaOk ? (evaInicial - evaFinal) : null;
            const porcentaje = (evaOk && evaInicial > 0) ? Math.round(((evaInicial - evaFinal) / evaInicial) * 100) : null;

            // Build note
            _notaAltaTexto = `JELIAN FT — CLINICAL SPORT
NOTA DE ALTA CLÍNICA
${'═'.repeat(40)}

PACIENTE: ${p.nombre.toUpperCase()}
Cédula / ID: ${p.ci || 'N/D'}       Edad: ${p.edad || 'N/D'} años       Sexo: ${p.sexo || 'N/D'}
Deporte: ${p.deporte || 'N/D'}       Zona lesionada: ${p.zona || 'N/D'}

${'─'.repeat(40)}
DIAGNÓSTICO INICIAL
${'─'.repeat(40)}
${p.diag || 'Sin diagnóstico registrado.'}

${'─'.repeat(40)}
RESUMEN DEL PROCESO
${'─'.repeat(40)}
• Fecha de ingreso:       ${fechaIngreso}
• Fecha de alta:          ${fechaAlta}
• Total de sesiones:      ${totalSes}
• EVA al inicio:          ${evaInicial}/10
• EVA al alta:            ${evaFinal}/10${mejora !== null ? `
• Reducción de dolor:     ${mejora} puntos (${porcentaje}% de mejoría)` : ''}

${'─'.repeat(40)}
EVOLUCIÓN REGISTRADA
${'─'.repeat(40)}
${totalSes === 0 ? 'Sin sesiones registradas.' : p.evoluciones.slice().reverse().map((s, i) =>
    `Sesión ${i+1} — ${s.fecha} | EVA: ${s.eva}/10 | ${s.fuerza || ''}${s.notas ? '\n  Notas: ' + s.notas : ''}`
).join('\n')}

${'─'.repeat(40)}
OBSERVACIONES DE ALTA
${'─'.repeat(40)}
El paciente ha completado el proceso de rehabilitación. Se da de alta con ${evaFinal <= 2 ? 'resolución completa del cuadro clínico' : evaFinal <= 4 ? 'mejoría significativa del cuadro' : 'mejoría parcial, se recomiendan controles posteriores'}.

${'═'.repeat(40)}
Fecha: ${fechaAlta}
Generado por Jelian FT — Clinical Sport v136`;

            document.getElementById('nota-alta-content').textContent = _notaAltaTexto;
            document.getElementById('modal-alta-clinica').classList.remove('hidden');
        }

        function cerrarModalAlta() {
            document.getElementById('modal-alta-clinica').classList.add('hidden');
        }

        function copiarNotaAlta() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(_notaAltaTexto)
                    .then(() => showToast('✓ Nota copiada al portapapeles.'))
                    .catch(() => _copiarFallback());
            } else {
                _copiarFallback();
            }
        }
        function _copiarFallback() {
            const ta = document.createElement('textarea');
            ta.value = _notaAltaTexto;
            ta.style.position = 'fixed'; ta.style.opacity = '0';
            document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); showToast('✓ Nota copiada.'); }
            catch(e) { showToast('No se pudo copiar. Selecciona el texto manualmente.', true); }
            document.body.removeChild(ta);
        }

        function imprimirNotaAlta() {
            const win = window.open('', '_blank');
            if (!win) { showToast('❌ Habilita ventanas emergentes.', true); return; }
            win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Nota de Alta</title>
            <style>body{font-family:monospace;font-size:13px;padding:40px;max-width:700px;margin:auto;line-height:1.8;color:#0f172a;white-space:pre-line;}</style></head>
            <body>${_notaAltaTexto.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</body></html>`);
            win.document.close(); win.print();
        }

        async function confirmarAlta() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            cerrarModalAlta();
            // Dar de alta directamente sin segundo confirm (ya se confirmó en el modal de nota)
            try { await sb.from('pacientes').delete().eq('id', currentId); } catch(e) { console.error('[JelianFT] Error dando de alta:', e.message); }
            pacientes = pacientes.filter(x => String(x.id) !== String(currentId));
            showSection('lista-pacientes');
            showToast('✓ Atleta dado de alta correctamente.');
            updateDashboard();
        }

        // ============================================================
        // LISTA DE ESPERA
        // ============================================================
        let listaEspera = JSON.parse(localStorage.getItem('jft_espera') || '[]');
        function saveEspera() { localStorage.setItem('jft_espera', JSON.stringify(listaEspera)); }

        function abrirModalEspera() {
            ['espera-nombre','espera-tel','espera-motivo','espera-notas'].forEach(id => {
                const el = document.getElementById(id); if(el) el.value = '';
            });
            const sel = document.getElementById('espera-prioridad'); if(sel) sel.value = 'normal';
            document.getElementById('modal-espera').classList.remove('hidden');
        }
        function cerrarModalEspera() { document.getElementById('modal-espera').classList.add('hidden'); }

        function guardarEspera() {
            const nombre = document.getElementById('espera-nombre').value.trim();
            if (!nombre) { showToast('Ingresa el nombre del paciente', true); return; }
            listaEspera.push({
                id: Date.now(),
                nombre,
                tel: document.getElementById('espera-tel').value.trim(),
                motivo: document.getElementById('espera-motivo').value.trim(),
                prioridad: document.getElementById('espera-prioridad').value,
                notas: document.getElementById('espera-notas').value.trim(),
                fecha: new Date().toISOString().split('T')[0]
            });
            saveEspera(); cerrarModalEspera(); renderEspera();
            showToast('✓ Paciente agregado a lista de espera.');
        }

        function eliminarEspera(id) {
            if (!confirm('¿Quitar de la lista de espera?')) return;
            listaEspera = listaEspera.filter(e => e.id !== id);
            saveEspera(); renderEspera();
            showToast('✓ Eliminado de lista de espera.');
        }

        function moverEsperaACita(e) {
            if (!e) return;
            // Pre-fill the calendar form if possible
            abrirFormCita && abrirFormCita();
            const nomInput = document.getElementById('cita-atleta');
            if (nomInput) nomInput.value = e.nombre;
            showSection('calendario');
            showToast('✓ Abre el formulario de cita con el nombre prellenado.');
        }

        function renderEspera() {
            const lista = document.getElementById('espera-lista');
            const totalEl = document.getElementById('espera-total');
            const urgEl = document.getElementById('espera-urgentes');
            const promEl = document.getElementById('espera-dias-prom');
            const navBadge = document.getElementById('espera-badge-nav');
            if (!lista) return;
            const hoy = new Date();
            const total = listaEspera.length;
            const urgentes = listaEspera.filter(e => e.prioridad === 'urgente').length;
            const diasProm = total > 0 ? Math.round(listaEspera.reduce((s,e) => {
                const d = new Date(e.fecha + 'T12:00:00');
                return s + Math.floor((hoy - d) / 86400000);
            }, 0) / total) : 0;
            if(totalEl) totalEl.textContent = total;
            if(urgEl) urgEl.textContent = urgentes;
            if(promEl) promEl.textContent = diasProm + 'd';
            if(navBadge) { navBadge.textContent = total; navBadge.classList.toggle('hidden', total === 0); }
            if (total === 0) {
                lista.innerHTML = '<div class="glass-card rounded-3xl p-12 text-center"><div class="text-4xl mb-4">🎉</div><p class="font-black text-slate-600 text-sm">Lista de espera vacía</p><p class="text-xs text-slate-400 mt-2">Todos los pacientes tienen cita asignada</p></div>';
                return;
            }
            const prioColor = { urgente: 'bg-rose-100 text-rose-700', normal: 'bg-amber-100 text-amber-700', rutina: 'bg-slate-100 text-slate-500' };
            const prioLabel = { urgente: '🔴 Urgente', normal: '🟡 Normal', rutina: '⚪ Rutina' };
            lista.innerHTML = [...listaEspera].sort((a,b) => {
                const order = { urgente: 0, normal: 1, rutina: 2 };
                return order[a.prioridad] - order[b.prioridad];
            }).map(e => {
                const dias = Math.floor((hoy - new Date(e.fecha + 'T12:00:00')) / 86400000);
                return `<div class="glass-card rounded-2xl p-5 flex flex-col sm:flex-row sm:items-center gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-extrabold text-slate-900 text-sm">${escHtml(e.nombre)}</span>
                            <span class="text-[9px] font-black px-2 py-0.5 rounded-full ${prioColor[e.prioridad] || 'bg-slate-100 text-slate-500'}">${prioLabel[e.prioridad] || e.prioridad}</span>
                        </div>
                        ${e.motivo ? `<p class="text-xs text-slate-500 mb-1">📋 ${escHtml(e.motivo)}</p>` : ''}
                        ${e.tel ? `<p class="text-xs text-slate-400">📱 ${escHtml(e.tel)}</p>` : ''}
                        ${e.notas ? `<p class="text-xs text-slate-400 italic mt-1">${escHtml(e.notas)}</p>` : ''}
                        <p class="text-[10px] text-slate-300 mt-2">En espera desde: ${e.fecha} (${dias}d)</p>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        ${e.tel ? `<a href="https://wa.me/${e.tel.replace(/\D/g,'')}" target="_blank" class="bg-green-500 text-white px-3 py-2 rounded-xl text-[10px] font-black hover:bg-green-600 transition-all">WhatsApp</a>` : ''}
                        <button onclick="eliminarEspera(${e.id})" class="bg-rose-50 text-rose-500 px-3 py-2 rounded-xl text-[10px] font-black hover:bg-rose-500 hover:text-white transition-all">Quitar</button>
                    </div>
                </div>`;
            }).join('');
        }

        // ============================================================
        // TIEMPO PROMEDIO POR LESIÓN (estadística en protocolos)
        // ============================================================
        // Lookup table base (sesiones promedio estimadas por lesión conocida)
        const SESIONES_BASE = {
            // ─── PIE Y TOBILLO ───
            'Fascitis plantar':                                  {min:16,max:32,prom:24},
            'Fascitis plantar resistente (crónica)':             {min:24,max:48,prom:36},
            'Espolón calcáneo':                                  {min:12,max:24,prom:18},
            'Esguince de tobillo grado I':                       {min:6, max:12,prom:9 },
            'Esguince grado II':                                 {min:12,max:24,prom:18},
            'Esguince grado III':                                {min:24,max:48,prom:36},
            'Tendinitis aquilea':                                {min:18,max:36,prom:27},
            'Rotura parcial del Aquiles':                        {min:40,max:72,prom:56},
            'Rotura total del Aquiles (post-quirúrgico)':        {min:60,max:100,prom:80},
            'Inestabilidad crónica de tobillo (CAI)':            {min:16,max:32,prom:24},
            'Síndrome de Achilles insertional':                  {min:16,max:32,prom:24},
            'Esguince de la articulación de Lisfranc':           {min:24,max:48,prom:36},
            'Sesamoiditis':                                      {min:12,max:24,prom:18},
            'Neuroma de Morton':                                 {min:12,max:24,prom:18},
            'Lesión condral de tobillo (OCD talar)':             {min:30,max:60,prom:45},
            'Periostitis tibial':                                {min:12,max:24,prom:18},
            'Periostitis tibial (Shin Splints)':                 {min:12,max:24,prom:18},
            'Fractura metatarsiana':                             {min:16,max:32,prom:24},
            'Fractura de Jones (5º metatarsiano)':               {min:20,max:40,prom:30},
            'Tobillo del basquetbolista':                        {min:12,max:24,prom:18},
            'Síndrome compartimental crónico':                   {min:12,max:24,prom:18},
            // ─── RODILLA ───
            'Tendinitis rotuliana':                              {min:20,max:36,prom:28},
            'Rodilla del saltador':                              {min:20,max:36,prom:28},
            'Rodilla del saltador (tendinopatía rotuliana)':     {min:20,max:36,prom:28},
            'Condromalacia rotuliana':                           {min:20,max:36,prom:28},
            'Síndrome patelofemoral':                            {min:16,max:30,prom:23},
            'Rodilla del corredor':                              {min:12,max:24,prom:18},
            'Rodilla del corredor (síndrome patelofemoral)':     {min:12,max:24,prom:18},
            'Síndrome de banda iliotibial':                      {min:12,max:24,prom:18},
            'Síndrome de banda iliotibial (ITBS)':               {min:12,max:24,prom:18},
            'Síndrome del corredor (ITBS avanzado)':             {min:16,max:32,prom:24},
            'Lesión LCA':                                        {min:60,max:100,prom:80},
            'Rehabilitación post-LCA (6 meses)':                {min:60,max:100,prom:80},
            'Lesión LCP':                                        {min:30,max:60,prom:45},
            'Lesión LCP (ligamento cruzado posterior)':          {min:30,max:60,prom:45},
            'Meniscopatía medial':                               {min:20,max:40,prom:30},
            'Meniscopatía lateral':                              {min:20,max:40,prom:30},
            'Bursitis prerrotuliana':                            {min:8, max:16,prom:12},
            'Síndrome de Osgood-Schlatter':                      {min:16,max:36,prom:26},
            'Síndrome de Sinding-Larsen-Johansson':              {min:12,max:24,prom:18},
            'Artrosis temprana de rodilla':                      {min:20,max:40,prom:30},
            'Edema óseo de rodilla':                             {min:20,max:40,prom:30},
            'Desequilibrios musculares (rodilla)':               {min:12,max:24,prom:18},
            'Pinzamiento articular de rodilla':                  {min:16,max:30,prom:23},
            'Fractura por estrés tibial':                        {min:16,max:32,prom:24},
            // ─── CADERA Y PELVIS ───
            'Pubalgia':                                          {min:24,max:48,prom:36},
            'Pubalgia futbolista':                               {min:24,max:48,prom:36},
            'Hernia inguinal deportiva (Gilmore Groin)':         {min:24,max:48,prom:36},
            'Osteítis de pubis':                                 {min:24,max:48,prom:36},
            'Bursitis trocantérica':                             {min:12,max:24,prom:18},
            'Bursitis iliopectínea':                             {min:12,max:24,prom:18},
            'Síndrome piriforme':                                {min:12,max:24,prom:18},
            'Lesión labrum acetabular':                          {min:30,max:60,prom:45},
            'Síndrome cadera en resorte':                        {min:12,max:24,prom:18},
            'Fractura por estrés de cadera (cuello femoral)':    {min:30,max:60,prom:45},
            'Avulsión apofisaria isquiática (adolescente)':      {min:16,max:32,prom:24},
            'Síndrome del ángulo isquio-femoral':                {min:12,max:24,prom:18},
            'Síndrome de fricción ciático-isquiática':           {min:12,max:24,prom:18},
            'Meralgia parestésica':                              {min:10,max:20,prom:15},
            'Neuropatía del nervio femoral':                     {min:12,max:24,prom:18},
            // ─── MUSLO Y PIERNA ───
            'Desgarro grado I':                                  {min:6, max:12,prom:9 },
            'Desgarro grado II':                                 {min:12,max:24,prom:18},
            'Desgarro grado III':                                {min:24,max:48,prom:36},
            'Desgarro isquiotibial':                             {min:12,max:24,prom:18},
            'Desgarro proximal de isquiotibiales':               {min:20,max:40,prom:30},
            'Desgarro aductores':                                {min:12,max:24,prom:18},
            'Contractura de cuádriceps':                         {min:6, max:12,prom:8 },
            'Contractura del aductor largo':                     {min:6, max:12,prom:8 },
            'Contusión muscular':                                {min:6, max:14,prom:10},
            'Tendinopatía proximal de isquiotibiales':           {min:20,max:40,prom:30},
            'Tendinopatía del psoas-ilíaco':                     {min:12,max:24,prom:18},
            'Tendinopatía peroneal':                             {min:16,max:32,prom:24},
            'DOMS (dolor muscular de aparición tardía)':         {min:2, max:6, prom:4 },
            // ─── COLUMNA LUMBAR ───
            'Lumbalgia mecánica':                                {min:8, max:16,prom:12},
            'Hernia discal lumbar':                              {min:20,max:40,prom:30},
            'Ciatalgia':                                         {min:16,max:32,prom:24},
            'Espondilolistesis':                                 {min:20,max:40,prom:30},
            'Contractura paravertebral':                         {min:4, max:10,prom:7 },
            'Lumbar del levantador':                             {min:12,max:24,prom:18},
            'Dorsalgia postural':                                {min:8, max:16,prom:12},
            'Síndrome de sobreentrenamiento':                    {min:12,max:24,prom:18},
            // ─── COLUMNA CERVICAL ───
            'Cervicalgia mecánica':                              {min:8, max:16,prom:12},
            'Latigazo cervical':                                 {min:12,max:24,prom:18},
            'Contractura cervical aguda (tortícolis)':           {min:4, max:10,prom:7 },
            'Contractura cervical aguda (tortícolis)':           {min:4, max:10,prom:7 },
            'Radiculopatía cervical':                            {min:16,max:32,prom:24},
            'Cefalea cervicogénica':                             {min:12,max:20,prom:16},
            'Miositis cervical del nadador':                     {min:8, max:16,prom:12},
            'Síndrome de salida torácica':                       {min:16,max:32,prom:24},
            'Síndrome miofascial':                               {min:10,max:20,prom:15},
            'Calambre muscular':                                 {min:2, max:6, prom:4 },
            'Calambres musculares':                              {min:2, max:6, prom:4 },
            // ─── HOMBRO ───
            'Síndrome de impingement subacromial (SIS)':         {min:16,max:32,prom:24},
            'Bursitis subacromial':                              {min:12,max:24,prom:18},
            'Bursitis subdeltoidea':                             {min:12,max:24,prom:18},
            'Capsulitis adhesiva (hombro congelado)':            {min:30,max:60,prom:45},
            'Capsulitis adhesiva (hombro congelado) fase aguda': {min:30,max:60,prom:45},
            'Manguito rotador — tendinopatía global (todos los tendones)': {min:20,max:40,prom:30},
            'Síndrome del manguito rotador':                     {min:20,max:40,prom:30},
            'Rotura del manguito rotador (parcial)':             {min:24,max:48,prom:36},
            'Rotura del manguito rotador (total, post-quirúrgico)': {min:48,max:80,prom:64},
            'Supraespinoso — tendinopatía (arco doloroso)':      {min:16,max:32,prom:24},
            'Infraespinoso — tendinopatía y debilidad de RE':    {min:16,max:32,prom:24},
            'Subescapular — tendinopatía y debilidad de RI':     {min:16,max:32,prom:24},
            'Redondo menor — tendinopatía (RE a 90° ABD)':       {min:12,max:24,prom:18},
            'Rotura del supraespinoso (parcial — cara articular)':{min:20,max:40,prom:30},
            'Rotura del infraespinoso y redondo menor':          {min:24,max:48,prom:36},
            'Rotura del subescapular':                           {min:24,max:48,prom:36},
            'Tendinitis calcificante del manguito rotador':      {min:16,max:32,prom:24},
            'Luxación hombro':                                   {min:24,max:48,prom:36},
            'Lesión de Bankart (labrum anterior)':               {min:36,max:60,prom:48},
            'Inestabilidad glenohumeral anterior (TUBS)':        {min:24,max:48,prom:36},
            'Inestabilidad glenohumeral multidireccional (AMBRI)':{min:24,max:48,prom:36},
            'Lesión SLAP tipo II-IV':                            {min:30,max:60,prom:45},
            'Síndrome SLAP':                                     {min:24,max:48,prom:36},
            'Síndrome de hipomovilidad glenohumeral posterior':  {min:12,max:24,prom:18},
            'Discinesia escapular':                              {min:12,max:24,prom:18},
            'Síndrome escapulotorácico (escápula alada / crujido)':{min:16,max:32,prom:24},
            "Hombro del lanzador (Thrower's shoulder)":         {min:20,max:40,prom:30},
            'Hombro del nadador':                                {min:16,max:32,prom:24},
            'Artritis glenohumeral (degenerativa/OA)':           {min:16,max:32,prom:24},
            'Artritis reumatoide del hombro':                    {min:20,max:40,prom:30},
            'Osteoartritis acromioclavicular':                   {min:12,max:24,prom:18},
            'Artropatía acromioclavicular (AC)':                 {min:12,max:24,prom:18},
            'Luxación acromioclavicular':                        {min:16,max:32,prom:24},
            'Luxación esternoclavicular (anterior/posterior)':   {min:20,max:40,prom:30},
            'Fractura de clavícula':                             {min:20,max:36,prom:28},
            'Fractura de cabeza humeral (Garden/Neer)':          {min:30,max:60,prom:45},
            'Fractura de escápula (cuerpo, cuello, glenoides)':  {min:24,max:48,prom:36},
            'Osteólisis distal de clavícula (hombro del levantador)':{min:12,max:24,prom:18},
            'Rotura del tendón del bíceps (porción larga)':      {min:24,max:48,prom:36},
            'Tendinitis bíceps larga porción':                   {min:12,max:24,prom:18},
            'Tendinopatía del bíceps (porción larga) — crónica': {min:16,max:32,prom:24},
            'Parálisis del nervio axilar':                       {min:16,max:36,prom:26},
            'Neuropatía del nervio supraescapular':              {min:16,max:32,prom:24},
            'Neuropatía del supraescapular':                     {min:16,max:32,prom:24},
            'Síndrome del pectoral menor (compresión subcoracoidea)':{min:12,max:24,prom:18},
            'Síndrome del túnel cuadrilátero (nervio axilar)':   {min:12,max:24,prom:18},
            // ─── CODO ───
            'Epicondilitis (codo tenista)':                      {min:16,max:30,prom:22},
            'Epitrocleitis (codo golfista)':                     {min:16,max:28,prom:20},
            'Codo del lanzador (UCL medial)':                    {min:24,max:48,prom:36},
            'Lesión tríceps (rotura distal)':                    {min:24,max:48,prom:36},
            'Fractura de olécranon':                             {min:20,max:40,prom:30},
            'Síndrome del nervio ulnar en codo (cubital tardío)':{min:16,max:32,prom:24},
            'Síndrome del nervio interóseo posterior':           {min:12,max:24,prom:18},
            // ─── MUÑECA Y MANO ───
            'Esguince de muñeca':                                {min:8, max:16,prom:12},
            'Muñeca del gimnasta':                               {min:16,max:32,prom:24},
            'Tendinitis de De Quervain':                         {min:12,max:24,prom:18},
            'Síndrome túnel carpiano':                           {min:12,max:24,prom:18},
            'Síndrome del canal de Guyon':                       {min:10,max:20,prom:15},
            'Artritis de la base del pulgar (rizartrosis)':      {min:16,max:32,prom:24},
            'Dedo en gatillo (tenosinovitis flexora)':           {min:10,max:20,prom:15},
            'Rotura del ligamento colateral cubital pulgar':     {min:16,max:32,prom:24},
            'Fractura de escafoides':                            {min:20,max:48,prom:34},
            // ─── CABEZA ───
            'Conmoción cerebral':                                {min:6, max:20,prom:12},
        };

        function getSesionesPromedio(nombreLesion) {
            // Exact match
            if (SESIONES_BASE[nombreLesion]) return SESIONES_BASE[nombreLesion];
            // Fuzzy match
            const key = Object.keys(SESIONES_BASE).find(k =>
                nombreLesion.toLowerCase().includes(k.toLowerCase()) ||
                k.toLowerCase().includes(nombreLesion.toLowerCase())
            );
            return key ? SESIONES_BASE[key] : null;
        }

        function calcularSesionesRealPorLesion(nombreLesion) {
            // Calculate from real patient data
            const completados = pacientes.filter(p => {
                const diag = (p.diag || '').toLowerCase();
                return diag.includes(nombreLesion.toLowerCase()) && p.evoluciones.length > 0;
            });
            if (completados.length === 0) return null;
            const totalSes = completados.reduce((s,p) => s + p.evoluciones.length, 0);
            return { real: Math.round(totalSes / completados.length), n: completados.length };
        }

        function cerrarModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        // ============================================================
        // FECHA DE NACIMIENTO → EDAD AUTOMÁTICA
        // ============================================================
        function _calcularEdad(fechaNac) {
            if (!fechaNac) return null;
            const hoy = new Date();
            const nac = new Date(fechaNac);
            let edad = hoy.getFullYear() - nac.getFullYear();
            const m = hoy.getMonth() - nac.getMonth();
            if (m < 0 || (m === 0 && hoy.getDate() < nac.getDate())) edad--;
            return edad;
        }

        function calcularEdadReg(input) {
            const edad = _calcularEdad(input.value);
            const lbl = document.getElementById('reg-edad-calculada');
            const hidden = document.getElementById('reg-edad');
            if (edad !== null && edad >= 0 && edad <= 120) {
                lbl.textContent = `${edad} años`;
                hidden.value = edad;
            } else {
                lbl.textContent = '';
                hidden.value = '';
            }
        }

        function calcularEdadEdit(input) {
            const edad = _calcularEdad(input.value);
            const lbl = document.getElementById('edit-edad-calculada');
            const hidden = document.getElementById('edit-edad');
            if (edad !== null && edad >= 0 && edad <= 120) {
                lbl.textContent = `${edad} años`;
                hidden.value = edad;
            } else {
                lbl.textContent = '';
                hidden.value = '';
            }
        }

        // ============================================================
        // EXPORTAR CSV INDIVIDUAL (paciente)
        // ============================================================
        function exportarCSVPaciente() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const header = 'Fecha,EVA,Métrica,RPE,PSFS,Técnicas,Notas\n';
            const filas = (p.evoluciones || []).map(s =>
                [s.fecha, s.eva, s.fuerza||'', s.rpe||'', s.psfs||'',
                 (s.tecnicas||[]).join(' | '), (s.notas||'').replace(/\n/g,' ')]
                .map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')
            ).join('\n');
            const csv = '\uFEFF' + header + filas; // BOM para Excel
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${p.nombre.replace(/\s+/g,'_')}_sesiones.csv`;
            a.click();
            showToast('✓ CSV exportado.');
        }

        // ============================================================
        // NOTIFICACIONES DE CITAS (Notification API)
        // ============================================================
        let _notifInterval = null;

        async function solicitarPermisosNotificacion() {
            if (!('Notification' in window)) return false;
            if (Notification.permission === 'granted') return true;
            if (Notification.permission !== 'denied') {
                const perm = await Notification.requestPermission();
                return perm === 'granted';
            }
            return false;
        }

        async function activarNotificacionesCitas() {
            const ok = await solicitarPermisosNotificacion();
            if (!ok) { showToast('❌ Permiso de notificaciones denegado.', true); return; }
            if (_notifInterval) clearInterval(_notifInterval);
            // Check on load and every 5 minutes
            _checkNotificacionesCitas();
            _notifInterval = setInterval(_checkNotificacionesCitas, 5 * 60 * 1000);
            showToast('✓ Notificaciones de citas activadas.');
            localStorage.setItem('jelian_notif', '1');
        }

        async function _checkNotificacionesCitas() {
            if (Notification.permission !== 'granted') return;
            const citas = await getCitas();
            const hoy = new Date().toISOString().split('T')[0];
            const ahora = new Date();
            const hhmm = `${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;
            citas.filter(c => c.fecha === hoy).forEach(c => {
                // Notify 15 min before appointment
                if (c.hora) {
                    const [h, m] = c.hora.split(':').map(Number);
                    const citaMin = h * 60 + m;
                    const ahoraMin = ahora.getHours() * 60 + ahora.getMinutes();
                    const diff = citaMin - ahoraMin;
                    if (diff > 0 && diff <= 15) {
                        const key = `jelian_notif_sent_${c.id}_${c.hora}`;
                        if (!sessionStorage.getItem(key)) {
                            new Notification('⏰ Cita en 15 minutos — Jelian FT', {
                                body: `${c.atleta} a las ${c.hora} (${c.tipo || 'Sesión'})`,
                                icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTQiIGZpbGw9IiM2MzY2ZjEiLz48dGV4dCB4PSI1MCUiIHk9IjU0JSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIEJsYWNrLHNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSI5MDAiIGZvbnQtc2l6ZT0iMjYiIGZpbGw9IndoaXRlIj5KRlQ8L3RleHQ+PC9zdmc+'
                            });
                            sessionStorage.setItem(key, '1');
                        }
                    }
                }
            });
        }

        // Auto-activate notifications if previously enabled
        (function() {
            if (localStorage.getItem('jelian_notif') === '1') {
                setTimeout(activarNotificacionesCitas, 2000);
            }
        })();

        // ============================================================
        // BEFOREUNLOAD — advertir si hay sesión sin guardar
        // ============================================================
        let _sesionPendiente = false;

        function marcarSesionPendiente() { _sesionPendiente = true; }
        function limpiarSesionPendiente() { _sesionPendiente = false; }

        window.addEventListener('beforeunload', function(e) {
            if (_sesionPendiente) {
                e.preventDefault();
                e.returnValue = '¿Salir sin guardar la sesión actual?';
                return e.returnValue;
            }
        });


        function setupApiKey() {
            const current = localStorage.getItem('jelian_anthropic_key') || '';
            const nueva = prompt('Pega tu Anthropic API Key (sk-ant-...):\nSe guarda solo en este navegador.', current);
            if (nueva === null) return;
            const trimmed = nueva.trim();
            if (trimmed === '') {
                localStorage.removeItem('jelian_anthropic_key');
                const lbl = document.getElementById('sidebar-apikey-label');
                if (lbl) lbl.textContent = 'API Key IA';
                showToast('API Key eliminada.');
            } else {
                localStorage.setItem('jelian_anthropic_key', trimmed);
                const lbl = document.getElementById('sidebar-apikey-label');
                if (lbl) lbl.textContent = '✓ API Key IA';
                showToast('✓ API Key guardada correctamente.');
            }
        }

        function cambiarNombre() {
            const actual = localStorage.getItem('jelian_username') || 'Jelian';
            const nuevo = prompt("¿Cómo te llamas?", actual);
            if (nuevo && nuevo.trim()) {
                localStorage.setItem('jelian_username', nuevo.trim());
                document.getElementById('greeting-name').innerText = nuevo.trim();
            }
        }

        // ============================================================
        // PIN SYSTEM

        async function setupPin() {
            const nuevo = prompt("Ingresa un PIN de 4 dígitos (deja vacío para eliminar):");
            if (nuevo === null) return;
            if (nuevo === '') {
                localStorage.removeItem(PIN_KEY);
                // Also clear legacy plain-text PIN if any
                localStorage.removeItem('jelian_pin');
                showToast("PIN eliminado.");
                return;
            }
            if (/^\d{4}$/.test(nuevo)) {
                const hashed = await _hashPin(nuevo);
                localStorage.setItem(PIN_KEY, hashed);
                showToast("✓ PIN guardado de forma segura.");
            } else {
                showToast("❌ El PIN debe ser exactamente 4 dígitos.", true);
            }
        }

        async function mostrarDiagnosticoSchema() {
            showToast('🔍 Consultando schema de Supabase...');
            // Intentar OpenAPI
            try {
                const resp = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (resp.ok) {
                    const spec = await resp.json();
                    const def = spec?.definitions?.pacientes?.properties;
                    if (def) {
                        const cols = Object.keys(def);
                        alert('✅ Columnas reales en tabla "pacientes":\n\n' + cols.join('\n') +
                              '\n\n(Copia esto y compártelo para corregir el código)');
                        return;
                    }
                }
            } catch(e) {}
            // Intentar fila
            try {
                const { data } = await sb.from('pacientes').select('*').limit(1);
                if (data && data.length > 0) {
                    const cols = Object.keys(data[0]);
                    alert('✅ Columnas detectadas de fila existente:\n\n' + cols.join('\n'));
                    return;
                }
            } catch(e) {}
            alert('⚠️ No se pudo detectar el schema.\nLa tabla puede estar vacía o sin permisos de lectura.\n\nColumnas actualmente asumidas:\n' + (_dbCols ? [..._dbCols].join('\n') : 'N/A'));
        }

        // ============================================================
        // DARK MODE
        // ============================================================
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('jelian_darkmode', isDark ? '1' : '0');
            document.getElementById('dark-icon').innerHTML = isDark
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M17.657 17.657l-.707-.707M6.343 6.343l-.707-.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
        }

        // ============================================================
        // STICKY NOTES
        // ============================================================
        function loadNotes() {
            const notes = localStorage.getItem('jelian_notes') || '';
            const el = document.getElementById('sticky-notes');
            if (el) el.value = notes;
        }
        function saveNotes() {
            localStorage.setItem('jelian_notes', document.getElementById('sticky-notes').value);
        }

        // ============================================================
        // STATUS
        // ============================================================
        const STATUS_LABELS = { activo: 'Activo', reposo: 'En Reposo', aguda: 'Lesión Aguda', alta: 'Alta Médica' };
        function statusHTML(status) {
            const s = status || 'activo';
            return `<span class="status-badge status-${s}">${STATUS_LABELS[s] || s}</span>`;
        }
        async function cambiarStatus(id) {
            const p = pacientes.find(x => String(x.id) === String(id));
            if (!p) return;
            const opts = Object.keys(STATUS_LABELS);
            const currentStatus = p.status || p.estado || 'activo';
            const idx = opts.indexOf(currentStatus);
            const newStatus = opts[(idx + 1) % opts.length];
            p.status = newStatus;
            p.estado = newStatus;
            await save();
            verDetalle(id);
        }

        // ============================================================
        // PHOTO UPLOAD
        // ============================================================
        function triggerPhotoUpload() {
            document.getElementById('photo-file-input').click();
        }
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const p = pacientes.find(x => String(x.id) === String(currentId));
                if (!p) return;
                p.foto = e.target.result;
                await save();
                renderAvatarDetalle(p);
            };
            reader.readAsDataURL(file);
        }
        function renderAvatarDetalle(p) {
            const el = document.getElementById('p-inicial');
            if (p.foto) {
                el.innerHTML = `<img src="${p.foto}" class="w-full h-full object-cover rounded-3xl" />`;
                el.classList.remove('bg-indigo-600');
            } else {
                el.innerHTML = p.nombre.charAt(0);
                el.classList.add('bg-indigo-600');
            }
        }

        // ============================================================
        // OBJECTIVES
        // ============================================================
        async function addObjetivo() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const texto = document.getElementById('obj-texto').value.trim();
            const evaObj = parseInt(document.getElementById('obj-eva').value, 10);
            const semanas = parseInt(document.getElementById('obj-semanas').value, 10);
            if (!texto || isNaN(evaObj) || isNaN(semanas)) { showToast("❌ Completa todos los campos del objetivo.", true); return; }
            if (!p.objetivos) p.objetivos = [];
            p.objetivos.push({ texto, evaObj, semanas, fechaCreacion: new Date().toISOString().split('T')[0], completado: false });
            await save();
            renderObjetivos();
            document.getElementById('obj-texto').value = '';
            document.getElementById('obj-eva').value = '';
            document.getElementById('obj-semanas').value = '';
            showToast("✓ Objetivo guardado.");
        }
        async function toggleObjetivo(idx) {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p || !p.objetivos) return;
            p.objetivos[idx].completado = !p.objetivos[idx].completado;
            await save();
            renderObjetivos();
        }
        function renderObjetivos() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            const cont = document.getElementById('objetivos-list');
            if (!cont) return;
            if (!p || !p.objetivos || p.objetivos.length === 0) {
                cont.innerHTML = '<p class="text-xs text-slate-400 italic">Sin objetivos definidos.</p>';
                return;
            }
            cont.innerHTML = p.objetivos.map((o, i) => {
                const evaActual = p.evoluciones.length > 0 ? p.evoluciones[0].eva : 10;
                const evaInicial = p.evoluciones.length > 0 ? p.evoluciones[p.evoluciones.length-1].eva : 10;
                const totalReduccion = Math.max(1, evaInicial - o.evaObj);
                const reduccionActual = Math.max(0, evaInicial - evaActual);
                const pct = Math.min(100, Math.round((reduccionActual / totalReduccion) * 100));
                return `
                <div class="p-4 rounded-2xl border ${o.completado ? 'border-emerald-200 bg-emerald-50' : 'border-slate-100 bg-white'} dark:border-slate-700">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-xs font-bold text-slate-700 ${o.completado ? 'line-through opacity-50' : ''}">${escHtml(o.texto)}</p>
                        <button onclick="toggleObjetivo(${i})" class="text-[10px] font-black px-2 py-1 rounded-lg ${o.completado ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}">
                            ${o.completado ? '✓ Logrado' : 'Marcar'}
                        </button>
                    </div>
                    <div class="flex gap-3 text-[10px] text-slate-400 mb-2">
                        <span>Meta EVA: <strong class="text-indigo-600">${o.evaObj}</strong></span>
                        <span>En: <strong>${o.semanas} semanas</strong></span>
                    </div>
                    <div class="obj-progress"><div class="obj-progress-bar" style="width:${pct}%"></div></div>
                    <p class="text-[10px] text-slate-400 mt-1">${pct}% completado</p>
                </div>`;
            }).join('');
        }

        // ============================================================
        // PREDICTION
        // ============================================================
        // Calcula racha de días consecutivos con registro EVA
        function calcularRacha(p) {
            const evo = p.evoluciones || [];
            const fechasSet = new Set(evo.map(e => e.fecha));
            let racha = 0;
            let d = new Date();
            while (true) {
                const f = d.toISOString().split('T')[0];
                if (fechasSet.has(f)) { racha++; d.setDate(d.getDate() - 1); }
                else break;
            }
            return racha;
        }

        function calcularPrediccion(p) {
            if (!p.evoluciones || p.evoluciones.length < 2) return null;
            const evos = [...p.evoluciones].reverse();
            const n = evos.length;
            const evaValues = evos.map(e => parseInt(e.eva, 10));
            const promCambio = (evaValues[n-1] - evaValues[0]) / n;
            if (promCambio >= 0) return null;
            const semanasRestantes = Math.ceil(evaValues[n-1] / Math.abs(promCambio));
            if (!isFinite(semanasRestantes) || semanasRestantes > 100) return null;
            return semanasRestantes;
        }

        // ============================================================
        // EXPORT PDF (print-based)
        // ============================================================
        function exportarPDF() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const printWin = window.open('', '_blank');
            if (!printWin) { showToast('❌ Habilita las ventanas emergentes para imprimir.', true); return; }
            const evosHTML = p.evoluciones.map(s => `
                <tr>
                    <td style="padding:8px;border-bottom:1px solid #f1f5f9">${s.fecha}</td>
                    <td style="padding:8px;border-bottom:1px solid #f1f5f9;color:${s.eva>6?'#dc2626':'#16a34a'};font-weight:800">${s.eva}/10</td>
                    <td style="padding:8px;border-bottom:1px solid #f1f5f9">${s.fuerza || '--'}</td>
                    <td style="padding:8px;border-bottom:1px solid #f1f5f9;font-style:italic">${s.notas || ''}</td>
                </tr>`).join('');
            printWin.document.write(`
                <!DOCTYPE html><html><head><meta charset="UTF-8">
                <title>Informe - ${p.nombre}</title>
                <style>
                    body{font-family:'Segoe UI',sans-serif;color:#0f172a;margin:0;padding:40px}
                    h1{font-size:28px;font-weight:900;letter-spacing:-1px;margin:0}
                    h2{font-size:14px;color:#6366f1;text-transform:uppercase;letter-spacing:3px;margin:0 0 4px}
                    .header{display:flex;justify-content:space-between;align-items:flex-end;padding-bottom:24px;border-bottom:3px solid #6366f1;margin-bottom:32px}
                    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:32px}
                    .card{background:#f8fafc;padding:16px;border-radius:12px}
                    .label{font-size:9px;font-weight:900;color:#94a3b8;text-transform:uppercase;letter-spacing:2px}
                    .value{font-size:16px;font-weight:800;color:#0f172a;margin-top:4px}
                    table{width:100%;border-collapse:collapse}
                    th{text-align:left;padding:10px 8px;font-size:10px;font-weight:900;color:#94a3b8;text-transform:uppercase;letter-spacing:2px;border-bottom:2px solid #e2e8f0}
                    .diag{background:#f8fafc;padding:20px;border-radius:12px;font-size:13px;line-height:1.7;white-space:pre-line}
                    .footer{margin-top:40px;padding-top:16px;border-top:1px solid #e2e8f0;font-size:10px;color:#94a3b8;display:flex;justify-content:space-between}
                </style></head><body>
                <div class="header">
                    <div>
                        <h2>Informe Clínico</h2>
                        <h1>${p.nombre}</h1>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:11px;color:#6366f1;font-weight:800">JELIAN FT · Clinical Sport</div>
                        <div style="font-size:11px;color:#94a3b8">${new Date().toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div>
                    </div>
                </div>
                <div class="grid">
                    <div class="card"><div class="label">Deporte</div><div class="value">${p.deporte}</div></div>
                    <div class="card"><div class="label">Edad</div><div class="value">${p.edad} años</div></div>
                    <div class="card"><div class="label">Sexo</div><div class="value">${p.sexo}</div></div>
                    <div class="card"><div class="label">Cédula</div><div class="value">${p.ci}</div></div>
                    <div class="card"><div class="label">Total Sesiones</div><div class="value">${p.evoluciones.length}</div></div>
                    <div class="card"><div class="label">Último EVA</div><div class="value" style="color:${(p.evoluciones[0]?.eva||0)>6?'#dc2626':'#16a34a'}">${p.evoluciones[0]?.eva ?? 'N/A'}/10</div></div>
                </div>
                <h2 style="margin-bottom:12px">Plan Clínico y Diagnóstico</h2>
                <div class="diag">${p.diag || 'Sin diagnóstico registrado.'}</div>
                <h2 style="margin:28px 0 12px">Historial de Sesiones</h2>
                <table>
                    <thead><tr><th>Fecha</th><th>EVA</th><th>Métrica</th><th>Notas</th></tr></thead>
                    <tbody>${evosHTML}</tbody>
                </table>
                <div class="footer">
                    <span>Jelian FT - Clinical Sport v136</span>
                    <span>Generado el ${new Date().toLocaleDateString('es-ES')}</span>
                </div>
                </body></html>`);
            printWin.document.close();
            printWin.print();
        }

        // ============================================================
        // SESSION COUNT PER ATHLETE
        // ============================================================
        function sesionesEsteMes(p) {
            const ahora = new Date();
            return (p.evoluciones || []).filter(s => {
                if (!s.fecha) return false;
                const partes = s.fecha.split('-');
                return partes.length === 3 && parseInt(partes[0], 10) === ahora.getFullYear() && parseInt(partes[1], 10)-1 === ahora.getMonth();
            }).length;
        }

        // ============================================================
        // COMPARATIVA DASHBOARD — filtra sesiones de esta semana
        // ============================================================
        function renderComparativa() {
            const cont = document.getElementById('comparativa-list');
            if (!cont) return;
            
            // Calcular inicio de semana actual (lunes)
            const hoy = new Date();
            const diaSemana = hoy.getDay() === 0 ? 6 : hoy.getDay() - 1;
            const lunesStr = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() - diaSemana).toISOString().split('T')[0];
            
            // Atletas con sesiones esta semana, ordenados por EVA más alto (más críticos primero)
            const conSesiones = pacientes
                .map(p => {
                    const sesionesSemana = (p.evoluciones || []).filter(s => s.fecha >= lunesStr);
                    const evaActual = p.evoluciones[0]?.eva ?? null;
                    return { p, sesionesSemana: sesionesSemana.length, evaActual };
                })
                .filter(x => x.sesionesSemana > 0 || x.evaActual !== null)
                .sort((a, b) => (b.evaActual || 0) - (a.evaActual || 0))
                .slice(0, 5);

            if (conSesiones.length === 0) {
                cont.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">Sin sesiones esta semana.</p>';
                return;
            }
            cont.innerHTML = conSesiones.map(({ p, sesionesSemana, evaActual }) => {
                const eva = evaActual ?? 0;
                const pct = (eva / 10) * 100;
                return `
                <div class="flex items-center gap-3 cursor-pointer hover:opacity-80" onclick="verDetalle('${p.id}')">
                    <div class="w-8 h-8 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center font-black text-xs flex-shrink-0 overflow-hidden">
                        ${p.foto ? `<img src="${p.foto}" class="w-full h-full object-cover" alt="${p.nombre}">` : p.nombre.charAt(0)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700 truncate">${p.nombre}</span>
                            <span class="text-xs font-black ${eva>6?'text-rose-500':'text-emerald-500'} ml-2">${eva ?? '—'}</span>
                        </div>
                        <div class="h-1.5 rounded-full bg-slate-100 overflow-hidden">
                            <div class="h-full rounded-full ${eva>6?'bg-rose-400':eva>3?'bg-amber-400':'bg-emerald-400'}" style="width:${pct}%"></div>
                        </div>
                        <p class="text-[9px] text-slate-400 mt-0.5">${sesionesSemana} sesión${sesionesSemana!==1?'es':''} esta semana</p>
                    </div>
                </div>`;
            }).join('');
        }

        // ============================================================
        // CHRONO
        // ============================================================
        let chronoInterval = null, chronoSeconds = 0, chronoRunning = false;
        function chronoToggle() {
            if (chronoRunning) {
                clearInterval(chronoInterval); chronoRunning = false;
                document.getElementById('chrono-btn').textContent = '▶ Continuar';
            } else {
                chronoRunning = true;
                document.getElementById('chrono-btn').textContent = '⏸ Pausar';
                chronoInterval = setInterval(() => {
                    chronoSeconds++;
                    const h = String(Math.floor(chronoSeconds/3600)).padStart(2,'0');
                    const m = String(Math.floor((chronoSeconds%3600)/60)).padStart(2,'0');
                    const s = String(chronoSeconds%60).padStart(2,'0');
                    document.getElementById('chrono-display').textContent = `${h}:${m}:${s}`;
                }, 1000);
            }
        }
        function chronoReset() {
            clearInterval(chronoInterval); chronoRunning = false; chronoSeconds = 0;
            document.getElementById('chrono-display').textContent = '00:00:00';
            document.getElementById('chrono-btn').textContent = '▶ Iniciar';
        }

        // ============================================================
        // AGENDA / CALENDARIO
        // ============================================================
        let calFecha = new Date();
        let calDiaSeleccionado = null;
        const CITAS_KEY = 'jelian_citas';

        async function getCitas() {
            try {
                const { data, error } = await sb.from('citas').select('*, pacientes(nombre)').order('fecha').order('hora');
                if (error) {
                    const msg = _sbErrMsg(error);
                    if (error.code === '42P01' || msg.includes('does not exist')) {
                        console.warn('[JelianFT] Tabla "citas" no existe en Supabase. Agenda desactivada.');
                    } else {
                        console.error('[JelianFT] Error citas:', msg);
                    }
                    return [];
                }
                return (data || []).map(c => ({
                    id: c.id,
                    atleta: c.pacientes?.nombre || c.paciente_nombre || '',
                    paciente_id: c.paciente_id,
                    fecha: c.fecha,
                    hora: c.hora,
                    tipo: c.tipo || '',
                    estado: c.estado || 'pendiente'
                }));
            } catch(e) {
                console.warn('[JelianFT] Excepción en getCitas:', e.message);
                return [];
            }
        }
        async function saveCitas(c) { /* no usado - ahora se guarda por cita */ }

        async function renderCalendario() {
            const año = calFecha.getFullYear(), mes = calFecha.getMonth();
            const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('cal-mes-titulo').textContent = `${meses[mes]} ${año}`;
            
            // Render day headers
            const diasSemana = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
            document.getElementById('cal-dias-semana').innerHTML = diasSemana.map(d =>
                `<div class="text-center text-[10px] font-black text-slate-400 uppercase py-2">${d}</div>`
            ).join('');

            const primerDia = new Date(año, mes, 1).getDay();
            const offset = primerDia === 0 ? 6 : primerDia - 1;
            const diasMes = new Date(año, mes+1, 0).getDate();
            const citas = await getCitas();
            const hoy = new Date();
            let html = '';
            for (let i = 0; i < offset; i++) html += '<div></div>';
            for (let d = 1; d <= diasMes; d++) {
                const fechaStr = `${año}-${String(mes+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const citasHoy = citas.filter(c => c.fecha === fechaStr);
                const isHoy = hoy.getDate()===d && hoy.getMonth()===mes && hoy.getFullYear()===año;
                html += `<div class="cal-day ${isHoy?'today':''} ${citasHoy.length?'has-events':''}" onclick="selDia('${fechaStr}')">
                    <span class="text-xs font-bold ${isHoy?'text-indigo-600':'text-slate-600'}">${d}</span>
                    ${citasHoy.slice(0,2).map(c=>`<span class="cal-event-pill">${escHtml(c.hora)} ${escHtml(c.atleta)}</span>`).join('')}
                    ${citasHoy.length>2?`<span class="text-[9px] text-indigo-400 font-bold">+${citasHoy.length-2} más</span>`:''}
                </div>`;
            }
            document.getElementById('cal-grid').innerHTML = html;
        }

        async function selDia(fechaStr) {
            calDiaSeleccionado = fechaStr;
            const citas = (await getCitas()).filter(c => c.fecha === fechaStr);
            const [año,mes,dia] = fechaStr.split('-');
            const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('cal-dia-titulo').textContent = `${dia} de ${meses[parseInt(mes, 10)-1]} de ${año}`;
            const cont = document.getElementById('cal-citas-dia');
            if (citas.length === 0) { cont.innerHTML = '<p class="text-xs text-slate-400 italic">Sin citas para este día.</p>'; return; }
            cont.innerHTML = citas.map((c,i) => `
                <div class="flex items-center justify-between p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center font-black text-sm">${c.hora}</div>
                        <div>
                            <p class="font-bold text-slate-800 text-sm">${c.atleta}</p>
                            <p class="text-[10px] text-slate-400">${c.tipo}</p>
                        </div>
                    </div>
                    <button onclick="eliminarCita('${c.id}')" class="text-rose-400 hover:text-rose-600 text-xs font-black">✕</button>
                </div>`).join('');
        }

        function cambiarMes(delta) { calFecha = new Date(calFecha.getFullYear(), calFecha.getMonth()+delta, 1); renderCalendario(); }

        function abrirFormCita() {
            const cont = document.getElementById('form-cita-container');
            cont.classList.remove('hidden');
            const sel = document.getElementById('cita-atleta');
            sel.innerHTML = pacientes.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
            document.getElementById('cita-fecha').value = calDiaSeleccionado || new Date().toISOString().split('T')[0];
            document.getElementById('cita-hora').value = '';
            cont.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function guardarCita() {
            const pacienteId = document.getElementById('cita-atleta').value;
            const fecha = document.getElementById('cita-fecha').value;
            const hora = document.getElementById('cita-hora').value;
            const tipo = document.getElementById('cita-tipo').value;
            if (!pacienteId || !fecha || !hora) { showToast('❌ Completa todos los campos.', true); return; }
            try {
                const { error } = await sb.from('citas').insert({ paciente_id: pacienteId, fecha, hora, tipo, estado: 'pendiente' });
                if (error) { showToast('Error guardando cita: ' + _sbErrMsg(error), true); return; }
            } catch(e) {
                showToast('Error de red al guardar cita: ' + e.message, true); return;
            }
            // Limpiar y cerrar formulario
            document.getElementById('cita-hora').value = '';
            document.getElementById('form-cita-container').classList.add('hidden');
            renderCalendario();
            selDia(fecha);
            renderCitasHoyDashboard();
            showToast('✓ Cita guardada.');
        }

        async function eliminarCita(citaId) {
            // FIX: elimina por ID directo — antes usaba índice posicional frágil que fallaba si se reordenaban las citas
            if (!citaId) return;
            try {
                const { error } = await sb.from('citas').delete().eq('id', citaId);
                if (error) { showToast('Error eliminando cita: ' + _sbErrMsg(error), true); return; }
            } catch(e) {
                showToast('Error de red al eliminar cita: ' + e.message, true); return;
            }
            await renderCalendario();
            if (calDiaSeleccionado) selDia(calDiaSeleccionado);
            showToast('✓ Cita eliminada.');
        }

        // ============================================================
        // PLANTILLAS
        // ============================================================
        const PLANTILLAS_KEY = 'jelian_plantillas';
        function getPlantillas() { try { return JSON.parse(localStorage.getItem(PLANTILLAS_KEY)) || []; } catch { return []; } }
        function savePlantillas(p) { localStorage.setItem(PLANTILLAS_KEY, JSON.stringify(p)); }

        function abrirFormPlantilla() {
            document.getElementById('form-plantilla-container').classList.toggle('hidden');
        }

        function guardarPlantilla() {
            const nombre = document.getElementById('pl-nombre').value.trim();
            const zona = document.getElementById('pl-zona').value.trim();
            const ejercicios = document.getElementById('pl-ejercicios').value.trim();
            if (!nombre || !ejercicios) { showToast('❌ Nombre y ejercicios son obligatorios.', true); return; }
            const pl = getPlantillas();
            pl.push({ nombre, zona, ejercicios, fecha: new Date().toISOString().split('T')[0] });
            savePlantillas(pl);
            ['pl-nombre','pl-zona','pl-ejercicios'].forEach(id=>document.getElementById(id).value='');
            document.getElementById('form-plantilla-container').classList.add('hidden');
            renderPlantillas();
            showToast('✓ Plantilla guardada.');
        }

        function renderPlantillas() {
            const pl = getPlantillas();
            const cont = document.getElementById('plantillas-grid');
            if (!cont) return;
            if (pl.length === 0) {
                cont.innerHTML = '<div class="col-span-3 text-center py-16 text-slate-400"><p class="font-black text-sm uppercase tracking-widest">Sin plantillas guardadas</p><p class="text-xs mt-2">Crea tu primera plantilla de sesión reutilizable</p></div>';
                return;
            }
            cont.innerHTML = pl.map((p,i) => `
                <div class="template-card">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-[9px] font-black text-indigo-500 bg-indigo-50 px-2 py-1 rounded-full uppercase">${p.zona||'General'}</span>
                            <h4 class="font-extrabold text-slate-800 text-sm mt-2">${p.nombre}</h4>
                            <p class="text-[10px] text-slate-400 mt-1">${p.fecha}</p>
                        </div>
                        <button onclick="eliminarPlantilla(${i})" class="text-slate-300 hover:text-rose-400 text-lg transition-colors">✕</button>
                    </div>
                    <pre class="text-xs text-slate-500 whitespace-pre-wrap font-sans leading-relaxed border-t border-slate-100 pt-3 mt-3">${p.ejercicios.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>
                    <button onclick="usarPlantilla(${i})" class="mt-4 w-full bg-indigo-50 text-indigo-600 py-2 rounded-xl text-xs font-black hover:bg-indigo-100 transition-colors">Usar en sesión actual</button>
                </div>`).join('');
        }

        function eliminarPlantilla(i) {
            const pl = getPlantillas();
            pl.splice(i, 1);
            savePlantillas(pl);
            renderPlantillas();
            showToast('✓ Plantilla eliminada.');
        }

        function usarPlantilla(i) {
            const pl = getPlantillas()[i];
            if (!currentId) { showToast('❌ Abre un expediente primero.', true); return; }
            document.getElementById('s-notas').value = pl.ejercicios;
            showSection('detalle-paciente');
            showToast(`✓ Plantilla "${pl.nombre}" cargada en la sesión.`);
        }

        // ============================================================
        // REPORTES
        // ============================================================
        let chartsReportes = {};

        function renderReportes() {
            renderReporteTabla();
            renderChartEvaGlobal();
            renderChartRpeEva();
            renderChartTendenciaZona();
        }

        function renderReporteTabla() {
            const cont = document.getElementById('reporte-mensual-tabla');
            if (!cont) return;
            const ahora = new Date();
            const rows = pacientes.map(p => {
                const sesMes = sesionesEsteMes(p);
                const evaActual = p.evoluciones[0]?.eva ?? '—';
                const evaInicial = p.evoluciones.length > 0 ? p.evoluciones[p.evoluciones.length-1].eva : '—';
                const tendencia = (typeof evaActual==='number' && typeof evaInicial==='number') ? (evaActual < evaInicial ? '▼ Mejora' : evaActual > evaInicial ? '▲ Empeora' : '→ Estable') : '—';
                const color = tendencia.includes('Mejora') ? 'text-emerald-600' : tendencia.includes('Empeora') ? 'text-rose-500' : 'text-slate-500';
                return `<tr class="border-b border-slate-50 hover:bg-slate-50/50">
                    <td class="py-3 px-4 font-bold text-slate-800 text-sm">${p.nombre}</td>
                    <td class="py-3 px-4 text-xs text-slate-500">${p.deporte}</td>
                    <td class="py-3 px-4 text-xs font-bold">${sesMes}</td>
                    <td class="py-3 px-4 text-xs font-black ${(evaActual>6)?'text-rose-500':'text-emerald-600'}">${evaActual}/10</td>
                    <td class="py-3 px-4 text-xs font-black ${color}">${tendencia}</td>
                    <td class="py-3 px-4">${statusHTML(p.status || p.estado)}</td>
                </tr>`;
            }).join('');
            cont.innerHTML = `<table class="w-full">
                <thead><tr class="bg-slate-50">
                    <th class="py-3 px-4 text-left text-[10px] font-black text-slate-400 uppercase">Atleta</th>
                    <th class="py-3 px-4 text-left text-[10px] font-black text-slate-400 uppercase">Deporte</th>
                    <th class="py-3 px-4 text-left text-[10px] font-black text-slate-400 uppercase">Ses. Mes</th>
                    <th class="py-3 px-4 text-left text-[10px] font-black text-slate-400 uppercase">EVA Actual</th>
                    <th class="py-3 px-4 text-left text-[10px] font-black text-slate-400 uppercase">Tendencia</th>
                    <th class="py-3 px-4 text-left text-[10px] font-black text-slate-400 uppercase">Estado</th>
                </tr></thead><tbody>${rows||'<tr><td colspan="6" class="text-center py-8 text-slate-400 text-xs">Sin datos</td></tr>'}</tbody></table>`;
        }

        function renderChartEvaGlobal() {
            const canvas = document.getElementById('chartEvaGlobal');
            if (!canvas) return;
            if (chartsReportes.evaGlobal) chartsReportes.evaGlobal.destroy();
            const todas = [];
            pacientes.forEach(p => p.evoluciones.forEach(s => todas.push({fecha:s.fecha, eva:s.eva})));
            todas.sort((a,b)=>a.fecha.localeCompare(b.fecha));
            const ultimas = todas.slice(-12);
            if (ultimas.length === 0) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle = '#94a3b8'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText('Sin datos aún', canvas.width/2, canvas.height/2);
                return;
            }
            chartsReportes.evaGlobal = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { labels: ultimas.map(s=>s.fecha), datasets: [{ label:'EVA', data: ultimas.map(s=>s.eva), borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.1)', tension:0.4, fill:true, pointRadius:4 }] },
                options: { maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{min:0,max:10,grid:{color:'#f1f5f9'}},x:{grid:{display:false},ticks:{maxTicksLimit:6,font:{size:9}}}} }
            });
        }

        function renderChartRpeEva() {
            const canvas = document.getElementById('chartRpeEva');
            if (!canvas) return;
            if (chartsReportes.rpeEva) chartsReportes.rpeEva.destroy();
            const puntos = [];
            pacientes.forEach(p => p.evoluciones.forEach(s => { if (s.rpe) puntos.push({x:s.rpe, y:s.eva}); }));
            if (puntos.length === 0) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle = '#94a3b8'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText('Registra sesiones con RPE para ver la correlación', canvas.width/2, canvas.height/2);
                return;
            }
            chartsReportes.rpeEva = new Chart(canvas.getContext('2d'), {
                type: 'scatter',
                data: { datasets: [{ label:'RPE vs EVA', data: puntos, backgroundColor:'rgba(99,102,241,0.6)', pointRadius:6 }] },
                options: { maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{title:{display:true,text:'RPE',font:{size:10}},min:1,max:10},y:{title:{display:true,text:'EVA',font:{size:10}},min:0,max:10}} }
            });
        }

        function renderChartTendenciaZona() {
            const canvas = document.getElementById('chartTendenciaZona');
            if (!canvas) return;
            if (chartsReportes.zona) chartsReportes.zona.destroy();
            const zonas = {};
            pacientes.forEach(p => { if (p.zona) zonas[p.zona] = (zonas[p.zona]||0)+1; });
            if (Object.keys(zonas).length === 0) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle = '#94a3b8'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText('Sin datos de zonas lesionadas', canvas.width/2, canvas.height/2);
                return;
            }
            chartsReportes.zona = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: { labels: Object.keys(zonas), datasets: [{ data: Object.values(zonas), backgroundColor:['#6366f1','#8b5cf6','#a78bfa','#c4b5fd','#e0e7ff'], borderWidth:0 }] },
                options: { maintainAspectRatio:false, plugins:{legend:{position:'right',labels:{font:{size:11},padding:12}}} }
            });
        }

        function exportarReporteMensualPDF() {
            const filas = pacientes.map(p => {
                const sesMes = sesionesEsteMes(p);
                const evaActual = p.evoluciones[0]?.eva ?? '—';
                const evaInicial = p.evoluciones.length>0 ? p.evoluciones[p.evoluciones.length-1].eva : '—';
                const tendencia = (typeof evaActual==='number' && typeof evaInicial==='number') ? (evaActual<evaInicial?'▼ Mejora':evaActual>evaInicial?'▲ Empeora':'→ Estable') : '—';
                return `<tr><td>${p.nombre}</td><td>${p.deporte}</td><td>${sesMes}</td><td>${evaActual}/10</td><td>${tendencia}</td><td>${STATUS_LABELS[p.status || p.estado]||'Activo'}</td></tr>`;
            }).join('');
            const win = window.open('','_blank');
            if (!win) { showToast('❌ Habilita las ventanas emergentes para imprimir.', true); return; }
            const mes = new Date().toLocaleDateString('es-ES',{month:'long',year:'numeric'});
            win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Reporte ${mes}</title>
            <style>body{font-family:'Segoe UI',sans-serif;padding:40px;color:#0f172a}h1{font-size:24px;font-weight:900;margin:0}h2{color:#6366f1;font-size:11px;text-transform:uppercase;letter-spacing:3px;margin:0 0 8px}
            table{width:100%;border-collapse:collapse;margin-top:24px}th{background:#f8fafc;padding:10px;text-align:left;font-size:10px;font-weight:900;color:#94a3b8;text-transform:uppercase;letter-spacing:2px}
            td{padding:12px 10px;border-bottom:1px solid #f1f5f9;font-size:13px}.footer{margin-top:40px;font-size:10px;color:#94a3b8;border-top:1px solid #e2e8f0;padding-top:12px;display:flex;justify-content:space-between}</style></head>
            <body><h2>Reporte Mensual</h2><h1>${mes}</h1>
            <table><thead><tr><th>Atleta</th><th>Deporte</th><th>Ses. Mes</th><th>EVA</th><th>Tendencia</th><th>Estado</th></tr></thead><tbody>${filas}</tbody></table>
            <div class="footer"><span>Jelian FT Clinical Sport v136</span><span>${new Date().toLocaleDateString('es-ES')}</span></div></body></html>`);
            win.document.close(); win.print();
        }

        // ============================================================
        // BÚSQUEDA GLOBAL
        // ============================================================
        function openGlobalSearch() {
            document.getElementById('global-search-overlay').classList.add('active');
            setTimeout(() => document.getElementById('global-search-input').focus(), 100);
        }
        function closeGlobalSearch() {
            document.getElementById('global-search-overlay').classList.remove('active');
            document.getElementById('global-search-input').value = '';
            document.getElementById('global-search-results').innerHTML = '<p class="text-xs text-slate-400 text-center py-6">Empieza a escribir para buscar...</p>';
        }
        function runGlobalSearch(q) {
            const cont = document.getElementById('global-search-results');
            if (!q.trim()) { cont.innerHTML = '<p class="text-xs text-slate-400 text-center py-6">Empieza a escribir para buscar...</p>'; return; }
            const ql = q.toLowerCase();
            const resultados = [];
            pacientes.forEach(p => {
                if (p.nombre.toLowerCase().includes(ql) || p.ci.includes(ql) || p.deporte.toLowerCase().includes(ql))
                    resultados.push({ tipo:'Atleta', texto:p.nombre, sub:`${p.deporte} · ID: ${p.ci}`, id:p.id, icon:'👤' });
                if (p.diag && p.diag.toLowerCase().includes(ql))
                    resultados.push({ tipo:'Diagnóstico', texto:p.nombre, sub:p.diag.substring(0,60)+'...', id:p.id, icon:'📋' });
                p.evoluciones.forEach(s => {
                    if (s.notas && s.notas.toLowerCase().includes(ql))
                        resultados.push({ tipo:'Sesión', texto:p.nombre, sub:`${s.fecha}: ${s.notas.substring(0,50)}...`, id:p.id, icon:'📝' });
                });
            });
            if (resultados.length === 0) { cont.innerHTML = '<p class="text-xs text-slate-400 text-center py-6">Sin resultados para "'+q+'"</p>'; return; }
            cont.innerHTML = resultados.slice(0,8).map(r => `
                <div class="search-result-item" onclick="closeGlobalSearch();verDetalle('${r.id}')">
                    <div class="flex items-start gap-3">
                        <span class="text-xl flex-shrink-0">${r.icon}</span>
                        <div>
                            <span class="text-[9px] font-black text-indigo-500 uppercase">${r.tipo}</span>
                            <p class="font-bold text-slate-800 text-sm">${r.texto}</p>
                            <p class="text-xs text-slate-400">${r.sub}</p>
                        </div>
                    </div>
                </div>`).join('');
        }

        // ============================================================
        // MODO KIOSK
        // ============================================================
        function openKiosk() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const eva = p.evoluciones[0]?.eva ?? 0;
            const color = eva > 6 ? '#ef4444' : eva > 3 ? '#f59e0b' : '#10b981';
            document.getElementById('kiosk-nombre').textContent = p.nombre;
            document.getElementById('kiosk-eva-num').textContent = eva;
            document.getElementById('kiosk-sesiones').textContent = p.evoluciones.length;
            document.getElementById('kiosk-deporte').textContent = p.deporte;
            document.getElementById('kiosk-status').textContent = STATUS_LABELS[p.status || p.estado] || 'Activo';
            document.getElementById('kiosk-eva-ring').style.borderColor = color;
            document.getElementById('kiosk-overlay').classList.add('active');
        }
        function closeKiosk() { document.getElementById('kiosk-overlay').classList.remove('active'); }


        // ============================================================
        // EXPORTAR A CSV
        // ============================================================
        function exportarExcel() {
            const headers = ['Nombre','Cédula','Edad','Sexo','Deporte','Zona','Estado','Sesiones Totales','Sesiones Mes','EVA Actual','EVA Inicial','Último Contacto (días)','RTS % completado'];
            const rows = pacientes.map(p => {
                const dias = diasDesdeUltimaSesion(p);
                const rtsPct = p.rts ? Math.round((p.rts.filter(c=>c.cumplido).length / p.rts.length) * 100) : '—';
                return [
                    p.nombre, p.ci, p.edad, p.sexo, p.deporte, p.zona||'—', STATUS_LABELS[p.status || p.estado]||'Activo',
                    p.evoluciones.length, sesionesEsteMes(p),
                    p.evoluciones[0]?.eva ?? '—',
                    p.evoluciones.length>0 ? p.evoluciones[p.evoluciones.length-1].eva : '—',
                    dias !== null ? dias : '—',
                    rtsPct
                ];
            });
            const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `JelianFT_Atletas_${new Date().toISOString().split('T')[0]}.csv`; a.click();
            showToast('✓ CSV exportado correctamente.');
        }

        // ============================================================
        // KEYBOARD SHORTCUTS
        // ============================================================
        document.addEventListener('keydown', e => {
            const tag = document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
            const appVisible = !document.getElementById('app-content').classList.contains('hidden');
            if (!appVisible) return;
            if (e.key === 'Escape') {
                closeGlobalSearch(); closeKiosk(); closeEditModal();
                const mo = document.getElementById('modal-overlay');
                if (!mo.classList.contains('hidden')) cerrarModal();
            }
            if (e.key === 'f' || e.key === 'F') openGlobalSearch();
            if (e.key === 'd' || e.key === 'D') showSection('dashboard');
            if (e.key === 'e' || e.key === 'E') showSection('lista-pacientes');
            if (e.key === 'p' || e.key === 'P') showSection('biblioteca');
            if (e.key === 'a' || e.key === 'A') showSection('calendario');
            if (e.key === 'n' && currentId) { document.getElementById('s-notas')?.focus(); }
        });

        // ============================================================
        // SHOWSECTION UPDATE con nuevas secciones
        // ============================================================
        function showSection(id) {
            if(window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.remove('sidebar-open');
                document.getElementById('overlay').classList.add('hidden');
                const icon = document.getElementById('menu-icon');
                if (icon) icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>';
            }
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            const sec = document.getElementById(id);
            if (sec) sec.classList.remove('hidden');
            // Scroll to top smoothly
            const mainEl = document.querySelector('main');
            if (mainEl) mainEl.scrollTo({ top: 0, behavior: 'smooth' });
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const sectionNavMap = {
                'dashboard': 0, 'calendario': 1, 'lista-pacientes': 2,
                'biblioteca': 3, 'plantillas': 4, 'reportes': 5, 'imagen-ia': 6, 'anatomia': 7, 'documentos': 8
            };
            const navBtns = document.querySelectorAll('nav .nav-btn');
            if (sectionNavMap[id] !== undefined && navBtns[sectionNavMap[id]]) {
                navBtns[sectionNavMap[id]].classList.add('active');
            }
            if(id === 'dashboard') { updateDashboard(); }
            if(id === 'biblioteca') renderBiblioteca();
            if(id === 'lista-pacientes') renderLista();
            if(id === 'calendario') { renderCalendario(); selDia(new Date().toISOString().split('T')[0]); if(calView==='semana') renderSemana(); }
            if(id === 'plantillas') renderPlantillas();
            if(id === 'reportes') setTimeout(renderReportes, 100);
            if(id === 'imagen-ia') setTimeout(() => { initImgTipoChips(); renderHistorialImg(); }, 50);
            if(id === 'anatomia') setTimeout(() => renderAnatomia('rodilla'), 50);
            if(id === 'documentos') { _poblarSelectPacientes('cons-paciente-sel'); _poblarSelectPacientes('ficha-paciente-sel'); llenarConsentimiento(); }
        }

        // ============================================================
        // FORMAT DURATION
        // ============================================================
        function formatDuracion(secs) {
            const h = Math.floor(secs/3600);
            const m = Math.floor((secs%3600)/60);
            const s = secs%60;
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        // ============================================================
        // EDIT PATIENT MODAL
        // ============================================================
        function openEditModal() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            document.getElementById('edit-nombre').value = p.nombre || '';
            document.getElementById('edit-ci').value = p.ci || '';
            document.getElementById('edit-edad').value = p.edad || '';
            document.getElementById('edit-deporte').value = p.deporte || '';
            document.getElementById('edit-sexo').value = p.sexo || 'Masculino';
            document.getElementById('edit-telefono').value = p.telefono || '';
            document.getElementById('edit-emergencia').value = p.emergencia || '';
            document.getElementById('edit-zona').value = p.zona || 'Rodilla';
            document.getElementById('edit-diag').value = p.diag || '';
            document.getElementById('edit-modal-overlay').classList.add('active');
        }
        function closeEditModal() {
            document.getElementById('edit-modal-overlay').classList.remove('active');
        }
        async function guardarEdicion() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const nombre = document.getElementById('edit-nombre').value.trim();
            if (!nombre) { showToast('❌ El nombre no puede estar vacío.', true); return; }
            p.nombre = nombre;
            p.ci = document.getElementById('edit-ci').value.trim();
            p.edad = document.getElementById('edit-edad').value;
            p.deporte = document.getElementById('edit-deporte').value.trim();
            p.sexo = document.getElementById('edit-sexo').value;
            p.telefono = document.getElementById('edit-telefono').value.trim();
            p.emergencia = document.getElementById('edit-emergencia').value.trim();
            p.zona = document.getElementById('edit-zona').value;
            p.diag = document.getElementById('edit-diag').value.trim();
            await save();
            closeEditModal();
            verDetalle(currentId);
            showToast('✓ Expediente actualizado correctamente.');
        }

        // ============================================================
        // RTS — RETURN TO SPORT
        // ============================================================
        const RTS_DEFAULT_CRITERIOS = [
            { texto: "EVA ≤ 1 en reposo y actividad", tipo: "eva" },
            { texto: "Fuerza ≥ 90% vs lado sano (dinamometría)", tipo: "manual" },
            { texto: "Test de salto unipodal ≥ 90%", tipo: "manual" },
            { texto: "Sin edema ni derrame articular", tipo: "manual" },
            { texto: "ROM completo sin dolor", tipo: "manual" },
            { texto: "Control neuromuscular en gestos específicos", tipo: "manual" }
        ];

        function renderRTS() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            if (!p.rts) p.rts = RTS_DEFAULT_CRITERIOS.map(c => ({ ...c, cumplido: false }));
            const cont = document.getElementById('rts-criterios');
            const semaforo = document.getElementById('rts-semaforo');
            if (!cont || !semaforo) return;
            const total = p.rts.length;
            const cumplidos = p.rts.filter(c => c.cumplido).length;
            const pct = total > 0 ? Math.round((cumplidos / total) * 100) : 0;
            if (pct === 100) {
                semaforo.className = 'text-xs font-black px-4 py-2 rounded-xl bg-emerald-100 text-emerald-700';
                const fechaStr = p.rts_aprobado_fecha
                    ? ` · ${new Date(p.rts_aprobado_fecha + 'T00:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}`
                    : '';
                semaforo.innerHTML = `🏆 APTO para vuelta al deporte${fechaStr} — <span style="font-weight:900">¡Notificado al paciente!</span>`;
            } else if (pct >= 60) {
                semaforo.className = 'text-xs font-black px-4 py-2 rounded-xl bg-amber-100 text-amber-700';
                semaforo.textContent = `⚠️ En progreso — ${cumplidos}/${total} criterios (${pct}%)`;
            } else {
                semaforo.className = 'text-xs font-black px-4 py-2 rounded-xl bg-rose-100 text-rose-700';
                semaforo.textContent = `🔴 No apto — ${cumplidos}/${total} criterios (${pct}%)`;
            }
            cont.innerHTML = p.rts.map((c, i) => `
                <div class="rts-item ${c.cumplido ? 'bg-emerald-50' : 'bg-white'}">
                    <div class="rts-dot ${c.cumplido ? 'verde' : 'rojo'}"></div>
                    <span class="flex-1 text-xs font-bold text-slate-700 ${c.cumplido ? 'line-through opacity-50' : ''}">${escHtml(c.texto)}</span>
                    <div class="flex gap-2">
                        <button onclick="toggleRTS(${i})" class="text-[10px] font-black px-3 py-1 rounded-lg ${c.cumplido ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'} hover:opacity-80">
                            ${c.cumplido ? '✓ Cumplido' : 'Marcar'}
                        </button>
                        <button onclick="eliminarCriterioRTS(${i})" class="text-[10px] text-slate-300 hover:text-rose-400">✕</button>
                    </div>
                </div>
            `).join('');
        }
        async function toggleRTS(idx) {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p || !p.rts) return;
            p.rts[idx].cumplido = !p.rts[idx].cumplido;

            // ── Verificar si acaba de llegar al 100% ──
            const total    = p.rts.length;
            const cumplidos = p.rts.filter(c => c.cumplido).length;
            const era100   = p.rts_aprobado === true;
            const ahora100 = total > 0 && cumplidos === total;

            if (ahora100 && !era100) {
                // Primera vez que completa todos los criterios
                p.rts_aprobado      = true;
                p.rts_aprobado_fecha = new Date().toISOString().split('T')[0];
                // Guardar directamente en Supabase para que el paciente lo vea
                try {
                    await sb.from('pacientes').update({
                        rts:              p.rts,
                        rts_aprobado:     true,
                        rts_aprobado_fecha: p.rts_aprobado_fecha
                    }).eq('id', p.id);
                    // Mensaje automático al paciente por el chat
                    await sb.from('mensajes').insert({
                        paciente_id:     p.id,
                        paciente_nombre: p.nombre,
                        texto: `🏆 ¡${p.nombre.split(' ')[0]}, has completado todos los criterios de vuelta al deporte! Tu fisio ha marcado que estás LISTO/A para volver a la actividad deportiva. ¡Enhorabuena por tu recuperación! 🎉`,
                        autor: 'fisio'
                    });
                    showToast('🏆 ¡Paciente aprobado para volver al deporte! Se le ha notificado.');
                } catch(e) {
                    console.error('[RTS] Error guardando aprobación:', e.message);
                }
            } else if (!ahora100 && era100) {
                // Desmarcó un criterio → quitar aprobación
                p.rts_aprobado = false;
                p.rts_aprobado_fecha = null;
                try {
                    await sb.from('pacientes').update({
                        rts: p.rts, rts_aprobado: false, rts_aprobado_fecha: null
                    }).eq('id', p.id);
                } catch(e) {}
            } else {
                await save();
            }
            renderRTS();
        }
        async function agregarCriterioRTS() {
            const texto = prompt("Escribe el nuevo criterio RTS:");
            if (!texto || !texto.trim()) return;
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            if (!p.rts) p.rts = [];
            p.rts.push({ texto: texto.trim(), tipo: 'manual', cumplido: false });
            await save();
            renderRTS();
            showToast('✓ Criterio RTS agregado.');
        }
        async function eliminarCriterioRTS(idx) {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p || !p.rts) return;
            p.rts.splice(idx, 1);
            await save();
            renderRTS();
        }

        // ============================================================
        // GALERÍA FOTOGRÁFICA CLÍNICA
        // ============================================================
        // ============================================================
        // SEGUIMIENTO FOTOGRÁFICO MEJORADO — antes/después + Supabase
        // ============================================================
        let _fotoTmpSrc = null;
        let _fotoFiltroActual = 'all';

        function abrirModalFoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                _fotoTmpSrc = e.target.result;
                const prev = document.getElementById('modal-foto-preview');
                const noimg = document.getElementById('modal-foto-noimg');
                prev.src = _fotoTmpSrc;
                prev.classList.remove('hidden');
                noimg.classList.add('hidden');
                document.getElementById('modal-agregar-foto').classList.remove('hidden');
                document.getElementById('modal-agregar-foto').classList.add('flex');
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function cerrarModalFoto() {
            document.getElementById('modal-agregar-foto').classList.add('hidden');
            document.getElementById('modal-agregar-foto').classList.remove('flex');
            _fotoTmpSrc = null;
            document.getElementById('modal-foto-preview').src = '';
            document.getElementById('modal-foto-preview').classList.add('hidden');
            document.getElementById('modal-foto-noimg').classList.remove('hidden');
            document.getElementById('modal-foto-zona').value = '';
            document.getElementById('modal-foto-notas').value = '';
        }

        async function guardarFotoModal() {
            if (!_fotoTmpSrc) return;
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const fase = document.getElementById('modal-foto-fase').value;
            const zona = document.getElementById('modal-foto-zona').value.trim();
            const notas = document.getElementById('modal-foto-notas').value.trim();
            if (!p.fotosClinicas) p.fotosClinicas = [];
            p.fotosClinicas.push({
                src: _fotoTmpSrc,
                fecha: new Date().toISOString().split('T')[0],
                fase,
                zona: zona || 'Sin especificar',
                notas
            });
            await save();
            cerrarModalFoto();
            renderFotosClinicas();
            showToast('✓ Foto clínica guardada en Supabase.');
        }

        // Compatibilidad con handler antiguo (el input viejo en el HTML)
        function agregarFotoClinica(event) { abrirModalFoto(event); }

        function filtrarFotos(fase) {
            _fotoFiltroActual = fase;
            document.querySelectorAll('.foto-filtro-btn').forEach(b => {
                b.classList.remove('bg-indigo-600', 'text-white');
                b.classList.add('bg-slate-100', 'text-slate-600');
            });
            event.target.classList.add('bg-indigo-600', 'text-white');
            event.target.classList.remove('bg-slate-100', 'text-slate-600');
            renderFotosClinicas();
        }

        function _faseBadge(fase) {
            const map = { inicial: ['📌', 'bg-amber-100 text-amber-700'], progreso: ['📈', 'bg-indigo-100 text-indigo-700'], alta: ['✅', 'bg-emerald-100 text-emerald-700'] };
            return map[fase] || ['📷', 'bg-slate-100 text-slate-600'];
        }

        function renderFotosClinicas() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            const grid = document.getElementById('fotos-clinicas-grid');
            const empty = document.getElementById('fotos-empty');
            if (!grid || !p) return;
            const fotos = (p.fotosClinicas || []).filter(f => _fotoFiltroActual === 'all' || f.fase === _fotoFiltroActual);
            if (!p.fotosClinicas || p.fotosClinicas.length === 0) {
                grid.innerHTML = '';
                if (empty) empty.classList.remove('hidden');
                return;
            }
            if (empty) empty.classList.add('hidden');
            if (fotos.length === 0) {
                grid.innerHTML = '<p class="text-xs text-slate-400 italic col-span-3">No hay fotos en esta fase.</p>';
                return;
            }
            grid.innerHTML = fotos.map((f, i) => {
                const realIdx = (p.fotosClinicas || []).indexOf(f);
                const [faseIcon, faseCls] = _faseBadge(f.fase);
                return `
                <div class="relative group rounded-2xl overflow-hidden bg-slate-50 border border-slate-100 hover:shadow-lg transition-all cursor-pointer" onclick="verFotoClinicaByIdx(${realIdx})">
                    <div class="aspect-square overflow-hidden">
                        <img src="${f.src}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" alt="Foto clínica">
                    </div>
                    <div class="p-3">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[9px] font-black px-2 py-0.5 rounded-full ${faseCls}">${faseIcon} ${f.fase||'sin fase'}</span>
                            <span class="text-[9px] text-slate-400 font-bold">${f.fecha}</span>
                        </div>
                        <p class="text-[10px] font-bold text-slate-700 truncate">${f.zona||''}</p>
                        ${f.notas ? `<p class="text-[9px] text-slate-400 truncate mt-0.5">${f.notas}</p>` : ''}
                    </div>
                    <button onclick="event.stopPropagation();eliminarFotoClinica(${realIdx})" class="absolute top-2 right-2 w-6 h-6 bg-rose-500 text-white text-xs rounded-full hidden group-hover:flex items-center justify-center font-black">✕</button>
                </div>`;
            }).join('');
        }

        async function eliminarFotoClinica(idx) {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p || !p.fotosClinicas) return;
            if (!confirm('¿Eliminar esta foto?')) return;
            p.fotosClinicas.splice(idx, 1);
            await save();
            renderFotosClinicas();
            showToast('Foto eliminada.');
        }

        function verFotoClinica(src) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:99999;display:flex;align-items:center;justify-content:center;cursor:pointer;';
            overlay.innerHTML = `<img src="${src}" style="max-width:90vw;max-height:90vh;border-radius:16px;">`;
            overlay.onclick = () => overlay.remove();
            document.body.appendChild(overlay);
        }

        function verFotoClinicaByIdx(idx) {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p || !p.fotosClinicas || !p.fotosClinicas[idx]) return;
            verFotoClinica(p.fotosClinicas[idx].src);
        }

        function abrirComparativaFotos() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p || !p.fotosClinicas || p.fotosClinicas.length === 0) {
                showToast('Sin fotos para comparar.', true); return;
            }
            const modal = document.getElementById('modal-comparativa');
            modal.classList.remove('hidden'); modal.classList.add('flex');
            const selAntes = document.getElementById('comp-sel-antes');
            const selDespues = document.getElementById('comp-sel-despues');
            const opts = p.fotosClinicas.map((f, i) => {
                const [icon] = _faseBadge(f.fase);
                return `<option value="${i}">${icon} ${f.fecha} — ${f.zona||f.fase||'foto'}</option>`;
            }).join('');
            selAntes.innerHTML = `<option value="">-- Seleccionar --</option>` + opts;
            selDespues.innerHTML = `<option value="">-- Seleccionar --</option>` + opts;
            // Auto-seleccionar inicial y más reciente
            const inicial = p.fotosClinicas.findIndex(f => f.fase === 'inicial');
            const alta = p.fotosClinicas.map((f,i)=>({...f,i})).filter(f=>f.fase==='alta'||f.fase==='progreso').pop();
            if (inicial >= 0) selAntes.value = inicial;
            if (alta) selDespues.value = alta.i;
            actualizarComparativa();
        }

        function cerrarComparativa() {
            const modal = document.getElementById('modal-comparativa');
            modal.classList.add('hidden'); modal.classList.remove('flex');
        }

        function actualizarComparativa() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const idxA = document.getElementById('comp-sel-antes').value;
            const idxD = document.getElementById('comp-sel-despues').value;
            const imgA = document.getElementById('comp-img-antes');
            const imgD = document.getElementById('comp-img-despues');
            const emA = document.getElementById('comp-empty-antes');
            const emD = document.getElementById('comp-empty-despues');
            const notaA = document.getElementById('comp-nota-antes');
            const notaD = document.getElementById('comp-nota-despues');
            if (idxA !== '' && p.fotosClinicas[idxA]) {
                imgA.src = p.fotosClinicas[idxA].src; imgA.classList.remove('hidden'); emA.classList.add('hidden');
                notaA.textContent = p.fotosClinicas[idxA].notas || '';
            } else { imgA.classList.add('hidden'); emA.classList.remove('hidden'); notaA.textContent = ''; }
            if (idxD !== '' && p.fotosClinicas[idxD]) {
                imgD.src = p.fotosClinicas[idxD].src; imgD.classList.remove('hidden'); emD.classList.add('hidden');
                notaD.textContent = p.fotosClinicas[idxD].notas || '';
            } else { imgD.classList.add('hidden'); emD.classList.remove('hidden'); notaD.textContent = ''; }
            // Calcular días entre fotos
            const evDiv = document.getElementById('comp-evolucion');
            if (idxA !== '' && idxD !== '' && p.fotosClinicas[idxA] && p.fotosClinicas[idxD]) {
                const d1 = new Date(p.fotosClinicas[idxA].fecha);
                const d2 = new Date(p.fotosClinicas[idxD].fecha);
                const dias = Math.abs(Math.round((d2-d1)/(1000*60*60*24)));
                document.getElementById('comp-dias').textContent = `${dias} día${dias!==1?'s':''} de evolución entre las fotos seleccionadas`;
                evDiv.classList.remove('hidden');
            } else { evDiv.classList.add('hidden'); }
        }

        // ============================================================
        // HOJA DE EJERCICIOS ESTRUCTURADA
        // ============================================================
        async function agregarEjercicioManual() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            if (!p.ejerciciosHoja) p.ejerciciosHoja = [];
            p.ejerciciosHoja.push({ nombre: 'Nuevo ejercicio', series: 3, reps: '10', carga: '', descanso: '60s', descripcion: '' });
            await save();
            renderHojaEjercicios();
        }
        function renderHojaEjercicios() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            const cont = document.getElementById('ejercicios-personalizados-container');
            if (!cont || !p) return;
            if (!p.ejerciciosHoja || p.ejerciciosHoja.length === 0) {
                cont.innerHTML = '<p class="text-xs text-slate-400 italic col-span-2">Usa el Motor IA para generar ejercicios o agrégalos manualmente:</p>';
                return;
            }
            cont.innerHTML = p.ejerciciosHoja.map((ej, i) => `
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-2">
                    <div class="flex justify-between items-start">
                        <input value="${escHtml(ej.nombre)}" onchange="updateEjercicio(${i},'nombre',this.value)" class="font-bold text-sm text-slate-800 bg-transparent outline-none w-full" placeholder="Nombre del ejercicio">
                        <button onclick="eliminarEjercicio(${i})" class="text-slate-300 hover:text-rose-400 text-lg leading-none ml-2">✕</button>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <div><label class="text-[8px] font-black text-slate-400 uppercase">Series</label><input type="number" value="${escHtml(ej.series)}" onchange="updateEjercicio(${i},'series',this.value)" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs font-bold outline-none"></div>
                        <div><label class="text-[8px] font-black text-slate-400 uppercase">Reps</label><input value="${escHtml(ej.reps)}" onchange="updateEjercicio(${i},'reps',this.value)" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs font-bold outline-none"></div>
                        <div><label class="text-[8px] font-black text-slate-400 uppercase">Carga</label><input value="${escHtml(ej.carga)}" onchange="updateEjercicio(${i},'carga',this.value)" placeholder="kg" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs font-bold outline-none"></div>
                        <div><label class="text-[8px] font-black text-slate-400 uppercase">Descanso</label><input value="${escHtml(ej.descanso)}" onchange="updateEjercicio(${i},'descanso',this.value)" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs font-bold outline-none"></div>
                    </div>
                    <input value="${escHtml(ej.descripcion)}" onchange="updateEjercicio(${i},'descripcion',this.value)" placeholder="Descripción / instrucciones..." class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none">
                </div>
            `).join('');
        }
        async function updateEjercicio(idx, campo, valor) {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p || !p.ejerciciosHoja) return;
            p.ejerciciosHoja[idx][campo] = campo === 'series' ? parseInt(valor, 10) : valor;
            await save();
        }
        async function eliminarEjercicio(idx) {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p || !p.ejerciciosHoja) return;
            p.ejerciciosHoja.splice(idx, 1);
            await save();
            renderHojaEjercicios();
        }
        function imprimirHojaEjercicios() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p) return;
            const ejercicios = p.ejerciciosHoja || [];
            const win = window.open('', '_blank');
            if (!win) { showToast('❌ Habilita las ventanas emergentes para imprimir.', true); return; }
            win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Hoja de Ejercicios - ${p.nombre}</title>
            <style>
                body{font-family:'Segoe UI',sans-serif;padding:40px;color:#0f172a;max-width:800px;margin:0 auto}
                h1{font-size:24px;font-weight:900;margin:0}h2{font-size:11px;color:#6366f1;text-transform:uppercase;letter-spacing:3px;margin:0 0 6px}
                .header{display:flex;justify-content:space-between;align-items:flex-end;padding-bottom:20px;border-bottom:3px solid #6366f1;margin-bottom:28px}
                .ej{background:#f8fafc;border-radius:12px;padding:16px 20px;margin-bottom:12px;border:1px solid #e2e8f0}
                .ej-name{font-weight:900;font-size:15px;margin-bottom:8px}
                .chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
                .chip{background:#e0e7ff;color:#4f46e5;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:800}
                .desc{font-size:12px;color:#64748b;font-style:italic}
                .footer{margin-top:40px;font-size:10px;color:#94a3b8;border-top:1px solid #e2e8f0;padding-top:12px;display:flex;justify-content:space-between}
                .notas-box{border:1px dashed #cbd5e1;border-radius:8px;height:60px;margin-top:8px;padding:8px;font-size:10px;color:#94a3b8}
            </style></head><body>
            <div class="header"><div><h2>Hoja de Ejercicios</h2><h1>${p.nombre}</h1></div>
            <div style="text-align:right;font-size:11px;color:#6366f1;font-weight:800">JELIAN FT · ${new Date().toLocaleDateString('es-ES')}</div></div>
            ${ejercicios.length > 0 ? ejercicios.map(ej => `
                <div class="ej">
                    <div class="ej-name">${ej.nombre}</div>
                    <div class="chips">
                        <span class="chip">${ej.series} series × ${ej.reps} reps</span>
                        ${ej.carga ? `<span class="chip">⚖️ ${ej.carga}</span>` : ''}
                        <span class="chip">⏸ ${ej.descanso} descanso</span>
                    </div>
                    ${ej.descripcion ? `<p class="desc">${ej.descripcion}</p>` : ''}
                    <div class="notas-box">Notas del paciente:</div>
                </div>
            `).join('') : '<p style="color:#94a3b8;font-style:italic">Sin ejercicios asignados.</p>'}
            <div class="footer"><span>Jelian FT Clinical Sport v136</span><span>${new Date().toLocaleDateString('es-ES')}</span></div>
            </body></html>`);
            win.document.close();
            win.print();
        }

        // ============================================================
        // FILTER CHIPS
        // ============================================================
        window._filtroZona = '';
        window._filtroStatus = '';
        window._filtroEva = '';

        function toggleFilterChip(btn) {
            const filter = btn.dataset.filter;
            const val = btn.dataset.val;
            // Deactivate siblings
            document.querySelectorAll(`.filter-chip[data-filter="${filter}"]`).forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            if (filter === 'zona') window._filtroZona = val;
            if (filter === 'status') window._filtroStatus = val;
            if (filter === 'eva') window._filtroEva = val;
            renderLista();
        }

        // ============================================================
        // DASHBOARD — CITAS DE HOY
        // ============================================================
        async function renderCitasHoyDashboard() {
            const hoy = new Date().toISOString().split('T')[0];
            const citas = (await getCitas()).filter(c => c.fecha === hoy).sort((a,b) => a.hora.localeCompare(b.hora));
            const cont = document.getElementById('dash-citas-hoy');
            const badge = document.getElementById('dash-citas-badge');
            if (!cont) return;
            if (citas.length === 0) {
                cont.innerHTML = '<p class="text-xs text-slate-400 italic">Sin citas para hoy.</p>';
                badge.classList.add('hidden');
                return;
            }
            badge.textContent = citas.length;
            badge.classList.remove('hidden');
            cont.innerHTML = citas.map(c => `
                <div class="flex items-center gap-3 p-3 bg-indigo-50 rounded-xl cursor-pointer hover:bg-indigo-100 transition-colors" onclick="showSection('calendario')">
                    <span class="text-indigo-600 font-black text-xs min-w-[36px]">${c.hora}</span>
                    <div>
                        <p class="font-bold text-slate-800 text-xs">${c.atleta}</p>
                        <p class="text-[9px] text-slate-400">${c.tipo}</p>
                    </div>
                </div>`).join('');
        }

        // ============================================================
        // WEEKLY CALENDAR VIEW
        // ============================================================
        let calView = 'mes';
        let calSemanaOffset = 0; // weeks from current

        function setCalView(view) {
            calView = view;
            document.getElementById('cal-btn-mes').className = view === 'mes'
                ? 'px-4 py-2 rounded-xl text-xs font-black transition-all bg-white shadow-sm text-indigo-600'
                : 'px-4 py-2 rounded-xl text-xs font-black transition-all text-slate-500';
            document.getElementById('cal-btn-semana').className = view === 'semana'
                ? 'px-4 py-2 rounded-xl text-xs font-black transition-all bg-white shadow-sm text-indigo-600'
                : 'px-4 py-2 rounded-xl text-xs font-black transition-all text-slate-500';
            document.getElementById('cal-vista-mes').classList.toggle('hidden', view !== 'mes');
            document.getElementById('cal-vista-semana').classList.toggle('hidden', view !== 'semana');
            if (view === 'semana') renderSemana();
        }

        function getLunesDeSemana(offset) {
            const hoy = new Date();
            const dia = hoy.getDay() === 0 ? 6 : hoy.getDay() - 1;
            const lunes = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() - dia + (offset * 7));
            return lunes;
        }

        function cambiarSemana(delta) {
            calSemanaOffset += delta;
            renderSemana();
        }

        async function renderSemana() {
            const lunes = getLunesDeSemana(calSemanaOffset);
            const dias = [];
            for (let i = 0; i < 7; i++) {
                dias.push(new Date(lunes.getFullYear(), lunes.getMonth(), lunes.getDate() + i));
            }
            const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            const hoyStr = new Date().toISOString().split('T')[0];
            const diasNombre = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
            const citas = await getCitas();

            // Título
            document.getElementById('cal-semana-titulo').textContent =
                `${lunes.getDate()} ${meses[lunes.getMonth()]} — ${dias[6].getDate()} ${meses[dias[6].getMonth()]} ${dias[6].getFullYear()}`;

            // Horas a mostrar
            const horas = [];
            for (let h = 7; h <= 20; h++) horas.push(`${String(h).padStart(2,'0')}:00`);

            let html = `<table class="w-full min-w-[700px] border-collapse text-xs">
                <thead><tr>
                    <th class="w-16 p-2 text-[9px] font-black text-slate-400 uppercase"></th>`;
            dias.forEach((d, i) => {
                const dStr = d.toISOString().split('T')[0];
                const isHoy = dStr === hoyStr;
                html += `<th class="week-col-header ${isHoy ? 'week-col-today' : ''} border-l border-slate-100">
                    <div class="${isHoy ? 'bg-indigo-600 text-white rounded-xl px-2 py-1 inline-block' : ''}">${diasNombre[i]}<br/>${d.getDate()}</div>
                </th>`;
            });
            html += `</tr></thead><tbody>`;

            horas.forEach(hora => {
                html += `<tr><td class="p-2 text-[9px] font-black text-slate-300 text-right pr-3 border-t border-slate-50">${hora}</td>`;
                dias.forEach(d => {
                    const dStr = d.toISOString().split('T')[0];
                    const citasSlot = citas.filter(c => c.fecha === dStr && c.hora && c.hora.startsWith(hora.slice(0,3)));
                    html += `<td class="week-slot border-l border-slate-100" onclick="selDia('${dStr}');setCalView('mes')">
                        ${citasSlot.map(c => `<span class="week-pill" title="${escHtml(c.tipo)}">${escHtml(c.hora)} ${escHtml(c.atleta)}</span>`).join('')}
                    </td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('cal-semana-grid').innerHTML = html;
        }

        // ============================================================
        // CALENDAR SEARCH
        // ============================================================
        async function filtrarCitasBusqueda(q) {
            const panel = document.getElementById('cal-search-results');
            const list = document.getElementById('cal-search-list');
            if (!q.trim()) { panel.classList.add('hidden'); return; }
            panel.classList.remove('hidden');
            const citas = (await getCitas()).filter(c => c.atleta.toLowerCase().includes(q.toLowerCase()) || c.tipo.toLowerCase().includes(q.toLowerCase()));
            if (citas.length === 0) {
                list.innerHTML = '<p class="text-xs text-slate-400 italic">Sin resultados.</p>'; return;
            }
            list.innerHTML = citas.map(c => `
                <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100 hover:border-indigo-200 cursor-pointer" onclick="irACita('${c.fecha}')">
                    <div class="flex items-center gap-3">
                        <span class="text-indigo-600 font-black text-xs min-w-[40px]">${c.hora}</span>
                        <div><p class="font-bold text-slate-800 text-xs">${c.atleta}</p><p class="text-[9px] text-slate-400">${c.tipo} · ${c.fecha}</p></div>
                    </div>
                </div>`).join('');
        }

        function irACita(fecha) {
            limpiarBusquedaCal();
            setCalView('mes');
            // Navigate to the right month
            const [y, m] = fecha.split('-');
            calFecha = new Date(parseInt(y, 10), parseInt(m, 10)-1, 1);
            renderCalendario();
            selDia(fecha);
        }

        function limpiarBusquedaCal() {
            document.getElementById('cal-busqueda').value = '';
            document.getElementById('cal-search-results').classList.add('hidden');
        }

        showSection('dashboard');

        // ============================================================
        // IA IMAGEN MÉDICA — MÓDULO COMPLETO
        // ============================================================
        const IMG_HISTORIAL_KEY = 'jelian_img_historial';
        let imgBase64 = null;
        let imgMediaType = 'image/jpeg';
        let imgAnalisisActual = null;

        // Radio chips visual update
        function initImgTipoChips() {
            document.querySelectorAll('.img-tipo-chip input').forEach(radio => {
                radio.addEventListener('change', () => {
                    document.querySelectorAll('.img-tipo-chip span').forEach(s => {
                        s.style.borderColor = ''; s.style.background = ''; s.style.color = '';
                    });
                    if (radio.checked) {
                        const span = radio.nextElementSibling;
                        span.style.borderColor = '#6366f1';
                        span.style.background = 'rgba(99,102,241,0.08)';
                        span.style.color = '#4f46e5';
                    }
                });
                if (radio.checked) {
                    const span = radio.nextElementSibling;
                    span.style.borderColor = '#6366f1';
                    span.style.background = 'rgba(99,102,241,0.08)';
                    span.style.color = '#4f46e5';
                }
            });

            // Drag & drop
            const dropzone = document.getElementById('img-dropzone');
            if (dropzone && !dropzone._ddInit) {
                dropzone._ddInit = true;
                dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-indigo-500','bg-indigo-50/50'); });
                dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-indigo-500','bg-indigo-50/50'));
                dropzone.addEventListener('drop', e => {
                    e.preventDefault();
                    dropzone.classList.remove('border-indigo-500','bg-indigo-50/50');
                    const file = e.dataTransfer.files[0];
                    if (file) processImgFile(file);
                });
            }
        }

        function onImgSelected(event) {
            const file = event.target.files[0];
            if (file) processImgFile(file);
        }

        function processImgFile(file) {
            if (!file.type.startsWith('image/')) { showToast('❌ Solo se admiten imágenes (JPG, PNG, WEBP).', true); return; }
            if (file.size > 20 * 1024 * 1024) { showToast('❌ La imagen no puede superar 20MB.', true); return; }
            imgMediaType = file.type;
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                imgBase64 = dataUrl.split(',')[1];
                document.getElementById('img-preview').src = dataUrl;
                document.getElementById('img-dropzone').classList.add('hidden');
                document.getElementById('img-preview-container').classList.remove('hidden');
                const tipoSelected = document.querySelector('input[name="img-tipo"]:checked')?.value || 'imagen';
                const labels = { 'resonancia': '🧲 RMN', 'rayos-x': '☢️ Rx', 'ecografia': '🔊 ECO' };
                document.getElementById('img-preview-label').textContent = labels[tipoSelected] || tipoSelected;
                showToast('✓ Imagen cargada correctamente.');
            };
            reader.readAsDataURL(file);
        }

        function clearImgUpload() {
            imgBase64 = null;
            const fi = document.getElementById('img-file-input');
            if (fi) fi.value = '';
            document.getElementById('img-dropzone').classList.remove('hidden');
            document.getElementById('img-preview-container').classList.add('hidden');
            document.getElementById('img-preview').src = '';
        }

        async function analizarImagenIA() {
            if (!imgBase64) { showToast('❌ Por favor carga una imagen primero.', true); return; }
            const zona = document.getElementById('img-zona').value;
            const contexto = document.getElementById('img-contexto').value.trim();
            const tipoSelected = document.querySelector('input[name="img-tipo"]:checked')?.value || 'imagen médica';
            const tipoLabels = { 'resonancia': 'Resonancia Magnética (RMN)', 'rayos-x': 'Radiografía (Rx)', 'ecografia': 'Ecografía / Ultrasonido' };
            const tipoLabel = tipoLabels[tipoSelected] || tipoSelected;

            document.getElementById('img-estado-inicial').classList.add('hidden');
            document.getElementById('img-resultado').classList.add('hidden');
            document.getElementById('img-error').classList.add('hidden');
            document.getElementById('img-loading').classList.remove('hidden');
            document.getElementById('btn-analizar-img').disabled = true;

            const promptSistema = `Eres un asistente clínico de fisioterapia deportiva especializado en interpretación de imágenes médicas. Ayudas al fisioterapeuta con análisis ORIENTATIVO. NUNCA emitas diagnóstico definitivo. Responde SIEMPRE con este JSON exacto, sin markdown ni texto fuera del JSON:
{"tipo_imagen":"...","zona_analizada":"...","calidad_imagen":"Óptima|Aceptable|Limitada","hallazgos_principales":[{"estructura":"...","hallazgo":"...","severidad":"Normal|Leve|Moderado|Severo"}],"posibles_diagnosticos":["..."],"correlacion_clinica":"...","recomendaciones_fisioterapia":["..."],"pruebas_complementarias":["..."],"banderas_rojas":["..."],"nota_orientativa":"..."}`;

            const promptUsuario = `Analiza esta imagen de ${tipoLabel}${zona ? ` zona: ${zona}` : ''}.${contexto ? `\nContexto clínico: ${contexto}` : ''}\nResponde SOLO con el JSON.`;

            try {
                const apiKey = localStorage.getItem('jelian_anthropic_key') || '';
                if (!apiKey) {
                    document.getElementById('img-loading').classList.add('hidden');
                    document.getElementById('img-error').classList.remove('hidden');
                    document.getElementById('img-error-msg').textContent = 'No hay API Key configurada. Ve al menú lateral y haz clic en "API Key IA" para ingresarla.';
                    document.getElementById('btn-analizar-img').disabled = false;
                    return;
                }
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'anthropic-version': '2023-06-01', 'x-api-key': apiKey, 'anthropic-dangerous-direct-browser-access': 'true' },
                    body: JSON.stringify({
                        model: 'claude-opus-4-5',
                        max_tokens: 2000,
                        system: promptSistema,
                        messages: [{ role: 'user', content: [
                            { type: 'image', source: { type: 'base64', media_type: imgMediaType, data: imgBase64 } },
                            { type: 'text', text: promptUsuario }
                        ]}]
                    })
                });
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || `HTTP ${response.status}`);
                }
                const data = await response.json();
                const rawText = data.content.map(c => c.text || '').join('');
                const cleanText = rawText.replace(/```json|```/g, '').trim();
                let analisis;
                try { analisis = JSON.parse(cleanText); }
                catch(pe) {
                    const match = cleanText.match(/\{[\s\S]*\}/);
                    if (match) analisis = JSON.parse(match[0]);
                    else throw new Error('La IA no devolvió un análisis válido. Intenta de nuevo.');
                }
                imgAnalisisActual = analisis;
                renderAnalisisResultado(analisis, tipoLabel, zona);
                guardarEnHistorialImg(analisis, tipoLabel, zona);
            } catch(err) {
                document.getElementById('img-loading').classList.add('hidden');
                document.getElementById('img-error').classList.remove('hidden');
                document.getElementById('img-error-msg').textContent = err.message || 'Error desconocido.';
            } finally {
                document.getElementById('btn-analizar-img').disabled = false;
            }
        }

        function renderAnalisisResultado(a, tipoLabel, zona) {
            document.getElementById('img-loading').classList.add('hidden');
            document.getElementById('img-resultado').classList.remove('hidden');
            document.getElementById('img-res-titulo').textContent = `${a.tipo_imagen || tipoLabel} — ${a.zona_analizada || zona || 'Zona analizada'}`;
            const cont = document.getElementById('img-res-contenido');
            const sevClass = s => {
                if (!s) return 'hallazgo-normal';
                s = s.toLowerCase();
                if (s.includes('normal')) return 'hallazgo-normal';
                if (s.includes('leve')) return 'hallazgo-leve';
                if (s.includes('moderado')) return 'hallazgo-moderado';
                return 'hallazgo-severo';
            };
            const calidadColor = a.calidad_imagen === 'Óptima' ? 'emerald' : a.calidad_imagen === 'Aceptable' ? 'amber' : 'rose';
            const banderasHtml = (a.banderas_rojas && a.banderas_rojas.length > 0 && a.banderas_rojas[0] !== '')
                ? `<div class="bg-rose-50 border border-rose-200 rounded-2xl p-4 mb-2">
                    <p class="text-[10px] font-black text-rose-600 uppercase tracking-widest mb-2">🚩 Banderas Rojas</p>
                    ${a.banderas_rojas.map(b=>`<p class="text-xs text-rose-700 font-medium">• ${b}</p>`).join('')}
                   </div>` : '';

            cont.innerHTML = `
                ${banderasHtml}
                <div class="flex flex-wrap gap-2 mb-1">
                    <span class="hallazgo-chip bg-slate-100 text-slate-600">📷 ${a.tipo_imagen||tipoLabel}</span>
                    <span class="hallazgo-chip bg-${calidadColor}-50 text-${calidadColor}-700">Calidad: ${a.calidad_imagen||'N/D'}</span>
                    ${a.zona_analizada?`<span class="hallazgo-chip bg-indigo-50 text-indigo-700">📍 ${a.zona_analizada}</span>`:''}
                </div>
                <div class="ia-section-card rounded-2xl">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">🔍 Hallazgos Principales</p>
                    ${(a.hallazgos_principales||[]).length > 0
                        ? a.hallazgos_principales.map(h=>`
                            <div class="flex items-start gap-3 py-2.5 border-b border-slate-100 last:border-0">
                                <span class="hallazgo-chip ${sevClass(h.severidad)} flex-shrink-0 mt-0.5">${h.severidad||'N/D'}</span>
                                <div><p class="text-xs font-black text-slate-700">${h.estructura||''}</p><p class="text-xs text-slate-500 mt-0.5">${h.hallazgo||''}</p></div>
                            </div>`).join('')
                        : '<p class="text-xs text-slate-400 italic">No se identificaron hallazgos específicos.</p>'}
                </div>
                ${(a.posibles_diagnosticos||[]).length>0 ? `
                <div class="ia-section-card rounded-2xl">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">🎯 Posibles Diagnósticos</p>
                    <div class="flex flex-wrap gap-2">${a.posibles_diagnosticos.map((d,i)=>`<span class="px-3 py-1.5 rounded-full text-xs font-bold ${i===0?'bg-indigo-100 text-indigo-700':'bg-slate-100 text-slate-600'}">${i===0?'★ ':''}${d}</span>`).join('')}</div>
                </div>` : ''}
                ${a.correlacion_clinica ? `
                <div class="ia-section-card rounded-2xl">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">🩺 Correlación Clínica</p>
                    <p class="text-xs text-slate-600 leading-relaxed">${a.correlacion_clinica}</p>
                </div>` : ''}
                ${(a.recomendaciones_fisioterapia||[]).length>0 ? `
                <div class="ia-section-card rounded-2xl">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">💪 Recomendaciones Fisioterapia</p>
                    <ul class="space-y-2">${a.recomendaciones_fisioterapia.map(r=>`<li class="flex items-start gap-2 text-xs text-slate-600"><span class="text-emerald-500 font-black mt-0.5 flex-shrink-0">→</span>${r}</li>`).join('')}</ul>
                </div>` : ''}
                ${(a.pruebas_complementarias||[]).length>0 && a.pruebas_complementarias[0]!=='' ? `
                <div class="ia-section-card rounded-2xl">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">🔬 Pruebas Sugeridas</p>
                    <div class="flex flex-wrap gap-2">${a.pruebas_complementarias.map(p=>`<span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-bold">${p}</span>`).join('')}</div>
                </div>` : ''}
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
                    <p class="text-xs text-amber-700 leading-relaxed">⚠️ <strong>Nota:</strong> ${a.nota_orientativa||'Este análisis es orientativo y de apoyo al criterio clínico del profesional.'}</p>
                </div>`;
            renderHistorialImg();
        }

        function copiarAnalisis() {
            if (!imgAnalisisActual) return;
            const a = imgAnalisisActual;
            let t = `ANÁLISIS IA JELIAN FT — ${a.tipo_imagen} — ${a.zona_analizada}\nFecha: ${new Date().toLocaleDateString('es-ES')}\n\n`;
            t += `HALLAZGOS:\n`; (a.hallazgos_principales||[]).forEach(h=>{t+=`• ${h.estructura}: ${h.hallazgo} [${h.severidad}]\n`;});
            t += `\nPOSIBLES DIAGNÓSTICOS:\n`; (a.posibles_diagnosticos||[]).forEach(d=>{t+=`• ${d}\n`;});
            t += `\nRECOMENDACIONES:\n`; (a.recomendaciones_fisioterapia||[]).forEach(r=>{t+=`• ${r}\n`;});
            if ((a.banderas_rojas||[]).length>0 && a.banderas_rojas[0]!=='') { t+=`\n🚩 BANDERAS ROJAS:\n`; a.banderas_rojas.forEach(b=>{t+=`• ${b}\n`;}); }
            t += `\n⚠️ Análisis orientativo — Jelian FT Clinical Sport v136`;
            navigator.clipboard.writeText(t).then(()=>showToast('✓ Análisis copiado al portapapeles.')).catch(()=>showToast('❌ No se pudo copiar.', true));
        }

        function guardarEnHistorialImg(analisis, tipoLabel, zona) {
            let h = []; try { h = JSON.parse(localStorage.getItem(IMG_HISTORIAL_KEY))||[]; } catch {}
            h.unshift({ fecha: new Date().toLocaleDateString('es-ES'), hora: new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}), tipo: analisis.tipo_imagen||tipoLabel, zona: analisis.zona_analizada||zona||'N/E', diags:(analisis.posibles_diagnosticos||[]).slice(0,2).join(', '), analisis });
            if (h.length>20) h=h.slice(0,20);
            localStorage.setItem(IMG_HISTORIAL_KEY, JSON.stringify(h));
        }

        function renderHistorialImg() {
            let h = []; try { h = JSON.parse(localStorage.getItem(IMG_HISTORIAL_KEY))||[]; } catch {}
            const cont = document.getElementById('img-historial');
            if (!cont) return;
            if (h.length===0) { cont.innerHTML='<p class="text-xs text-slate-400 italic">Sin análisis previos.</p>'; return; }
            cont.innerHTML = h.map((item,i)=>`
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-indigo-50 transition-colors" onclick="verAnalisisHistorial(${i})">
                    <div class="w-9 h-9 bg-indigo-100 rounded-xl flex items-center justify-center text-sm flex-shrink-0">${(item.tipo||'').includes('RMN')||(item.tipo||'').includes('Resonancia')?'🧲':(item.tipo||'').includes('Rx')||(item.tipo||'').includes('Radio')?'☢️':'🔊'}</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-black text-slate-700 truncate">${item.zona}</p>
                        <p class="text-[9px] text-slate-400 truncate">${item.diags||'Sin diagnóstico'} · ${item.fecha} ${item.hora}</p>
                    </div>
                </div>`).join('');
        }

        function verAnalisisHistorial(idx) {
            let h = []; try { h = JSON.parse(localStorage.getItem(IMG_HISTORIAL_KEY))||[]; } catch {}
            if (!h[idx]) return;
            imgAnalisisActual = h[idx].analisis;
            document.getElementById('img-estado-inicial').classList.add('hidden');
            document.getElementById('img-loading').classList.add('hidden');
            document.getElementById('img-error').classList.add('hidden');
            renderAnalisisResultado(h[idx].analisis, h[idx].tipo, h[idx].zona);
        }

        function clearHistorialImg() {
            if (!confirm('¿Limpiar historial de análisis?')) return;
            localStorage.removeItem(IMG_HISTORIAL_KEY);
            renderHistorialImg();
            showToast('✓ Historial limpiado.');
        }

        function nuevoAnalisis() {
            clearImgUpload();
            const ctx = document.getElementById('img-contexto'); if (ctx) ctx.value='';
            const zon = document.getElementById('img-zona'); if (zon) zon.value='';
            document.getElementById('img-resultado').classList.add('hidden');
            document.getElementById('img-error').classList.add('hidden');
            document.getElementById('img-estado-inicial').classList.remove('hidden');
            imgAnalisisActual = null;
        }

        // ============================================================
        // BIBLIOTECA DE ANATOMÍA — Diagramas interactivos + referencia
        // ============================================================
        const ANATOMIA_DATA = {
            rodilla: {
                titulo: 'Rodilla',
                estructuras: [
                    { id: 'lca', nombre: 'Ligamento Cruzado Anterior (LCA)', tipo: 'Ligamento', icono: '🔗',
                      funcion: 'Estabilización anterior de la tibia respecto al fémur. Controla la rotación interna y el varo/valgo en extensión.',
                      lesiones: 'Rotura completa/parcial (muy frecuente en deportes de pivote). Esguince grado I-III.',
                      tests: 'Lachman Test (gold standard), Cajón Anterior, Pivot Shift Test, KT-1000',
                      dolor: 'Cara anterior-central de rodilla. Hemartros agudo. Sensación de "crujido" en el momento de la lesión.' },
                    { id: 'lcp', nombre: 'Ligamento Cruzado Posterior (LCP)', tipo: 'Ligamento', icono: '🔗',
                      funcion: 'Evita el desplazamiento posterior de la tibia. Estabilizador primario posterior.',
                      lesiones: 'Rotura por impacto directo en cara anterior (dashboard injury). Menos frecuente que LCA.',
                      tests: 'Cajón Posterior, Test de Godfrey, Sag Test',
                      dolor: 'Cara posterior de rodilla. Dolor difuso. Posible irradiación a pantorrilla.' },
                    { id: 'menisco_medial', nombre: 'Menisco Medial', tipo: 'Fibrocartílago', icono: '🌙',
                      funcion: 'Amortiguación y distribución de cargas en el compartimento medial. Estabilización secundaria.',
                      lesiones: 'Lesión de asta posterior (más frecuente), rotura en asa de cubo, lesión degenerativa.',
                      tests: 'McMurray (RI + varo), Test de Apley, Test de Thessaly 20°, Steinmann I y II',
                      dolor: 'Interlínea medial. Dolor al girar en carga. Posible bloqueo articular.' },
                    { id: 'menisco_lateral', nombre: 'Menisco Lateral', tipo: 'Fibrocartílago', icono: '🌙',
                      funcion: 'Amortiguación en compartimento lateral. Mayor movilidad que el medial.',
                      lesiones: 'Lesión de asta posterior, quiste meniscal lateral, lesión discal.',
                      tests: 'McMurray (RE + valgo), Test de Apley lateral, Thessaly lateral',
                      dolor: 'Interlínea lateral. Dolor en flexión profunda y rotación.' },
                    { id: 'lco', nombre: 'Ligamento Colateral Interno (LCI)', tipo: 'Ligamento', icono: '🔗',
                      funcion: 'Estabilización en valgo. Restricción a la rotación externa de tibia.',
                      lesiones: 'Esguince por valgo forzado (grados I-III). Frecuente en fútbol y esquí.',
                      tests: 'Test de estrés en valgo (0° y 30°), Palpación directa',
                      dolor: 'Cara medial de rodilla. Dolor a la palpación del ligamento.' },
                    { id: 'rotula', nombre: 'Rótula / Tendón Rotuliano', tipo: 'Hueso / Tendón', icono: '⚡',
                      funcion: 'Palanca del cuádriceps. Incrementa la eficiencia mecánica en extensión.',
                      lesiones: 'Tendinopatía rotuliana, condromalacia, síndrome femoropatelar, fractura de rótula.',
                      tests: 'Clarke Test, Test de Zohlen, Palpación polo inferior, FPA',
                      dolor: 'Polo inferior de rótula. Dolor al bajar escaleras y en cuclillas.' },
                    { id: 'femur', nombre: 'Fémur (cóndilo distal)', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Transmisión de cargas desde la cadera. Los cóndilos forman la superficie articular superior de la rodilla.',
                      lesiones: 'Fractura supracondílea, osteocondritis disecante (OCD), contusión ósea, necrosis avascular.',
                      tests: 'Radiografía AP/lateral, RMN para OCD y contusión ósea, Palpación de cóndilos',
                      dolor: 'Cara distal del muslo. En OCD: dolor difuso mal localizado, peor en carga y rotación.' },
                    { id: 'tibia_r', nombre: 'Tibia (platillo tibial)', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Soporte principal de carga. El platillo tibial forma la superficie articular inferior de la rodilla.',
                      lesiones: 'Fractura de platillo tibial (Schatzker I-VI), síndrome de Osgood-Schlatter, fractura por estrés.',
                      tests: 'Rx AP/lateral, TC para clasificación de fractura, Palpación tuberosidad tibial',
                      dolor: 'Tuberosidad anterior (Osgood-Schlatter en adolescentes). Cara proximal en fracturas.' },
                ],
                tests: [
                    { nombre: 'Lachman Test', estructura: 'LCA', posicion: 'Supino, rodilla 20-30° flexión', ejecucion: 'Traslación anterior de tibia con fémur fijo', positivo: 'Traslación >3mm o tope blando', sensibilidad: '85%' },
                    { nombre: 'McMurray', estructura: 'Meniscos', posicion: 'Supino, rodilla en flexión máxima', ejecucion: 'Rotación interna + valgo (menisco lateral) / RI + varo (menisco medial)', positivo: 'Click o dolor en interlínea', sensibilidad: '61%' },
                    { nombre: 'Apley', estructura: 'Meniscos', posicion: 'Prono, rodilla 90°', ejecucion: 'Compresión + rotación (menisco) / Tracción + rotación (ligamentos)', positivo: 'Dolor con compresión', sensibilidad: '58%' },
                    { nombre: 'Thessaly 20°', estructura: 'Meniscos', posicion: 'De pie monopodal, 20° flexión', ejecucion: 'Rotación interna y externa del cuerpo x3', positivo: 'Dolor en interlínea', sensibilidad: '89%' },
                    { nombre: 'Estrés en valgo', estructura: 'LCI', posicion: 'Supino, 0° y 30° de flexión', ejecucion: 'Fuerza en valgo sobre rodilla', positivo: 'Apertura articular con dolor', sensibilidad: '86%' },
                    { nombre: 'Clarke / Zohlen', estructura: 'Rótula', posicion: 'Supino, rodilla extendida', ejecucion: 'Presión sobre rótula + contracción de cuádriceps', positivo: 'Dolor retrorrotuliano', sensibilidad: '49%' },
                ]
            },
            hombro: {
                titulo: 'Hombro',
                estructuras: [
                    { id: 'manguito', nombre: 'Manguito Rotador (Supraespinoso)', tipo: 'Tendón', icono: '💪',
                      funcion: 'Depresión de la cabeza humeral. Rotación interna y abducción inicial (0-15°).',
                      lesiones: 'Tendinopatía, rotura parcial/total. Causa más frecuente de dolor de hombro en >40 años.',
                      tests: 'Neer Test, Hawkins-Kennedy, Empty Can (Jobe), Drop Arm Test',
                      dolor: 'Cara anterolateral de hombro. Arco doloroso 60-120°. Dolor nocturno.' },
                    { id: 'biceps', nombre: 'Bíceps (Porción Larga)', tipo: 'Tendón', icono: '💪',
                      funcion: 'Flexión de hombro y codo. Supinación del antebrazo.',
                      lesiones: 'Tendinitis bicipital, rotura del tendón de la porción larga.',
                      tests: 'Speed Test, Yergason Test, Palpación del surco bicipital',
                      dolor: 'Cara anterior de hombro, surco bicipital. Dolor a la supinación resistida.' },
                    { id: 'acromio', nombre: 'Articulación Acromioclavicular', tipo: 'Articulación', icono: '🦴',
                      funcion: 'Transmisión de fuerzas entre extremidad superior y tronco.',
                      lesiones: 'Esguince AC (grados I-VI), luxación acromioclavicular.',
                      tests: 'Test de Cross Body, Palpación directa, O Brien modificado',
                      dolor: 'Punto exacto de AC. Dolor al cruzar el brazo por delante del cuerpo.' },
                    { id: 'glenohumeral', nombre: 'Cápsula Glenohumeral / LGHI', tipo: 'Ligamento', icono: '🔗',
                      funcion: 'Estabilización anterior e inferior de la articulación glenohumeral.',
                      lesiones: 'Inestabilidad anterior, luxación glenohumeral, lesión de Bankart.',
                      tests: 'Apprehension Test, Relocation Test, Load & Shift',
                      dolor: 'Cara anterior de hombro. Miedo a luxación en ABD + RE.' },
                    { id: 'humero', nombre: 'Húmero (cabeza y tuberosidades)', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Forma la articulación glenohumeral. Las tuberosidades son inserción del manguito rotador.',
                      lesiones: 'Fractura de troquíter (caída sobre mano), fractura de cuello quirúrgico, luxación glenohumeral, lesión de Hill-Sachs.',
                      tests: 'Rx AP/perfil axilar, TC para fractura compleja, RMN para lesión de Hill-Sachs',
                      dolor: 'Cara lateral de hombro. En fracturas: dolor intenso con impotencia funcional y deformidad.' },
                    { id: 'escapula', nombre: 'Escápula / Acromion', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Base de inserción del manguito rotador y bíceps. El acromion forma el techo del espacio subacromial.',
                      lesiones: 'Fractura de escápula (alta energía), discinesia escapular, síndrome de pinzamiento subacromial por morfología acromial (tipo I-III).',
                      tests: 'Kibler Test (discinesia), Clasificación acromial en Rx outlet, Palpación espina escapular',
                      dolor: 'Cara posterior de hombro en discinesia. Dolor difuso en pinzamiento subacromial.' },
                    { id: 'clavicula', nombre: 'Clavícula', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Única conexión ósea entre extremidad superior y tronco. Protege el paquete vasculonervioso subyacente.',
                      lesiones: 'Fractura de clavícula (1/3 medio más frecuente), fractura por estrés en atletas de lanzamiento.',
                      tests: 'Rx AP con 15° de inclinación cefálica, Palpación directa del trazo de fractura',
                      dolor: 'Dolor localizado en la clavícula con deformidad visible. Dolor al elevar el brazo.' },
                ],
                tests: [
                    { nombre: 'Neer Test', estructura: 'Supraespinoso', posicion: 'Sentado, brazo neutro', ejecucion: 'Elevación pasiva con RI forzada', positivo: 'Dolor en arco de movimiento', sensibilidad: '72%' },
                    { nombre: 'Hawkins-Kennedy', estructura: 'Manguito/Subescapular', posicion: 'Sentado, hombro 90° flexión', ejecucion: 'Rotación interna forzada', positivo: 'Dolor anterolateral', sensibilidad: '79%' },
                    { nombre: 'Empty Can (Jobe)', estructura: 'Supraespinoso', posicion: 'De pie, ABD 90°, RI, pulgar abajo', ejecucion: 'Resistencia a la abducción', positivo: 'Debilidad o dolor', sensibilidad: '69%' },
                    { nombre: 'Speed Test', estructura: 'Bíceps PLB', posicion: 'De pie, codo extendido, supinado', ejecucion: 'Resistencia a la flexión de hombro', positivo: 'Dolor en surco bicipital', sensibilidad: '54%' },
                    { nombre: 'Apprehension Test', estructura: 'Cápsula anterior', posicion: 'Supino, ABD 90° + RE 90°', ejecucion: 'RE pasiva progresiva', positivo: 'Miedo a luxación', sensibilidad: '72%' },
                    { nombre: 'Cross Body Test', estructura: 'AC', posicion: 'Sentado', ejecucion: 'Aducción horizontal forzada', positivo: 'Dolor en AC', sensibilidad: '82%' },
                ]
            },
            tobillo: {
                titulo: 'Tobillo / Pie',
                estructuras: [
                    { id: 'pla', nombre: 'Ligamento Peroneoastragalino Anterior (LPAA)', tipo: 'Ligamento', icono: '🔗',
                      funcion: 'Estabilización lateral del tobillo. Limita la inversión y traslación anterior del astrágalo.',
                      lesiones: 'Esguince de tobillo lateral (más frecuente en deporte). Rotura parcial o total.',
                      tests: 'Cajón Anterior de Tobillo, Test de Inversión Forzada',
                      dolor: 'Cara anterior del maléolo peroneo. Equimosis en 24-48h.' },
                    { id: 'aquiles', nombre: 'Tendón de Aquiles', tipo: 'Tendón', icono: '⚡',
                      funcion: 'Flexión plantar del pie. Transmisión de la fuerza del tríceps sural.',
                      lesiones: 'Tendinopatía insercional o de cuerpo medio, rotura total del tendón.',
                      tests: 'Thompson Test, Royal London Hospital Test, Arc Sign, Palpación',
                      dolor: 'Cara posterior del talón (insercional) o 2-6cm proximal (cuerpo medio).' },
                    { id: 'fascia', nombre: 'Fascia Plantar', tipo: 'Fascia', icono: '📏',
                      funcion: 'Soporte del arco plantar. Windlass mechanism durante la marcha.',
                      lesiones: 'Fasciopatía plantar (antes llamada fascitis). Espolón calcáneo.',
                      tests: 'Windlass Test, Palpación de tuberosidad medial del calcáneo, First Step Test',
                      dolor: 'Cara medial del calcáneo. Peor al levantarse y tras el reposo.' },
                    { id: 'tibpost', nombre: 'Tibial Posterior', tipo: 'Tendón', icono: '💪',
                      funcion: 'Supinación e inversión del pie. Soporte del arco medial.',
                      lesiones: 'Disfunción del tibial posterior, pie plano adquirido del adulto.',
                      tests: 'Too Many Toes Sign, Single Leg Heel Rise, Palpación retromaleolar',
                      dolor: 'Cara medial del tobillo, zona retromaleolar.' },
                    { id: 'tibia_t', nombre: 'Tibia (maléolo medial / pilón tibial)', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Forma el maléolo medial y el techo de la mortaja tibioperonea. Soporte principal de carga del tobillo.',
                      lesiones: 'Fractura de maléolo medial, fractura de pilón tibial (alta energía), fractura por estrés de tibia distal.',
                      tests: 'Rx AP/lateral/mortaja, Ottawa Ankle Rules, TC para fractura compleja de pilón',
                      dolor: 'Cara medial del tobillo. En fractura de pilón: dolor e inflamación masiva con deformidad visible.' },
                    { id: 'astragalo', nombre: 'Astrágalo', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Clave de bóveda del tobillo. Transmite el 100% del peso corporal. Sin inserciones musculares directas.',
                      lesiones: 'Fractura de astrágalo (Hawkins I-IV), osteocondritis disecante astragalina (ODA), necrosis avascular.',
                      tests: 'Rx AP/lateral/mortaja, RMN para ODA y necrosis, TC para fracturas complejas, Signo de Hawkins',
                      dolor: 'Dolor difuso en tobillo. En ODA: dolor anterior con efusión articular. Crepitación en movimiento.' },
                    { id: 'calcaneo', nombre: 'Calcáneo', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Mayor hueso del tarso. Punto de apoyo del talón y palanca del tendón de Aquiles.',
                      lesiones: 'Fractura por compresión axial (caída de altura), fractura por estrés (corredores), espolón calcáneo.',
                      tests: 'Rx lateral con ángulo de Böhler, TC para fractura intraarticular, Squeeze Test (fractura estrés)',
                      dolor: 'Talón en fractura aguda. Cara posteromedial en fractura estrés. Cara plantar en espolón.' },
                    { id: 'perone_t', nombre: 'Peroné (maléolo lateral)', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Forma el maléolo lateral de la mortaja tibioperonea. Estabilización lateral del tobillo.',
                      lesiones: 'Fractura de maléolo lateral (Weber A/B/C), fractura por avulsión (esguince grado III), fractura de Maisonneuve.',
                      tests: 'Rx AP/lateral/mortaja, Ottawa Ankle Rules, Squeeze Test para Maisonneuve',
                      dolor: 'Cara lateral del tobillo con equimosis. Dolor en punta del maléolo en avulsión.' },
                ],
                tests: [
                    { nombre: 'Cajón Anterior', estructura: 'LPAA', posicion: 'Supino, tobillo 20° FP', ejecucion: 'Traslación anterior del astrágalo', positivo: '>3mm traslación o tope blando', sensibilidad: '83%' },
                    { nombre: 'Thompson Test', estructura: 'Aquiles', posicion: 'Prono, rodilla flexionada', ejecucion: 'Compresión del tríceps sural', positivo: 'Ausencia de flexión plantar', sensibilidad: '96%' },
                    { nombre: 'Windlass Test', estructura: 'Fascia plantar', posicion: 'De pie monopodal', ejecucion: 'Extensión pasiva del 1er dedo', positivo: 'Dolor en inserción calcánea', sensibilidad: '32%' },
                    { nombre: 'Single Leg Heel Rise', estructura: 'Tibial posterior', posicion: 'De pie monopodal', ejecucion: 'Elevación repetida en punta de pie', positivo: 'Imposibilidad de supinación', sensibilidad: '70%' },
                ]
            },
            columna: {
                titulo: 'Columna Vertebral',
                estructuras: [
                    { id: 'disco', nombre: 'Disco Intervertebral', tipo: 'Fibrocartílago', icono: '🫧',
                      funcion: 'Amortiguación de cargas axiales. Permite movimiento entre vértebras.',
                      lesiones: 'Hernia discal (protrusión, extrusión, secuestro), degeneración discal.',
                      tests: 'Lasègue (SLR), Slump Test, Bragard, Valsalva',
                      dolor: 'Lumbalgia + radiculopatía (ciático). Peor en sedestación prolongada.' },
                    { id: 'facetas', nombre: 'Articulaciones Facetarias', tipo: 'Articulación', icono: '🦴',
                      funcion: 'Guían y limitan el movimiento segmentario. Estabilización posterior.',
                      lesiones: 'Síndrome facetario, artrosis facetaria, bloqueo facetario.',
                      tests: 'Kemp Test, Extensión + rotación con compresión, Palpación paravertebral',
                      dolor: 'Lumbar + referido a glúteo/muslo (sin irradiación distal). Peor en extensión.' },
                    { id: 'nervio_ciatico', nombre: 'Nervio Ciático', tipo: 'Nervio', icono: '⚡',
                      funcion: 'Inervación motora y sensitiva de extremidad inferior (L4-S3).',
                      lesiones: 'Compresión por hernia discal, síndrome piriforme, estenosis.',
                      tests: 'Lasègue (SLR), Slump Test, Bowstring Test, Neurodinamia',
                      dolor: 'Irradiación desde glúteo hasta pie siguiendo dermatoma. Parestesias/disestesias.' },
                    { id: 'sacroiliaca', nombre: 'Articulación Sacroilíaca (ASI)', tipo: 'Articulación', icono: '⚙️',
                      funcion: 'Transmisión de cargas entre columna y pelvis. Amortiguación.',
                      lesiones: 'Disfunción sacroilíaca, sacroileítis, bloqueo articular.',
                      tests: 'FABER, Gaenslen, Compresión/Distracción, Thigh Thrust, ASLR',
                      dolor: 'Zona glútea alta, EIPS. Dolor unilateral, raramente irradia más allá de la rodilla.' },
                    { id: 'vertebra', nombre: 'Cuerpo Vertebral Lumbar', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Soporte de carga axial. Los pedículos y láminas forman el canal vertebral que protege la médula.',
                      lesiones: 'Fractura por compresión (osteoporosis), fractura por estallido, espondilolistesis, espondilólisis (istmo).',
                      tests: 'Rx AP/lateral en bipedestación, TC para fractura, Rx dinámica para inestabilidad, Stork Test (espondilólisis)',
                      dolor: 'Lumbalgia central. En fractura: dolor agudo en carga axial. En espondilolistesis: dolor con extensión.' },
                    { id: 'sacro', nombre: 'Sacro', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Cierre posterior de la pelvis. Transmisión de cargas entre columna lumbar e ilíacos.',
                      lesiones: 'Fractura sacra por insuficiencia (osteoporosis), fractura por estrés (corredores), fractura traumática de alta energía.',
                      tests: 'RMN para fractura estrés, TC para fractura traumática, Rx AP pelvis, Palpación de la línea media sacra',
                      dolor: 'Dolor sacro central o paramedial. En fractura estrés: dolor glúteo difuso que empeora con el ejercicio.' },
                ],
                tests: [
                    { nombre: 'Lasègue (SLR)', estructura: 'Nervio Ciático / Disco', posicion: 'Supino', ejecucion: 'Elevación pasiva de pierna con rodilla extendida', positivo: 'Dolor radicular <70°', sensibilidad: '91%' },
                    { nombre: 'Slump Test', estructura: 'Sistema nervioso central', posicion: 'Sentado al borde de la camilla', ejecucion: 'Flexión cervical + rodilla extendida + FD tobillo', positivo: 'Síntomas reproducidos', sensibilidad: '84%' },
                    { nombre: 'Kemp Test', estructura: 'Facetas', posicion: 'De pie', ejecucion: 'Extensión + rotación + compresión axial', positivo: 'Dolor lumbar ipsilateral', sensibilidad: '67%' },
                    { nombre: 'FABER', estructura: 'Sacroilíaca / Cadera', posicion: 'Supino, figura 4', ejecucion: 'Presión sobre rodilla flexionada', positivo: 'Dolor en ASI o cadera', sensibilidad: '77%' },
                    { nombre: 'Gaenslen', estructura: 'Sacroilíaca', posicion: 'Decúbito lateral', ejecucion: 'Extensión de cadera inferior + flexión superior', positivo: 'Dolor en ASI', sensibilidad: '71%' },
                ]
            },
            cadera: {
                titulo: 'Cadera / Pelvis',
                estructuras: [
                    { id: 'labrum', nombre: 'Labrum Acetabular', tipo: 'Fibrocartílago', icono: '🌙',
                      funcion: 'Profundización de la cavidad acetabular. Sello de presión negativa intraarticular.',
                      lesiones: 'Lesión del labrum (anterior más frecuente), asociada a choque femoroacetabular (FAI).',
                      tests: 'FADIR, FABER, Test de Impingement anterior, Thomas modificado',
                      dolor: 'Ingle profunda (C-sign). Dolor en sedestación prolongada y en rotación.' },
                    { id: 'isquiotibiales', nombre: 'Isquiotibiales (Inserción)', tipo: 'Tendón', icono: '💪',
                      funcion: 'Extensión de cadera y flexión de rodilla.',
                      lesiones: 'Tendinopatía proximal de isquiotibiales, avulsión isquiática.',
                      tests: 'Puranen-Orava Test, Test de Bent Knee Stretch, Palpación tuberosidad isquiática',
                      dolor: 'Glúteo profundo / tuberosidad isquiática. Peor en sedestación y en sprint.' },
                    { id: 'piriforme', nombre: 'Músculo Piriforme', tipo: 'Músculo', icono: '🎯',
                      funcion: 'Rotación externa de cadera. Estabilizador de la articulación sacroilíaca.',
                      lesiones: 'Síndrome del piriforme (compresión del ciático).',
                      tests: 'FAIR Test, Pace Test, Beatty Test, Freiberg Test',
                      dolor: 'Glúteo profundo con irradiación ciática. Diferencial con hernia discal.' },
                    { id: 'it_band', nombre: 'Banda Iliotibial (TFL/ITB)', tipo: 'Fascia', icono: '📏',
                      funcion: 'Estabilización lateral de cadera y rodilla. Control de la aducción en carga.',
                      lesiones: 'Síndrome de la banda iliotibial (rodilla del corredor).',
                      tests: 'Test de Ober, Test de Noble, Palpación del tubérculo de Gerdy',
                      dolor: 'Cara lateral de rodilla (epicóndilo lateral). Peor a los 30 min de carrera.' },
                    { id: 'pelvis', nombre: 'Pelvis (ilíaco / isquion)', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Transmisión de cargas entre columna y extremidades. Protección de órganos pélvicos. Inserción de músculos del suelo pélvico y cadera.',
                      lesiones: 'Fractura de pelvis (alta energía), avulsión de EIAS (sartorio/TFL), avulsión isquiática (isquiotibiales), osteítis púbica.',
                      tests: 'Rx AP pelvis, TC para clasificación de fractura, Palpación de EIAS y EIPS, Test de osteítis púbica',
                      dolor: 'Variable según zona. EIAS: dolor en sprint. Isquion: dolor en sprint y sedestación. Sínfisis: dolor en aducción.' },
                    { id: 'cabeza_femoral', nombre: 'Cabeza y cuello femoral', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Forma la articulación coxofemoral. El cuello transmite las cargas en ángulo hacia la diáfisis.',
                      lesiones: 'Fractura de cuello femoral (Garden I-IV), necrosis avascular de cabeza femoral (NAF), choque femoroacetabular (FAI).',
                      tests: 'Rx AP/Dunn 45°, RMN para NAF precoz, FADIR para FAI, Test de Thomas para anteversión',
                      dolor: 'Ingle profunda. En NAF: dolor progresivo en carga. En fractura: impotencia funcional total con EEII en RE.' },
                ],
                tests: [
                    { nombre: 'FADIR', estructura: 'FAI / Labrum', posicion: 'Supino', ejecucion: 'Flexión 90° + aducción + RI pasiva', positivo: 'Dolor en ingle', sensibilidad: '88%' },
                    { nombre: 'Test de Ober', estructura: 'Banda Iliotibial', posicion: 'Decúbito lateral', ejecucion: 'Abducción + extensión de cadera, luego soltar', positivo: 'Extremidad no baja al neutro', sensibilidad: '76%' },
                    { nombre: 'FAIR Test', estructura: 'Piriforme', posicion: 'Decúbito lateral', ejecucion: 'Flexión + RI + aducción pasiva con presión sobre piriforme', positivo: 'Dolor glúteo con irradiación', sensibilidad: '78%' },
                    { nombre: 'Puranen-Orava', estructura: 'Isquiotibiales', posicion: 'De pie', ejecucion: 'Extensión de rodilla con cadera 90° flexión', positivo: 'Dolor en tuberosidad isquiática', sensibilidad: '76%' },
                ]
            },
            codo: {
                titulo: 'Codo / Muñeca',
                estructuras: [
                    { id: 'epi_lat', nombre: 'Extensores del Carpo (Epicóndilo Lateral)', tipo: 'Tendón', icono: '💪',
                      funcion: 'Extensión de muñeca y dedos. Supinación del antebrazo.',
                      lesiones: 'Epicondilalgia lateral (tenis elbow). ECRB afectado principalmente.',
                      tests: 'Cozen Test, Mill Test, Chair Test, Maudsley Test',
                      dolor: 'Epicóndilo lateral. Irradiación por cara dorsal del antebrazo. Peor al apretar.' },
                    { id: 'epi_med', nombre: 'Flexores del Carpo (Epicóndilo Medial)', tipo: 'Tendón', icono: '💪',
                      funcion: 'Flexión de muñeca y dedos. Pronación.',
                      lesiones: 'Epicondilalgia medial (golfer\'s elbow).',
                      tests: 'Test de Golfer (Flexión + pronación resistida), Palpación epicóndilo medial',
                      dolor: 'Epicóndilo medial. Peor al flexionar muñeca con carga.' },
                    { id: 'tunel_carpo', nombre: 'Nervio Mediano (Túnel Carpiano)', tipo: 'Nervio', icono: '⚡',
                      funcion: 'Inervación sensitiva de los 3 primeros dedos y motor de la eminencia tenar.',
                      lesiones: 'Síndrome del túnel carpiano (neuropatía por compresión más frecuente).',
                      tests: 'Phalen Test, Tinel Sign, Durkan Test, Sensibilidad con monofilamento',
                      dolor: 'Parestesias nocturas en 1°-3° dedos. Debilidad en pinza. Peor al conducir.' },
                    { id: 'triangular', nombre: 'Complejo Fibrocartílago Triangular (TFCC)', tipo: 'Fibrocartílago', icono: '🌙',
                      funcion: 'Estabilización de la articulación radiocubital distal. Carga axial en el cúbito.',
                      lesiones: 'Lesión traumática o degenerativa del TFCC.',
                      tests: 'TFCC Compression Test, Press Test, Shuck Test, RUD Stress Test',
                      dolor: 'Cara cubital de la muñeca. Dolor en pronosupinación con carga.' },
                    { id: 'humero_codo', nombre: 'Húmero distal (epicóndilos)', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Los epicóndilos son el origen de los músculos flexores (medial) y extensores (lateral) del antebrazo.',
                      lesiones: 'Fractura supracondílea (niños), fractura de epicóndilo medial, fractura de cabeza radial, osteocondritis disecante del capitelo.',
                      tests: 'Rx AP/lateral de codo, Rx oblicua para epicóndilo medial, RMN para OCD del capitelo',
                      dolor: 'Dolor localizado en el epicóndilo afectado. En fractura: deformidad y crepitación en codo.' },
                    { id: 'radio_cubito', nombre: 'Radio y Cúbito', tipo: 'Hueso', icono: '🦴',
                      funcion: 'Radio soporta el 80% de carga en muñeca. La pronosupinación ocurre por rotación del radio alrededor del cúbito fijo.',
                      lesiones: 'Fractura de Colles (radio distal), fractura de Smith, fractura de escafoides, fractura de Monteggia, fractura de Galeazzi.',
                      tests: 'Rx AP/lateral de muñeca, Rx de escafoides en desviación cubital, TC para fractura de escafoides oculta',
                      dolor: 'Muñeca en fractura de Colles: deformidad en "dorso de tenedor". Tabaquera anatómica en fractura de escafoides.' },
                ],
                tests: [
                    { nombre: 'Cozen Test', estructura: 'Epicóndilo lateral', posicion: 'Codo extendido, muñeca pronada', ejecucion: 'Extensión de muñeca resistida', positivo: 'Dolor en epicóndilo lateral', sensibilidad: '84%' },
                    { nombre: 'Phalen Test', estructura: 'Nervio Mediano', posicion: 'Sentado', ejecucion: 'Flexión máxima de muñeca 60 segundos', positivo: 'Parestesias en 1°-3° dedos', sensibilidad: '75%' },
                    { nombre: 'Tinel Sign (muñeca)', estructura: 'Nervio Mediano', posicion: 'Muñeca neutra', ejecucion: 'Percusión sobre el túnel carpiano', positivo: 'Parestesias distales', sensibilidad: '50%' },
                    { nombre: 'TFCC Compression', estructura: 'TFCC', posicion: 'Codo 90°, antebrazo neutro', ejecucion: 'Compresión axial + desviación cubital + pronosupinación', positivo: 'Dolor cubital', sensibilidad: '74%' },
                    { nombre: 'Mill Test', estructura: 'Epicóndilo lateral', posicion: 'Codo extendido, muñeca en flexión', ejecucion: 'Pronación forzada', positivo: 'Dolor en epicóndilo lateral', sensibilidad: '76%' },
                ]
            }
        };

        let _anatRegionActual = 'rodilla';

        function setAnatomiaRegion(region) {
            _anatRegionActual = region;
            document.querySelectorAll('.anat-tab-btn').forEach(b => {
                b.classList.remove('bg-emerald-600', 'text-white');
                b.classList.add('bg-slate-100', 'text-slate-600');
            });
            event.target.classList.add('bg-emerald-600', 'text-white');
            event.target.classList.remove('bg-slate-100', 'text-slate-600');
            renderAnatomia(region);
        }

        function renderAnatomia(region) {
            const data = ANATOMIA_DATA[region];
            if (!data) return;
            document.getElementById('anat-region-title').textContent = data.titulo;
            renderAnatomeSVG(region, data);
            renderEstructurasList(data);
            renderTestsGrid(data);
            limpiarInfoPanel();
        }

        function limpiarInfoPanel() {
            document.getElementById('anat-info-default').classList.remove('hidden');
            document.getElementById('anat-info-content').classList.add('hidden');
        }

        function seleccionarEstructura(id) {
            const data = ANATOMIA_DATA[_anatRegionActual];
            const est = data.estructuras.find(e => e.id === id);
            if (!est) return;
            // Highlight SVG
            document.querySelectorAll('.anat-estructura-svg').forEach(el => {
                el.classList.remove('anat-activo');
            });
            const el = document.getElementById('svg-' + id);
            if (el) el.classList.add('anat-activo');
            // Mostrar info
            document.getElementById('anat-info-default').classList.add('hidden');
            document.getElementById('anat-info-content').classList.remove('hidden');
            document.getElementById('anat-info-icon').textContent = est.icono;
            document.getElementById('anat-info-nombre').textContent = est.nombre;
            document.getElementById('anat-info-tipo').textContent = est.tipo;
            document.getElementById('anat-info-funcion').textContent = est.funcion;
            document.getElementById('anat-info-lesiones').textContent = est.lesiones;
            document.getElementById('anat-info-tests').textContent = est.tests;
            document.getElementById('anat-info-dolor').textContent = est.dolor;
            // Highlight list item
            document.querySelectorAll('.anat-list-item').forEach(li => li.classList.remove('bg-emerald-50', 'border-emerald-200'));
            const li = document.getElementById('li-' + id);
            if (li) { li.classList.add('bg-emerald-50', 'border-emerald-200'); li.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
        }

        function renderEstructurasList(data) {
            const cont = document.getElementById('anat-estructuras-list');
            cont.innerHTML = data.estructuras.map(e => `
                <div id="li-${e.id}" class="anat-list-item flex items-center gap-3 p-3 rounded-xl border border-transparent cursor-pointer hover:bg-slate-50 transition-all" onclick="seleccionarEstructura('${e.id}')">
                    <span class="text-lg">${e.icono}</span>
                    <div>
                        <p class="text-xs font-bold text-slate-700">${e.nombre}</p>
                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wide">${e.tipo}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderTestsGrid(data) {
            const cont = document.getElementById('anat-tests-grid');
            cont.innerHTML = data.tests.map(t => `
                <div class="bg-white border border-slate-100 rounded-2xl p-5 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="text-sm font-extrabold text-slate-900">${t.nombre}</h5>
                        <span class="text-[9px] font-black px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full">${t.sensibilidad}</span>
                    </div>
                    <p class="text-[9px] font-black text-indigo-500 uppercase tracking-widest mb-3">${t.estructura}</p>
                    <div class="space-y-1.5">
                        <p class="text-[10px] text-slate-500"><span class="font-black text-slate-700">Posición:</span> ${t.posicion}</p>
                        <p class="text-[10px] text-slate-500"><span class="font-black text-slate-700">Ejecución:</span> ${t.ejecucion}</p>
                        <p class="text-[10px] text-emerald-700 font-bold"><span class="font-black">✓ Positivo:</span> ${t.positivo}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderAnatomeSVG(region, data) {
            const cont = document.getElementById('anat-svg-container');
            const svgs = {
                rodilla: `<svg viewBox="0 0 300 400" class="w-full max-w-xs" xmlns="http://www.w3.org/2000/svg" style="max-height:360px">
                    <defs><style>
                        .anat-estructura-svg { cursor:pointer; transition: all 0.2s; }
                        .anat-estructura-svg:hover { filter: brightness(1.15) drop-shadow(0 0 4px rgba(99,102,241,0.5)); }
                        .anat-activo { filter: drop-shadow(0 0 8px #10b981) brightness(1.2); }
                        .anat-label { font-family: sans-serif; font-size: 9px; font-weight: 700; pointer-events: none; }
                        .hueso-svg { cursor:pointer; transition: all 0.2s; }
                        .hueso-svg:hover { filter: brightness(0.9) drop-shadow(0 0 5px rgba(100,116,139,0.6)); }
                    </style></defs>
                    <!-- Fémur CLICKEABLE -->
                    <ellipse id="svg-femur" class="hueso-svg" cx="150" cy="68" rx="55" ry="62" fill="#dde3ea" stroke="#94a3b8" stroke-width="2.5" onclick="seleccionarEstructura('femur')"/>
                    <text x="150" y="65" text-anchor="middle" class="anat-label" fill="#475569">Fémur</text>
                    <text x="150" y="75" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Tibia CLICKEABLE -->
                    <ellipse id="svg-tibia_r" class="hueso-svg" cx="150" cy="315" rx="50" ry="58" fill="#dde3ea" stroke="#94a3b8" stroke-width="2.5" onclick="seleccionarEstructura('tibia_r')"/>
                    <text x="150" y="312" text-anchor="middle" class="anat-label" fill="#475569">Tibia</text>
                    <text x="150" y="322" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Espacio articular -->
                    <rect x="95" y="128" width="110" height="14" rx="4" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/>
                    <!-- Menisco medial -->
                    <path id="svg-menisco_medial" class="anat-estructura-svg" d="M100 132 Q118 125 118 140 Q100 145 100 132Z" fill="#6366f1" opacity="0.8" onclick="seleccionarEstructura('menisco_medial')"/>
                    <text x="65" y="133" class="anat-label" fill="#6366f1">M.Med</text>
                    <!-- Menisco lateral -->
                    <path id="svg-menisco_lateral" class="anat-estructura-svg" d="M200 132 Q182 125 182 140 Q200 145 200 132Z" fill="#8b5cf6" opacity="0.8" onclick="seleccionarEstructura('menisco_lateral')"/>
                    <text x="202" y="133" class="anat-label" fill="#8b5cf6">M.Lat</text>
                    <!-- LCA -->
                    <line id="svg-lca" class="anat-estructura-svg" x1="140" y1="130" x2="160" y2="142" stroke="#ef4444" stroke-width="7" stroke-linecap="round" onclick="seleccionarEstructura('lca')"/>
                    <text x="118" y="118" class="anat-label" fill="#ef4444">LCA</text>
                    <!-- LCP -->
                    <line id="svg-lcp" class="anat-estructura-svg" x1="160" y1="130" x2="140" y2="142" stroke="#f97316" stroke-width="7" stroke-linecap="round" onclick="seleccionarEstructura('lcp')"/>
                    <text x="162" y="118" class="anat-label" fill="#f97316">LCP</text>
                    <!-- LCI -->
                    <line id="svg-lco" class="anat-estructura-svg" x1="97" y1="115" x2="97" y2="155" stroke="#0ea5e9" stroke-width="6" stroke-linecap="round" onclick="seleccionarEstructura('lco')"/>
                    <text x="56" y="148" class="anat-label" fill="#0ea5e9">LCI</text>
                    <!-- Rótula -->
                    <ellipse id="svg-rotula" class="anat-estructura-svg" cx="150" cy="135" rx="20" ry="14" fill="#10b981" opacity="0.9" onclick="seleccionarEstructura('rotula')"/>
                    <text x="150" y="139" text-anchor="middle" class="anat-label" fill="white">Rótula</text>
                    <!-- Leyenda -->
                    <rect x="8" y="346" width="284" height="48" rx="8" fill="#f8fafc" stroke="#e2e8f0"/>
                    <text x="16" y="360" class="anat-label" fill="#64748b">Haz clic en cada estructura — huesos grises también clickeables</text>
                    <circle cx="16" cy="374" r="4" fill="#dde3ea" stroke="#94a3b8"/><text x="24" y="377" class="anat-label" fill="#64748b">Hueso</text>
                    <circle cx="68" cy="374" r="4" fill="#ef4444"/><text x="76" y="377" class="anat-label" fill="#64748b">LCA</text>
                    <circle cx="104" cy="374" r="4" fill="#f97316"/><text x="112" y="377" class="anat-label" fill="#64748b">LCP</text>
                    <circle cx="140" cy="374" r="4" fill="#6366f1"/><text x="148" y="377" class="anat-label" fill="#64748b">M.Med</text>
                    <circle cx="184" cy="374" r="4" fill="#8b5cf6"/><text x="192" y="377" class="anat-label" fill="#64748b">M.Lat</text>
                    <circle cx="228" cy="374" r="4" fill="#10b981"/><text x="236" y="377" class="anat-label" fill="#64748b">Rótula</text>
                </svg>`,
                hombro: `<svg viewBox="0 0 300 360" class="w-full max-w-xs" xmlns="http://www.w3.org/2000/svg" style="max-height:340px">
                    <defs><style>.anat-estructura-svg{cursor:pointer;transition:all 0.2s}.anat-estructura-svg:hover{filter:brightness(1.15) drop-shadow(0 0 4px rgba(99,102,241,0.5))}.anat-activo{filter:drop-shadow(0 0 8px #10b981) brightness(1.2)}.anat-label{font-family:sans-serif;font-size:9px;font-weight:700;pointer-events:none}.hueso-svg{cursor:pointer;transition:all 0.2s}.hueso-svg:hover{filter:brightness(0.88) drop-shadow(0 0 5px rgba(100,116,139,0.6))}</style></defs>
                    <!-- Escápula CLICKEABLE -->
                    <path id="svg-escapula" class="hueso-svg" d="M60 80 Q100 60 180 90 Q200 130 190 180 Q160 210 120 200 Q80 180 60 140 Z" fill="#dde3ea" stroke="#94a3b8" stroke-width="2.5" onclick="seleccionarEstructura('escapula')"/>
                    <text x="112" y="148" text-anchor="middle" class="anat-label" fill="#475569">Escápula</text>
                    <text x="112" y="158" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Acromion parte de escápula (también clickeable) -->
                    <rect id="svg-escapula2" class="hueso-svg" x="155" y="68" width="55" height="18" rx="8" fill="#ccd4de" stroke="#94a3b8" stroke-width="1.5" onclick="seleccionarEstructura('escapula')"/>
                    <text x="182" y="80" text-anchor="middle" class="anat-label" fill="#475569">Acromion</text>
                    <!-- Clavícula CLICKEABLE -->
                    <line id="svg-clavicula" class="hueso-svg" x1="215" y1="73" x2="280" y2="55" stroke="#ccd4de" stroke-width="12" stroke-linecap="round" onclick="seleccionarEstructura('clavicula')" style="pointer-events:stroke"/>
                    <text x="252" y="50" class="anat-label" fill="#475569">Clavícula ▶</text>
                    <!-- Articulación AC -->
                    <ellipse id="svg-acromio" class="anat-estructura-svg" cx="213" cy="72" rx="10" ry="8" fill="#f59e0b" opacity="0.9" onclick="seleccionarEstructura('acromio')"/>
                    <text x="196" y="66" class="anat-label" fill="#92400e">AC</text>
                    <!-- Húmero CLICKEABLE -->
                    <ellipse id="svg-humero" class="hueso-svg" cx="200" cy="195" rx="35" ry="30" fill="#dde3ea" stroke="#94a3b8" stroke-width="2.5" onclick="seleccionarEstructura('humero')"/>
                    <rect class="hueso-svg" x="182" y="215" width="36" height="90" rx="10" fill="#dde3ea" stroke="#94a3b8" stroke-width="1.5" onclick="seleccionarEstructura('humero')"/>
                    <text x="200" y="192" text-anchor="middle" class="anat-label" fill="#475569">Húmero</text>
                    <text x="200" y="202" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <text x="200" y="268" text-anchor="middle" class="anat-label" fill="#64748b">Diáfisis</text>
                    <!-- GH Cápsula -->
                    <ellipse id="svg-glenohumeral" class="anat-estructura-svg" cx="175" cy="175" rx="22" ry="28" fill="#6366f1" opacity="0.5" onclick="seleccionarEstructura('glenohumeral')"/>
                    <text x="118" y="178" class="anat-label" fill="#4f46e5">GH</text>
                    <!-- Manguito rotador -->
                    <path id="svg-manguito" class="anat-estructura-svg" d="M158 148 Q185 135 210 155 Q205 170 185 168 Q165 165 158 148Z" fill="#ef4444" opacity="0.75" onclick="seleccionarEstructura('manguito')"/>
                    <text x="175" y="145" text-anchor="middle" class="anat-label" fill="#dc2626">Manguito</text>
                    <!-- Bíceps PLB -->
                    <path id="svg-biceps" class="anat-estructura-svg" d="M185 168 Q188 185 190 230" stroke="#10b981" stroke-width="5" fill="none" stroke-linecap="round" onclick="seleccionarEstructura('biceps')" style="pointer-events:stroke"/>
                    <text x="194" y="200" class="anat-label" fill="#059669">Bíceps</text>
                    <!-- Leyenda -->
                    <rect x="8" y="316" width="284" height="36" rx="8" fill="#f8fafc" stroke="#e2e8f0"/>
                    <circle cx="16" cy="330" r="4" fill="#dde3ea" stroke="#94a3b8"/><text x="24" y="333" class="anat-label" fill="#64748b">Hueso</text>
                    <circle cx="60" cy="330" r="4" fill="#ef4444"/><text x="68" y="333" class="anat-label" fill="#64748b">Manguito</text>
                    <circle cx="116" cy="330" r="4" fill="#10b981"/><text x="124" y="333" class="anat-label" fill="#64748b">Bíceps</text>
                    <circle cx="160" cy="330" r="4" fill="#f59e0b"/><text x="168" y="333" class="anat-label" fill="#64748b">AC</text>
                    <circle cx="192" cy="330" r="4" fill="#6366f1"/><text x="200" y="333" class="anat-label" fill="#64748b">Cápsula GH</text>
                    <text x="16" y="347" class="anat-label" fill="#94a3b8">Húmero, Escápula y Clavícula también son clickeables</text>
                </svg>`,
                tobillo: `<svg viewBox="0 0 300 360" class="w-full max-w-xs" xmlns="http://www.w3.org/2000/svg" style="max-height:340px">
                    <defs><style>.anat-estructura-svg{cursor:pointer;transition:all 0.2s}.anat-estructura-svg:hover{filter:brightness(1.15) drop-shadow(0 0 4px rgba(99,102,241,0.5))}.anat-activo{filter:drop-shadow(0 0 8px #10b981) brightness(1.2)}.anat-label{font-family:sans-serif;font-size:9px;font-weight:700;pointer-events:none}.hueso-svg{cursor:pointer;transition:all 0.2s}.hueso-svg:hover{filter:brightness(0.88) drop-shadow(0 0 5px rgba(100,116,139,0.6))}</style></defs>
                    <!-- Tibia CLICKEABLE -->
                    <rect id="svg-tibia_t" class="hueso-svg" x="100" y="20" width="40" height="120" rx="8" fill="#dde3ea" stroke="#94a3b8" stroke-width="2" onclick="seleccionarEstructura('tibia_t')"/>
                    <text x="120" y="68" text-anchor="middle" class="anat-label" fill="#475569">Tibia</text>
                    <text x="120" y="78" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Peroné CLICKEABLE -->
                    <rect id="svg-perone_t" class="hueso-svg" x="160" y="30" width="28" height="100" rx="8" fill="#dde3ea" stroke="#94a3b8" stroke-width="2" onclick="seleccionarEstructura('perone_t')"/>
                    <text x="174" y="68" text-anchor="middle" class="anat-label" fill="#475569">Peroné</text>
                    <text x="174" y="78" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Astrágalo CLICKEABLE -->
                    <ellipse id="svg-astragalo" class="hueso-svg" cx="130" cy="168" rx="45" ry="28" fill="#dde3ea" stroke="#94a3b8" stroke-width="2" onclick="seleccionarEstructura('astragalo')"/>
                    <text x="130" y="165" text-anchor="middle" class="anat-label" fill="#475569">Astrágalo</text>
                    <text x="130" y="175" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Calcáneo CLICKEABLE -->
                    <ellipse id="svg-calcaneo" class="hueso-svg" cx="115" cy="238" rx="50" ry="28" fill="#dde3ea" stroke="#94a3b8" stroke-width="2" onclick="seleccionarEstructura('calcaneo')"/>
                    <text x="115" y="235" text-anchor="middle" class="anat-label" fill="#475569">Calcáneo</text>
                    <text x="115" y="245" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- LPAA -->
                    <line id="svg-pla" class="anat-estructura-svg" x1="172" y1="128" x2="168" y2="160" stroke="#ef4444" stroke-width="6" stroke-linecap="round" onclick="seleccionarEstructura('pla')"/>
                    <text x="176" y="145" class="anat-label" fill="#dc2626">LPAA</text>
                    <!-- Aquiles -->
                    <line id="svg-aquiles" class="anat-estructura-svg" x1="155" y1="140" x2="158" y2="218" stroke="#f97316" stroke-width="7" stroke-linecap="round" onclick="seleccionarEstructura('aquiles')"/>
                    <text x="162" y="183" class="anat-label" fill="#ea580c">Aquiles</text>
                    <!-- Fascia plantar -->
                    <path id="svg-fascia" class="anat-estructura-svg" d="M72 256 Q115 268 185 263 Q190 278 180 286 Q115 283 68 268Z" fill="#10b981" opacity="0.75" onclick="seleccionarEstructura('fascia')"/>
                    <text x="120" y="278" text-anchor="middle" class="anat-label" fill="#065f46">Fascia Plantar</text>
                    <!-- Tibial posterior -->
                    <path id="svg-tibpost" class="anat-estructura-svg" d="M104 140 Q90 165 88 208" stroke="#6366f1" stroke-width="5" fill="none" stroke-linecap="round" onclick="seleccionarEstructura('tibpost')" style="pointer-events:stroke"/>
                    <text x="44" y="182" class="anat-label" fill="#4f46e5">Tib.Post</text>
                    <!-- Leyenda -->
                    <rect x="8" y="314" width="284" height="38" rx="8" fill="#f8fafc" stroke="#e2e8f0"/>
                    <circle cx="16" cy="328" r="4" fill="#dde3ea" stroke="#94a3b8"/><text x="24" y="331" class="anat-label" fill="#64748b">Hueso</text>
                    <circle cx="60" cy="328" r="4" fill="#ef4444"/><text x="68" y="331" class="anat-label" fill="#64748b">LPAA</text>
                    <circle cx="100" cy="328" r="4" fill="#f97316"/><text x="108" y="331" class="anat-label" fill="#64748b">Aquiles</text>
                    <circle cx="148" cy="328" r="4" fill="#10b981"/><text x="156" y="331" class="anat-label" fill="#64748b">Fascia</text>
                    <circle cx="192" cy="328" r="4" fill="#6366f1"/><text x="200" y="331" class="anat-label" fill="#64748b">Tib.Post</text>
                    <text x="16" y="345" class="anat-label" fill="#94a3b8">Astrágalo, Calcáneo, Tibia y Peroné también clickeables</text>
                </svg>`,
                columna: `<svg viewBox="0 0 300 380" class="w-full max-w-xs" xmlns="http://www.w3.org/2000/svg" style="max-height:360px">
                    <defs><style>.anat-estructura-svg{cursor:pointer;transition:all 0.2s}.anat-estructura-svg:hover{filter:brightness(1.15) drop-shadow(0 0 4px rgba(99,102,241,0.5))}.anat-activo{filter:drop-shadow(0 0 8px #10b981) brightness(1.2)}.anat-label{font-family:sans-serif;font-size:9px;font-weight:700;pointer-events:none}.hueso-svg{cursor:pointer;transition:all 0.2s}.hueso-svg:hover{filter:brightness(0.88) drop-shadow(0 0 5px rgba(100,116,139,0.6))}</style></defs>
                    <!-- L1 -->
                    <rect class="hueso-svg" x="95" y="30" width="80" height="28" rx="6" fill="#dde3ea" stroke="#94a3b8" stroke-width="1.5" onclick="seleccionarEstructura('vertebra')"/>
                    <text x="135" y="45" text-anchor="middle" class="anat-label" fill="#475569">L1</text>
                    <rect class="hueso-svg" x="175" y="34" width="22" height="20" rx="4" fill="#ccd4de" stroke="#94a3b8" stroke-width="1" onclick="seleccionarEstructura('vertebra')"/>
                    <!-- Disco L1-L2 -->
                    <rect class="anat-estructura-svg" x="100" y="58" width="70" height="12" rx="3" fill="#6366f1" opacity="0.55" onclick="seleccionarEstructura('disco')"/>
                    <!-- Faceta L1 -->
                    <rect id="svg-facetas" class="anat-estructura-svg" x="82" y="34" width="14" height="12" rx="3" fill="#f97316" opacity="0.8" onclick="seleccionarEstructura('facetas')"/>
                    <!-- L2 -->
                    <rect class="hueso-svg" x="95" y="74" width="80" height="28" rx="6" fill="#dde3ea" stroke="#94a3b8" stroke-width="1.5" onclick="seleccionarEstructura('vertebra')"/>
                    <text x="135" y="89" text-anchor="middle" class="anat-label" fill="#475569">L2</text>
                    <rect class="hueso-svg" x="175" y="78" width="22" height="20" rx="4" fill="#ccd4de" stroke="#94a3b8" stroke-width="1" onclick="seleccionarEstructura('vertebra')"/>
                    <!-- Disco L2-L3 -->
                    <rect class="anat-estructura-svg" x="100" y="102" width="70" height="12" rx="3" fill="#6366f1" opacity="0.55" onclick="seleccionarEstructura('disco')"/>
                    <!-- Faceta L2 -->
                    <rect class="anat-estructura-svg" x="82" y="78" width="14" height="12" rx="3" fill="#f97316" opacity="0.8" onclick="seleccionarEstructura('facetas')"/>
                    <!-- L3 (destacada) -->
                    <rect id="svg-vertebra" class="hueso-svg" x="95" y="118" width="80" height="28" rx="6" fill="#c8d4e0" stroke="#94a3b8" stroke-width="2.5" onclick="seleccionarEstructura('vertebra')"/>
                    <text x="135" y="133" text-anchor="middle" class="anat-label" fill="#475569">L3</text>
                    <rect class="hueso-svg" x="175" y="122" width="22" height="20" rx="4" fill="#ccd4de" stroke="#94a3b8" stroke-width="1" onclick="seleccionarEstructura('vertebra')"/>
                    <!-- Disco L3-L4 (destacado) -->
                    <rect id="svg-disco" class="anat-estructura-svg" x="100" y="146" width="70" height="12" rx="3" fill="#6366f1" opacity="0.85" onclick="seleccionarEstructura('disco')"/>
                    <!-- Faceta L3 -->
                    <rect class="anat-estructura-svg" x="82" y="122" width="14" height="12" rx="3" fill="#f97316" opacity="0.8" onclick="seleccionarEstructura('facetas')"/>
                    <!-- L4 -->
                    <rect class="hueso-svg" x="95" y="162" width="80" height="28" rx="6" fill="#dde3ea" stroke="#94a3b8" stroke-width="1.5" onclick="seleccionarEstructura('vertebra')"/>
                    <text x="135" y="177" text-anchor="middle" class="anat-label" fill="#475569">L4</text>
                    <rect class="hueso-svg" x="175" y="166" width="22" height="20" rx="4" fill="#ccd4de" stroke="#94a3b8" stroke-width="1" onclick="seleccionarEstructura('vertebra')"/>
                    <!-- Disco L4-L5 -->
                    <rect class="anat-estructura-svg" x="100" y="190" width="70" height="12" rx="3" fill="#6366f1" opacity="0.55" onclick="seleccionarEstructura('disco')"/>
                    <!-- Faceta L4 -->
                    <rect class="anat-estructura-svg" x="82" y="166" width="14" height="12" rx="3" fill="#f97316" opacity="0.8" onclick="seleccionarEstructura('facetas')"/>
                    <!-- L5 -->
                    <rect class="hueso-svg" x="95" y="206" width="80" height="28" rx="6" fill="#dde3ea" stroke="#94a3b8" stroke-width="1.5" onclick="seleccionarEstructura('vertebra')"/>
                    <text x="135" y="221" text-anchor="middle" class="anat-label" fill="#475569">L5</text>
                    <rect class="hueso-svg" x="175" y="210" width="22" height="20" rx="4" fill="#ccd4de" stroke="#94a3b8" stroke-width="1" onclick="seleccionarEstructura('vertebra')"/>
                    <!-- Faceta L5 -->
                    <rect class="anat-estructura-svg" x="82" y="210" width="14" height="12" rx="3" fill="#f97316" opacity="0.8" onclick="seleccionarEstructura('facetas')"/>
                    <!-- Etiquetas laterales -->
                    <text x="57" y="48" class="anat-label" fill="#ea580c">Facetas</text>
                    <text x="57" y="104" class="anat-label" fill="#4f46e5">Disco IV</text>
                    <!-- Nervio ciático -->
                    <path id="svg-nervio_ciatico" class="anat-estructura-svg" d="M130 236 Q140 260 130 295 Q125 310 120 330" stroke="#ef4444" stroke-width="4" fill="none" stroke-linecap="round" onclick="seleccionarEstructura('nervio_ciatico')" style="pointer-events:stroke"/>
                    <text x="143" y="278" class="anat-label" fill="#dc2626">Ciático</text>
                    <!-- Sacro CLICKEABLE -->
                    <ellipse id="svg-sacro" class="hueso-svg" cx="135" cy="258" rx="38" ry="22" fill="#dde3ea" stroke="#94a3b8" stroke-width="2" onclick="seleccionarEstructura('sacro')"/>
                    <text x="135" y="255" text-anchor="middle" class="anat-label" fill="#475569">Sacro</text>
                    <text x="135" y="265" text-anchor="middle" class="anat-label" fill="#64748b">clic</text>
                    <!-- ASI -->
                    <ellipse id="svg-sacroiliaca" class="anat-estructura-svg" cx="90" cy="254" rx="14" ry="20" fill="#10b981" opacity="0.75" onclick="seleccionarEstructura('sacroiliaca')"/>
                    <text x="50" y="258" class="anat-label" fill="#065f46">ASI</text>
                    <!-- Leyenda -->
                    <rect x="8" y="292" width="284" height="82" rx="8" fill="#f8fafc" stroke="#e2e8f0"/>
                    <text x="16" y="306" class="anat-label" fill="#94a3b8">Todas las vertebras, discos y facetas son clickeables</text>
                    <circle cx="16" cy="320" r="4" fill="#dde3ea" stroke="#94a3b8"/><text x="24" y="323" class="anat-label" fill="#64748b">Vertebra (L1-L5)</text>
                    <circle cx="108" cy="320" r="4" fill="#6366f1"/><text x="116" y="323" class="anat-label" fill="#64748b">Disco IV</text>
                    <circle cx="156" cy="320" r="4" fill="#f97316"/><text x="164" y="323" class="anat-label" fill="#64748b">Facetas</text>
                    <circle cx="16" cy="338" r="4" fill="#ef4444"/><text x="24" y="341" class="anat-label" fill="#64748b">Nervio Ciatico</text>
                    <circle cx="108" cy="338" r="4" fill="#dde3ea" stroke="#94a3b8"/><text x="116" y="341" class="anat-label" fill="#64748b">Sacro</text>
                    <circle cx="156" cy="338" r="4" fill="#10b981"/><text x="164" y="341" class="anat-label" fill="#64748b">ASI</text>
                    <text x="16" y="358" class="anat-label" fill="#94a3b8">L3 y Disco L3-L4 destacados como referencia anatomica</text>
                    <text x="16" y="368" class="anat-label" fill="#94a3b8">Apofisis espinosas (grises) tambien son clickeables</text>
                </svg>`,
                cadera: `<svg viewBox="0 0 300 360" class="w-full max-w-xs" xmlns="http://www.w3.org/2000/svg" style="max-height:340px">
                    <defs><style>.anat-estructura-svg{cursor:pointer;transition:all 0.2s}.anat-estructura-svg:hover{filter:brightness(1.15) drop-shadow(0 0 4px rgba(99,102,241,0.5))}.anat-activo{filter:drop-shadow(0 0 8px #10b981) brightness(1.2)}.anat-label{font-family:sans-serif;font-size:9px;font-weight:700;pointer-events:none}.hueso-svg{cursor:pointer;transition:all 0.2s}.hueso-svg:hover{filter:brightness(0.88) drop-shadow(0 0 5px rgba(100,116,139,0.6))}</style></defs>
                    <!-- Pelvis CLICKEABLE -->
                    <path id="svg-pelvis" class="hueso-svg" d="M50 80 Q150 40 250 80 Q270 130 240 180 Q200 210 150 215 Q100 210 60 180 Q30 130 50 80Z" fill="#dde3ea" stroke="#94a3b8" stroke-width="2.5" onclick="seleccionarEstructura('pelvis')"/>
                    <text x="150" y="118" text-anchor="middle" class="anat-label" fill="#475569">Pelvis</text>
                    <text x="150" y="128" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Acetábulo -->
                    <circle cx="150" cy="190" r="30" fill="#f1f5f9" stroke="#94a3b8" stroke-width="2"/>
                    <!-- Labrum -->
                    <circle id="svg-labrum" class="anat-estructura-svg" cx="150" cy="190" r="33" fill="none" stroke="#6366f1" stroke-width="8" stroke-dasharray="4 2" onclick="seleccionarEstructura('labrum')"/>
                    <text x="194" y="175" class="anat-label" fill="#4f46e5">Labrum</text>
                    <!-- Cabeza femoral CLICKEABLE -->
                    <circle id="svg-cabeza_femoral" class="hueso-svg" cx="150" cy="190" r="24" fill="#ccd4de" stroke="#94a3b8" stroke-width="2.5" onclick="seleccionarEstructura('cabeza_femoral')"/>
                    <text x="150" y="187" text-anchor="middle" class="anat-label" fill="#475569">Cab.</text>
                    <text x="150" y="197" text-anchor="middle" class="anat-label" fill="#475569">Fem.</text>
                    <!-- Cuello + diáfisis femoral CLICKEABLE -->
                    <path id="svg-cabeza_femoral2" class="hueso-svg" d="M150 214 Q165 240 170 295 Q148 297 128 295 Q133 240 150 214Z" fill="#dde3ea" stroke="#94a3b8" stroke-width="1.5" onclick="seleccionarEstructura('cabeza_femoral')"/>
                    <text x="150" y="262" text-anchor="middle" class="anat-label" fill="#64748b">Fémur ▶ clic</text>
                    <!-- Isquiotibiales -->
                    <path id="svg-isquiotibiales" class="anat-estructura-svg" d="M78 204 Q66 228 72 278" stroke="#f97316" stroke-width="6" fill="none" stroke-linecap="round" onclick="seleccionarEstructura('isquiotibiales')" style="pointer-events:stroke"/>
                    <text x="24" y="244" class="anat-label" fill="#ea580c">Isquiotib.</text>
                    <!-- Piriforme -->
                    <path id="svg-piriforme" class="anat-estructura-svg" d="M95 160 Q130 148 155 165" stroke="#ef4444" stroke-width="5" fill="none" stroke-linecap="round" onclick="seleccionarEstructura('piriforme')" style="pointer-events:stroke"/>
                    <text x="88" y="148" class="anat-label" fill="#dc2626">Piriforme</text>
                    <!-- ITB -->
                    <path id="svg-it_band" class="anat-estructura-svg" d="M222 188 Q232 224 228 280" stroke="#10b981" stroke-width="6" fill="none" stroke-linecap="round" onclick="seleccionarEstructura('it_band')" style="pointer-events:stroke"/>
                    <text x="234" y="238" class="anat-label" fill="#065f46">ITB</text>
                    <!-- Leyenda -->
                    <rect x="8" y="312" width="284" height="40" rx="8" fill="#f8fafc" stroke="#e2e8f0"/>
                    <circle cx="16" cy="326" r="4" fill="#dde3ea" stroke="#94a3b8"/><text x="24" y="329" class="anat-label" fill="#64748b">Hueso</text>
                    <circle cx="60" cy="326" r="4" fill="#6366f1"/><text x="68" y="329" class="anat-label" fill="#64748b">Labrum</text>
                    <circle cx="112" cy="326" r="4" fill="#f97316"/><text x="120" y="329" class="anat-label" fill="#64748b">Isquiotib.</text>
                    <circle cx="172" cy="326" r="4" fill="#ef4444"/><text x="180" y="329" class="anat-label" fill="#64748b">Piriforme</text>
                    <circle cx="228" cy="326" r="4" fill="#10b981"/><text x="236" y="329" class="anat-label" fill="#64748b">ITB</text>
                    <text x="16" y="344" class="anat-label" fill="#94a3b8">Pelvis y Fémur (cabeza + diáfisis) son clickeables</text>
                </svg>`,
                codo: `<svg viewBox="0 0 300 360" class="w-full max-w-xs" xmlns="http://www.w3.org/2000/svg" style="max-height:340px">
                    <defs><style>.anat-estructura-svg{cursor:pointer;transition:all 0.2s}.anat-estructura-svg:hover{filter:brightness(1.15) drop-shadow(0 0 4px rgba(99,102,241,0.5))}.anat-activo{filter:drop-shadow(0 0 8px #10b981) brightness(1.2)}.anat-label{font-family:sans-serif;font-size:9px;font-weight:700;pointer-events:none}.hueso-svg{cursor:pointer;transition:all 0.2s}.hueso-svg:hover{filter:brightness(0.88) drop-shadow(0 0 5px rgba(100,116,139,0.6))}</style></defs>
                    <!-- Húmero distal CLICKEABLE -->
                    <rect id="svg-humero_codo" class="hueso-svg" x="100" y="20" width="70" height="100" rx="10" fill="#dde3ea" stroke="#94a3b8" stroke-width="2" onclick="seleccionarEstructura('humero_codo')"/>
                    <text x="135" y="62" text-anchor="middle" class="anat-label" fill="#475569">Húmero</text>
                    <text x="135" y="72" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Epicóndilo lateral CLICKEABLE -->
                    <ellipse id="svg-epi_lat" class="anat-estructura-svg" cx="175" cy="115" rx="18" ry="14" fill="#ef4444" opacity="0.85" onclick="seleccionarEstructura('epi_lat')"/>
                    <text x="195" y="118" class="anat-label" fill="#dc2626">Lat</text>
                    <!-- Epicóndilo medial CLICKEABLE -->
                    <ellipse id="svg-epi_med" class="anat-estructura-svg" cx="95" cy="115" rx="18" ry="14" fill="#f97316" opacity="0.85" onclick="seleccionarEstructura('epi_med')"/>
                    <text x="56" y="118" class="anat-label" fill="#ea580c">Med</text>
                    <!-- Radio CLICKEABLE -->
                    <rect id="svg-radio_cubito" class="hueso-svg" x="105" y="130" width="30" height="120" rx="8" fill="#dde3ea" stroke="#94a3b8" stroke-width="2" onclick="seleccionarEstructura('radio_cubito')"/>
                    <text x="120" y="188" text-anchor="middle" class="anat-label" fill="#475569">Radio</text>
                    <text x="120" y="198" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Cúbito CLICKEABLE -->
                    <rect class="hueso-svg" x="145" y="130" width="28" height="120" rx="8" fill="#dde3ea" stroke="#94a3b8" stroke-width="2" onclick="seleccionarEstructura('radio_cubito')"/>
                    <text x="159" y="188" text-anchor="middle" class="anat-label" fill="#475569">Cúbito</text>
                    <text x="159" y="198" text-anchor="middle" class="anat-label" fill="#64748b">▶ clic</text>
                    <!-- Muñeca CLICKEABLE -->
                    <rect class="hueso-svg" x="90" y="256" width="90" height="38" rx="8" fill="#dde3ea" stroke="#94a3b8" stroke-width="2" onclick="seleccionarEstructura('radio_cubito')"/>
                    <text x="135" y="279" text-anchor="middle" class="anat-label" fill="#475569">Muñeca ▶ clic</text>
                    <!-- Nervio mediano -->
                    <path id="svg-tunel_carpo" class="anat-estructura-svg" d="M128 252 Q130 265 131 278" stroke="#6366f1" stroke-width="6" fill="none" stroke-linecap="round" onclick="seleccionarEstructura('tunel_carpo')" style="pointer-events:stroke"/>
                    <text x="106" y="260" class="anat-label" fill="#4f46e5">Mediano</text>
                    <!-- TFCC -->
                    <ellipse id="svg-triangular" class="anat-estructura-svg" cx="168" cy="260" rx="14" ry="10" fill="#10b981" opacity="0.85" onclick="seleccionarEstructura('triangular')"/>
                    <text x="183" y="263" class="anat-label" fill="#065f46">TFCC</text>
                    <!-- Leyenda -->
                    <rect x="8" y="306" width="284" height="46" rx="8" fill="#f8fafc" stroke="#e2e8f0"/>
                    <circle cx="16" cy="320" r="4" fill="#dde3ea" stroke="#94a3b8"/><text x="24" y="323" class="anat-label" fill="#64748b">Hueso</text>
                    <circle cx="60" cy="320" r="4" fill="#ef4444"/><text x="68" y="323" class="anat-label" fill="#64748b">Epi.Lat</text>
                    <circle cx="108" cy="320" r="4" fill="#f97316"/><text x="116" y="323" class="anat-label" fill="#64748b">Epi.Med</text>
                    <circle cx="160" cy="320" r="4" fill="#6366f1"/><text x="168" y="323" class="anat-label" fill="#64748b">T.Carpiano</text>
                    <circle cx="236" cy="320" r="4" fill="#10b981"/><text x="244" y="323" class="anat-label" fill="#64748b">TFCC</text>
                    <text x="16" y="338" class="anat-label" fill="#94a3b8">Húmero, Radio, Cúbito y Muñeca también son clickeables</text>
                    <text x="16" y="348" class="anat-label" fill="#94a3b8">Radio/Cúbito → info de fracturas de muñeca (Colles, escafoides)</text>
                </svg>`
            };
            cont.innerHTML = svgs[region] || `<div class="text-center text-slate-400 text-sm p-8">Diagrama no disponible para esta región</div>`;
        }

        // Dark mode para la sección anatomía
        // (se maneja automáticamente por el sistema de dark mode existente)

        // ============================================================
        // Init API Key label
        (function initApiKeyLabel() {
            if (localStorage.getItem('jelian_anthropic_key')) {
                const lbl = document.getElementById('sidebar-apikey-label');
                if (lbl) lbl.textContent = '✓ API Key IA';
            }
        })();

        // Init PIN
        (function initPin() {
            const saved = localStorage.getItem(PIN_KEY);
            // Migrate legacy plain-text PIN to hashed
            const legacyPin = localStorage.getItem('jelian_pin');
            if (legacyPin && !saved) {
                // Legacy PIN exists but no hashed one yet — ask user to re-set it
                console.log('[JelianFT] PIN legacy detectado. Se pedirá reconfiguración.');
                localStorage.removeItem('jelian_pin');
                unlockApp();
                setTimeout(() => showToast('⚠️ Reconfigura tu PIN desde Ajustes (mejora de seguridad).'), 1500);
            } else if (!saved) {
                unlockApp();
            }
        })();

        // --- _mostrarBannerError: UI feedback de errores de Supabase ---
        function _mostrarBannerError(msg, code) {
            const banner = document.getElementById('supabase-banner');
            if (!banner) return;
            let html, cls;
            if (code === '42P01' || (msg && msg.includes('does not exist'))) {
                cls = 'mx-auto max-w-7xl mb-6 px-4 py-3 bg-amber-50 border border-amber-200 rounded-2xl text-xs font-bold text-amber-700 flex items-center gap-2';
                html = '⚠️ La tabla <strong>pacientes</strong> no existe en Supabase. Créala o importa un backup.';
            } else if (code === 'PGRST301' || (msg && (msg.includes('permission') || msg.includes('policy') || msg.includes('JWT')))) {
                cls = 'mx-auto max-w-7xl mb-6 px-4 py-3 bg-amber-50 border border-amber-200 rounded-2xl text-xs font-bold text-amber-700 flex items-center gap-2';
                html = '🔒 Sin permisos en Supabase — Revisa las <strong>RLS Policies</strong> y activa acceso anónimo en la tabla <code>pacientes</code>.';
            } else {
                cls = 'mx-auto max-w-7xl mb-6 px-4 py-3 bg-rose-50 border border-rose-200 rounded-2xl text-xs font-bold text-rose-700 flex items-center gap-2';
                html = '❌ Error Supabase: ' + (msg || 'Error desconocido') + ' <button onclick="this.parentElement.classList.add(&quot;hidden&quot;)" class="ml-auto text-rose-400 hover:text-rose-600 font-black text-sm">✕</button>';
            }
            banner.className = cls;
            banner.innerHTML = html;
            banner.classList.remove('hidden');
        }

        // --- INIT SUPABASE ---
        (async function initApp() {
            if (IS_SANDBOX) {
                // Vista previa de Claude: omitir llamadas de red, solo renderizar UI vacía
                console.info('[JelianFT] Modo preview sandbox — Supabase desactivado.');
                try { renderCalendario(); } catch(e) {}
                renderBiblioteca();
                updateDashboard();
                loadNotes();
                return;
            }
            try {
                await detectarSchemaDB();
                await cargarPacientesDB();
            } catch(e) {
                console.error('[JelianFT] Error en init:', e.message);
                _mostrarBannerError(e.message);
            }
            try { renderCalendario(); } catch(e) { console.warn('[JelianFT] renderCalendario:', e.message); }
            renderBiblioteca();
            updateDashboard();
            loadNotes();
            try { renderEspera(); } catch(e) {}
        })();


        // ============================================================
        // PWA — INSTALL PROMPT
        // ============================================================
        let _pwaPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            _pwaPrompt = e;
            const btn = document.getElementById('pwa-install-btn');
            if (btn) btn.classList.remove('hidden');
        });
        function instalarPWA() {
            if (!_pwaPrompt) { showToast('Para instalar: abre el menu del navegador y selecciona "Agregar a pantalla de inicio"'); return; }
            _pwaPrompt.prompt();
            _pwaPrompt.userChoice.then(r => {
                if (r.outcome === 'accepted') {
                    showToast('App instalada correctamente');
                    const btn = document.getElementById('pwa-install-btn');
                    if (btn) btn.classList.add('hidden');
                }
                _pwaPrompt = null;
            });
        }
        // ============================================================
        // INDICADOR DE CONEXIÓN (offline/online)
        // ============================================================
        function _actualizarBadgeConexion() {
            const badge = document.getElementById('offline-badge');
            const dot = document.getElementById('offline-dot');
            const online = navigator.onLine;
            if (badge) badge.classList.toggle('hidden', online);
            if (dot)   dot.classList.toggle('hidden', online);
        }
        window.addEventListener('online',  _actualizarBadgeConexion);
        window.addEventListener('offline', () => {
            _actualizarBadgeConexion();
            showToast('⚠️ Sin conexión — los datos se guardarán cuando vuelva la red', true);
        });
        window.addEventListener('load', _actualizarBadgeConexion);

        // ============================================================
        // WHATSAPP — Recordatorio de cita
        // ============================================================
        function abrirWhatsApp() {
            const p = pacientes.find(x => String(x.id) === String(currentId));
            if (!p || !p.telefono) { showToast('Este paciente no tiene teléfono registrado', true); return; }

            // Construir número internacional:
            // Quitar espacios, guiones, paréntesis
            let tel = p.telefono.replace(/[^\d+]/g, '');
            // Si empieza con 0 → reemplazar por código Ecuador +593
            if (tel.startsWith('0')) tel = '593' + tel.slice(1);
            // Si empieza con + → quitar el +
            if (tel.startsWith('+')) tel = tel.slice(1);
            // Si ya tiene 593 al inicio, dejarlo tal cual
            // Resultado final: solo dígitos sin +, p.ej. 593987654321

            // Próxima cita desde el calendario si existe
            let fechaCita = 'tu próxima cita';
            const hoy = new Date().toISOString().split('T')[0];
            const proxima = (window._eventosCalendario || []).find(ev => {
                const pid = String(ev.pacienteId || ev.paciente_id || '');
                return pid === String(currentId) && (ev.fecha || '') >= hoy;
            });
            if (proxima) {
                const d = new Date(proxima.fecha + 'T00:00:00');
                fechaCita = d.toLocaleDateString('es-ES', { weekday:'long', day:'numeric', month:'long' });
                if (proxima.hora) fechaCita += ' a las ' + proxima.hora;
            }

            const nombre = p.nombre ? p.nombre.split(' ')[0] : 'paciente';
            const plantilla = _getPlantillaWA();
            const texto = plantilla
                .replace('{nombre}', nombre)
                .replace('{cita}', fechaCita);
            const url = `https://api.whatsapp.com/send?phone=${tel}&text=${encodeURIComponent(texto)}`;
            window.open(url, '_blank');
        }

        // ============================================================
        // BODY MAP — Mapa de dolor interactivo
        // ============================================================
        let _bodymapPuntos = [];

        const _ZONAS_FRONT = [
            { id:'cabeza-f',    label:'Cabeza',         shape:'ellipse', cx:55, cy:28, rx:22, ry:26 },
            { id:'cuello-f',    label:'Cuello',         shape:'rect',    x:46,  y:52,  w:18,  h:14 },
            { id:'pecho-f',     label:'Pecho/Tórax',    shape:'rect',    x:28,  y:64,  w:54,  h:40 },
            { id:'abdomen-f',   label:'Abdomen',        shape:'rect',    x:28,  y:104, w:54,  h:40 },
            { id:'brazo-iz-f',  label:'Brazo izq.',     shape:'rect',    x:8,   y:66,  w:18,  h:64 },
            { id:'brazo-de-f',  label:'Brazo der.',     shape:'rect',    x:84,  y:66,  w:18,  h:64 },
            { id:'antebr-iz-f', label:'Antebrazo izq.', shape:'rect',    x:6,   y:132, w:16,  h:52 },
            { id:'antebr-de-f', label:'Antebrazo der.', shape:'rect',    x:88,  y:132, w:16,  h:52 },
            { id:'mano-iz-f',   label:'Mano izq.',      shape:'ellipse', cx:14, cy:194, rx:9,  ry:12 },
            { id:'mano-de-f',   label:'Mano der.',      shape:'ellipse', cx:96, cy:194, rx:9,  ry:12 },
            { id:'pelvis-f',    label:'Pelvis/Cadera',  shape:'rect',    x:26,  y:142, w:58,  h:26 },
            { id:'muslo-iz-f',  label:'Muslo izq.',     shape:'rect',    x:28,  y:166, w:24,  h:60 },
            { id:'muslo-de-f',  label:'Muslo der.',     shape:'rect',    x:58,  y:166, w:24,  h:60 },
            { id:'pierna-iz-f', label:'Pierna izq.',    shape:'rect',    x:30,  y:228, w:20,  h:42 },
            { id:'pierna-de-f', label:'Pierna der.',    shape:'rect',    x:60,  y:228, w:20,  h:42 },
            { id:'pie-iz-f',    label:'Pie izq.',       shape:'ellipse', cx:36, cy:274, rx:13, ry:7 },
            { id:'pie-de-f',    label:'Pie der.',       shape:'ellipse', cx:74, cy:274, rx:13, ry:7 },
        ];
        const _ZONAS_BACK = _ZONAS_FRONT.map(z => ({
            ...z, id: z.id.replace('-f','-b'),
            label: z.label.replace('Pecho/Tórax','Espalda sup.').replace('Abdomen','Espalda baja')
        }));

        function _initBodyMap(svgId, zonas, vista) {
            const svg = document.getElementById(svgId);
            if (!svg || svg.dataset.init) return;
            svg.dataset.init = '1';
            // Hacer cada zona clicable con un overlay invisible
            zonas.forEach(z => {
                let el;
                if (z.shape === 'ellipse') {
                    el = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
                    el.setAttribute('cx', z.cx); el.setAttribute('cy', z.cy);
                    el.setAttribute('rx', z.rx); el.setAttribute('ry', z.ry);
                } else {
                    el = document.createElementNS('http://www.w3.org/2000/svg','rect');
                    el.setAttribute('x', z.x); el.setAttribute('y', z.y);
                    el.setAttribute('width', z.w); el.setAttribute('height', z.h);
                    el.setAttribute('rx', '6');
                }
                el.setAttribute('fill', 'transparent');
                el.setAttribute('stroke', 'none');
                el.style.cursor = 'pointer';
                el.dataset.zid = z.id;
                el.addEventListener('click', () => _toggleZona(z, vista, el));
                svg.appendChild(el);
            });
        }

        function _toggleZona(z, vista, el) {
            const idx = _bodymapPuntos.findIndex(p => p.id === z.id);
            if (idx >= 0) {
                _bodymapPuntos.splice(idx, 1);
                el.setAttribute('fill', 'transparent');
            } else {
                _bodymapPuntos.push({ id: z.id, zona: z.label, vista });
                el.setAttribute('fill', 'rgba(239,68,68,0.35)');
            }
            _renderBodyMapLista();
        }

        function _renderBodyMapLista() {
            const cont = document.getElementById('bodymap-puntos-lista');
            if (!cont) return;
            if (_bodymapPuntos.length === 0) {
                cont.innerHTML = '<p class="text-slate-300 italic">Toca la figura para marcar zonas de dolor</p>';
                return;
            }
            cont.innerHTML = _bodymapPuntos.map(p =>
                `<div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-rose-400 flex-shrink-0"></span><span>${p.zona} <span class="opacity-50">(${p.vista})</span></span></div>`
            ).join('');
        }

        function limpiarBodyMap() {
            _bodymapPuntos = [];
            ['bodymap-front','bodymap-back'].forEach(id => {
                const svg = document.getElementById(id);
                if (svg) svg.querySelectorAll('[data-zid]').forEach(el => el.setAttribute('fill','transparent'));
            });
            _renderBodyMapLista();
        }

        // Inicializar body maps cuando se muestre el detalle del paciente
        const _origVerDetalle = typeof verDetalle === 'function' ? verDetalle : null;

        function _initBodyMapsDelay() {
            setTimeout(() => {
                _initBodyMap('bodymap-front', _ZONAS_FRONT, 'Frontal');
                _initBodyMap('bodymap-back',  _ZONAS_BACK,  'Posterior');
            }, 300);
        }

        // ============================================================
        // ASISTENCIA — estilos de los botones radio
        // ============================================================
        function _actualizarAsistenciaBtns() {
            const val = (document.querySelector('input[name="s-asistencia"]:checked') || {}).value || 'vino';
            const config = {
                vino:    { bg: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-300' },
                falto:   { bg: 'bg-rose-50',    text: 'text-rose-600',    border: 'border-rose-300'    },
                cancelo: { bg: 'bg-amber-50',   text: 'text-amber-600',   border: 'border-amber-300'   },
            };
            ['vino','falto','cancelo'].forEach(v => {
                const span = document.querySelector(`input[name="s-asistencia"][value="${v}"] + span`);
                if (!span) return;
                const c = config[v];
                span.className = `block text-center py-2.5 rounded-xl text-xs font-black border-2 transition-all ${c.bg} ${c.text} ${val===v ? c.border : 'border-transparent'}`;
            });
        }

        document.addEventListener('change', e => {
            if (e.target && e.target.name === 's-asistencia') _actualizarAsistenciaBtns();
        });

        // ── Engancharse a verDetalle para iniciar bodymaps ──────────
        window.addEventListener('load', () => {
            const _orig = window.verDetalle;
            if (typeof _orig === 'function') {
                window.verDetalle = function(id) {
                    _orig(id);
                    _initBodyMapsDelay();
                    limpiarBodyMap();
                    _actualizarAsistenciaBtns();
                };
            }
        });

                // ============================================================
        // RESUMEN RÁPIDO DEL PACIENTE
        // ============================================================
        function renderResumenRapido(p) {
            // Última sesión
            const rrUltima = document.getElementById('rr-ultima');
            const rrEva    = document.getElementById('rr-eva');
            const rrSes    = document.getElementById('rr-sesiones');
            const rrCita   = document.getElementById('rr-cita');
            const rrTend   = document.getElementById('rr-tendencia');
            if (!rrUltima) return;

            // Última sesión hace X días
            const dias = diasDesdeUltimaSesion(p);
            if (dias === null)       rrUltima.innerHTML = '<span class="text-slate-500">Sin sesiones</span>';
            else if (dias === 0)     rrUltima.innerHTML = '<span class="text-emerald-400">Hoy</span>';
            else if (dias === 1)     rrUltima.innerHTML = '<span class="text-emerald-400">Ayer</span>';
            else if (dias <= 7)      rrUltima.innerHTML = `<span class="text-amber-400">Hace ${dias} días</span>`;
            else                     rrUltima.innerHTML = `<span class="text-rose-400">Hace ${dias} días</span>`;

            // EVA actual (último registrado)
            const ultimaS = p.evoluciones && p.evoluciones[0];
            if (ultimaS && ultimaS.eva != null) {
                const eva = ultimaS.eva;
                const col = eva <= 3 ? 'text-emerald-400' : eva <= 6 ? 'text-amber-400' : 'text-rose-400';
                rrEva.innerHTML = `<span class="${col} text-sm font-black">${eva}<span class="text-slate-600 text-[10px]">/10</span></span>`;
            } else {
                rrEva.innerHTML = '<span class="text-slate-500">Sin datos</span>';
            }

            // Total sesiones · este mes
            const total = p.evoluciones ? p.evoluciones.length : 0;
            const mes   = sesionesEsteMes(p);
            rrSes.textContent = `${total} total · ${mes} este mes`;

            // Próxima cita
            const hoy = new Date().toISOString().split('T')[0];
            const proxima = (window._eventosCalendario || []).find(ev => {
                return String(ev.pacienteId || ev.paciente_id || '') === String(p.id) && (ev.fecha || '') >= hoy;
            });
            if (proxima) {
                const d = new Date(proxima.fecha + 'T00:00:00');
                let txt = d.toLocaleDateString('es-ES', { weekday:'short', day:'numeric', month:'short' });
                if (proxima.hora) txt += ' ' + proxima.hora;
                rrCita.innerHTML = `<span class="text-indigo-400">${txt}</span>`;
            } else {
                rrCita.innerHTML = '<span class="text-slate-500">Sin cita agendada</span>';
            }

            // Tendencia EVA (últimas 3 sesiones)
            if (p.evoluciones && p.evoluciones.length >= 2) {
                const evs = p.evoluciones.slice(0, 3).map(s => s.eva).filter(e => e != null);
                if (evs.length >= 2) {
                    const diff = evs[0] - evs[evs.length - 1];
                    if (diff < 0)       rrTend.innerHTML = '<span class="text-rose-400">↑ Subiendo</span>';
                    else if (diff > 0)  rrTend.innerHTML = '<span class="text-emerald-400">↓ Bajando</span>';
                    else                rrTend.innerHTML = '<span class="text-slate-400">→ Estable</span>';
                } else { rrTend.innerHTML = '<span class="text-slate-500">—</span>'; }
            } else { rrTend.innerHTML = '<span class="text-slate-500">—</span>'; }
        }

        // ============================================================
        // MENSAJE AUTOMÁTICO WHATSAPP
        // ============================================================
        function _getPlantillaWA() {
            return 'Hola {nombre} 👋, te recuerdo que tienes {cita} en Jelian FT. Si necesitas cambiar la cita, escríbeme. ¡Hasta pronto! 💪';
        }

                // ============================================================
        // SERVICE WORKER — Registro + detección de actualizaciones
        // ============================================================
        let _swRegistration = null;
        let _swWaiting = null;

        function _spinBothIcons(on) {
            ['reload-icon', 'reload-icon-sidebar'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                if (on) {
                    el.style.transition = 'transform 0.7s linear';
                    el.style.transform = 'rotate(360deg)';
                } else {
                    el.style.transition = 'none';
                    el.style.transform = '';
                }
            });
        }

        function _setReloadLabel(txt, color) {
            const lbl = document.getElementById('reload-label-sidebar');
            if (lbl) { lbl.textContent = txt; lbl.style.color = color || ''; }
            const btn = document.getElementById('btn-reload');
            if (btn) { btn.title = txt; }
            const btnS = document.getElementById('btn-reload-sidebar');
            if (btnS) btnS.title = txt;
        }

        // APP_VERSION se usa para detectar si hay nueva versión en el servidor
        const APP_VERSION = '136.0.0';

        async function forceReload() {
            _spinBothIcons(true);
            _setReloadLabel('Actualizando...');

            try {
                // 1. Indicar al Service Worker en espera que tome control
                if (_swWaiting) {
                    _swWaiting.postMessage({ type: 'SKIP_WAITING' });
                    // El controllerchange event hará location.reload() automáticamente
                    return;
                }

                // 2. Limpiar TODOS los cachés del Service Worker
                if ('caches' in window) {
                    const keys = await caches.keys();
                    await Promise.all(keys.map(k => caches.delete(k)));
                }

                // 3. Desregistrar el Service Worker para forzar re-descarga completa
                if ('serviceWorker' in navigator) {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(regs.map(r => r.unregister()));
                }

                // 4. Verificar si hay versión nueva en el servidor
                const resp = await fetch('./index.html?_nocache=' + Date.now(), { cache: 'no-store' });
                const html = await resp.text();
                const match = html.match(/const APP_VERSION\s*=\s*'([^']+)'/);
                const serverVer = match ? match[1] : null;

                if (serverVer && serverVer !== APP_VERSION) {
                    showToast('🔄 Nueva versión detectada — recargando...');
                } else {
                    showToast('🔄 Recargando app...');
                }

                // 5. Recargar forzando descarga desde servidor
                location.href = location.href.split('?')[0] + '?_v=' + Date.now();

            } catch(e) {
                // Si falla la conexión, al menos intentar recargar
                _setReloadLabel('Sin conexión', '#f87171');
                showToast('Sin conexión — intento de recarga local', true);
                setTimeout(() => {
                    location.reload(true);
                    _spinBothIcons(false);
                }, 1500);
            }
        }

        function _markUpdateReady() {
            showToast('🔄 Nueva versión disponible — pulsa Actualizar para instalar');
        }

        if ('serviceWorker' in navigator && !IS_SANDBOX) {
            window.addEventListener('load', async () => {
                // Limpiar SW viejo con bug de clone
                try {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    for (const r of regs) {
                        const swUrl = r.active?.scriptURL || '';
                        // Si el SW activo no tiene el fix, desregistrar
                        if (swUrl && !swUrl.includes('sw.js')) await r.unregister();
                    }
                } catch(e) {}

                navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' }).then(reg => {
                    _swRegistration = reg;
                    if (reg.waiting) { _swWaiting = reg.waiting; _markUpdateReady(); }
                    reg.addEventListener('updatefound', () => {
                        const nw = reg.installing;
                        if (!nw) return;
                        nw.addEventListener('statechange', () => {
                            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                                _swWaiting = nw;
                                _markUpdateReady();
                            }
                        });
                    });
                    // Chequear actualizaciones cada 5 minutos
                    setInterval(() => { reg.update().catch(() => {}); }, 5 * 60 * 1000);
                }).catch(() => {});

                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) { refreshing = true; window.location.reload(); }
                });
            });
        }

        // ============================================================
        // DOCUMENTOS — TABS, CONSENTIMIENTO, FICHA VALORACION
        // ============================================================
        function docTab(tab) {
            ['consentimiento','ficha'].forEach(t => {
                const panel = document.getElementById('doc-panel-' + t);
                const btn = document.getElementById('doc-tab-' + t);
                if (!panel || !btn) return;
                if (t === tab) {
                    panel.classList.remove('hidden');
                    btn.className = 'px-6 py-2.5 rounded-2xl text-xs font-black bg-indigo-600 text-white transition-all';
                } else {
                    panel.classList.add('hidden');
                    btn.className = 'px-6 py-2.5 rounded-2xl text-xs font-black bg-slate-100 text-slate-600 transition-all';
                }
            });
            if (tab === 'consentimiento') llenarConsentimiento();
            if (tab === 'ficha') llenarFicha();
        }

        function _poblarSelectPacientes(selId) {
            const sel = document.getElementById(selId);
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">Seleccionar paciente</option>';
            (pacientes || []).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.nombre + (p.edad ? ', ' + p.edad + ' anos' : '');
                sel.appendChild(opt);
            });
            if (current) sel.value = current;
        }

        function llenarConsentimiento() {
            _poblarSelectPacientes('cons-paciente-sel');
            const selId = document.getElementById('cons-paciente-sel')?.value;
            const p = (pacientes || []).find(x => String(x.id) === String(selId));
            const fisio = document.getElementById('cons-fisio')?.value || 'el/la fisioterapeuta';
            const tipo = document.getElementById('cons-tipo')?.value || 'Fisioterapia deportiva general';
            const ciudad = document.getElementById('cons-ciudad')?.value || '';

            const nombre = p ? p.nombre : 'el/la paciente';
            const edad = p ? (p.edad || '') : '';

            const intro = document.getElementById('cons-intro');
            if (intro) intro.textContent = 'Yo, ' + nombre + (edad ? ', de ' + edad + ' anos de edad,' : ',') + ' con plena capacidad legal, declaro haber sido informado/a de manera clara y comprensible por ' + fisio + ' sobre el siguiente procedimiento terapeutico:';

            const desc = document.getElementById('cons-desc');
            if (desc) desc.textContent = tipo + (p && p.diag ? '. Diagnostico de referencia: ' + p.diag + '.' : '.');

            const sigP = document.getElementById('cons-sig-paciente');
            if (sigP) sigP.textContent = nombre;
            const sigF = document.getElementById('cons-sig-fisio');
            if (sigF) sigF.textContent = fisio;
            const fecha = document.getElementById('cons-fecha-lugar');
            if (fecha) fecha.textContent = ciudad || ('Fecha: ' + new Date().toLocaleDateString('es-ES', {day:'numeric',month:'long',year:'numeric'}));
        }

        function llenarFicha() {
            _poblarSelectPacientes('ficha-paciente-sel');
            const selId = document.getElementById('ficha-paciente-sel')?.value;
            const p = (pacientes || []).find(x => String(x.id) === String(selId));
            const fisio = document.getElementById('ficha-fisio')?.value || '';
            const motivo = document.getElementById('ficha-motivo')?.value || '';
            const fecha = document.getElementById('ficha-fecha')?.value || new Date().toISOString().split('T')[0];
            const antec = document.getElementById('ficha-antecedentes')?.value || '';
            const explor = document.getElementById('ficha-exploracion')?.value || '';
            const evaVal = document.getElementById('ficha-eva')?.value || '';
            const objDoc = document.getElementById('ficha-objetivos-doc')?.value || '';

            const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || ''; };
            set('fv-nombre', p ? p.nombre : '');
            set('fv-edad', p ? (p.edad || '') : '');
            set('fv-deporte', p ? (p.deporte || '') : '');
            set('fv-sexo', p ? (p.sexo || '') : '');
            set('fv-diag', p ? ((p.diag || '') + (p.zona ? ' — ' + p.zona : '')) : '');
            set('fv-motivo', motivo);
            set('fv-fecha', fecha ? new Date(fecha + 'T12:00:00').toLocaleDateString('es-ES', {day:'numeric',month:'long',year:'numeric'}) : '');
            set('fv-fisio-out', fisio);
            set('fv-antecedentes', antec);
            set('fv-exploracion', explor);
            set('fv-objetivos', objDoc || (p && p.objetivos && p.objetivos.length ? p.objetivos.map(o=>o.texto).join(', ') : ''));
            set('fv-sig-paciente', p ? p.nombre : '');
            set('fv-sig-fisio2', fisio);

            // EVA bar
            const eva = parseFloat(evaVal) || (p && p.valoracion && p.valoracion.length ? p.valoracion[p.valoracion.length-1].eva : 0) || 0;
            const bar = document.getElementById('fv-eva-bar');
            const num = document.getElementById('fv-eva-num');
            if (bar) bar.style.width = (eva * 10) + '%';
            if (num) num.textContent = eva || '';
        }

        function imprimirDoc(previewId) {
            const el = document.getElementById(previewId);
            if (!el) return;
            const w = window.open('', '_blank', 'width=800,height=900');
            if (!w) { showToast('❌ Habilita las ventanas emergentes para imprimir.', true); return; }
            w.document.write('<html><head><title>Jelian FT - Documento</title><style>body{margin:32px;font-family:Georgia,serif;line-height:1.7;color:#1e293b}table{border-collapse:collapse;width:100%}td{border:1px solid #e2e8f0;padding:8px 12px}</style></head><body>' + el.innerHTML + '</body></html>');
            w.document.close();
            w.focus();
            setTimeout(() => { w.print(); }, 400);
        }


        // ============================================================
        // FACTURACIÓN
        // ============================================================
        let facturas = JSON.parse(localStorage.getItem('jft_facturas') || '[]');
        let _factEstado = 'pagado';
        function saveFacturas() { localStorage.setItem('jft_facturas', JSON.stringify(facturas)); }
        function abrirModalFactura() {
            _factEstado = 'pagado';
            document.getElementById('fest-pagado').className = 'flex-1 py-2 rounded-xl text-xs font-black bg-emerald-600 text-white transition-all';
            document.getElementById('fest-pendiente').className = 'flex-1 py-2 rounded-xl text-xs font-black bg-slate-100 text-slate-600 transition-all';
            const sel = document.getElementById('fact-pac');
            sel.innerHTML = '<option value="">Seleccionar...</option>';
            (pacientes||[]).forEach(p => { const o=document.createElement('option'); o.value=p.id; o.textContent=p.nombre; sel.appendChild(o); });
            document.getElementById('fact-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('fact-monto').value = '';
            document.getElementById('fact-notas').value = '';
            document.getElementById('modal-factura').classList.remove('hidden');
        }
        function cerrarModalFactura() { document.getElementById('modal-factura').classList.add('hidden'); }
        function setFactEstado(est) {
            _factEstado = est;
            document.getElementById('fest-pagado').className = 'flex-1 py-2 rounded-xl text-xs font-black ' + (est==='pagado' ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-600') + ' transition-all';
            document.getElementById('fest-pendiente').className = 'flex-1 py-2 rounded-xl text-xs font-black ' + (est==='pendiente' ? 'bg-amber-500 text-white' : 'bg-slate-100 text-slate-600') + ' transition-all';
        }
        function guardarFactura() {
            const pacId = document.getElementById('fact-pac').value;
            const monto = parseFloat(document.getElementById('fact-monto').value);
            if (!pacId || !monto) { showToast('Completa paciente y monto', true); return; }
            const pac = (pacientes||[]).find(p=>String(p.id)===String(pacId));
            facturas.push({ id: Date.now(), pacId, pacNombre: pac ? pac.nombre : '', monto, estado: _factEstado,
                tipo: document.getElementById('fact-tipo').value, metodo: document.getElementById('fact-metodo').value,
                fecha: document.getElementById('fact-fecha').value, notas: document.getElementById('fact-notas').value });
            saveFacturas(); cerrarModalFactura(); renderFacturas(); showToast('Factura guardada');
        }
        function renderFacturas() {
            const filtroEstado = document.getElementById('fact-filtro-estado')?.value || 'todos';
            const filtroPac = document.getElementById('fact-filtro-paciente')?.value || '';
            const selFP = document.getElementById('fact-filtro-paciente');
            if (selFP && selFP.options.length <= 1) {
                (pacientes||[]).forEach(p => { const o=document.createElement('option'); o.value=p.id; o.textContent=p.nombre; selFP.appendChild(o); });
            }
            let lista = [...facturas].sort((a,b)=>b.fecha.localeCompare(a.fecha));
            if (filtroEstado !== 'todos') lista = lista.filter(f=>f.estado===filtroEstado);
            if (filtroPac) lista = lista.filter(f=>String(f.pacId)===String(filtroPac));
            const hoy = new Date(); const mes = hoy.getMonth(); const anio = hoy.getFullYear();
            const esMes = f => { const d=new Date(f.fecha+'T12:00:00'); return d.getMonth()===mes && d.getFullYear()===anio; };
            const totalMes = facturas.filter(f=>f.estado==='pagado'&&esMes(f)).reduce((s,f)=>s+f.monto,0);
            const totalPend = facturas.filter(f=>f.estado==='pendiente').reduce((s,f)=>s+f.monto,0);
            const totalGen = facturas.filter(f=>f.estado==='pagado').reduce((s,f)=>s+f.monto,0);
            document.getElementById('fact-mes').textContent = '$'+totalMes.toFixed(2);
            document.getElementById('fact-pendiente').textContent = '$'+totalPend.toFixed(2);
            document.getElementById('fact-total').textContent = '$'+totalGen.toFixed(2);
            document.getElementById('fact-sesiones').textContent = facturas.filter(f=>f.estado==='pagado').length;
            const container = document.getElementById('fact-tabla');
            if (!lista.length) { container.innerHTML='<div class="p-8 text-center text-slate-400 font-bold text-sm">Sin facturas registradas</div>'; return; }
            container.innerHTML = lista.map(f => {
                const ec = f.estado==='pagado' ? 'bg-emerald-100 text-emerald-700' : f.estado==='pendiente' ? 'bg-amber-100 text-amber-700' : 'bg-rose-100 text-rose-700';
                return '<div class="p-5 flex flex-col sm:flex-row sm:items-center gap-3 hover:bg-slate-50 transition-colors">'
                    + '<div class="flex-1 min-w-0"><p class="font-black text-slate-900 text-sm truncate">' + escHtml(f.pacNombre) + '</p>'
                    + '<p class="text-xs text-slate-400">' + escHtml(f.tipo) + ' · ' + escHtml(f.metodo) + ' · ' + f.fecha + '</p>'
                    + (f.notas ? '<p class="text-xs text-slate-400 italic mt-0.5">' + escHtml(f.notas) + '</p>' : '') + '</div>'
                    + '<div class="flex items-center gap-3 flex-shrink-0">'
                    + '<span class="text-lg font-black text-slate-900">$' + f.monto.toFixed(2) + '</span>'
                    + '<span class="px-3 py-1 rounded-full text-[10px] font-black ' + ec + '">' + f.estado + '</span>'
                    + (f.estado==='pendiente' ? '<button onclick="marcarPagado(' + f.id + ')" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black hover:bg-emerald-700 transition-all">Cobrar</button>' : '')
                    + '<button onclick="eliminarFactura(' + f.id + ')" class="text-rose-400 hover:text-rose-600 font-black text-sm transition-colors">✕</button>'
                    + '</div></div>';
            }).join('');
        }
        function marcarPagado(id) { const f=facturas.find(x=>x.id===id); if(f){f.estado='pagado';saveFacturas();renderFacturas();showToast('Marcado como pagado');} }
        function eliminarFactura(id) { if(!confirm('¿Eliminar esta factura?'))return; facturas=facturas.filter(f=>f.id!==id);saveFacturas();renderFacturas(); }
        function exportarFacturasCSV() {
            // FIX: CSV injection prevention + BOM para Excel UTF-8
            const _csvSafe = v => { const s = String(v == null ? '' : v); return /^[=+\-@\t\r]/.test(s) ? "'" + s : s; };
            const header = 'Fecha,Paciente,Tipo,Monto,Estado,Metodo,Notas\n';
            const rows = facturas.map(f => [f.fecha, f.pacNombre, f.tipo, f.monto, f.estado, f.metodo, f.notas||'']
                .map(v => '"' + _csvSafe(v).replace(/"/g, '""') + '"').join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(['\uFEFF' + header + rows], {type: 'text/csv;charset=utf-8;'}));
            a.download = 'facturas_jelianft.csv'; a.click();
        }

        // ============================================================
        // INVENTARIO
        // ============================================================
        let inventario = JSON.parse(localStorage.getItem('jft_inventario') || '[]');
        let _invCatFiltro = 'todos';
        function saveInventario() { localStorage.setItem('jft_inventario', JSON.stringify(inventario)); }
        function abrirModalInventario(id) {
            const modal = document.getElementById('modal-inventario');
            if (id) {
                const item = inventario.find(i=>i.id===id); if(!item)return;
                document.getElementById('inv-modal-titulo').textContent='Editar Material';
                document.getElementById('inv-edit-id').value=id;
                document.getElementById('inv-nombre').value=item.nombre;
                document.getElementById('inv-cat').value=item.cat;
                document.getElementById('inv-unidad').value=item.unidad;
                document.getElementById('inv-stock').value=item.stock;
                document.getElementById('inv-min').value=item.min;
                document.getElementById('inv-notas').value=item.notas||'';
            } else {
                document.getElementById('inv-modal-titulo').textContent='Nuevo Material';
                document.getElementById('inv-edit-id').value='';
                ['inv-nombre','inv-unidad','inv-notas'].forEach(id=>document.getElementById(id).value='');
                document.getElementById('inv-stock').value=''; document.getElementById('inv-min').value='';
            }
            modal.classList.remove('hidden');
        }
        function cerrarModalInventario() { document.getElementById('modal-inventario').classList.add('hidden'); }
        function guardarInventario() {
            const nombre=document.getElementById('inv-nombre').value.trim();
            const stock=parseInt(document.getElementById('inv-stock').value, 10);
            if(!nombre||isNaN(stock)){showToast('Completa nombre y stock',true);return;}
            const editId=parseInt(document.getElementById('inv-edit-id').value, 10);
            const data={nombre,cat:document.getElementById('inv-cat').value,unidad:document.getElementById('inv-unidad').value||'unidades',
                stock,min:parseInt(document.getElementById('inv-min').value, 10)||0,notas:document.getElementById('inv-notas').value};
            if(editId){const i=inventario.findIndex(x=>x.id===editId);if(i>=0)inventario[i]={...inventario[i],...data};}
            else{inventario.push({id:Date.now(),...data});}
            saveInventario();cerrarModalInventario();renderInventario();showToast('Material guardado');
        }
        function filtrarInv(cat) {
            _invCatFiltro=cat;
            ['todos','consumible','equipo','accesorio'].forEach(c=>{
                const btn=document.getElementById('inv-cat-'+c); if(!btn)return;
                btn.className='px-4 py-2 rounded-xl text-xs font-black transition-all '+(c===cat?'bg-indigo-600 text-white':'bg-slate-100 text-slate-600');
            });
            renderInventario();
        }
        function renderInventario() {
            let lista=_invCatFiltro==='todos'?inventario:inventario.filter(i=>i.cat===_invCatFiltro);
            const bajos=inventario.filter(i=>i.stock<=i.min&&i.min>0);
            const alertDiv=document.getElementById('inv-alertas');
            if(bajos.length){alertDiv.innerHTML='<div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 flex items-start gap-3 mb-2"><span class="text-amber-500 text-xl">⚠️</span><div><p class="font-black text-amber-800 text-sm">Stock bajo en: '+bajos.map(i=>escHtml(i.nombre)).join(', ')+'</p><p class="text-xs text-amber-600 mt-0.5">Considera reponer estos materiales</p></div></div>';}
            else{alertDiv.innerHTML='';}
            const grid=document.getElementById('inv-grid');
            if(!lista.length){grid.innerHTML='<div class="col-span-full text-center text-slate-400 font-bold text-sm py-12">Sin materiales registrados</div>';return;}
            const cc={consumible:'amber',equipo:'indigo',accesorio:'emerald'};
            grid.innerHTML=lista.map(item=>{
                const pct=item.stock<=0?0:Math.min(100,(item.stock/Math.max(item.min*3,item.stock))*100);
                const col=cc[item.cat]||'slate'; const bajo=item.min>0&&item.stock<=item.min;
                return '<div class="glass-card rounded-2xl p-5 '+(bajo?'ring-2 ring-amber-400':'')+'"><div class="flex justify-between items-start mb-3">'
                    +'<span class="text-[10px] font-black bg-'+col+'-100 text-'+col+'-700 px-2 py-0.5 rounded-full uppercase tracking-wide">'+item.cat+'</span>'
                    +'<div class="flex gap-1">'
                    +'<button onclick="ajustarStock('+item.id+',-1)" class="w-7 h-7 rounded-lg bg-rose-100 text-rose-600 font-black text-sm hover:bg-rose-200 transition-all flex items-center justify-center">−</button>'
                    +'<button onclick="ajustarStock('+item.id+',1)" class="w-7 h-7 rounded-lg bg-emerald-100 text-emerald-600 font-black text-sm hover:bg-emerald-200 transition-all flex items-center justify-center">+</button>'
                    +'<button onclick="abrirModalInventario('+item.id+')" class="w-7 h-7 rounded-lg bg-slate-100 text-slate-600 font-black text-xs hover:bg-slate-200 transition-all flex items-center justify-center">✏️</button>'
                    +'<button onclick="eliminarInventario('+item.id+')" class="w-7 h-7 rounded-lg bg-slate-100 text-rose-500 font-black text-xs hover:bg-rose-100 transition-all flex items-center justify-center">✕</button>'
                    +'</div></div>'
                    +'<p class="font-extrabold text-slate-900 text-sm mb-0.5">'+escHtml(item.nombre)+'</p>'
                    +(item.notas?'<p class="text-xs text-slate-400 mb-2">'+escHtml(item.notas)+'</p>':'')
                    +'<div class="flex items-baseline gap-1 mb-2"><span class="text-3xl font-black '+(bajo?'text-amber-500':'text-slate-800')+'">'+item.stock+'</span>'
                    +'<span class="text-xs text-slate-400">'+escHtml(item.unidad)+'</span>'
                    +(bajo?'<span class="ml-auto text-[10px] font-black text-amber-500 bg-amber-50 px-2 py-0.5 rounded-full">Stock bajo</span>':'')+'</div>'
                    +'<div class="h-1.5 bg-slate-100 rounded-full overflow-hidden"><div class="h-full rounded-full transition-all duration-500 '+(bajo?'bg-amber-400':'bg-emerald-400')+'" style="width:'+pct+'%"></div></div>'
                    +'<p class="text-[10px] text-slate-400 mt-1">Mínimo: '+item.min+' '+escHtml(item.unidad)+'</p></div>';
            }).join('');
        }
        function ajustarStock(id,delta){const i=inventario.findIndex(x=>x.id===id);if(i<0)return;inventario[i].stock=Math.max(0,inventario[i].stock+delta);saveInventario();renderInventario();}
        function eliminarInventario(id){if(!confirm('¿Eliminar este material?'))return;inventario=inventario.filter(i=>i.id!==id);saveInventario();renderInventario();}

        // ============================================================
        // CALCULADORAS CLÍNICAS
        // ============================================================
        function calcTab(tab) {
            ['imc','carga','karvonen','rpe','oswestry','dash'].forEach(t=>{
                const p=document.getElementById('calc-panel-'+t),b=document.getElementById('calc-tab-'+t);if(!p||!b)return;
                if(t===tab){p.classList.remove('hidden');b.className='px-5 py-2.5 rounded-2xl text-xs font-black bg-indigo-600 text-white transition-all';}
                else{p.classList.add('hidden');b.className='px-5 py-2.5 rounded-2xl text-xs font-black bg-slate-100 text-slate-600 transition-all';}
            });
            if(tab==='rpe')renderRPEGrid();
            if(tab==='oswestry')renderOswestryItems();
            if(tab==='dash')renderDashItems();
        }
        function calcIMC(){
            const peso=parseFloat(document.getElementById('imc-peso').value),alt=parseFloat(document.getElementById('imc-altura').value);
            if(!peso||!alt)return;
            const imc=peso/((alt/100)**2);
            document.getElementById('imc-resultado').classList.remove('hidden');
            document.getElementById('imc-valor').textContent=imc.toFixed(1);
            let cat,color,pct;
            if(imc<18.5){cat='Bajo peso';color='#3b82f6';pct=((imc-16)/2)*25;}
            else if(imc<25){cat='Peso normal';color='#10b981';pct=25+((imc-18.5)/6.5)*25;}
            else if(imc<30){cat='Sobrepeso';color='#f59e0b';pct=50+((imc-25)/5)*25;}
            else{cat='Obesidad';color='#ef4444';pct=75+Math.min(25,((imc-30)/10)*25);}
            document.getElementById('imc-categoria').textContent=cat;document.getElementById('imc-categoria').style.color=color;
            const bar=document.getElementById('imc-bar');bar.style.width=Math.min(100,Math.max(0,pct))+'%';bar.style.background=color;
        }
        function calcCarga(){
            const min=parseFloat(document.getElementById('carga-min').value),rpe=parseFloat(document.getElementById('carga-rpe').value);
            if(!min||!rpe)return; const ua=min*rpe;
            document.getElementById('carga-resultado').classList.remove('hidden');
            document.getElementById('carga-valor').textContent=ua.toFixed(0);
            let nivel;
            if(ua<300)nivel='🟢 Carga baja — adecuada para recuperación';
            else if(ua<500)nivel='🟡 Carga moderada — óptima para rehabilitación activa';
            else if(ua<700)nivel='🟠 Carga alta — monitorizar fatiga acumulada';
            else nivel='🔴 Carga muy alta — precaución, riesgo de sobreentrenamiento';
            document.getElementById('carga-nivel').textContent=nivel;
        }
        function calcKarvonen(){
            const edad=parseFloat(document.getElementById('karv-edad').value),reposo=parseFloat(document.getElementById('karv-reposo').value);
            const intMin=parseFloat(document.getElementById('karv-int-min').value)||60,intMax=parseFloat(document.getElementById('karv-int-max').value)||80;
            if(!edad||!reposo)return;
            const fcmax=220-edad,reserva=fcmax-reposo;
            document.getElementById('karv-resultado').classList.remove('hidden');
            document.getElementById('karv-fcmax').textContent=fcmax;
            document.getElementById('karv-min').textContent=Math.round(reserva*(intMin/100)+reposo);
            document.getElementById('karv-max').textContent=Math.round(reserva*(intMax/100)+reposo);
        }
        const RPE_DATA=[
            {val:1,label:'Muy muy suave',color:'#bbf7d0',recom:'Reposo activo, recuperación pasiva'},
            {val:2,label:'Muy suave',color:'#86efac',recom:'Movilidad articular, estiramientos suaves'},
            {val:3,label:'Suave',color:'#4ade80',recom:'Ejercicio de calentamiento sin fatiga'},
            {val:4,label:'Moderado suave',color:'#22c55e',recom:'Trabajo aeróbico de baja intensidad'},
            {val:5,label:'Moderado',color:'#fbbf24',recom:'Zona aeróbica óptima para rehabilitación'},
            {val:6,label:'Moderado alto',color:'#f59e0b',recom:'Control de la respiración, pausas si necesita'},
            {val:7,label:'Difícil',color:'#f97316',recom:'Trabajo de fuerza moderada, monitorizar dolor'},
            {val:8,label:'Muy difícil',color:'#ef4444',recom:'Alta intensidad, sesiones cortas y supervisadas'},
            {val:9,label:'Extremadamente difícil',color:'#dc2626',recom:'Límite del esfuerzo, no recomendado en fase aguda'},
            {val:10,label:'Esfuerzo máximo',color:'#991b1b',recom:'Esfuerzo absoluto, evitar en rehabilitación'},
        ];
        function renderRPEGrid(){
            const grid=document.getElementById('rpe-grid');if(!grid||grid.children.length>0)return;
            grid.innerHTML=RPE_DATA.map(r=>'<button onclick="selectRPE('+r.val+')" id="rpe-btn-'+r.val+'" class="rounded-2xl p-4 text-center transition-all hover:scale-105 border-2 border-transparent" style="background:'+r.color+'20"><p class="text-2xl font-black" style="color:'+r.color+'">'+r.val+'</p><p class="text-[10px] font-bold text-slate-600 mt-1 leading-tight">'+r.label+'</p></button>').join('');
        }
        function selectRPE(val){
            RPE_DATA.forEach(r=>{const btn=document.getElementById('rpe-btn-'+r.val);if(btn)btn.style.borderColor='transparent';});
            const r=RPE_DATA.find(x=>x.val===val);const selBtn=document.getElementById('rpe-btn-'+val);
            if(selBtn&&r)selBtn.style.borderColor=r.color;
            document.getElementById('rpe-resultado').classList.remove('hidden');
            document.getElementById('rpe-desc').textContent=val+' — '+r.label;document.getElementById('rpe-desc').style.color=r.color;
            document.getElementById('rpe-recom').textContent='💡 '+r.recom;
        }
        const OSW_ITEMS=[
            {titulo:'Intensidad del dolor',opts:['Puedo soportar el dolor sin analgésicos','El dolor es fuerte pero puedo manejarlo sin pastillas','Los analgésicos alivian completamente el dolor','Los analgésicos alivian el dolor moderadamente','Los analgésicos apenas alivian el dolor','Los analgésicos no tienen efecto']},
            {titulo:'Cuidado personal',opts:['Puedo cuidarme solo sin dolor','Puedo cuidarme solo pero con dolor','Cuidarme es doloroso y lento','Necesito ayuda pero me cuido gran parte','Necesito ayuda en todo','Me visto en cama']},
            {titulo:'Levantar objetos',opts:['Puedo levantar objetos pesados sin dolor','Puedo levantar pesados con algo de dolor','El dolor impide levantar pesados del suelo','El dolor impide levantar pesados','Solo puedo levantar objetos muy ligeros','No puedo levantar ni cargar nada']},
            {titulo:'Caminar',opts:['El dolor no impide caminar cualquier distancia','El dolor impide caminar más de 1 km','El dolor impide caminar más de 500 m','El dolor impide caminar más de 100 m','Solo puedo caminar con bastón o muletas','Paso la mayor parte en cama']},
            {titulo:'Estar sentado',opts:['Puedo estar sentado tanto tiempo como quiera','Puedo estar sentado con algo de dolor','El dolor impide estar sentado más de 1 hora','El dolor impide estar sentado más de 30 min','El dolor impide estar sentado más de 10 min','El dolor impide estar sentado']},
            {titulo:'Estar de pie',opts:['Puedo estar de pie tanto tiempo como quiera','Puedo estar de pie con algo de dolor','El dolor impide estar de pie más de 1 hora','El dolor impide estar de pie más de 30 min','El dolor impide estar de pie más de 10 min','El dolor impide estar de pie']},
            {titulo:'Dormir',opts:['El sueño no se ve afectado','Levemente afectado (< 1h insomnio)','Levemente afectado (1-2h insomnio)','El dolor impide dormir más de 4 horas','El dolor impide dormir más de 2 horas','El dolor impide dormir']},
            {titulo:'Vida social',opts:['Mi vida social es normal sin dolor','Mi vida social es normal pero con dolor','El dolor tiene poco efecto en mi vida social','El dolor ha restringido mi vida social','El dolor ha limitado al hogar','No tengo vida social']},
            {titulo:'Viajes',opts:['Puedo viajar a cualquier parte sin dolor','Puedo viajar con algo de dolor','El dolor es fuerte en viajes > 2 horas','El dolor limita viajes < 1 hora','El dolor limita viajes esenciales < 30 min','El dolor impide viajar excepto al médico']},
            {titulo:'Empleo / actividad diaria',opts:['Mi actividad no aumenta el dolor','Mi actividad aumenta el dolor pero puedo hacerla','Solo puedo hacer trabajos ligeros','No puedo hacer mi actividad habitual','Apenas puedo trabajar','No puedo trabajar']},
        ];
        function renderOswestryItems(){
            const cont=document.getElementById('oswestry-items');if(!cont||cont.children.length>0)return;
            cont.innerHTML=OSW_ITEMS.map((item,i)=>'<div class="bg-slate-50 rounded-2xl p-5"><p class="font-black text-slate-900 text-sm mb-3">'+(i+1)+'. '+item.titulo+'</p>'+item.opts.map((opt,j)=>'<label class="flex items-start gap-3 py-1.5 cursor-pointer group"><input type="radio" name="osw'+i+'" value="'+j+'" class="mt-0.5 accent-indigo-600 flex-shrink-0"><span class="text-xs text-slate-600 group-hover:text-slate-900 transition-colors">('+j+') '+opt+'</span></label>').join('')+'</div>').join('');
        }
        function calcOswestry(){
            let total=0,count=0;
            OSW_ITEMS.forEach((_,i)=>{const sel=document.querySelector('input[name=osw'+i+']:checked');if(sel){total+=parseInt(sel.value, 10);count++;}});
            if(count<10){showToast('Responde todas las preguntas',true);return;}
            const pct = count > 0 ? (total / (count * 5)) * 100 : 0; // FIX: divisor correcto ODI (preguntas respondidas × 5)
            document.getElementById('oswestry-resultado').classList.remove('hidden');
            document.getElementById('oswestry-valor').textContent=pct.toFixed(0)+'%';
            let nivel,desc,col;
            if(pct<21){nivel='Mínima discapacidad';desc='El paciente puede manejarse solo. Se recomiendan consejos posturales.';col='text-emerald-600';}
            else if(pct<41){nivel='Discapacidad moderada';desc='El dolor interfiere en actividades. Fisioterapia ambulatoria indicada.';col='text-amber-500';}
            else if(pct<61){nivel='Discapacidad severa';desc='El dolor afecta todos los aspectos de la vida. Programa intensivo.';col='text-orange-500';}
            else if(pct<81){nivel='Incapacidad grave';desc='El dolor incapacita significativamente. Evaluación multidisciplinar.';col='text-rose-600';}
            else{nivel='Postrado en cama';desc='Hospitalización o evaluación quirúrgica puede ser necesaria.';col='text-rose-800';}
            document.getElementById('oswestry-nivel').textContent=nivel;document.getElementById('oswestry-nivel').className='text-sm font-black mt-2 '+col;
            document.getElementById('oswestry-desc').textContent=desc;
        }
        const DASH_ITEMS_LIST=['Abrir un tarro o frasco hermético','Escribir','Girar una llave','Preparar una comida','Empujar para abrir una puerta pesada','Colocar un objeto en un estante por encima de su cabeza','Hacer tareas domésticas pesadas','Trabajar en el jardín','Tender la cama','Cargar una bolsa de compras o maletín','Lavar o secar la espalda'];
        function renderDashItems(){
            const cont=document.getElementById('dash-items');if(!cont||cont.children.length>0)return;
            cont.innerHTML=DASH_ITEMS_LIST.map((q,i)=>'<div class="bg-slate-50 rounded-2xl p-4"><p class="font-black text-slate-900 text-xs mb-3">'+(i+1)+'. '+q+'</p><div class="flex gap-2">'+[1,2,3,4,5].map(v=>'<label class="flex-1 text-center cursor-pointer"><input type="radio" name="dash'+i+'" value="'+v+'" class="hidden peer"><span class="block py-2 rounded-xl text-xs font-bold peer-checked:bg-indigo-600 peer-checked:text-white bg-white border border-slate-200 hover:bg-indigo-50 transition-all">'+v+'</span></label>').join('')+'</div><div class="flex justify-between text-[9px] text-slate-400 mt-1 px-1"><span>Sin dificultad</span><span>Imposible</span></div></div>').join('');
        }
        function calcDASH(){
            let total=0,count=0;
            DASH_ITEMS_LIST.forEach((_,i)=>{const sel=document.querySelector('input[name=dash'+i+']:checked');if(sel){total+=parseInt(sel.value, 10);count++;}});
            if(count<11){showToast('Responde todas las preguntas',true);return;}
            const score=((total/count)-1)/4*100;
            document.getElementById('dash-resultado').classList.remove('hidden');
            document.getElementById('dash-valor').textContent=score.toFixed(1);
            let nivel,col;
            if(score<25){nivel='Discapacidad leve — buena funcionalidad del miembro superior';col='text-emerald-600';}
            else if(score<50){nivel='Discapacidad moderada — limitación funcional notable';col='text-amber-500';}
            else if(score<75){nivel='Discapacidad severa — impacto importante en actividades diarias';col='text-orange-500';}
            else{nivel='Discapacidad grave — pérdida funcional severa del miembro superior';col='text-rose-600';}
            document.getElementById('dash-nivel').textContent=nivel;document.getElementById('dash-nivel').className='text-sm font-black '+col;
        }



        // Hook showSection para inicializar módulos al navegar
        const _origShowSection2 = showSection;
        showSection = function(id){
            _origShowSection2(id);
            if(id==='facturacion'){renderFacturas();_poblarSelectPacientes('fact-filtro-paciente');}
            if(id==='inventario')renderInventario();
            if(id==='calculadoras')calcTab('imc');
            if(id==='lista-espera')renderEspera();
        };

    </script>
</div>
        <!-- ===== SECCIÓN LISTA DE ESPERA ===== -->
        <section id="lista-espera" class="hidden max-w-4xl mx-auto pb-20">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                <div>
                    <span class="text-amber-500 font-bold text-xs uppercase tracking-widest">Gestión de Pacientes</span>
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mt-1">Lista de Espera</h2>
                    <p class="text-slate-500 text-sm mt-1">Pacientes que quieren cita pero no hay hueco disponible</p>
                </div>
                <button onclick="abrirModalEspera()" class="bg-amber-500 text-white px-6 py-3 rounded-2xl font-black text-sm hover:bg-amber-600 transition-all shadow-lg shadow-amber-100">+ Agregar a Lista</button>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="glass-card rounded-2xl p-5 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">En Espera</p>
                    <p id="espera-total" class="text-3xl font-extrabold text-amber-500">0</p>
                </div>
                <div class="glass-card rounded-2xl p-5 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Urgente</p>
                    <p id="espera-urgentes" class="text-3xl font-extrabold text-rose-500">0</p>
                </div>
                <div class="glass-card rounded-2xl p-5 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Prom. Espera</p>
                    <p id="espera-dias-prom" class="text-3xl font-extrabold text-slate-700">0d</p>
                </div>
            </div>
            <div id="espera-lista" class="space-y-3"></div>
            <div id="modal-espera" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl">
                    <h3 class="text-xl font-extrabold text-slate-900 mb-6">Agregar a Lista de Espera</h3>
                    <div class="space-y-4">
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Nombre del Paciente</label>
                        <input id="espera-nombre" type="text" placeholder="Nombre completo" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-semibold focus:border-amber-400 outline-none"></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Teléfono</label>
                        <input id="espera-tel" type="tel" placeholder="0999123456" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm focus:border-amber-400 outline-none"></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Motivo de consulta</label>
                        <input id="espera-motivo" type="text" placeholder="Ej: Dolor de rodilla..." class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm focus:border-amber-400 outline-none"></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Prioridad</label>
                        <select id="espera-prioridad" class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-semibold focus:border-amber-400 outline-none">
                            <option value="normal">Normal</option>
                            <option value="urgente">Urgente</option>
                            <option value="rutina">Rutina</option>
                        </select></div>
                        <div><label class="text-xs font-bold text-slate-500 block mb-1">Notas</label>
                        <textarea id="espera-notas" rows="2" placeholder="Información adicional..." class="w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm resize-none focus:border-amber-400 outline-none"></textarea></div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="cerrarModalEspera()" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl text-xs font-black hover:bg-slate-200 transition-all">Cancelar</button>
                        <button onclick="guardarEspera()" class="flex-1 bg-amber-500 text-white py-3 rounded-xl text-xs font-black hover:bg-amber-600 transition-all">Agregar</button>
                    </div>
                </div>
            </div>
        </section>

    <!-- MODAL NOTA DE ALTA CLÍNICA -->
    <div id="modal-alta-clinica" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[9998] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <span class="text-indigo-500 font-bold text-xs uppercase tracking-widest">Nota Automática</span>
                    <h3 class="text-2xl font-extrabold text-slate-900 mt-1">📋 Nota de Alta Clínica</h3>
                </div>
                <button onclick="cerrarModalAlta()" class="text-slate-400 hover:text-slate-700 text-2xl font-bold">✕</button>
            </div>
            <div id="nota-alta-content" class="bg-slate-50 rounded-2xl p-6 text-sm text-slate-700 leading-relaxed font-medium whitespace-pre-line mb-6"></div>
            <div class="flex gap-3">
                <button onclick="imprimirNotaAlta()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-xs font-black hover:bg-indigo-700 transition-all">🖨 Imprimir / PDF</button>
                <button onclick="copiarNotaAlta()" class="flex-1 bg-slate-800 text-white py-3 rounded-xl text-xs font-black hover:bg-slate-700 transition-all">📋 Copiar</button>
                <button onclick="confirmarAlta()" class="flex-1 bg-rose-600 text-white py-3 rounded-xl text-xs font-black hover:bg-rose-700 transition-all">✓ Confirmar Alta</button>
            </div>
        </div>
    </div>


    <!-- ═══════════════════════════════════════════════════
         PANEL CHAT PACIENTES — VERSIÓN CORREGIDA
         FIX 1: z-index elevado para no quedar bajo overlays
         FIX 2: usa sb global, sin segundo createClient
         FIX 3: manejo graceful si tabla mensajes no existe
    ════════════════════════════════════════════════════ -->
    <div id="chat-panel-overlay" onclick="cerrarChatPanel()" style="
        display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
        z-index:99990; backdrop-filter:blur(2px);"></div>

    <div id="chat-panel" style="
        position:fixed; top:0; right:0; height:100%; width:min(520px,100vw);
        background:#fff; z-index:99991; display:flex; flex-direction:column;
        transform:translateX(100%); transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);
        box-shadow:-20px 0 60px rgba(0,0,0,0.2); border-left:1px solid #e2e8f0;">

        <!-- Panel header -->
        <div style="display:flex;align-items:center;justify-content:space-between;
                    padding:1rem 1.25rem; border-bottom:1px solid #e2e8f0;
                    background:#0f172a; flex-shrink:0;">
            <div style="display:flex;align-items:center;gap:0.75rem;">
                <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#6366f1,#8b5cf6);
                            display:flex;align-items:center;justify-content:center;">
                    <svg width="18" height="18" fill="none" stroke="white" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </div>
                <div>
                    <div style="font-weight:800;font-size:0.9rem;color:#f1f5f9;">Chat Pacientes</div>
                    <div id="chat-panel-status" style="font-size:0.65rem;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;">Cargando...</div>
                </div>
            </div>
            <button onclick="cerrarChatPanel()" style="background:rgba(255,255,255,0.07);border:none;border-radius:8px;
                    width:32px;height:32px;cursor:pointer;color:#94a3b8;font-size:1.1rem;
                    display:flex;align-items:center;justify-content:center;">✕</button>
        </div>

        <!-- Aviso tabla no creada -->
        <div id="cp-no-tabla" style="display:none;background:#fef3c7;border-bottom:1px solid #fde68a;
             padding:0.6rem 1rem;font-size:0.72rem;color:#92400e;font-weight:600;flex-shrink:0;">
            ⚠️ La tabla <code>mensajes</code> no existe en Supabase. Ejecuta el archivo
            <strong>SETUP_SUPABASE.sql</strong> para activar el chat.
        </div>

        <!-- Layout: lista izq + chat der -->
        <div style="flex:1;display:flex;overflow:hidden;">

            <!-- Lista de pacientes -->
            <div style="width:200px;flex-shrink:0;border-right:1px solid #e2e8f0;overflow-y:auto;background:#f8fafc;">
                <div style="padding:0.6rem;border-bottom:1px solid #e2e8f0;">
                    <input id="cp-search" placeholder="🔍 Buscar…" oninput="cpFiltrar(this.value)"
                        style="width:100%;background:white;border:1px solid #e2e8f0;border-radius:8px;
                               padding:0.4rem 0.6rem;font-size:0.75rem;outline:none;color:#0f172a;">
                </div>
                <div id="cp-pacientes-list"></div>
            </div>

            <!-- Área de chat -->
            <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">

                <!-- Empty state -->
                <div id="cp-empty" style="flex:1;display:flex;flex-direction:column;align-items:center;
                             justify-content:center;color:#94a3b8;text-align:center;padding:2rem;">
                    <div style="font-size:2.5rem;margin-bottom:0.75rem;opacity:0.4;">💬</div>
                    <div style="font-weight:700;font-size:0.85rem;color:#0f172a;margin-bottom:0.3rem;">Selecciona un paciente</div>
                    <div style="font-size:0.75rem;line-height:1.6;">Elige un paciente para ver su conversación.</div>
                </div>

                <!-- Chat activo -->
                <div id="cp-chat-activo" style="flex:1;display:none;flex-direction:column;overflow:hidden;">
                    <div id="cp-chat-header" style="padding:0.75rem 1rem;border-bottom:1px solid #e2e8f0;
                                 background:white;display:flex;align-items:center;gap:0.6rem;flex-shrink:0;">
                        <div id="cp-hdr-avatar" style="width:32px;height:32px;border-radius:50%;
                                     background:linear-gradient(135deg,#6366f1,#8b5cf6);
                                     display:flex;align-items:center;justify-content:center;
                                     font-weight:800;font-size:0.7rem;color:white;flex-shrink:0;"></div>
                        <div style="min-width:0;">
                            <div id="cp-hdr-name" style="font-weight:800;font-size:0.82rem;color:#0f172a;"></div>
                            <div id="cp-hdr-diag" style="font-size:0.65rem;color:#94a3b8;"></div>
                        </div>
                        <div style="margin-left:auto;width:7px;height:7px;border-radius:50%;background:#22c55e;flex-shrink:0;"></div>
                    </div>

                    <div id="cp-messages" style="flex:1;overflow-y:auto;padding:0.85rem;
                                 display:flex;flex-direction:column;gap:0.4rem;scroll-behavior:smooth;
                                 background:#f8fafc;"></div>

                    <div style="padding:0.4rem 0.75rem;background:white;border-top:1px solid #f1f5f9;
                                display:flex;gap:0.3rem;flex-wrap:wrap;flex-shrink:0;">
                        <button onclick="cpQuick('¡Hola! ¿Cómo te has sentido?')" class="cp-quick">👋 Saludo</button>
                        <button onclick="cpQuick('Recuerda hacer tus ejercicios hoy 💪')" class="cp-quick">📋 Ejercicios</button>
                        <button onclick="cpQuick('¡Excelente evolución! Sigue así 🌟')" class="cp-quick">⭐ Motivar</button>
                        <button onclick="cpQuick('Si el dolor aumenta, descansa y avísame.')" class="cp-quick">⚠️ Alerta</button>
                    </div>

                    <div style="padding:0.6rem 0.75rem;background:white;border-top:1px solid #e2e8f0;
                                display:flex;gap:0.5rem;align-items:flex-end;flex-shrink:0;">
                        <textarea id="cp-input" rows="1" placeholder="Escribe como fisio…"
                            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();cpEnviar();}"
                            oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"
                            style="flex:1;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:10px;
                                   padding:0.55rem 0.75rem;font-size:0.82rem;color:#0f172a;outline:none;
                                   resize:none;max-height:100px;min-height:36px;line-height:1.4;transition:border-color 0.2s;"
                            onfocus="this.style.borderColor='#6366f1';this.style.background='white'"
                            onblur="this.style.borderColor='#e2e8f0';this.style.background='#f8fafc'"></textarea>
                        <button onclick="cpEnviar()" id="cp-btn-send"
                            style="background:#6366f1;border:none;border-radius:10px;width:36px;height:36px;
                                   cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <svg width="15" height="15" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        #chat-panel.open { transform: translateX(0) !important; }
        .cp-quick { background:rgba(99,102,241,0.08); border:1px solid rgba(99,102,241,0.2); border-radius:99px; padding:0.22rem 0.65rem; font-size:0.68rem; font-weight:700; color:#6366f1; cursor:pointer; transition:all 0.15s; white-space:nowrap; }
        .cp-quick:hover { background:rgba(99,102,241,0.15); }
        .cp-pac-item { display:flex; align-items:center; gap:0.5rem; padding:0.6rem 0.75rem; cursor:pointer; border-bottom:1px solid #f1f5f9; transition:background 0.12s; }
        .cp-pac-item:hover { background:#f1f5f9; }
        .cp-pac-item.active { background:rgba(99,102,241,0.08); border-left:3px solid #6366f1; }
        .cp-msg-fisio { display:flex; justify-content:flex-end; }
        .cp-msg-pac { display:flex; justify-content:flex-start; }
        .cp-bubble { max-width:80%; padding:0.5rem 0.75rem; font-size:0.8rem; line-height:1.5; border-radius:14px; }
        .cp-bubble.fisio { background:#6366f1; color:white; border-radius:14px 14px 3px 14px; }
        .cp-bubble.paciente { background:white; color:#0f172a; border:1px solid #e2e8f0; border-radius:14px 14px 14px 3px; }
        .cp-bubble-time { font-size:0.6rem; opacity:0.55; text-align:right; margin-top:2px; }
        .cp-pac-label { font-size:0.62rem; font-weight:800; color:#6366f1; text-transform:uppercase; letter-spacing:0.07em; margin-bottom:2px; }
        .cp-day-div { text-align:center; font-size:0.65rem; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.08em; padding:0.4rem 0; display:flex; align-items:center; gap:0.5rem; flex-shrink:0; }
        .cp-day-div::before,.cp-day-div::after { content:''; flex:1; height:1px; background:#e2e8f0; }
        #cp-messages::-webkit-scrollbar { width:3px; }
        #cp-messages::-webkit-scrollbar-thumb { background:#e2e8f0; border-radius:3px; }
    </style>

    <script>
    // ═══════════════════════════════════════════════════════
    // CHAT PANEL — VERSIÓN CORREGIDA
    // FIX 1: Reutiliza `sb` global (sin segundo GoTrueClient)
    // FIX 2: z-index 99991 para aparecer sobre todo
    // FIX 3: Detecta tabla inexistente y muestra aviso claro
    // FIX 4: Inicialización segura con espera a que `sb` exista
    // ═══════════════════════════════════════════════════════
    (function() {
        let cpPacientes   = [];
        let cpActual      = null;
        let cpSub         = null;
        let cpSubGlobal   = null;
        let cpUnread      = {};
        let cpPanelAbierto = false;
        let cpInicializado = false;
        let cpTablaOk     = true; // asume que existe hasta saber lo contrario

        // ── Usar el sb global de Jelian FT (no crear uno nuevo) ──
        function getSb() {
            return window.sb || null;
        }

        function cpEsc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        function cpInitials(n) { return (n||'?').split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase(); }
        function cpHora(iso) { return iso ? new Date(iso).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}) : ''; }
        function cpDia(iso) {
            if (!iso) return '';
            const d=new Date(iso), h=new Date(), a=new Date(h);
            a.setDate(a.getDate()-1);
            if (d.toDateString()===h.toDateString()) return 'Hoy';
            if (d.toDateString()===a.toDateString()) return 'Ayer';
            return d.toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'});
        }
        function cpById(id) { return document.getElementById(id); }

        // ── Abrir panel ──
        window.abrirChatPanel = async function() {
            cpById('chat-panel').classList.add('open');
            cpById('chat-panel-overlay').style.display = 'block';
            cpPanelAbierto = true;
            if (!cpInicializado) {
                cpInicializado = true;
                // Esperar a que `sb` esté disponible (puede estar cargando)
                let intentos = 0;
                while (!getSb() && intentos < 20) {
                    await new Promise(r => setTimeout(r, 200));
                    intentos++;
                }
                if (!getSb()) {
                    cpById('chat-panel-status').textContent = 'Error: sin conexión BD';
                    return;
                }
                await cpCargarPacientes();
                if (cpTablaOk) cpSuscribirGlobal();
            }
        };

        window.cerrarChatPanel = function() {
            cpById('chat-panel').classList.remove('open');
            cpById('chat-panel-overlay').style.display = 'none';
            cpPanelAbierto = false;
        };

        // ── Cargar lista de pacientes ──
        async function cpCargarPacientes() {
            const s = getSb();
            try {
                const { data, error } = await s.from('pacientes')
                    .select('id,nombre,diagnostico,estado').order('nombre');
                if (error) throw error;
                cpPacientes = data || [];

                // Intentar cargar mensajes — detectar si la tabla existe
                let msgs = [];
                try {
                    const { data: mdata, error: merr } = await s
                        .from('mensajes')
                        .select('paciente_id,autor,texto,created_at')
                        .order('created_at', { ascending: false });
                    if (merr) {
                        // 404 = tabla no existe, 400 = error de sintaxis/permisos
                        if (merr.code === '42P01' || merr.message?.includes('does not exist') || merr.status === 404 || merr.status === 400) {
                            cpTablaOk = false;
                            cpById('cp-no-tabla').style.display = 'block';
                        }
                    } else {
                        msgs = mdata || [];
                    }
                } catch(me) {
                    cpTablaOk = false;
                    cpById('cp-no-tabla').style.display = 'block';
                }

                // Calcular unread y previews
                const byPac = {};
                msgs.forEach(m => {
                    if (!byPac[m.paciente_id]) byPac[m.paciente_id] = { last: m, unread: 0 };
                    const seen = parseInt(localStorage.getItem('jft_fisio_seen_'+m.paciente_id)||'0');
                    if (m.autor === 'paciente' && new Date(m.created_at).getTime() > seen) {
                        byPac[m.paciente_id].unread++;
                    }
                });
                cpUnread = byPac;

                const totalUnread = Object.values(cpUnread).reduce((a,b) => a+(b.unread||0), 0);
                const badge = cpById('chat-nav-badge');
                if (badge) badge.classList.toggle('hidden', totalUnread === 0);

                cpById('chat-panel-status').textContent = cpPacientes.length + ' pacientes';
                cpRenderLista(cpPacientes);

            } catch(e) {
                const isOffline = e.message?.includes('fetch') || e.message?.includes('Failed') || e.message?.includes('ERR_CONNECTION');
                cpById('chat-panel-status').textContent = isOffline ? 'Sin conexión' : 'Error al cargar';
                cpById('cp-pacientes-list').innerHTML =
                    `<div style="padding:1rem;color:#ef4444;font-size:0.72rem;text-align:center;">Error: ${cpEsc(e.message)}</div>`;
            }
        }

        function cpRenderLista(lista) {
            const cont = cpById('cp-pacientes-list');
            if (!lista || !lista.length) {
                cont.innerHTML = '<div style="padding:1rem;color:#94a3b8;font-size:0.75rem;text-align:center;">Sin pacientes</div>';
                return;
            }
            cont.innerHTML = lista.map(p => {
                const info    = cpUnread[p.id];
                const preview = (info && info.last)
                    ? cpEsc(info.last.texto.substring(0,28)) + (info.last.texto.length > 28 ? '…' : '')
                    : '<span style="color:#cbd5e1;font-style:italic">Sin mensajes</span>';
                const unread  = info ? info.unread : 0;
                const isAct   = cpActual && cpActual.id === p.id;
                // Serializar solo los campos seguros para onclick
                const pData   = JSON.stringify({id:p.id, nombre:p.nombre, diag:p.diagnostico||'', diagnostico:p.diagnostico||''});
                return `<div class="cp-pac-item${isAct?' active':''}" id="cppac-${p.id}"
                        onclick='cpAbrirConversacion(${pData.replace(/'/g,"&#39;")})'>
                    <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);
                                display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.6rem;color:white;flex-shrink:0;">
                        ${cpInitials(p.nombre)}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:700;font-size:0.75rem;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${cpEsc(p.nombre)}</div>
                        <div style="font-size:0.65rem;color:#94a3b8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${preview}</div>
                    </div>
                    ${unread > 0 ? `<span style="background:#6366f1;color:white;border-radius:99px;font-size:0.6rem;font-weight:800;padding:1px 6px;flex-shrink:0;">${unread}</span>` : ''}
                </div>`;
            }).join('');
        }

        window.cpFiltrar = function(q) {
            cpRenderLista(cpPacientes.filter(p => (p.nombre||'').toLowerCase().includes(q.toLowerCase())));
        };

        // ── Abrir conversación ──
        window.cpAbrirConversacion = async function(p) {
            // p puede llegar como objeto (desde realtime) o string (desde onclick)
            if (typeof p === 'string') { try { p = JSON.parse(p); } catch(e) { return; } }
            cpActual = p;
            localStorage.setItem('jft_fisio_seen_'+p.id, Date.now());
            if (cpUnread[p.id]) cpUnread[p.id].unread = 0;

            // Resaltar en lista
            document.querySelectorAll('.cp-pac-item').forEach(el => el.classList.remove('active'));
            const item = cpById('cppac-'+p.id);
            if (item) {
                item.classList.add('active');
                // Quitar badge de no leídos
                const b = item.querySelector('span[style*="background:#6366f1"]');
                if (b && !b.style.borderRadius?.includes('50%')) b.remove();
            }

            // Mostrar header
            cpById('cp-hdr-avatar').textContent = cpInitials(p.nombre);
            cpById('cp-hdr-name').textContent   = p.nombre;
            cpById('cp-hdr-diag').textContent   = p.diagnostico || p.diag || 'Sin diagnóstico';

            // Mostrar área de chat
            cpById('cp-empty').style.display = 'none';
            const chatEl = cpById('cp-chat-activo');
            chatEl.style.display      = 'flex';
            chatEl.style.flexDirection = 'column';

            await cpCargarMensajes(p.id);

            // Realtime — desuscribir anterior y suscribir nuevo
            const s = getSb();
            if (cpSub) { try { s.removeChannel(cpSub); } catch(e){} cpSub = null; }
            if (cpTablaOk) {
                cpSub = s.channel('jft-cp-' + p.id)
                    .on('postgres_changes', {
                        event: 'INSERT', schema: 'public',
                        table: 'mensajes', filter: `paciente_id=eq.${p.id}`
                    }, payload => {
                        cpAgregarBurbuja(payload.new);
                        cpScrollDown();
                        localStorage.setItem('jft_fisio_seen_'+p.id, Date.now());
                    }).subscribe();
            }

            setTimeout(() => cpById('cp-input').focus(), 100);
        };

        async function cpCargarMensajes(pid) {
            const area = cpById('cp-messages');
            area.innerHTML = '<div style="text-align:center;padding:2rem;color:#94a3b8;font-size:0.8rem;">Cargando…</div>';

            if (!cpTablaOk) {
                area.innerHTML = '<div style="text-align:center;padding:2rem;color:#f59e0b;font-size:0.78rem;">⚠️ Tabla de mensajes no configurada.<br>Ejecuta el SQL de setup primero.</div>';
                return;
            }

            const s = getSb();
            try {
                const { data, error } = await s.from('mensajes').select('*')
                    .eq('paciente_id', pid).order('created_at', { ascending: true });
                if (error) throw error;
                area.innerHTML = '';
                if (!data || data.length === 0) {
                    area.innerHTML = '<div style="text-align:center;padding:2rem;color:#94a3b8;font-size:0.78rem;">Sin mensajes aún.<br>¡Escríbele primero! 👋</div>';
                    return;
                }
                let lastDay = '';
                data.forEach(m => {
                    const d = cpDia(m.created_at);
                    if (d !== lastDay) {
                        const sep = document.createElement('div');
                        sep.className = 'cp-day-div';
                        sep.textContent = d;
                        area.appendChild(sep);
                        lastDay = d;
                    }
                    cpAgregarBurbuja(m);
                });
                cpScrollDown();
            } catch(e) {
                area.innerHTML = `<div style="text-align:center;padding:1rem;color:#ef4444;font-size:0.75rem;">Error al cargar: ${cpEsc(e.message)}</div>`;
            }
        }

        function cpAgregarBurbuja(m) {
            const area = cpById('cp-messages');
            // Limpiar estados vacíos/loading
            ['Cargando', 'Sin mensajes', 'Error al cargar', 'Tabla de mensajes'].forEach(txt => {
                const el = area.querySelector(`div[style*="text-align:center"]`);
                if (el && el.textContent.includes(txt)) el.remove();
            });
            const esFisio = m.autor === 'fisio';
            const row = document.createElement('div');
            row.className = esFisio ? 'cp-msg-fisio' : 'cp-msg-pac';
            row.innerHTML = `<div class="cp-bubble ${esFisio ? 'fisio' : 'paciente'}">
                ${!esFisio ? `<div class="cp-pac-label">${cpEsc(m.paciente_nombre || 'Paciente')}</div>` : ''}
                ${cpEsc(m.texto)}
                <div class="cp-bubble-time">${cpHora(m.created_at)}</div>
            </div>`;
            area.appendChild(row);
        }

        function cpScrollDown() {
            const a = cpById('cp-messages');
            if (a) setTimeout(() => a.scrollTop = a.scrollHeight, 50);
        }

        // ── Enviar mensaje ──
        window.cpEnviar = async function() {
            if (!cpActual) return;
            if (!cpTablaOk) {
                if (window.showToast) showToast('⚠️ Tabla de mensajes no configurada', true);
                return;
            }
            const input = cpById('cp-input');
            const texto = (input.value || '').trim();
            if (!texto) return;
            const btn = cpById('cp-btn-send');
            btn.style.opacity = '0.5';
            input.value = '';
            input.style.height = '36px';
            const s = getSb();
            try {
                const { error } = await s.from('mensajes').insert({
                    paciente_id:     cpActual.id,
                    paciente_nombre: cpActual.nombre,
                    texto,
                    autor: 'fisio'
                });
                if (error) throw error;
            } catch(e) {
                if (window.showToast) showToast('Error al enviar: ' + e.message, true);
                input.value = texto;
            }
            btn.style.opacity = '1';
            setTimeout(() => input.focus(), 50);
        };

        window.cpQuick = function(txt) {
            const inp = cpById('cp-input');
            inp.value = txt; inp.focus();
            inp.style.height = 'auto';
            inp.style.height = Math.min(inp.scrollHeight, 100) + 'px';
        };

        // ── Realtime global para badges del sidebar ──
        function cpSuscribirGlobal() {
            const s = getSb(); if (!s) return;
            cpSubGlobal = s.channel('jft-global-chat-' + Date.now())
                .on('postgres_changes', { event:'INSERT', schema:'public', table:'mensajes' }, payload => {
                    const m = payload.new;
                    if (m.autor !== 'paciente') return;
                    // Badge en botón sidebar
                    const badge = cpById('chat-nav-badge');
                    if (badge && (!cpPanelAbierto || !cpActual || m.paciente_id !== cpActual.id)) {
                        badge.classList.remove('hidden');
                    }
                    // Badge en item de lista
                    if (!cpActual || m.paciente_id !== cpActual.id) {
                        const item = cpById('cppac-' + m.paciente_id);
                        if (item) {
                            const prev = item.querySelectorAll('div')[1]?.querySelector('div:last-child');
                            if (prev) prev.textContent = m.texto.substring(0, 28) + (m.texto.length > 28 ? '…' : '');
                            let b = item.querySelector('span[style*="border-radius:99px"]');
                            if (!b) {
                                b = document.createElement('span');
                                b.style.cssText = 'background:#6366f1;color:white;border-radius:99px;font-size:0.6rem;font-weight:800;padding:1px 6px;flex-shrink:0;';
                                item.appendChild(b);
                                b.textContent = '0';
                            }
                            b.textContent = (parseInt(b.textContent || '0') + 1);
                        }
                    }
                }).subscribe();
        }

    })();
    </script>

</body>
</html>
